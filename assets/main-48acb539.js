import{O as l,C as d,U as o,S as A}from"./clashConstants-ff1486f5.js";import{i as g,U as y,d as f,R as h,O as w,B as T,g as p,G as R,P as S}from"./bsSceneCache-70263cd4.js";function E(){l.contextMenu.create({id:`${d.EXTENSIONID}/context-menu`,icons:[{icon:"/addunit.svg",label:"[Clash!] Add to Initiative",filter:{every:[{key:["metadata",o.ONLIST],operator:"!=",value:!0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"MOUNT"}]}},{icon:"/removeunit.svg",label:"[Clash!] Remove from Initiative",filter:{every:[{key:["metadata",o.ONLIST],operator:"==",value:!0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"MOUNT"}]}}],async onClick(I){const m=I.items.filter(e=>e.layer==="CHARACTER"||e.layer==="MOUNT"),u=m.every(e=>e.metadata[o.ONLIST]===!0),r=m.filter(e=>g(e));if(u){const e=m.map(i=>i.id+"_hpbar");await l.scene.items.deleteItems(e),await l.scene.items.updateItems(m,i=>{for(let n of i)delete n.metadata[o.ONLIST],delete n.metadata[o.HPBAR]})}else{const e=[];for(const i of r){const n=i.text?.plainText||i.name;if(i.metadata[o.ID]!==void 0){const a={};a[o.ID]=i.id,a[o.ONLIST]=!0,e.push(a);continue}let s=new y(i.id,n,i.createdUserId);if(d.ALPHANUMERICTEXTMATCH.test(i.name)){const a=n.slice(0,-2),c=await f.Creatures.get({unitName:a});c&&s.SetToModel(c)}else{const a=await f.Creatures.get({unitName:n});a&&s.SetToModel(a)}const t=s.GetMetadata();t[o.ONLIST]=!0,e.push(t)}await l.scene.items.updateItems(r,i=>{for(let n of i){const s=e.find(t=>t[o.ID]===n.id);if(s){if(h(A.NAMELABELS)){const t=s[o.UNITNAME];t&&(n.text.plainText=t)}Object.assign(n.metadata,s)}}})}}}),l.contextMenu.create({id:`${d.EXTENSIONID}/context-menu-sheet`,icons:[{icon:"/sheet.svg",label:"[Clash!] View Info",filter:{max:1,some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"MOUNT"}]}},{icon:"/multi-sheet.svg",label:"[Clash!] View Info",filter:{min:2,some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"MOUNT"}]}}],async onClick(I,m){const u=I.items.filter(r=>r.layer==="CHARACTER"||r.layer==="MOUNT");if(u.length==1){const r=[],e=u[0],i=e.text?.plainText||e.name;if(e.metadata[o.ID]===void 0){let n=new y(e.id,i,e.createdUserId);if(d.ALPHANUMERICTEXTMATCH.test(e.name)){const t=i.slice(0,-2),a=await f.Creatures.get({unitName:t});a&&n.SetToModel(a)}else{const t=await f.Creatures.get({unitName:i});t&&n.SetToModel(t)}const s=n.GetMetadata();r.push(s),await l.scene.items.updateItems([e.id],t=>{for(let a of t){const c=r.find(N=>N[o.ID]===a.id);c&&Object.assign(a.metadata,c)}})}await w(e.id,m)}else{const r=[];for(const s of u){const t=s,a=t.text?.plainText||t.name;if(t.metadata[o.ID]===void 0){let c=new y(t.id,a,t.createdUserId);if(d.ALPHANUMERICTEXTMATCH.test(t.name)){const C=a.slice(0,-2),M=await f.Creatures.get({unitName:C});M&&c.SetToModel(M)}else{const C=await f.Creatures.get({unitName:a});C&&c.SetToModel(C)}const N=c.GetMetadata();r.push(N)}}await l.scene.items.updateItems(u,s=>{for(let t of s){const a=r.find(c=>c[o.ID]===t.id);a&&Object.assign(t.metadata,a)}});const e=await l.viewport.getHeight(),i=100,n=e>800?700:e-i;await l.popover.open({id:d.EXTENSIONSUBMENUID,url:`/submenu/subindex.html?unitid=${u.map(s=>s.id)}&multi=true`,height:n,width:350,anchorElementId:m,hidePaper:!0,disableClickAway:!0})}}})}d.MAINAPP.innerHTML=`
  <div>
    <h1>Loading...</h1>
  </div>
`;d.MAINLOAD.innerHTML=`
<div>
    <h1 id="loadingScreenHeader">Waiting for Scene...</h1>
    <div class="imageContainer">
        <img class="resize-fit-center" src="logo.png" alt="Clash!" class="center">
    </div>
</div>`;d.MAINDISABLED.innerHTML=`
<div>
    <h1 id="loadingScreenHeader">Access has been disabled</h1>
    <div class="imageContainer">
        <img class="resize-fit-center" src="logo.png" alt="Clash!" class="center">
    </div>
</div>`;l.onReady(async()=>{if(await l.scene.isReady()===!1){const m=l.scene.onReadyChange(async u=>{u&&(m(),await v())})}else await v()});async function v(){await T.InitializeCache(),T.SetupHandlers(),T.playerRole==="GM"&&(await p(),f.Ready()),T.playerRole==="GM"?(R.Render(),E()):S.Render(),d.MAINAPP.hidden=!1,d.MAINLOAD.hidden=!0}
