import{O as h,C as m,b as W,a as z,d as f,U as B,G,I as V,S as D,F as K,H as q,W as J}from"./utilities-4e7020ab.js";class O{static async CenterViewportOnImage(e){const n=await h.scene.grid.getDpi(),r=await h.viewport.getScale(),s=await h.viewport.getWidth(),o=await h.viewport.getHeight(),a={x:s/2,y:o/2},t={x:a.x/r,y:a.y/r},i=await this.GetImageCenter(e,n),l={x:i.x-t.x,y:i.y-t.y},c={x:l.x*r*-1,y:l.y*r*-1};await h.viewport.animateTo({position:c,scale:r})}static async GetImageCenter(e,n){const r=n/e.dpi,s=e.width*r,o=e.height*r,a=e.offsetx/e.width*s,t=e.offsety/e.height*o;return{x:e.xpos-a+s/2,y:e.ypos-t+o/2}}}class L{static async UpdateLabel(e,n){const r=await h.scene.items.getItems([m.LABEL]),s=n||"« Go! »";let o=!1;if(r.length==0||r[0].id!=m.LABEL){const i=W().fillColor("#ffffff").plainText(s).build();i.visible=!1,i.type="LABEL",i.id=m.LABEL,i.style={backgroundColor:"#bb99ff",backgroundOpacity:.5,pointerDirection:"DOWN",pointerWidth:15,pointerHeight:15,cornerRadius:10};const l=document.getElementById("initiative-list");if(l.rows?.length>1){for(var a=0,t;t=l.rows[a];a++)t.className=="turnOutline"&&(i.position={x:e.xpos,y:e.ypos-100},i.visible=!!e.visible,i.text.plainText=i.visible?s:s+`\r
(Hidden)`,i.attachedTo=e.id,i.locked=!0,o=!0);o||(i.visible=!1)}await h.scene.items.addItems([i])}else await h.scene.items.updateItems(i=>i.id==m.LABEL,i=>{for(let u of i){const C=document.getElementById("initiative-list");if(C.rows?.length>1){for(var l=0,c;c=C.rows[l];l++)c.className=="turnOutline"&&(u.position={x:e.xpos,y:e.ypos-100},u.visible=!!e.visible,u.text.plainText=u.visible?s:s+`\r
(Hidden)`,u.attachedTo=e.id,u.locked=!0,o=!0);o||(u.visible=!1)}}})}static UpdateHPBar(e,n,r){const s=e.id+"_hpbar",o=L.getHealthPercentageString(n,r),a=L.getHealthColorString(n,r),t=z().plainText(o).fontWeight(800).fillOpacity(.75).fillColor(a).strokeWidth(1).strokeColor("black").strokeOpacity(1).build();return t.id=s,t.type="TEXT",t.attachedTo=e.id,t.visible=!!e.visible,t.locked=!0,t.position={x:e.position.x-85,y:e.position.y+25},t.disableAttachmentBehavior=["ROTATION","SCALE"],t.text.style.fontFamily="Segoe UI",t.text.style.fontSize=24,t.text.type="PLAIN",t.text.style.textAlign="CENTER",t}static getHealthPercentageString(e,n){const r=e/n*100;switch(!0){case r==0:return"▱▱▱▱▱ 0%";case r<=20:return"▰▱▱▱▱ 20%";case r<=40:return"▰▰▱▱▱ 40%";case r<=60:return"▰▰▰▱▱ 60%";case r<=80:return"▰▰▰▰▱ 80%";default:return"▰▰▰▰▰ 100%"}}static getHealthColorString(e,n){const r=e/n*100;switch(!0){case r<=25:return"red";case r<=50:return"yellow";default:return"white"}}static async GetCTUFromRow(e){let n={id:"",visible:!1,xpos:0,ypos:0,dpi:0,width:0,height:0,offsetx:0,offsety:0};const r=e.getAttribute("unit-id"),s=await h.scene.items.getItems([r]);for(let o of s){const a=o;n={id:a.id,visible:a.visible,xpos:a.position.x,ypos:a.position.y,dpi:a.grid.dpi,width:a.image.width,height:a.image.height,offsetx:a.grid.offset.x,offsety:a.grid.offset.y}}return n}}async function Y(d,e){var n=e;const r='<hr style="height:5px; margin-top: 4px; margin-bottom: 4px; visibility:hidden;" />';d.querySelector("#clash-main-body-settings").innerHTML=`
        <div id="settingsContainer">
        <h2 style="margin-top: 10px;">Settings</h2>
        <div><span id="exportAllContainer"></span>Export Collection Data </div>
        <i><small>This will save Collection data to a Text/JSON file</small></i>
        </br>
        ${r}
        <div><span id="importSubmitContainer"></span>Import Collection Data </div>
        <div><span id="importAllContainer"></span></div>
        <i><small>This will overwrite keys with the same Name/Author</small></i>
        </br>
        ${r}
        <div><span id="clearAllContainer"></span>Clear All Data </div>
        <i><small>This will delete the database.</small></i>
        </br>
        ${r}
        <div>${b("hideHp")}</span>&emsp;Hide HP Indication from Players </div>
        ${r}
        <div>${b("hideAll")}</span>&emsp;Hide All from Players </div>
        ${r}
        <div>${b("reverseList")}</span>&emsp;Reverse Initiative </div>
        ${r}
        <div>${b("noFocus")}</span>&emsp;Disable Camera Focus </div>
        ${r}
        <div>${b("noLabel")}</span>&emsp;Disable Turn Label </div>
        <div id="turnLabelTextContainer">&emsp;&emsp;&emsp;&emsp;</div>
        ${r}
        <div>${b("logToGM")}</span>&emsp;[Rumble!] Send Log to GM Only </div>
        <footer><span class="returnFloatLeft" id="settingsReturnContainer"></span></footer>
        </div>
       `,p(d,"hideHp",e.gmHideHp,e),p(d,"hideAll",e.gmHideAll,e),p(d,"reverseList",e.gmReverseList,e),p(d,"noFocus",e.gmDisableFocus,e),p(d,"noLabel",e.gmDisableLabel,e),p(d,"logToGM",e.gmRumbleLog,e);const s=d.getElementById("turnLabelTextContainer"),o=d.createElement("input");o.type="text",o.id="textLabelButton",o.title="Change your Turn Label's text",o.placeholder="« Go! »",o.maxLength=40,o.value=e.gmTurnText?e.gmTurnText:"",o.size=30,o.className="textInput",s?.appendChild(o);const a=d.getElementById("importAllContainer"),t=d.createElement("input");t.type="file",t.id="importButton",t.title="Choose a file to import",t.className="tinyType";const i=d.createElement("input");i.type="checkbox",i.id="favBox",i.title="Unfavorite during Upload";const l=d.getElementById("importSubmitContainer"),c=d.createElement("input");c.type="button",c.id="importSubmitButton",c.value="IMPORT DATA",c.title="Import Clash Collection Data",c.className="tinyType",c.onclick=async function(){if(t.files&&t.files.length>0){let T=t.files[0],y=new FileReader;y.readAsText(T),y.onload=async function(){try{const E=JSON.parse(y.result);await N(E),h.notification.show("Import Complete!","SUCCESS")}catch(E){alert(`The import failed - ${E}`)}},y.onerror=function(){console.log(y.error)}}},a?.appendChild(i),a?.appendChild(d.createTextNode("Un-Favorite  ˣ  ")),a?.appendChild(t),l?.appendChild(c);const u=d.getElementById("exportAllContainer"),C=d.createElement("input");C.type="button",C.id="exportButton",C.value="EXPORT DATA",C.title="Export Clash Collection Data",C.className="tinyType",C.onclick=async function(){await v()},u?.appendChild(C);const I=d.getElementById("clearAllContainer"),g=d.createElement("input");g.type="button",g.id="resetButton",g.value="DELETE DATA",g.title="Clear all Clash! Data",g.className="tinyType",g.onclick=async function(){if(confirm("Delete EVERYTHING? (Deletes Database and Refreshes Window)")){n.turnCounter=1,n.roundCounter=1;const T=d.getElementById("roundCount");T.innerText=`Round: ${n.roundCounter}`,await h.scene.items.deleteItems([m.LABEL]),await h.scene.items.updateItems(y=>y.metadata[`${m.EXTENSIONID}/metadata_initiative`]!=null||y.id===m.LABEL,y=>{for(let E of y)delete E.metadata[`${m.EXTENSIONID}/metadata_initiative`]}),await f.delete(),window.location.reload()}},I?.appendChild(g);const w=d.getElementById("settingsReturnContainer"),x=d.createElement("input");x.type="button",x.id="returnButton",x.className="turnColor chalkBorder turnIndicator",x.title="Save and return to Initiative List",x.value="Return",x.onclick=async function(){e.gmTurnText=o.value,await f.Settings.update(m.SETTINGSID,{gmHideHp:e.gmHideHp,gmHideAll:e.gmHideAll,gmDisableLabel:e.gmDisableLabel,gmReverseList:e.gmReverseList,gmTurnText:e.gmTurnText,gmRumbleLog:e.gmRumbleLog,disableFocus:e.gmDisableFocus}),e.gmDisableLabel&&h.scene.items.deleteItems([m.LABEL]),n.ShowSettingsMenu(!1),n.ShowMainMenu(!0)},w?.append(x);function b(T){return`<label class="switch" id="setting${T}Container">
            <span class="slider round"></span>
            </label>`}function p(T,y,E,S){const H=T.getElementById(`setting${y}Container`),R=T.createElement("input");R.type="checkbox",R.value=String(E),R.checked=E,R.onclick=async function(M){const k=M.target;switch(R.value=String(k.checked),y){case"hideHp":S.gmHideHp=k.checked;break;case"hideAll":S.gmHideAll=k.checked;break;case"noFocus":S.gmDisableFocus=k.checked;break;case"noLabel":S.gmDisableLabel=k.checked;break;case"reverseList":S.gmReverseList=k.checked;break;case"logToGM":S.gmRumbleLog=k.checked;break}},H?.insertBefore(R,H.firstChild)}async function v(){const T=await f.Creatures.toArray();var y=d.createElement("a"),E=new Blob([JSON.stringify(T)],{type:"text/plain"});y.href=URL.createObjectURL(E),y.download=`ClashCollectionExport-${Date.now()}`,d.body.appendChild(y),y.click(),d.body.removeChild(y)}async function N(T){const y=await f.Creatures.toArray();let E=[];T.forEach(S=>{let H=new B("","Default");H.SetToModel(S,!i.checked),H.tokenId="";const R=y.find(M=>M.unitName==S.unitName&&M.dataSlug==S.dataSlug);R?H.id=R.id:H.id=G(),E.push(H)}),await f.Creatures.bulkPut(E)}}function j(d,e){var n=e;const r=d.getElementById("saveButtonContainer"),s=d.createElement("input");s.type="image",s.className="Icon clickable",s.id="saveButton",s.onclick=async function(){await n.Save()},s.src="/save.svg",s.title="Save Changes",s.height=20,s.width=20,r.appendChild(s)}function Q(d){const e=d.getElementById("rollAllContainer"),n=d.createElement("input");n.type="image",n.className="Icon RollerButton clickable",n.id="rollAllButton",n.onclick=async function(){h.notification.show("Rolled Initiative for all Monsters."),d.querySelectorAll(".isMonster").forEach(s=>{const a=s.id.substring(2),t=d.querySelector(`#iI${a}`),i=parseFloat(t.getAttribute("unit-dexbonus"));t.value=(i+Math.floor(Math.random()*(20-1)+1)).toString()})},n.src="/dice.svg",n.title="Roll Initiative for all Monsters",n.height=20,n.width=20,e.appendChild(n)}function Z(d,e){var n=e;const r=d.getElementById("prevContainer"),s=d.getElementById("nextContainer"),o=d.createElement("input");o.type="button",o.id="previousButton",o.value="Previous",o.className="turnColor chalkBorder turnIndicator",o.title="Previous Turn",o.onclick=async function(){const t=d.getElementById("initiative-list");if(t.rows?.length>1){n.turnCounter--;for(var i=0,l;l=t.rows[i];i++)l.className=="turnOutline"&&l.parentElement?.firstElementChild===l&&(n.roundCounter--,n.roundCounter<1&&(n.roundCounter=1),n.turnCounter=l.parentElement.childElementCount);await n.FocusOnCurrentTurnUnit(t),await n.Save()}};const a=d.createElement("input");a.type="button",a.id="nextButton",a.value="Next",a.className="turnColor chalkBorder turnIndicator",a.title="Next Turn",a.onclick=async function(){const t=d.getElementById("initiative-list");if(t.rows?.length>1){n.turnCounter++;for(var i=0,l;l=t.rows[i];i++)l.className=="turnOutline"&&l.parentElement?.lastElementChild===l&&(n.roundCounter++,n.turnCounter=1);await n.FocusOnCurrentTurnUnit(t),await n.Save()}},r?.appendChild(o),s?.appendChild(a)}function ee(d,e){var n=e;const r=d.getElementById("resetContainer"),s=d.createElement("input");s.type="button",s.id="resetTurnButton",s.value="Reset Round",s.title="Reset Round",s.className="tinyType",s.onclick=async function(){n.turnCounter=1,n.roundCounter=1;const t=d.getElementById("roundCount");t.innerText=`Round: ${n.roundCounter}`,await f.Tracker.clear(),await f.Tracker.add({id:m.TURNTRACKER,currentRound:1,currentTurn:1}),await h.scene.items.deleteItems([m.LABEL]),await e.ShowTurnSelection(),await e.Save()},r.appendChild(s);const o=d.createElement("input");o.type="button",o.id="clearButton",o.value="CLEAR LIST",o.title="Clear List",o.className="tinyType",o.onclick=async function(){if(confirm("Clear the Initiative List (This will leave unit info)?")){n.turnCounter=1,n.roundCounter=1;const t=d.getElementById("roundCount");t.innerText=`Round: ${n.roundCounter}`,await f.Tracker.clear(),await f.Tracker.add({id:m.TURNTRACKER,currentRound:1,currentTurn:1}),await f.ActiveEncounter.where("isActive").equals(1).modify({isActive:0}),await h.scene.items.deleteItems([m.LABEL]),await h.scene.items.updateItems(i=>i.metadata[`${m.EXTENSIONID}/metadata_initiative`]!=null||i.id===m.LABEL,i=>{for(let l of i)delete l.metadata[`${m.EXTENSIONID}/metadata_initiative`]}),await e.Save()}},r.appendChild(o);const a=d.createElement("input");a.type="button",a.id="settingsButton",a.value="Settings",a.title="View Settings",a.className="tinyType",a.onclick=async function(){n.ShowMainMenu(!1),n.ShowSettingsMenu(!0),Y(d,e)},r.appendChild(a)}class te{unitsInScene=[];roundCounter=1;turnCounter=1;party=[];gmHideHp=!1;gmHideAll=!1;gmDisableLabel=!1;gmDisableFocus=!1;gmReverseList=!1;gmRumbleLog=!1;gmTurnText="";rendered=!1;sceneId="";itemOnChangeHandler;async RenderInitiativeList(e){this.setupContextMenu(this),this.ShowSettingsMenu(!1),this.ShowMainMenu(!0);const n=e.querySelector("#clash-main-body-app");if(n.innerHTML=`
        <div id="contextMenu" class="context-menu" style="display: none">
            <ul id="playerListing"></ul>
        </div>
        <table id="initiative-list">
        <thead>
            <tr>
            <th style="width: 8%"><img class="Icon" title="Initiative" src="/queue.svg"></th>
            <th style="width: 8%"><div id="rollAllContainer"></div></th>
            <th style="width: 42%">Name</th>
            <th style="width: 24%"><img class="Icon" title="Hit Points" src="/heart.svg"></th>
            <th style="width: 8%"><img class="Icon" title="Armor Class" src="/shield.svg"></th>
            <th style="width: 10%"><span id="saveButtonContainer"></span></th>
            </tr>
        </thead>
        <tbody id="unit-list"></tbody>
        </table>
        <footer>
        <div id="roundCounter" class="bottom"><span id="prevContainer"></span><span id="roundCount" class="centerish">Round: ${this.roundCounter}</span><span id="nextContainer"></span></div>
        <div id="bombContainer" class="bombBottom"><span id="resetContainer" class=""></span></div>
        </footer>
        `,f.inMemory){const i=e.createElement("div");i.innerText="Local Storage Disabled - Features Limited",i.className="noDatabase",n.prepend(i)}j(e,this),Z(e,this),ee(e,this),Q(e);const r=await f.Settings.get(m.SETTINGSID);r?(this.gmHideHp=r.gmHideHp,this.gmHideAll=r.gmHideAll,this.gmDisableLabel=r.gmDisableLabel,this.gmDisableFocus=r.disableFocus,this.gmReverseList=r.gmReverseList,this.gmRumbleLog=r.gmRumbleLog,this.gmTurnText=r.gmTurnText):await f.Settings.add({id:m.SETTINGSID,gmHideHp:!1,gmHideAll:!1,gmDisableLabel:!1,gmTurnText:"",gmReverseList:!1,gmRumbleLog:!1,disableFocus:!1});const s=await f.Tracker.get(m.TURNTRACKER);s?(this.turnCounter=s.currentTurn,this.roundCounter=s.currentRound):await f.Tracker.add({id:m.TURNTRACKER,currentRound:1,currentTurn:1});const o=e.getElementById("playerListing");this.party=await h.party.getPlayers(),o.appendChild(P()),this.party.forEach(i=>{const l=e.createElement("li");l.id=i.id,l.textContent=i.name,l.style.color=i.color,o.appendChild(l)}),h.party.onChange(i=>{o.innerHTML="",o.appendChild(P()),this.party=i,i.forEach(async l=>{const c=e.createElement("li");c.id=l.id,c.textContent=l.name,c.style.color=l.color,o.appendChild(c);const u=l.metadata;if(u[`${m.EXTENSIONID}/metadata_playerItem`]!=null){const I=u[`${m.EXTENSIONID}/metadata_playerItem`].PlayerUpdate;V(I.stamp)||(I.initiative?await f.ActiveEncounter.update(I.id,{initiative:I.initiative}):I.cHp?await f.ActiveEncounter.update(I.id,{currentHP:I.cHp}):I.mHp?await f.ActiveEncounter.update(I.id,{maxHP:I.mHp}):I.aC&&await f.ActiveEncounter.update(I.id,{armorClass:I.aC}),await this.UpdateTrackerForPlayers())}})});const a=await h.theme.getTheme();D(a,e),h.theme.onChange(i=>{D(i,e)}),await J(async()=>await f.ActiveEncounter.toArray()).subscribe({next:async i=>{this.RefreshList(i)},error:i=>console.log("Error refreshing list: "+i)}),await this.RefreshList(),this.AttachFocusListeners(),this.rendered=!0}SetupItemOnChangeHandler(){this.itemOnChangeHandler=h.scene.items.onChange(async e=>{const n=[];e.forEach(async t=>{if(t.layer!=="CHARACTER")return;const i=t,l=i.text?.plainText||i.name,c=this.unitsInScene.find(u=>u.id===i.id);if(c&&c.unitName!==l&&await f.ActiveEncounter.update(c.id,{unitName:l}),t.metadata[`${m.EXTENSIONID}/metadata_initiative`]!==void 0&&c?.isActive==0&&await f.ActiveEncounter.update(c.id,{isActive:1}),t.metadata[`${m.EXTENSIONID}/metadata_initiative`]!==void 0&&!c){const u=this.unitsInScene.find(I=>I.unitName===l),C=await f.ActiveEncounter.where("id").equals(i.id).first();if(m.ALPHANUMERICTEXTMATCH.test(l)){const I=l.slice(0,-2),g=await f.ActiveEncounter.where("unitName").startsWith(I).first();if(g){g.id=t.id;let w=new B(t.id,l,t.createdUserId);w.SetToModel(g),w.unitName=l,w.tokenId=t.id,w.isActive=1,await w.SaveToDB(this.sceneId)}}else if(u){u.id=t.id;let I=new B(t.id,l,t.createdUserId);I.SetToModel(u),I.unitName=l,I.tokenId=t.id,I.isActive=1,await I.SaveToDB(this.sceneId)}else C?.sceneId===this.sceneId&&n.push(t.id)}}),n.length>0&&await h.scene.items.updateItems(t=>n.includes(t.id),t=>{for(let i of t)delete i.metadata[`${m.EXTENSIONID}/metadata_initiative`],delete i.metadata[`${m.EXTENSIONID}/metadata_hpbar`]});const r=e.filter(t=>t.layer==="CHARACTER"),s=K(this.unitsInScene.map(t=>t.id),r.map(t=>t.id)),o=this.unitsInScene.filter(t=>!e.some(i=>i.id===t.id)),a=r.filter(t=>!this.unitsInScene.some(i=>i.id===t.id));a.length>0&&a.forEach(async t=>{const i=t,l=i.text?.plainText||i.name;let c=new B(i.id,l,i.createdUserId);if(m.ALPHANUMERICTEXTMATCH.test(i.name)){const u=l.slice(0,-2),C=await f.Creatures.get({unitName:u});C&&c.SetToModel(C)}else{const u=await f.Creatures.get({unitName:l});u&&c.SetToModel(u)}c.SaveToDB(this.sceneId)}),o.length>0&&await f.ActiveEncounter.bulkDelete(s),this.RefreshList()})}async RefreshActiveUnits(e){const n=e||await f.ActiveEncounter.toCollection().toArray();this.unitsInScene=n.filter(r=>r.sceneId===this.sceneId)}async RefreshList(e){const n=document.querySelector("#unit-list");await this.RefreshActiveUnits(e);const r=this.unitsInScene.filter(a=>a.isActive===1),s=this,o=this.gmReverseList?r.sort((a,t)=>a.initiative-t.initiative||a.unitName.localeCompare(t.unitName)):r.sort((a,t)=>t.initiative-a.initiative||a.unitName.localeCompare(t.unitName));for(;n?.rows.length>0;)n.deleteRow(0);for(const a of o){let t;if(a.ownerId){const y=this.party.find(E=>E.id===a.ownerId)?.color;y&&(t=q(y,.4))}let i=n.insertRow(-1),l=i.insertCell(0),c=i.insertCell(1),u=i.insertCell(2),C=i.insertCell(3),I=i.insertCell(4),g=i.insertCell(5);i.setAttribute("unit-id",a.id);const w=document.createElement("input");w.className="InitiativeInput",w.inputMode="numeric",w.setAttribute("unit-dexbonus",Math.floor((a.dexScore-10)/2).toString()),w.value=a.initiative.toString(),w.id=`iI${a.id}`,w.size=2,w.min="0",w.max="99",w.maxLength=2;const x=document.createElement("input");x.type="image",x.title="Roll this Unit's Iniative",x.id=`rB${a.id}`,x.className="clickable",x.onclick=async function(){const y=parseFloat(w.getAttribute("unit-dexbonus"));w.value=(y+Math.floor(Math.random()*(20-1)+1)).toString()},x.src="/dice.svg",x.height=20,x.width=20;const b=document.createElement("input");b.type="button",b.value=a.isMonster?`ʳ ${a.unitName} ʴ`:a.unitName,b.title="Change between Player and Monster groups",b.id=`nT${a.id}`,b.style.width="100%",b.style.textOverflow="ellipsis",b.style.overflow="hidden",t&&(b.style.background=`linear-gradient(200deg, transparent, ${t})`),b.className=a.isMonster?"isMonster nameToggleInput":"nameToggleInput",b.onclick=async function(){b.className=="isMonster nameToggleInput"?(b.value=a.unitName,b.className="nameToggleInput"):(b.value=`ʳ ${a.unitName} ʴ`,b.className="isMonster nameToggleInput")},b.oncontextmenu=async function(y){y.preventDefault();const E=document.getElementById("contextMenu");E.addEventListener("click",async H=>{H.stopPropagation();const R=H.target,M=E.getAttribute("currentUnit");await f.ActiveEncounter.update(M,{ownerId:R.id})}),E.setAttribute("currentUnit",a.id);const S=()=>{E.style.display="none",document.removeEventListener("click",S)};document.addEventListener("click",S),E.style.display=="block"?ne():(E.style.display="block",E.style.left=y.pageX+"px",E.style.top=y.pageY+"px")};const p=document.createElement("input");p.className="HealthInput",p.inputMode="numeric",p.id=`cHP${a.id}`,p.title=a.currentHP.toString(),p.value=a.currentHP.toString(),p.size=4,p.maxLength=4,p.onblur=function(y){const S=y.currentTarget.value;if(S.substring(0,1)=="+"){const H=S.substring(S.indexOf("+")+1);p.value=(+H+ +p.title).toString(),p.title=p.value,y.preventDefault()}else if(S.substring(0,1)=="-"){const H=S.substring(S.indexOf("-")+1);p.value=(+p.title-+H).toString(),p.title=p.value,y.preventDefault()}s.Save()},p.onkeydown=function(y){if(y.key!=="Enter")return;const S=y.currentTarget.value;if(S.substring(0,1)=="+"){const H=S.substring(S.indexOf("+")+1);p.value=(+H+ +p.title).toString(),p.title=p.value,y.preventDefault()}else if(S.substring(0,1)=="-"){const H=S.substring(S.indexOf("-")+1);p.value=(+p.title-+H).toString(),p.title=p.value,y.preventDefault()}s.Save()};const v=document.createElement("input");v.className="HealthInput",v.inputMode="numeric",v.id=`mHP${a.id}`,v.value=a.maxHP.toString(),v.size=4,v.maxLength=4;const N=document.createElement("input");N.className="ArmorInput",N.inputMode="numeric",N.id=`aC${a.id}`,N.value=a.armorClass.toString(),N.size=2,N.maxLength=2;const T=document.createElement("input");T.type="image",T.title="View/Edit this Unit's Stats",T.id=`tB${a.id}`,T.className="clickable",T.onclick=async function(y){const E=y.currentTarget;await s.OpenSubMenu(E.id.substring(2))},T.src="/triangle.svg",T.height=20,T.width=20,T.style.marginLeft="5px",l.appendChild(w),l.style.width="8%",c.appendChild(x),c.style.width="8%",u.appendChild(b),u.style.width="42%",C.appendChild(p),C.appendChild(document.createTextNode("/")),C.appendChild(v),C.style.width="24%",I.appendChild(N),I.style.width="8%",f.inMemory||(g.appendChild(T),g.style.width="10%")}this.ShowTurnSelection()}AttachFocusListeners(){const e=document.getElementById("initiative-list");e&&e.addEventListener("dblclick",n);async function n(r){r.preventDefault();const s=r.target.closest("tr");if(!s)return;const o=await L.GetCTUFromRow(s);await O.CenterViewportOnImage(o)}}ShowTurnSelection(){const e=document.getElementById("initiative-list");if(e&&e.rows?.length>1){for(var n=0,r;r=e.rows[n];n++)r.classList.remove("turnOutline");if(this.turnCounter>=e.rows.length&&(this.turnCounter=e.rows.length-1),e.rows[this.turnCounter]){const s=e.rows[this.turnCounter];s.className="turnOutline";const o=document.getElementById("roundCount");o.innerText=`Round: ${this.roundCounter}`}}}async Save(){document.querySelectorAll(".InitiativeInput").forEach(async n=>{const r=n,s=r.id.substring(2),o=r.value,a=document.querySelector(`#cHP${s}`),t=a.value?a.value:"0",i=document.querySelector(`#mHP${s}`),l=i.value?i.value:"1",c=document.querySelector(`#aC${s}`),u=c.value?c.value:"10",I=document.querySelector(`#nT${s}`).className=="isMonster nameToggleInput";if(!s||!o)return;let g=this.unitsInScene?.find(w=>w.id==s);g&&await f.ActiveEncounter.update(g.id,{initiative:parseFloat(o),currentHP:parseFloat(t),maxHP:parseFloat(l),armorClass:parseFloat(u),isMonster:I})}),await f.Tracker.update(m.TURNTRACKER,{id:m.TURNTRACKER,currentTurn:this.turnCounter,currentRound:this.roundCounter}),await this.RefreshList(),await this.UpdateTrackerForPlayers()}async UpdateTrackerForPlayers(){const e=[],n=new Date().toISOString(),r=[];(await h.scene.items.getItems(t=>t.id.endsWith("_hpbar"))).forEach(t=>{const i=t,l=this.unitsInScene.find(c=>c.id===i.id.replace("_hpbar",""));l&&(i.text.plainText=L.getHealthPercentageString(l.currentHP,l.maxHP),i.text.style.fillColor=L.getHealthColorString(l.currentHP,l.maxHP),r.push(i))}),await h.scene.items.addItems(r);for(const t of this.unitsInScene)e.push({id:t.id,name:t.unitName,initiative:t.initiative,cHp:t.currentHP,mHp:t.maxHP,aC:t.armorClass,owner:t.ownerId});const o={turn:this.turnCounter,round:this.roundCounter,units:e,gmHideHp:this.gmHideHp,gmHideAll:this.gmHideAll,gmReverseList:this.gmReverseList,lastUpdate:n},a={};a[`${m.EXTENSIONID}/metadata_trackeritem`]={Tracker:o},await h.scene.setMetadata(a)}async FocusOnCurrentTurnUnit(e){const n=e.rows[this.turnCounter],r=await L.GetCTUFromRow(n);this.gmDisableFocus||await O.CenterViewportOnImage(r),this.gmDisableLabel||await L.UpdateLabel(r,this.gmTurnText)}ShowSettingsMenu(e){const n=document.querySelector("#clash-main-body-settings");n.hidden=!e}ShowMainMenu(e){const n=document.querySelector("#clash-main-body-app");n.hidden=!e}async OpenSubMenu(e){const r=window.innerWidth<m.MOBILEWIDTH,s=window.outerHeight-150,o=s>800?700:s-100;r?await h.popover.open({id:m.EXTENSIONSUBMENUID,url:`/submenu/subindex.html?unitid=${e}&sceneid=${this.sceneId}`,height:o,width:325,hidePaper:!0}):await h.modal.open({id:m.EXTENSIONSUBMENUID,url:`/submenu/subindex.html?unitid=${e}&sceneid=${this.sceneId}`,height:o,width:350})}setupContextMenu(e){f.inMemory||h.contextMenu.create({id:`${m.EXTENSIONID}/context-menu-sheet`,icons:[{icon:"/sheet.svg",label:"[Clash!] View Info",filter:{max:1,every:[{key:"layer",value:"CHARACTER"}]}},{icon:"/multi-sheet.svg",label:"[Clash!] View Info",filter:{min:2,every:[{key:"layer",value:"CHARACTER"}]}}],async onClick(n,r){if(n.items.length==1){const s=n.items[0],o=s.text?.plainText||s.name;if(!await f.ActiveEncounter.get(s.id)){let c=new B(s.id,o);if(m.ALPHANUMERICTEXTMATCH.test(o)){const u=o.slice(0,-2),C=await f.Creatures.get({unitName:u});C&&c.SetToModel(C)}else{const u=await f.Creatures.get({unitName:o});u&&c.SetToModel(u)}await c.SaveToDB(e.sceneId)}const t=100,i=window.outerHeight-150,l=i>800?700:i-t;await h.popover.open({id:m.EXTENSIONSUBMENUID,url:`/submenu/subindex.html?unitid=${s.id}&sceneid=${e.sceneId}`,height:l,width:325,anchorElementId:r,hidePaper:!0})}else{n.items.forEach(async l=>{const c=l,u=c.text?.plainText||c.name;if(!await f.ActiveEncounter.get(l.id)){let I=new B(l.id,u);if(m.ALPHANUMERICTEXTMATCH.test(u)){const g=u.slice(0,-2),w=await f.Creatures.get({unitName:g});w&&I.SetToModel(w)}else{const g=await f.Creatures.get({unitName:u});g&&I.SetToModel(g)}await I.SaveToDB(e.sceneId)}});const s=n.items.map(l=>l.id).toString(),o=n.items.map(l=>l.metadata[`${m.EXTENSIONID}/metadata_initiative`]!==void 0).toString(),a=100,t=window.outerHeight-150,i=t>800?700:t-a;await h.popover.open({id:m.EXTENSIONSUBMENUID,url:`/submenu/subindex.html?unitid=${s}&unitactive=${o}&multi=true&sceneid=${e.sceneId}`,height:i,width:325,anchorElementId:r,hidePaper:!0})}}}),h.contextMenu.create({id:`${m.EXTENSIONID}/context-hp-menu`,icons:[{icon:"/health.svg",label:"[Clash!] Show HP Bar",filter:{every:[{key:"layer",value:"CHARACTER"},{key:["metadata",`${m.EXTENSIONID}/metadata_hpbar`],value:void 0},{key:["metadata",`${m.EXTENSIONID}/metadata_initiative`],value:void 0,operator:"!="}]}},{icon:"/health-black.svg",label:"[Clash!] Hide HP Bar",filter:{every:[{key:"layer",value:"CHARACTER"},{key:["metadata",`${m.EXTENSIONID}/metadata_hpbar`],value:void 0,operator:"!="}]}}],async onClick(n){if(n.items.every(s=>s.metadata[`${m.EXTENSIONID}/metadata_hpbar`]===void 0)){const o=[];await h.scene.items.updateItems(n.items,a=>{for(let t of a){const i=t,l=e.unitsInScene.find(c=>c.id===t.id);l&&(t.metadata[`${m.EXTENSIONID}/metadata_hpbar`]={showHpBars:!0},o.push(L.UpdateHPBar(i,l.currentHP,l.maxHP)))}}),await h.scene.items.addItems(o)}else{const s=n.items.map(o=>o.id+"_hpbar");await h.scene.items.deleteItems(s),await h.scene.items.updateItems(n.items,o=>{for(let a of o)delete a.metadata[`${m.EXTENSIONID}/metadata_hpbar`]})}}}),h.contextMenu.create({id:`${m.EXTENSIONID}/context-menu`,icons:[{icon:"/addunit.svg",label:"[Clash!] Add to Initiative",filter:{every:[{key:"layer",value:"CHARACTER"},{key:["metadata",`${m.EXTENSIONID}/metadata_initiative`],value:void 0}]}},{icon:"/removeunit.svg",label:"[Clash!] Remove from Initiative",filter:{every:[{key:"layer",value:"CHARACTER"}]}}],async onClick(n){const r=e.sceneId,s=n.items.every(a=>a.metadata[`${m.EXTENSIONID}/metadata_initiative`]===void 0),o=n.items;if(s)o.forEach(async a=>{const t=a.text?.plainText||a.name;if(await f.ActiveEncounter.get(a.id))f.ActiveEncounter.update(a.id,{isActive:1});else{let l=new B(a.id,t,a.createdUserId);if(m.ALPHANUMERICTEXTMATCH.test(a.name)){const c=t.slice(0,-2),u=await f.Creatures.get({unitName:c});u&&l.SetToModel(u)}else{const c=await f.Creatures.get({unitName:t});c&&l.SetToModel(c)}l.isActive=1,l.SaveToDB(e.sceneId)}}),await h.scene.items.updateItems(o,a=>{for(let t of a)t.metadata[`${m.EXTENSIONID}/metadata_initiative`]={initiative:r}});else{const a=n.items.map(t=>t.id+"_hpbar");await h.scene.items.deleteItems(a),await h.scene.items.updateItems(n.items,t=>{for(let i of t)delete i.metadata[`${m.EXTENSIONID}/metadata_initiative`],delete i.metadata[`${m.EXTENSIONID}/metadata_hpbar`]}),o.forEach(async t=>{f.ActiveEncounter.update(t.id,{isActive:0})})}}})}}function P(){const d=document.createElement("li");return d.id="",d.textContent="No Owner",d}function ne(){document.getElementById("contextMenu").style.display="none"}class ie{roundCounter=1;turnCounter=1;enableAutoFocus=!1;lastUpdate="";playerId="";playerColor="";party=[];rendered=!1;async Render(e){e.querySelector("#clash-main-body-app").innerHTML=`
            <table id="initiative-list">
            <thead>
                <tr>
                <th style="width: 10%"><img class="Icon" title="Initiative" src="/queue.svg"></th>
                <th style="width: 58%">Name</th>
                <th style="width: 24%"><img class="Icon" title="Hit Points" src="/heart.svg"></th>
                <th style="width: 8%"><img class="Icon" title="Armor Class" src="/shield.svg"></th>
                </tr>
            </thead>
            <tbody id="unit-list"></tbody>
            </table>
            <footer>
            <div id="roundCounter" class="playerBottom">
            <label class="switch" id="settingnoFocusContainer">
            <span class="slider round"></span>
            </label> AutoFocus
            <span id="roundCount" class="playerCenterish">Round: ${this.roundCounter}</span>
            </div>
            </footer>
            `;var n=this;const r=e.getElementById("settingnoFocusContainer"),s=e.createElement("input");s.type="checkbox",s.value=String(this.enableAutoFocus),s.checked=this.enableAutoFocus,s.onclick=async function(t){const i=t.target;s.value=String(i.checked),n.enableAutoFocus=i.checked},r?.insertBefore(s,r.firstChild),this.playerId=await h.player.getId(),this.playerColor=await h.player.getColor(),this.party=await h.party.getPlayers();const o=await h.theme.getTheme();D(o,e),this.SetupListeners();const a=await h.scene.getMetadata();await this.RefreshList(a),this.rendered=!0}async RefreshList(e){const n=this,s=e[`${m.EXTENSIONID}/metadata_trackeritem`]?.Tracker;if(!s||!s.units||s.lastUpdate==this.lastUpdate)return;this.lastUpdate=s.lastUpdate;const o=document.querySelector("#unit-list");if(s.gmHideAll){o.innerHTML="";return}const a=s.gmReverseList?s.units.sort((t,i)=>t.initiative-i.initiative||t.name.localeCompare(i.name)):s.units.sort((t,i)=>i.initiative-t.initiative||t.name.localeCompare(i.name));for(this.roundCounter=s.round,this.turnCounter=s.turn;o.rows.length>0;)o.deleteRow(0);for(const t of a){let i=o.insertRow(-1);if(t.owner===this.playerId){const l=q(this.playerColor,.4);i.setAttribute("unit-id",t.id);let c=i.insertCell(0);c.style.placeContent="center";const u=document.createElement("input");u.className="InitiativeInput wide",u.inputMode="numeric",u.value=t.initiative.toString(),u.id=`iI${t.id}`,u.size=2,u.min="0",u.max="99",u.maxLength=2,u.onblur=function(p){const v=p.currentTarget;v.value&&n.SendUpdate({id:v.id.substring(2),initiative:+v.value})},u.onkeydown=function(p){if(p.key!=="Enter")return;const v=p.currentTarget;v.value&&n.SendUpdate({id:v.id.substring(2),initiative:+v.value})};let C=i.insertCell(1);C.style.placeContent="center",C.style.textOverflow="ellipsis",C.style.overflow="hidden",C.style.whiteSpace="nowrap",C.className="nameToggleInput",C.style.background=`linear-gradient(200deg, transparent, ${l})`;let I=i.insertCell(2);const g=document.createElement("input");g.className="HealthInput",g.inputMode="numeric",g.id=`cHP${t.id}`,g.title=t.cHp.toString(),g.value=t.cHp.toString(),g.size=4,g.maxLength=4,g.onblur=function(p){const v=p.currentTarget,N=v.value;if(N.substring(0,1)=="+"){const T=N.substring(N.indexOf("+")+1);g.value=(+T+ +g.title).toString(),g.title=g.value,p.preventDefault()}else if(N.substring(0,1)=="-"){const T=N.substring(N.indexOf("-")+1);g.value=(+g.title-+T).toString(),g.title=g.value,p.preventDefault()}v.value&&n.SendUpdate({id:v.id.substring(3),cHp:+v.value})},g.onkeydown=function(p){if(p.key!=="Enter")return;const v=p.currentTarget,N=v.value;if(N.substring(0,1)=="+"){const T=N.substring(N.indexOf("+")+1);g.value=(+T+ +g.title).toString(),g.title=g.value,p.preventDefault()}else if(N.substring(0,1)=="-"){const T=N.substring(N.indexOf("-")+1);g.value=(+g.title-+T).toString(),g.title=g.value,p.preventDefault()}v.value&&n.SendUpdate({id:v.id.substring(3),cHp:+v.value})};const w=document.createElement("input");w.className="HealthInput",w.inputMode="numeric",w.id=`mHP${t.id}`,w.value=t.mHp.toString(),w.size=4,w.maxLength=4,w.onblur=function(p){const v=p.currentTarget;v.value&&n.SendUpdate({id:v.id.substring(3),mHp:+v.value})},w.onkeydown=function(p){if(p.key!=="Enter")return;const v=p.currentTarget;v.value&&n.SendUpdate({id:v.id.substring(3),mHp:+v.value})};let x=i.insertCell(3);const b=document.createElement("input");b.className="ArmorInput",b.inputMode="numeric",b.id=`aC${t.id}`,b.value=t.aC.toString(),b.size=2,b.maxLength=2,b.onblur=function(p){const v=p.currentTarget;v.value&&n.SendUpdate({id:v.id.substring(2),aC:+v.value})},b.onkeydown=function(p){if(p.key!=="Enter")return;const v=p.currentTarget;v.value&&n.SendUpdate({id:v.id.substring(2),aC:+v.value})},s.gmHideHp||(t.cHp<=t.mHp/4?C.className=C.className+" unitHarmed":t.cHp<=t.mHp/2?C.className=C.className+" unitHurt":C.className=C.className+" unitHappy"),c.appendChild(u),c.style.width="10%",C.appendChild(document.createTextNode(t.name)),C.style.width="58%",I.appendChild(g),I.appendChild(document.createTextNode("/")),I.appendChild(w),x.appendChild(b),x.style.width="8%"}else{let l=i.insertCell(0);l.style.placeContent="center";let c=i.insertCell(1);c.style.placeContent="center",c.style.textOverflow="ellipsis",c.style.overflow="hidden",c.style.whiteSpace="nowrap",i.setAttribute("unit-id",t.id);const u=document.createElement("input");u.className="HealthInput",u.inputMode="numeric",u.id="cHP"+t.id,u.value=t.cHp.toString(),u.size=4,u.maxLength=4,s.gmHideHp||(t.cHp<=t.mHp/4?c.className="unitHarmed":t.cHp<=t.mHp/2?c.className="unitHurt":c.className="unitHappy"),l.appendChild(document.createTextNode(t.initiative.toString())),l.style.width="10%",c.appendChild(document.createTextNode(t.name)),c.style.width="58%"}}this.AttachFocusListeners(),await this.ShowTurnSelection()}AttachFocusListeners(){const e=document.getElementById("initiative-list");e&&e.addEventListener("dblclick",n);async function n(r){r.preventDefault();const s=r.target.closest("tr"),o=await L.GetCTUFromRow(s);await O.CenterViewportOnImage(o)}}async ShowTurnSelection(){const e=document.getElementById("initiative-list");if(e.rows?.length>1){for(var n=0,r;r=e.rows[n];n++)r.classList.remove("turnOutline");if(this.turnCounter>=e.rows.length&&(this.turnCounter=e.rows.length-1),e.rows[this.turnCounter]){const s=e.rows[this.turnCounter];s.className="turnOutline";const o=document.getElementById("roundCount");o.innerText=`Round: ${this.roundCounter}`;let a=await L.GetCTUFromRow(s);a.visible&&this.enableAutoFocus&&await O.CenterViewportOnImage(a)}}}async SetupListeners(){h.scene.onMetadataChange(e=>this.RefreshList(e)),h.theme.onChange(e=>{D(e,document)}),h.player.onChange(e=>{this.playerColor=e.color}),h.party.onChange(e=>{this.party=e})}async SendUpdate(e){e.stamp=new Date().toISOString();const n={};n[`${m.EXTENSIONID}/metadata_playerItem`]={PlayerUpdate:e},await h.player.setMetadata(n)}}const A=new te,F=new ie;let X=!1;const U=document.querySelector("#clash-main-body-app"),$=document.querySelector("#clash-main-body-loading"),ae=f;ae.Ready();U.innerHTML=`
  <div>
    <h1>Loading...</h1>
  </div>
`;$.innerHTML=`
<div>
<h1>Waiting for Scene...</h1>
<div class="imageContainer">
<img class="resize_fit_center" src="logo.png" alt="Clash!" class="center">
</div>
</div>`;h.onReady(async()=>{X=await h.scene.isReady(),await _(X),h.scene.onReadyChange(async d=>{await _(d)})});async function _(d){const e=await h.player.getRole();d?(e==="GM"?(await se(),A.rendered||await A.RenderInitiativeList(document),A.SetupItemOnChangeHandler(),await A.RefreshList()):F.rendered||await F.Render(document),U.hidden=!1,$.hidden=!0):(typeof A.itemOnChangeHandler=="function"&&A.itemOnChangeHandler(),U.hidden=!0,$.hidden=!1)}async function se(){const d=await h.scene.getMetadata(),e=d[`${m.EXTENSIONID}/metadata_sceneid`];if(A.sceneId=e?.SceneId,!A.sceneId){const s=G(),o={};o[`${m.EXTENSIONID}/metadata_sceneid`]={SceneId:s},await h.scene.setMetadata(o),A.sceneId=s}const r=d[`${m.EXTENSIONID}/metadata_trackeritem`]?.Tracker;r?(A.roundCounter=r.round,A.turnCounter=r.turn):(A.roundCounter=1,A.turnCounter=1)}
