import{C as G,O as F,S as N,U as E,b as po,a as jr}from"./clashConstants-e5912b2a.js";var Lr=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function yo(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}function mo(n){return n.type==="CURVE"}function go(n){return n.type==="IMAGE"}const Fe=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global,We=Object.keys,nt=Array.isArray;function lt(n,e){return typeof e!="object"||We(e).forEach(function(t){n[t]=e[t]}),n}typeof Promise>"u"||Fe.Promise||(Fe.Promise=Promise);const Hn=Object.getPrototypeOf,vo={}.hasOwnProperty;function At(n,e){return vo.call(n,e)}function On(n,e){typeof e=="function"&&(e=e(Hn(n))),(typeof Reflect>"u"?We:Reflect.ownKeys)(e).forEach(t=>{Yt(n,t,e[t])})}const is=Object.defineProperty;function Yt(n,e,t,r){is(n,e,lt(t&&At(t,"get")&&typeof t.get=="function"?{get:t.get,set:t.set,configurable:!0}:{value:t,configurable:!0,writable:!0},r))}function An(n){return{from:function(e){return n.prototype=Object.create(e.prototype),Yt(n.prototype,"constructor",n),{extend:On.bind(null,n.prototype)}}}}const bo=Object.getOwnPropertyDescriptor;function Ai(n,e){let t;return bo(n,e)||(t=Hn(n))&&Ai(t,e)}const wo=[].slice;function br(n,e,t){return wo.call(n,e,t)}function ss(n,e){return e(n)}function Nn(n){if(!n)throw new Error("Assertion Failed")}function os(n){Fe.setImmediate?setImmediate(n):setTimeout(n,0)}function as(n,e){return n.reduce((t,r,i)=>{var s=e(r,i);return s&&(t[s[0]]=s[1]),t},{})}function Xt(n,e){if(At(n,e))return n[e];if(!e)return n;if(typeof e!="string"){for(var t=[],r=0,i=e.length;r<i;++r){var s=Xt(n,e[r]);t.push(s)}return t}var o=e.indexOf(".");if(o!==-1){var c=n[e.substr(0,o)];return c===void 0?void 0:Xt(c,e.substr(o+1))}}function Nt(n,e,t){if(n&&e!==void 0&&(!("isFrozen"in Object)||!Object.isFrozen(n)))if(typeof e!="string"&&"length"in e){Nn(typeof t!="string"&&"length"in t);for(var r=0,i=e.length;r<i;++r)Nt(n,e[r],t[r])}else{var s=e.indexOf(".");if(s!==-1){var o=e.substr(0,s),c=e.substr(s+1);if(c==="")t===void 0?nt(n)&&!isNaN(parseInt(o))?n.splice(o,1):delete n[o]:n[o]=t;else{var a=n[o];a&&At(n,o)||(a=n[o]={}),Nt(a,c,t)}}else t===void 0?nt(n)&&!isNaN(parseInt(e))?n.splice(e,1):delete n[e]:n[e]=t}}function us(n){var e={};for(var t in n)At(n,t)&&(e[t]=n[t]);return e}const Eo=[].concat;function cs(n){return Eo.apply([],n)}const ls="Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(cs([8,16,32,64].map(n=>["Int","Uint","Float"].map(e=>e+n+"Array")))).filter(n=>Fe[n]),Ao=ls.map(n=>Fe[n]);as(ls,n=>[n,!0]);let en=null;function Jn(n){en=typeof WeakMap<"u"&&new WeakMap;const e=zr(n);return en=null,e}function zr(n){if(!n||typeof n!="object")return n;let e=en&&en.get(n);if(e)return e;if(nt(n)){e=[],en&&en.set(n,e);for(var t=0,r=n.length;t<r;++t)e.push(zr(n[t]))}else if(Ao.indexOf(n.constructor)>=0)e=n;else{const s=Hn(n);for(var i in e=s===Object.prototype?{}:Object.create(s),en&&en.set(n,e),n)At(n,i)&&(e[i]=zr(n[i]))}return e}const{toString:So}={};function Jr(n){return So.call(n).slice(8,-1)}const Qr=typeof Symbol<"u"?Symbol.iterator:"@@iterator",Co=typeof Qr=="symbol"?function(n){var e;return n!=null&&(e=n[Qr])&&e.apply(n)}:function(){return null},En={};function Gt(n){var e,t,r,i;if(arguments.length===1){if(nt(n))return n.slice();if(this===En&&typeof n=="string")return[n];if(i=Co(n)){for(t=[];!(r=i.next()).done;)t.push(r.value);return t}if(n==null)return[n];if(typeof(e=n.length)=="number"){for(t=new Array(e);e--;)t[e]=n[e];return t}return[n]}for(e=arguments.length,t=new Array(e);e--;)t[e]=arguments[e];return t}const Si=typeof Symbol<"u"?n=>n[Symbol.toStringTag]==="AsyncFunction":()=>!1;var Lt=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function ds(n,e){Lt=n,hs=e}var hs=()=>!0;const Io=!new Error("").stack;function gn(){if(Io)try{throw gn.arguments,new Error}catch(n){return n}return new Error}function Zr(n,e){var t=n.stack;return t?(e=e||0,t.indexOf(n.name)===0&&(e+=(n.name+n.message).split(`
`).length),t.split(`
`).slice(e).filter(hs).map(r=>`
`+r).join("")):""}var fs=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],Ci=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(fs),Oo={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function Sn(n,e){this._e=gn(),this.name=n,this.message=e}function ps(n,e){return n+". Errors: "+Object.keys(e).map(t=>e[t].toString()).filter((t,r,i)=>i.indexOf(t)===r).join(`
`)}function wr(n,e,t,r){this._e=gn(),this.failures=e,this.failedKeys=r,this.successCount=t,this.message=ps(n,e)}function Pn(n,e){this._e=gn(),this.name="BulkError",this.failures=Object.keys(e).map(t=>e[t]),this.failuresByPos=e,this.message=ps(n,e)}An(Sn).from(Error).extend({stack:{get:function(){return this._stack||(this._stack=this.name+": "+this.message+Zr(this._e,2))}},toString:function(){return this.name+": "+this.message}}),An(wr).from(Sn),An(Pn).from(Sn);var Ii=Ci.reduce((n,e)=>(n[e]=e+"Error",n),{});const _o=Sn;var ie=Ci.reduce((n,e)=>{var t=e+"Error";function r(i,s){this._e=gn(),this.name=t,i?typeof i=="string"?(this.message=`${i}${s?`
 `+s:""}`,this.inner=s||null):typeof i=="object"&&(this.message=`${i.name} ${i.message}`,this.inner=i):(this.message=Oo[e]||t,this.inner=null)}return An(r).from(_o),n[e]=r,n},{});ie.Syntax=SyntaxError,ie.Type=TypeError,ie.Range=RangeError;var ki=fs.reduce((n,e)=>(n[e+"Error"]=ie[e],n),{}),hr=Ci.reduce((n,e)=>(["Syntax","Type","Range"].indexOf(e)===-1&&(n[e+"Error"]=ie[e]),n),{});function Oe(){}function Un(n){return n}function To(n,e){return n==null||n===Un?e:function(t){return e(n(t))}}function pn(n,e){return function(){n.apply(this,arguments),e.apply(this,arguments)}}function Do(n,e){return n===Oe?e:function(){var t=n.apply(this,arguments);t!==void 0&&(arguments[0]=t);var r=this.onsuccess,i=this.onerror;this.onsuccess=null,this.onerror=null;var s=e.apply(this,arguments);return r&&(this.onsuccess=this.onsuccess?pn(r,this.onsuccess):r),i&&(this.onerror=this.onerror?pn(i,this.onerror):i),s!==void 0?s:t}}function xo(n,e){return n===Oe?e:function(){n.apply(this,arguments);var t=this.onsuccess,r=this.onerror;this.onsuccess=this.onerror=null,e.apply(this,arguments),t&&(this.onsuccess=this.onsuccess?pn(t,this.onsuccess):t),r&&(this.onerror=this.onerror?pn(r,this.onerror):r)}}function Bo(n,e){return n===Oe?e:function(t){var r=n.apply(this,arguments);lt(t,r);var i=this.onsuccess,s=this.onerror;this.onsuccess=null,this.onerror=null;var o=e.apply(this,arguments);return i&&(this.onsuccess=this.onsuccess?pn(i,this.onsuccess):i),s&&(this.onerror=this.onerror?pn(s,this.onerror):s),r===void 0?o===void 0?void 0:o:lt(r,o)}}function Ro(n,e){return n===Oe?e:function(){return e.apply(this,arguments)!==!1&&n.apply(this,arguments)}}function Oi(n,e){return n===Oe?e:function(){var t=n.apply(this,arguments);if(t&&typeof t.then=="function"){for(var r=this,i=arguments.length,s=new Array(i);i--;)s[i]=arguments[i];return t.then(function(){return e.apply(r,s)})}return e.apply(this,arguments)}}hr.ModifyError=wr,hr.DexieError=Sn,hr.BulkError=Pn;var Kn={};const ys=100,[ei,Er,ti]=typeof Promise>"u"?[]:(()=>{let n=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[n,Hn(n),n];const e=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[e,Hn(e),n]})(),ms=Er&&Er.then,fr=ei&&ei.constructor,_i=!!ti;var ni=!1,No=ti?()=>{ti.then(rr)}:Fe.setImmediate?setImmediate.bind(null,rr):Fe.MutationObserver?()=>{var n=document.createElement("div");new MutationObserver(()=>{rr(),n=null}).observe(n,{attributes:!0}),n.setAttribute("i","1")}:()=>{setTimeout(rr,0)},kn=function(n,e){Fn.push([n,e]),Ar&&(No(),Ar=!1)},ri=!0,Ar=!0,dn=[],pr=[],ii=null,si=Un,Cn={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:Li,pgp:!1,env:{},finalize:function(){this.unhandleds.forEach(n=>{try{Li(n[0],n[1])}catch{}})}},J=Cn,Fn=[],hn=0,yr=[];function V(n){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this.onuncatched=Oe,this._lib=!1;var e=this._PSD=J;if(Lt&&(this._stackHolder=gn(),this._prev=null,this._numPrev=0),typeof n!="function"){if(n!==Kn)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&ai(this,this._value))}this._state=null,this._value=null,++e.ref,vs(this,n)}const oi={get:function(){var n=J,e=Sr;function t(r,i){var s=!n.global&&(n!==J||e!==Sr);const o=s&&!zt();var c=new V((a,h)=>{Ti(this,new gs(Cr(r,n,s,o),Cr(i,n,s,o),a,h,n))});return Lt&&Es(c,this),c}return t.prototype=Kn,t},set:function(n){Yt(this,"then",n&&n.prototype===Kn?oi:{get:function(){return n},set:oi.set})}};function gs(n,e,t,r,i){this.onFulfilled=typeof n=="function"?n:null,this.onRejected=typeof e=="function"?e:null,this.resolve=t,this.reject=r,this.psd=i}function vs(n,e){try{e(t=>{if(n._state===null){if(t===n)throw new TypeError("A promise cannot be resolved with itself.");var r=n._lib&&Qn();t&&typeof t.then=="function"?vs(n,(i,s)=>{t instanceof V?t._then(i,s):t.then(i,s)}):(n._state=!0,n._value=t,bs(n)),r&&Zn()}},ai.bind(null,n))}catch(t){ai(n,t)}}function ai(n,e){if(pr.push(e),n._state===null){var t=n._lib&&Qn();e=si(e),n._state=!1,n._value=e,Lt&&e!==null&&typeof e=="object"&&!e._promise&&function(r,i,s){try{r.apply(null,s)}catch(o){i&&i(o)}}(()=>{var r=Ai(e,"stack");e._promise=n,Yt(e,"stack",{get:()=>ni?r&&(r.get?r.get.apply(e):r.value):n.stack})}),function(r){dn.some(i=>i._value===r._value)||dn.push(r)}(n),bs(n),t&&Zn()}}function bs(n){var e=n._listeners;n._listeners=[];for(var t=0,r=e.length;t<r;++t)Ti(n,e[t]);var i=n._PSD;--i.ref||i.finalize(),hn===0&&(++hn,kn(()=>{--hn==0&&Di()},[]))}function Ti(n,e){if(n._state!==null){var t=n._state?e.onFulfilled:e.onRejected;if(t===null)return(n._state?e.resolve:e.reject)(n._value);++e.psd.ref,++hn,kn(Fo,[t,n,e])}else n._listeners.push(e)}function Fo(n,e,t){try{ii=e;var r,i=e._value;e._state?r=n(i):(pr.length&&(pr=[]),r=n(i),pr.indexOf(i)===-1&&function(s){for(var o=dn.length;o;)if(dn[--o]._value===s._value)return void dn.splice(o,1)}(e)),t.resolve(r)}catch(s){t.reject(s)}finally{ii=null,--hn==0&&Di(),--t.psd.ref||t.psd.finalize()}}function ws(n,e,t){if(e.length===t)return e;var r="";if(n._state===!1){var i,s,o=n._value;o!=null?(i=o.name||"Error",s=o.message||o,r=Zr(o,0)):(i=o,s=""),e.push(i+(s?": "+s:"")+r)}return Lt&&((r=Zr(n._stackHolder,2))&&e.indexOf(r)===-1&&e.push(r),n._prev&&ws(n._prev,e,t)),e}function Es(n,e){var t=e?e._numPrev+1:0;t<100&&(n._prev=e,n._numPrev=t)}function rr(){Qn()&&Zn()}function Qn(){var n=ri;return ri=!1,Ar=!1,n}function Zn(){var n,e,t;do for(;Fn.length>0;)for(n=Fn,Fn=[],t=n.length,e=0;e<t;++e){var r=n[e];r[0].apply(null,r[1])}while(Fn.length>0);ri=!0,Ar=!0}function Di(){var n=dn;dn=[],n.forEach(r=>{r._PSD.onunhandled.call(null,r._value,r)});for(var e=yr.slice(0),t=e.length;t;)e[--t]()}function ir(n){return new V(Kn,!1,n)}function ke(n,e){var t=J;return function(){var r=Qn(),i=J;try{return rn(t,!0),n.apply(this,arguments)}catch(s){e&&e(s)}finally{rn(i,!1),r&&Zn()}}}On(V.prototype,{then:oi,_then:function(n,e){Ti(this,new gs(null,null,n,e,J))},catch:function(n){if(arguments.length===1)return this.then(null,n);var e=arguments[0],t=arguments[1];return typeof e=="function"?this.then(null,r=>r instanceof e?t(r):ir(r)):this.then(null,r=>r&&r.name===e?t(r):ir(r))},finally:function(n){return this.then(e=>(n(),e),e=>(n(),ir(e)))},stack:{get:function(){if(this._stack)return this._stack;try{ni=!0;var n=ws(this,[],20).join(`
From previous: `);return this._state!==null&&(this._stack=n),n}finally{ni=!1}}},timeout:function(n,e){return n<1/0?new V((t,r)=>{var i=setTimeout(()=>r(new ie.Timeout(e)),n);this.then(t,r).finally(clearTimeout.bind(null,i))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&Yt(V.prototype,Symbol.toStringTag,"Dexie.Promise"),Cn.env=As(),On(V,{all:function(){var n=Gt.apply(null,arguments).map(sr);return new V(function(e,t){n.length===0&&e([]);var r=n.length;n.forEach((i,s)=>V.resolve(i).then(o=>{n[s]=o,--r||e(n)},t))})},resolve:n=>{if(n instanceof V)return n;if(n&&typeof n.then=="function")return new V((t,r)=>{n.then(t,r)});var e=new V(Kn,!0,n);return Es(e,ii),e},reject:ir,race:function(){var n=Gt.apply(null,arguments).map(sr);return new V((e,t)=>{n.map(r=>V.resolve(r).then(e,t))})},PSD:{get:()=>J,set:n=>J=n},totalEchoes:{get:()=>Sr},newPSD:nn,usePSD:xn,scheduler:{get:()=>kn,set:n=>{kn=n}},rejectionMapper:{get:()=>si,set:n=>{si=n}},follow:(n,e)=>new V((t,r)=>nn((i,s)=>{var o=J;o.unhandleds=[],o.onunhandled=s,o.finalize=pn(function(){(function(c){function a(){c(),yr.splice(yr.indexOf(a),1)}yr.push(a),++hn,kn(()=>{--hn==0&&Di()},[])})(()=>{this.unhandleds.length===0?i():s(this.unhandleds[0])})},o.finalize),n()},e,t,r))}),fr&&(fr.allSettled&&Yt(V,"allSettled",function(){const n=Gt.apply(null,arguments).map(sr);return new V(e=>{n.length===0&&e([]);let t=n.length;const r=new Array(t);n.forEach((i,s)=>V.resolve(i).then(o=>r[s]={status:"fulfilled",value:o},o=>r[s]={status:"rejected",reason:o}).then(()=>--t||e(r)))})}),fr.any&&typeof AggregateError<"u"&&Yt(V,"any",function(){const n=Gt.apply(null,arguments).map(sr);return new V((e,t)=>{n.length===0&&t(new AggregateError([]));let r=n.length;const i=new Array(r);n.forEach((s,o)=>V.resolve(s).then(c=>e(c),c=>{i[o]=c,--r||t(new AggregateError(i))}))})}));const tt={awaits:0,echoes:0,id:0};var Po=0,mr=[],Hr=0,Sr=0,ko=0;function nn(n,e,t,r){var i=J,s=Object.create(i);s.parent=i,s.ref=0,s.global=!1,s.id=++ko;var o=Cn.env;s.env=_i?{Promise:V,PromiseProp:{value:V,configurable:!0,writable:!0},all:V.all,race:V.race,allSettled:V.allSettled,any:V.any,resolve:V.resolve,reject:V.reject,nthen:Mi(o.nthen,s),gthen:Mi(o.gthen,s)}:{},e&&lt(s,e),++i.ref,s.finalize=function(){--this.parent.ref||this.parent.finalize()};var c=xn(s,n,t,r);return s.ref===0&&s.finalize(),c}function Dn(){return tt.id||(tt.id=++Po),++tt.awaits,tt.echoes+=ys,tt.id}function zt(){return!!tt.awaits&&(--tt.awaits==0&&(tt.id=0),tt.echoes=tt.awaits*ys,!0)}function sr(n){return tt.echoes&&n&&n.constructor===fr?(Dn(),n.then(e=>(zt(),e),e=>(zt(),qe(e)))):n}function Mo(n){++Sr,tt.echoes&&--tt.echoes!=0||(tt.echoes=tt.id=0),mr.push(J),rn(n,!0)}function jo(){var n=mr[mr.length-1];mr.pop(),rn(n,!1)}function rn(n,e){var t=J;if((e?!tt.echoes||Hr++&&n===J:!Hr||--Hr&&n===J)||Ss(e?Mo.bind(null,n):jo),n!==J&&(J=n,t===Cn&&(Cn.env=As()),_i)){var r=Cn.env.Promise,i=n.env;Er.then=i.nthen,r.prototype.then=i.gthen,(t.global||n.global)&&(Object.defineProperty(Fe,"Promise",i.PromiseProp),r.all=i.all,r.race=i.race,r.resolve=i.resolve,r.reject=i.reject,i.allSettled&&(r.allSettled=i.allSettled),i.any&&(r.any=i.any))}}function As(){var n=Fe.Promise;return _i?{Promise:n,PromiseProp:Object.getOwnPropertyDescriptor(Fe,"Promise"),all:n.all,race:n.race,allSettled:n.allSettled,any:n.any,resolve:n.resolve,reject:n.reject,nthen:Er.then,gthen:n.prototype.then}:{}}function xn(n,e,t,r,i){var s=J;try{return rn(n,!0),e(t,r,i)}finally{rn(s,!1)}}function Ss(n){ms.call(ei,n)}function Cr(n,e,t,r){return typeof n!="function"?n:function(){var i=J;t&&Dn(),rn(e,!0);try{return n.apply(this,arguments)}finally{rn(i,!1),r&&Ss(zt)}}}function Mi(n,e){return function(t,r){return n.call(this,Cr(t,e),Cr(r,e))}}(""+ms).indexOf("[native code]")===-1&&(Dn=zt=Oe);const ji="unhandledrejection";function Li(n,e){var t;try{t=e.onuncatched(n)}catch{}if(t!==!1)try{var r,i={promise:e,reason:n};if(Fe.document&&document.createEvent?((r=document.createEvent("Event")).initEvent(ji,!0,!0),lt(r,i)):Fe.CustomEvent&&lt(r=new CustomEvent(ji,{detail:i}),i),r&&Fe.dispatchEvent&&(dispatchEvent(r),!Fe.PromiseRejectionEvent&&Fe.onunhandledrejection))try{Fe.onunhandledrejection(r)}catch{}Lt&&r&&!r.defaultPrevented&&console.warn(`Unhandled rejection: ${n.stack||n}`)}catch{}}var qe=V.reject;function ui(n,e,t,r){if(n.idbdb&&(n._state.openComplete||J.letThrough||n._vip)){var i=n._createTransaction(e,t,n._dbSchema);try{i.create(),n._state.PR1398_maxLoop=3}catch(s){return s.name===Ii.InvalidState&&n.isOpen()&&--n._state.PR1398_maxLoop>0?(console.warn("Dexie: Need to reopen db"),n._close(),n.open().then(()=>ui(n,e,t,r))):qe(s)}return i._promise(e,(s,o)=>nn(()=>(J.trans=i,r(s,o,i)))).then(s=>i._completion.then(()=>s))}if(n._state.openComplete)return qe(new ie.DatabaseClosed(n._state.dbOpenError));if(!n._state.isBeingOpened){if(!n._options.autoOpen)return qe(new ie.DatabaseClosed);n.open().catch(Oe)}return n._state.dbReadyPromise.then(()=>ui(n,e,t,r))}const Hi="3.2.4",ln=String.fromCharCode(65535),ci=-1/0,Vt="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",Cs="String expected.",Mn=[],Br=typeof navigator<"u"&&/(MSIE|Trident|Edge)/.test(navigator.userAgent),Lo=Br,Ho=Br,Is=n=>!/(dexie\.js|dexie\.min\.js)/.test(n),Rr="__dbnames",Ur="readonly",Kr="readwrite";function yn(n,e){return n?e?function(){return n.apply(this,arguments)&&e.apply(this,arguments)}:n:e}const Os={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function or(n){return typeof n!="string"||/\./.test(n)?e=>e:e=>(e[n]===void 0&&n in e&&delete(e=Jn(e))[n],e)}class Uo{_trans(e,t,r){const i=this._tx||J.trans,s=this.name;function o(a,h,l){if(!l.schema[s])throw new ie.NotFound("Table "+s+" not part of transaction");return t(l.idbtrans,l)}const c=Qn();try{return i&&i.db===this.db?i===J.trans?i._promise(e,o,r):nn(()=>i._promise(e,o,r),{trans:i,transless:J.transless||J}):ui(this.db,e,[this.name],o)}finally{c&&Zn()}}get(e,t){return e&&e.constructor===Object?this.where(e).first(t):this._trans("readonly",r=>this.core.get({trans:r,key:e}).then(i=>this.hook.reading.fire(i))).then(t)}where(e){if(typeof e=="string")return new this.db.WhereClause(this,e);if(nt(e))return new this.db.WhereClause(this,`[${e.join("+")}]`);const t=We(e);if(t.length===1)return this.where(t[0]).equals(e[t[0]]);const r=this.schema.indexes.concat(this.schema.primKey).filter(h=>h.compound&&t.every(l=>h.keyPath.indexOf(l)>=0)&&h.keyPath.every(l=>t.indexOf(l)>=0))[0];if(r&&this.db._maxKey!==ln)return this.where(r.name).equals(r.keyPath.map(h=>e[h]));!r&&Lt&&console.warn(`The query ${JSON.stringify(e)} on ${this.name} would benefit of a compound index [${t.join("+")}]`);const{idxByName:i}=this.schema,s=this.db._deps.indexedDB;function o(h,l){try{return s.cmp(h,l)===0}catch{return!1}}const[c,a]=t.reduce(([h,l],d)=>{const p=i[d],b=e[d];return[h||p,h||!p?yn(l,p&&p.multi?C=>{const m=Xt(C,d);return nt(m)&&m.some(v=>o(b,v))}:C=>o(b,Xt(C,d))):l]},[null,null]);return c?this.where(c.name).equals(e[c.keyPath]).filter(a):r?this.filter(a):this.where(t).equals("")}filter(e){return this.toCollection().and(e)}count(e){return this.toCollection().count(e)}offset(e){return this.toCollection().offset(e)}limit(e){return this.toCollection().limit(e)}each(e){return this.toCollection().each(e)}toArray(e){return this.toCollection().toArray(e)}toCollection(){return new this.db.Collection(new this.db.WhereClause(this))}orderBy(e){return new this.db.Collection(new this.db.WhereClause(this,nt(e)?`[${e.join("+")}]`:e))}reverse(){return this.toCollection().reverse()}mapToClass(e){this.schema.mappedClass=e;const t=r=>{if(!r)return r;const i=Object.create(e.prototype);for(var s in r)if(At(r,s))try{i[s]=r[s]}catch{}return i};return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=t,this.hook("reading",t),e}defineClass(){return this.mapToClass(function(e){lt(this,e)})}add(e,t){const{auto:r,keyPath:i}=this.schema.primKey;let s=e;return i&&r&&(s=or(i)(e)),this._trans("readwrite",o=>this.core.mutate({trans:o,type:"add",keys:t!=null?[t]:null,values:[s]})).then(o=>o.numFailures?V.reject(o.failures[0]):o.lastResult).then(o=>{if(i)try{Nt(e,i,o)}catch{}return o})}update(e,t){if(typeof e!="object"||nt(e))return this.where(":id").equals(e).modify(t);{const r=Xt(e,this.schema.primKey.keyPath);if(r===void 0)return qe(new ie.InvalidArgument("Given object does not contain its primary key"));try{typeof t!="function"?We(t).forEach(i=>{Nt(e,i,t[i])}):t(e,{value:e,primKey:r})}catch{}return this.where(":id").equals(r).modify(t)}}put(e,t){const{auto:r,keyPath:i}=this.schema.primKey;let s=e;return i&&r&&(s=or(i)(e)),this._trans("readwrite",o=>this.core.mutate({trans:o,type:"put",values:[s],keys:t!=null?[t]:null})).then(o=>o.numFailures?V.reject(o.failures[0]):o.lastResult).then(o=>{if(i)try{Nt(e,i,o)}catch{}return o})}delete(e){return this._trans("readwrite",t=>this.core.mutate({trans:t,type:"delete",keys:[e]})).then(t=>t.numFailures?V.reject(t.failures[0]):void 0)}clear(){return this._trans("readwrite",e=>this.core.mutate({trans:e,type:"deleteRange",range:Os})).then(e=>e.numFailures?V.reject(e.failures[0]):void 0)}bulkGet(e){return this._trans("readonly",t=>this.core.getMany({keys:e,trans:t}).then(r=>r.map(i=>this.hook.reading.fire(i))))}bulkAdd(e,t,r){const i=Array.isArray(t)?t:void 0,s=(r=r||(i?void 0:t))?r.allKeys:void 0;return this._trans("readwrite",o=>{const{auto:c,keyPath:a}=this.schema.primKey;if(a&&i)throw new ie.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(i&&i.length!==e.length)throw new ie.InvalidArgument("Arguments objects and keys must have the same length");const h=e.length;let l=a&&c?e.map(or(a)):e;return this.core.mutate({trans:o,type:"add",keys:i,values:l,wantResults:s}).then(({numFailures:d,results:p,lastResult:b,failures:C})=>{if(d===0)return s?p:b;throw new Pn(`${this.name}.bulkAdd(): ${d} of ${h} operations failed`,C)})})}bulkPut(e,t,r){const i=Array.isArray(t)?t:void 0,s=(r=r||(i?void 0:t))?r.allKeys:void 0;return this._trans("readwrite",o=>{const{auto:c,keyPath:a}=this.schema.primKey;if(a&&i)throw new ie.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(i&&i.length!==e.length)throw new ie.InvalidArgument("Arguments objects and keys must have the same length");const h=e.length;let l=a&&c?e.map(or(a)):e;return this.core.mutate({trans:o,type:"put",keys:i,values:l,wantResults:s}).then(({numFailures:d,results:p,lastResult:b,failures:C})=>{if(d===0)return s?p:b;throw new Pn(`${this.name}.bulkPut(): ${d} of ${h} operations failed`,C)})})}bulkDelete(e){const t=e.length;return this._trans("readwrite",r=>this.core.mutate({trans:r,type:"delete",keys:e})).then(({numFailures:r,lastResult:i,failures:s})=>{if(r===0)return i;throw new Pn(`${this.name}.bulkDelete(): ${r} of ${t} operations failed`,s)})}}function jn(n){var e={},t=function(o,c){if(c){for(var a=arguments.length,h=new Array(a-1);--a;)h[a-1]=arguments[a];return e[o].subscribe.apply(null,h),n}if(typeof o=="string")return e[o]};t.addEventType=s;for(var r=1,i=arguments.length;r<i;++r)s(arguments[r]);return t;function s(o,c,a){if(typeof o!="object"){var h;c||(c=Ro),a||(a=Oe);var l={subscribers:[],fire:a,subscribe:function(d){l.subscribers.indexOf(d)===-1&&(l.subscribers.push(d),l.fire=c(l.fire,d))},unsubscribe:function(d){l.subscribers=l.subscribers.filter(function(p){return p!==d}),l.fire=l.subscribers.reduce(c,a)}};return e[o]=t[o]=l,l}We(h=o).forEach(function(d){var p=h[d];if(nt(p))s(d,h[d][0],h[d][1]);else{if(p!=="asap")throw new ie.InvalidArgument("Invalid event config");var b=s(d,Un,function(){for(var C=arguments.length,m=new Array(C);C--;)m[C]=arguments[C];b.subscribers.forEach(function(v){os(function(){v.apply(null,m)})})})}})}}function Bn(n,e){return An(e).from({prototype:n}),e}function bn(n,e){return!(n.filter||n.algorithm||n.or)&&(e?n.justLimit:!n.replayFilter)}function Vr(n,e){n.filter=yn(n.filter,e)}function Wr(n,e,t){var r=n.replayFilter;n.replayFilter=r?()=>yn(r(),e()):e,n.justLimit=t&&!r}function gr(n,e){if(n.isPrimKey)return e.primaryKey;const t=e.getIndexByKeyPath(n.index);if(!t)throw new ie.Schema("KeyPath "+n.index+" on object store "+e.name+" is not indexed");return t}function Ui(n,e,t){const r=gr(n,e.schema);return e.openCursor({trans:t,values:!n.keysOnly,reverse:n.dir==="prev",unique:!!n.unique,query:{index:r,range:n.range}})}function ar(n,e,t,r){const i=n.replayFilter?yn(n.filter,n.replayFilter()):n.filter;if(n.or){const s={},o=(c,a,h)=>{if(!i||i(a,h,p=>a.stop(p),p=>a.fail(p))){var l=a.primaryKey,d=""+l;d==="[object ArrayBuffer]"&&(d=""+new Uint8Array(l)),At(s,d)||(s[d]=!0,e(c,a,h))}};return Promise.all([n.or._iterate(o,t),Ki(Ui(n,r,t),n.algorithm,o,!n.keysOnly&&n.valueMapper)])}return Ki(Ui(n,r,t),yn(n.algorithm,i),e,!n.keysOnly&&n.valueMapper)}function Ki(n,e,t,r){var i=ke(r?(s,o,c)=>t(r(s),o,c):t);return n.then(s=>{if(s)return s.start(()=>{var o=()=>s.continue();e&&!e(s,c=>o=c,c=>{s.stop(c),o=Oe},c=>{s.fail(c),o=Oe})||i(s.value,s,c=>o=c),o()})})}function ct(n,e){try{const t=Vi(n),r=Vi(e);if(t!==r)return t==="Array"?1:r==="Array"?-1:t==="binary"?1:r==="binary"?-1:t==="string"?1:r==="string"?-1:t==="Date"?1:r!=="Date"?NaN:-1;switch(t){case"number":case"Date":case"string":return n>e?1:n<e?-1:0;case"binary":return function(i,s){const o=i.length,c=s.length,a=o<c?o:c;for(let h=0;h<a;++h)if(i[h]!==s[h])return i[h]<s[h]?-1:1;return o===c?0:o<c?-1:1}(Wi(n),Wi(e));case"Array":return function(i,s){const o=i.length,c=s.length,a=o<c?o:c;for(let h=0;h<a;++h){const l=ct(i[h],s[h]);if(l!==0)return l}return o===c?0:o<c?-1:1}(n,e)}}catch{}return NaN}function Vi(n){const e=typeof n;if(e!=="object")return e;if(ArrayBuffer.isView(n))return"binary";const t=Jr(n);return t==="ArrayBuffer"?"binary":t}function Wi(n){return n instanceof Uint8Array?n:ArrayBuffer.isView(n)?new Uint8Array(n.buffer,n.byteOffset,n.byteLength):new Uint8Array(n)}class Ko{_read(e,t){var r=this._ctx;return r.error?r.table._trans(null,qe.bind(null,r.error)):r.table._trans("readonly",e).then(t)}_write(e){var t=this._ctx;return t.error?t.table._trans(null,qe.bind(null,t.error)):t.table._trans("readwrite",e,"locked")}_addAlgorithm(e){var t=this._ctx;t.algorithm=yn(t.algorithm,e)}_iterate(e,t){return ar(this._ctx,e,t,this._ctx.table.core)}clone(e){var t=Object.create(this.constructor.prototype),r=Object.create(this._ctx);return e&&lt(r,e),t._ctx=r,t}raw(){return this._ctx.valueMapper=null,this}each(e){var t=this._ctx;return this._read(r=>ar(t,e,r,t.table.core))}count(e){return this._read(t=>{const r=this._ctx,i=r.table.core;if(bn(r,!0))return i.count({trans:t,query:{index:gr(r,i.schema),range:r.range}}).then(o=>Math.min(o,r.limit));var s=0;return ar(r,()=>(++s,!1),t,i).then(()=>s)}).then(e)}sortBy(e,t){const r=e.split(".").reverse(),i=r[0],s=r.length-1;function o(h,l){return l?o(h[r[l]],l-1):h[i]}var c=this._ctx.dir==="next"?1:-1;function a(h,l){var d=o(h,s),p=o(l,s);return d<p?-c:d>p?c:0}return this.toArray(function(h){return h.sort(a)}).then(t)}toArray(e){return this._read(t=>{var r=this._ctx;if(r.dir==="next"&&bn(r,!0)&&r.limit>0){const{valueMapper:i}=r,s=gr(r,r.table.core.schema);return r.table.core.query({trans:t,limit:r.limit,values:!0,query:{index:s,range:r.range}}).then(({result:o})=>i?o.map(i):o)}{const i=[];return ar(r,s=>i.push(s),t,r.table.core).then(()=>i)}},e)}offset(e){var t=this._ctx;return e<=0||(t.offset+=e,bn(t)?Wr(t,()=>{var r=e;return(i,s)=>r===0||(r===1?(--r,!1):(s(()=>{i.advance(r),r=0}),!1))}):Wr(t,()=>{var r=e;return()=>--r<0})),this}limit(e){return this._ctx.limit=Math.min(this._ctx.limit,e),Wr(this._ctx,()=>{var t=e;return function(r,i,s){return--t<=0&&i(s),t>=0}},!0),this}until(e,t){return Vr(this._ctx,function(r,i,s){return!e(r.value)||(i(s),t)}),this}first(e){return this.limit(1).toArray(function(t){return t[0]}).then(e)}last(e){return this.reverse().first(e)}filter(e){var t,r;return Vr(this._ctx,function(i){return e(i.value)}),t=this._ctx,r=e,t.isMatch=yn(t.isMatch,r),this}and(e){return this.filter(e)}or(e){return new this.db.WhereClause(this._ctx.table,e,this)}reverse(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this}desc(){return this.reverse()}eachKey(e){var t=this._ctx;return t.keysOnly=!t.isMatch,this.each(function(r,i){e(i.key,i)})}eachUniqueKey(e){return this._ctx.unique="unique",this.eachKey(e)}eachPrimaryKey(e){var t=this._ctx;return t.keysOnly=!t.isMatch,this.each(function(r,i){e(i.primaryKey,i)})}keys(e){var t=this._ctx;t.keysOnly=!t.isMatch;var r=[];return this.each(function(i,s){r.push(s.key)}).then(function(){return r}).then(e)}primaryKeys(e){var t=this._ctx;if(t.dir==="next"&&bn(t,!0)&&t.limit>0)return this._read(i=>{var s=gr(t,t.table.core.schema);return t.table.core.query({trans:i,values:!1,limit:t.limit,query:{index:s,range:t.range}})}).then(({result:i})=>i).then(e);t.keysOnly=!t.isMatch;var r=[];return this.each(function(i,s){r.push(s.primaryKey)}).then(function(){return r}).then(e)}uniqueKeys(e){return this._ctx.unique="unique",this.keys(e)}firstKey(e){return this.limit(1).keys(function(t){return t[0]}).then(e)}lastKey(e){return this.reverse().firstKey(e)}distinct(){var e=this._ctx,t=e.index&&e.table.schema.idxByName[e.index];if(!t||!t.multi)return this;var r={};return Vr(this._ctx,function(i){var s=i.primaryKey.toString(),o=At(r,s);return r[s]=!0,!o}),this}modify(e){var t=this._ctx;return this._write(r=>{var i;if(typeof e=="function")i=e;else{var s=We(e),o=s.length;i=function(m){for(var v=!1,A=0;A<o;++A){var g=s[A],O=e[g];Xt(m,g)!==O&&(Nt(m,g,O),v=!0)}return v}}const c=t.table.core,{outbound:a,extractKey:h}=c.schema.primaryKey,l=this.db._options.modifyChunkSize||200,d=[];let p=0;const b=[],C=(m,v)=>{const{failures:A,numFailures:g}=v;p+=m-g;for(let O of We(A))d.push(A[O])};return this.clone().primaryKeys().then(m=>{const v=A=>{const g=Math.min(l,m.length-A);return c.getMany({trans:r,keys:m.slice(A,A+g),cache:"immutable"}).then(O=>{const I=[],x=[],M=a?[]:null,_=[];for(let T=0;T<g;++T){const $=O[T],Y={value:Jn($),primKey:m[A+T]};i.call(Y,Y.value,Y)!==!1&&(Y.value==null?_.push(m[A+T]):a||ct(h($),h(Y.value))===0?(x.push(Y.value),a&&M.push(m[A+T])):(_.push(m[A+T]),I.push(Y.value)))}const P=bn(t)&&t.limit===1/0&&(typeof e!="function"||e===Gr)&&{index:t.index,range:t.range};return Promise.resolve(I.length>0&&c.mutate({trans:r,type:"add",values:I}).then(T=>{for(let $ in T.failures)_.splice(parseInt($),1);C(I.length,T)})).then(()=>(x.length>0||P&&typeof e=="object")&&c.mutate({trans:r,type:"put",keys:M,values:x,criteria:P,changeSpec:typeof e!="function"&&e}).then(T=>C(x.length,T))).then(()=>(_.length>0||P&&e===Gr)&&c.mutate({trans:r,type:"delete",keys:_,criteria:P}).then(T=>C(_.length,T))).then(()=>m.length>A+g&&v(A+l))})};return v(0).then(()=>{if(d.length>0)throw new wr("Error modifying one or more objects",d,p,b);return m.length})})})}delete(){var e=this._ctx,t=e.range;return bn(e)&&(e.isPrimKey&&!Ho||t.type===3)?this._write(r=>{const{primaryKey:i}=e.table.core.schema,s=t;return e.table.core.count({trans:r,query:{index:i,range:s}}).then(o=>e.table.core.mutate({trans:r,type:"deleteRange",range:s}).then(({failures:c,lastResult:a,results:h,numFailures:l})=>{if(l)throw new wr("Could not delete some values",Object.keys(c).map(d=>c[d]),o-l);return o-l}))}):this.modify(Gr)}}const Gr=(n,e)=>e.value=null;function Vo(n,e){return n<e?-1:n===e?0:1}function Wo(n,e){return n>e?-1:n===e?0:1}function wt(n,e,t){var r=n instanceof Ts?new n.Collection(n):n;return r._ctx.error=t?new t(e):new TypeError(e),r}function wn(n){return new n.Collection(n,()=>_s("")).limit(0)}function Go(n,e,t,r,i,s){for(var o=Math.min(n.length,r.length),c=-1,a=0;a<o;++a){var h=e[a];if(h!==r[a])return i(n[a],t[a])<0?n.substr(0,a)+t[a]+t.substr(a+1):i(n[a],r[a])<0?n.substr(0,a)+r[a]+t.substr(a+1):c>=0?n.substr(0,c)+e[c]+t.substr(c+1):null;i(n[a],h)<0&&(c=a)}return o<r.length&&s==="next"?n+t.substr(n.length):o<n.length&&s==="prev"?n.substr(0,t.length):c<0?null:n.substr(0,c)+r[c]+t.substr(c+1)}function ur(n,e,t,r){var i,s,o,c,a,h,l,d=t.length;if(!t.every(m=>typeof m=="string"))return wt(n,Cs);function p(m){i=function(A){return A==="next"?g=>g.toUpperCase():g=>g.toLowerCase()}(m),s=function(A){return A==="next"?g=>g.toLowerCase():g=>g.toUpperCase()}(m),o=m==="next"?Vo:Wo;var v=t.map(function(A){return{lower:s(A),upper:i(A)}}).sort(function(A,g){return o(A.lower,g.lower)});c=v.map(function(A){return A.upper}),a=v.map(function(A){return A.lower}),h=m,l=m==="next"?"":r}p("next");var b=new n.Collection(n,()=>Zt(c[0],a[d-1]+r));b._ondirectionchange=function(m){p(m)};var C=0;return b._addAlgorithm(function(m,v,A){var g=m.key;if(typeof g!="string")return!1;var O=s(g);if(e(O,a,C))return!0;for(var I=null,x=C;x<d;++x){var M=Go(g,O,c[x],a[x],o,h);M===null&&I===null?C=x+1:(I===null||o(I,M)>0)&&(I=M)}return v(I!==null?function(){m.continue(I+l)}:A),!1}),b}function Zt(n,e,t,r){return{type:2,lower:n,upper:e,lowerOpen:t,upperOpen:r}}function _s(n){return{type:1,lower:n,upper:n}}class Ts{get Collection(){return this._ctx.table.db.Collection}between(e,t,r,i){r=r!==!1,i=i===!0;try{return this._cmp(e,t)>0||this._cmp(e,t)===0&&(r||i)&&(!r||!i)?wn(this):new this.Collection(this,()=>Zt(e,t,!r,!i))}catch{return wt(this,Vt)}}equals(e){return e==null?wt(this,Vt):new this.Collection(this,()=>_s(e))}above(e){return e==null?wt(this,Vt):new this.Collection(this,()=>Zt(e,void 0,!0))}aboveOrEqual(e){return e==null?wt(this,Vt):new this.Collection(this,()=>Zt(e,void 0,!1))}below(e){return e==null?wt(this,Vt):new this.Collection(this,()=>Zt(void 0,e,!1,!0))}belowOrEqual(e){return e==null?wt(this,Vt):new this.Collection(this,()=>Zt(void 0,e))}startsWith(e){return typeof e!="string"?wt(this,Cs):this.between(e,e+ln,!0,!0)}startsWithIgnoreCase(e){return e===""?this.startsWith(e):ur(this,(t,r)=>t.indexOf(r[0])===0,[e],ln)}equalsIgnoreCase(e){return ur(this,(t,r)=>t===r[0],[e],"")}anyOfIgnoreCase(){var e=Gt.apply(En,arguments);return e.length===0?wn(this):ur(this,(t,r)=>r.indexOf(t)!==-1,e,"")}startsWithAnyOfIgnoreCase(){var e=Gt.apply(En,arguments);return e.length===0?wn(this):ur(this,(t,r)=>r.some(i=>t.indexOf(i)===0),e,ln)}anyOf(){const e=Gt.apply(En,arguments);let t=this._cmp;try{e.sort(t)}catch{return wt(this,Vt)}if(e.length===0)return wn(this);const r=new this.Collection(this,()=>Zt(e[0],e[e.length-1]));r._ondirectionchange=s=>{t=s==="next"?this._ascending:this._descending,e.sort(t)};let i=0;return r._addAlgorithm((s,o,c)=>{const a=s.key;for(;t(a,e[i])>0;)if(++i,i===e.length)return o(c),!1;return t(a,e[i])===0||(o(()=>{s.continue(e[i])}),!1)}),r}notEqual(e){return this.inAnyRange([[ci,e],[e,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})}noneOf(){const e=Gt.apply(En,arguments);if(e.length===0)return new this.Collection(this);try{e.sort(this._ascending)}catch{return wt(this,Vt)}const t=e.reduce((r,i)=>r?r.concat([[r[r.length-1][1],i]]):[[ci,i]],null);return t.push([e[e.length-1],this.db._maxKey]),this.inAnyRange(t,{includeLowers:!1,includeUppers:!1})}inAnyRange(e,t){const r=this._cmp,i=this._ascending,s=this._descending,o=this._min,c=this._max;if(e.length===0)return wn(this);if(!e.every(g=>g[0]!==void 0&&g[1]!==void 0&&i(g[0],g[1])<=0))return wt(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",ie.InvalidArgument);const a=!t||t.includeLowers!==!1,h=t&&t.includeUppers===!0;let l,d=i;function p(g,O){return d(g[0],O[0])}try{l=e.reduce(function(g,O){let I=0,x=g.length;for(;I<x;++I){const M=g[I];if(r(O[0],M[1])<0&&r(O[1],M[0])>0){M[0]=o(M[0],O[0]),M[1]=c(M[1],O[1]);break}}return I===x&&g.push(O),g},[]),l.sort(p)}catch{return wt(this,Vt)}let b=0;const C=h?g=>i(g,l[b][1])>0:g=>i(g,l[b][1])>=0,m=a?g=>s(g,l[b][0])>0:g=>s(g,l[b][0])>=0;let v=C;const A=new this.Collection(this,()=>Zt(l[0][0],l[l.length-1][1],!a,!h));return A._ondirectionchange=g=>{g==="next"?(v=C,d=i):(v=m,d=s),l.sort(p)},A._addAlgorithm((g,O,I)=>{for(var x=g.key;v(x);)if(++b,b===l.length)return O(I),!1;return!!function(M){return!C(M)&&!m(M)}(x)||(this._cmp(x,l[b][1])===0||this._cmp(x,l[b][0])===0||O(()=>{d===i?g.continue(l[b][0]):g.continue(l[b][1])}),!1)}),A}startsWithAnyOf(){const e=Gt.apply(En,arguments);return e.every(t=>typeof t=="string")?e.length===0?wn(this):this.inAnyRange(e.map(t=>[t,t+ln])):wt(this,"startsWithAnyOf() only works with strings")}}function kt(n){return ke(function(e){return Vn(e),n(e.target.error),!1})}function Vn(n){n.stopPropagation&&n.stopPropagation(),n.preventDefault&&n.preventDefault()}const Wn="storagemutated",tn="x-storagemutated-1",sn=jn(null,Wn);class qo{_lock(){return Nn(!J.global),++this._reculock,this._reculock!==1||J.global||(J.lockOwnerFor=this),this}_unlock(){if(Nn(!J.global),--this._reculock==0)for(J.global||(J.lockOwnerFor=null);this._blockedFuncs.length>0&&!this._locked();){var e=this._blockedFuncs.shift();try{xn(e[1],e[0])}catch{}}return this}_locked(){return this._reculock&&J.lockOwnerFor!==this}create(e){if(!this.mode)return this;const t=this.db.idbdb,r=this.db._state.dbOpenError;if(Nn(!this.idbtrans),!e&&!t)switch(r&&r.name){case"DatabaseClosedError":throw new ie.DatabaseClosed(r);case"MissingAPIError":throw new ie.MissingAPI(r.message,r);default:throw new ie.OpenFailed(r)}if(!this.active)throw new ie.TransactionInactive;return Nn(this._completion._state===null),(e=this.idbtrans=e||(this.db.core?this.db.core.transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability}):t.transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability}))).onerror=ke(i=>{Vn(i),this._reject(e.error)}),e.onabort=ke(i=>{Vn(i),this.active&&this._reject(new ie.Abort(e.error)),this.active=!1,this.on("abort").fire(i)}),e.oncomplete=ke(()=>{this.active=!1,this._resolve(),"mutatedParts"in e&&sn.storagemutated.fire(e.mutatedParts)}),this}_promise(e,t,r){if(e==="readwrite"&&this.mode!=="readwrite")return qe(new ie.ReadOnly("Transaction is readonly"));if(!this.active)return qe(new ie.TransactionInactive);if(this._locked())return new V((s,o)=>{this._blockedFuncs.push([()=>{this._promise(e,t,r).then(s,o)},J])});if(r)return nn(()=>{var s=new V((o,c)=>{this._lock();const a=t(o,c,this);a&&a.then&&a.then(o,c)});return s.finally(()=>this._unlock()),s._lib=!0,s});var i=new V((s,o)=>{var c=t(s,o,this);c&&c.then&&c.then(s,o)});return i._lib=!0,i}_root(){return this.parent?this.parent._root():this}waitFor(e){var t=this._root();const r=V.resolve(e);if(t._waitingFor)t._waitingFor=t._waitingFor.then(()=>r);else{t._waitingFor=r,t._waitingQueue=[];var i=t.idbtrans.objectStore(t.storeNames[0]);(function o(){for(++t._spinCount;t._waitingQueue.length;)t._waitingQueue.shift()();t._waitingFor&&(i.get(-1/0).onsuccess=o)})()}var s=t._waitingFor;return new V((o,c)=>{r.then(a=>t._waitingQueue.push(ke(o.bind(null,a))),a=>t._waitingQueue.push(ke(c.bind(null,a)))).finally(()=>{t._waitingFor===s&&(t._waitingFor=null)})})}abort(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new ie.Abort))}table(e){const t=this._memoizedTables||(this._memoizedTables={});if(At(t,e))return t[e];const r=this.schema[e];if(!r)throw new ie.NotFound("Table "+e+" not part of transaction");const i=new this.db.Table(e,r,this);return i.core=this.db.core.table(e),t[e]=i,i}}function li(n,e,t,r,i,s,o){return{name:n,keyPath:e,unique:t,multi:r,auto:i,compound:s,src:(t&&!o?"&":"")+(r?"*":"")+(i?"++":"")+Ds(e)}}function Ds(n){return typeof n=="string"?n:n?"["+[].join.call(n,"+")+"]":""}function xs(n,e,t){return{name:n,primKey:e,indexes:t,mappedClass:null,idxByName:as(t,r=>[r.name,r])}}let Gn=n=>{try{return n.only([[]]),Gn=()=>[[]],[[]]}catch{return Gn=()=>ln,ln}};function di(n){return n==null?()=>{}:typeof n=="string"?function(e){return e.split(".").length===1?r=>r[e]:r=>Xt(r,e)}(n):e=>Xt(e,n)}function Gi(n){return[].slice.call(n)}let $o=0;function Ln(n){return n==null?":id":typeof n=="string"?n:`[${n.join("+")}]`}function Yo(n,e,t){function r(a){if(a.type===3)return null;if(a.type===4)throw new Error("Cannot convert never type to IDBKeyRange");const{lower:h,upper:l,lowerOpen:d,upperOpen:p}=a;return h===void 0?l===void 0?null:e.upperBound(l,!!p):l===void 0?e.lowerBound(h,!!d):e.bound(h,l,!!d,!!p)}const{schema:i,hasGetAll:s}=function(a,h){const l=Gi(a.objectStoreNames);return{schema:{name:a.name,tables:l.map(d=>h.objectStore(d)).map(d=>{const{keyPath:p,autoIncrement:b}=d,C=nt(p),m=p==null,v={},A={name:d.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:m,compound:C,keyPath:p,autoIncrement:b,unique:!0,extractKey:di(p)},indexes:Gi(d.indexNames).map(g=>d.index(g)).map(g=>{const{name:O,unique:I,multiEntry:x,keyPath:M}=g,_={name:O,compound:nt(M),keyPath:M,unique:I,multiEntry:x,extractKey:di(M)};return v[Ln(M)]=_,_}),getIndexByKeyPath:g=>v[Ln(g)]};return v[":id"]=A.primaryKey,p!=null&&(v[Ln(p)]=A.primaryKey),A})},hasGetAll:l.length>0&&"getAll"in h.objectStore(l[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}}(n,t),o=i.tables.map(a=>function(h){const l=h.name;return{name:l,schema:h,mutate:function({trans:d,type:p,keys:b,values:C,range:m}){return new Promise((v,A)=>{v=ke(v);const g=d.objectStore(l),O=g.keyPath==null,I=p==="put"||p==="add";if(!I&&p!=="delete"&&p!=="deleteRange")throw new Error("Invalid operation type: "+p);const{length:x}=b||C||{length:1};if(b&&C&&b.length!==C.length)throw new Error("Given keys array must have same length as given values array.");if(x===0)return v({numFailures:0,failures:{},results:[],lastResult:void 0});let M;const _=[],P=[];let T=0;const $=he=>{++T,Vn(he)};if(p==="deleteRange"){if(m.type===4)return v({numFailures:T,failures:P,results:[],lastResult:void 0});m.type===3?_.push(M=g.clear()):_.push(M=g.delete(r(m)))}else{const[he,X]=I?O?[C,b]:[C,null]:[b,null];if(I)for(let ne=0;ne<x;++ne)_.push(M=X&&X[ne]!==void 0?g[p](he[ne],X[ne]):g[p](he[ne])),M.onerror=$;else for(let ne=0;ne<x;++ne)_.push(M=g[p](he[ne])),M.onerror=$}const Y=he=>{const X=he.target.result;_.forEach((ne,Qe)=>ne.error!=null&&(P[Qe]=ne.error)),v({numFailures:T,failures:P,results:p==="delete"?b:_.map(ne=>ne.result),lastResult:X})};M.onerror=he=>{$(he),Y(he)},M.onsuccess=Y})},getMany:({trans:d,keys:p})=>new Promise((b,C)=>{b=ke(b);const m=d.objectStore(l),v=p.length,A=new Array(v);let g,O=0,I=0;const x=_=>{const P=_.target;A[P._pos]=P.result,++I===O&&b(A)},M=kt(C);for(let _=0;_<v;++_)p[_]!=null&&(g=m.get(p[_]),g._pos=_,g.onsuccess=x,g.onerror=M,++O);O===0&&b(A)}),get:({trans:d,key:p})=>new Promise((b,C)=>{b=ke(b);const m=d.objectStore(l).get(p);m.onsuccess=v=>b(v.target.result),m.onerror=kt(C)}),query:function(d){return p=>new Promise((b,C)=>{b=ke(b);const{trans:m,values:v,limit:A,query:g}=p,O=A===1/0?void 0:A,{index:I,range:x}=g,M=m.objectStore(l),_=I.isPrimaryKey?M:M.index(I.name),P=r(x);if(A===0)return b({result:[]});if(d){const T=v?_.getAll(P,O):_.getAllKeys(P,O);T.onsuccess=$=>b({result:$.target.result}),T.onerror=kt(C)}else{let T=0;const $=v||!("openKeyCursor"in _)?_.openCursor(P):_.openKeyCursor(P),Y=[];$.onsuccess=he=>{const X=$.result;return X?(Y.push(v?X.value:X.primaryKey),++T===A?b({result:Y}):void X.continue()):b({result:Y})},$.onerror=kt(C)}})}(s),openCursor:function({trans:d,values:p,query:b,reverse:C,unique:m}){return new Promise((v,A)=>{v=ke(v);const{index:g,range:O}=b,I=d.objectStore(l),x=g.isPrimaryKey?I:I.index(g.name),M=C?m?"prevunique":"prev":m?"nextunique":"next",_=p||!("openKeyCursor"in x)?x.openCursor(r(O),M):x.openKeyCursor(r(O),M);_.onerror=kt(A),_.onsuccess=ke(P=>{const T=_.result;if(!T)return void v(null);T.___id=++$o,T.done=!1;const $=T.continue.bind(T);let Y=T.continuePrimaryKey;Y&&(Y=Y.bind(T));const he=T.advance.bind(T),X=()=>{throw new Error("Cursor not stopped")};T.trans=d,T.stop=T.continue=T.continuePrimaryKey=T.advance=()=>{throw new Error("Cursor not started")},T.fail=ke(A),T.next=function(){let ne=1;return this.start(()=>ne--?this.continue():this.stop()).then(()=>this)},T.start=ne=>{const Qe=new Promise((Me,et)=>{Me=ke(Me),_.onerror=kt(et),T.fail=et,T.stop=dt=>{T.stop=T.continue=T.continuePrimaryKey=T.advance=X,Me(dt)}}),Ze=()=>{if(_.result)try{ne()}catch(Me){T.fail(Me)}else T.done=!0,T.start=()=>{throw new Error("Cursor behind last entry")},T.stop()};return _.onsuccess=ke(Me=>{_.onsuccess=Ze,Ze()}),T.continue=$,T.continuePrimaryKey=Y,T.advance=he,Ze(),Qe},v(T)},A)})},count({query:d,trans:p}){const{index:b,range:C}=d;return new Promise((m,v)=>{const A=p.objectStore(l),g=b.isPrimaryKey?A:A.index(b.name),O=r(C),I=O?g.count(O):g.count();I.onsuccess=ke(x=>m(x.target.result)),I.onerror=kt(v)})}}}(a)),c={};return o.forEach(a=>c[a.name]=a),{stack:"dbcore",transaction:n.transaction.bind(n),table(a){if(!c[a])throw new Error(`Table '${a}' not found`);return c[a]},MIN_KEY:-1/0,MAX_KEY:Gn(e),schema:i}}function hi({_novip:n},e){const t=e.db,r=function(i,s,{IDBKeyRange:o,indexedDB:c},a){return{dbcore:function(l,d){return d.reduce((p,{create:b})=>({...p,...b(p)}),l)}(Yo(s,o,a),i.dbcore)}}(n._middlewares,t,n._deps,e);n.core=r.dbcore,n.tables.forEach(i=>{const s=i.name;n.core.schema.tables.some(o=>o.name===s)&&(i.core=n.core.table(s),n[s]instanceof n.Table&&(n[s].core=i.core))})}function Ir({_novip:n},e,t,r){t.forEach(i=>{const s=r[i];e.forEach(o=>{const c=Ai(o,i);(!c||"value"in c&&c.value===void 0)&&(o===n.Transaction.prototype||o instanceof n.Transaction?Yt(o,i,{get(){return this.table(i)},set(a){is(this,i,{value:a,writable:!0,configurable:!0,enumerable:!0})}}):o[i]=new n.Table(i,s))})})}function fi({_novip:n},e){e.forEach(t=>{for(let r in t)t[r]instanceof n.Table&&delete t[r]})}function Xo(n,e){return n._cfg.version-e._cfg.version}function zo(n,e,t,r){const i=n._dbSchema,s=n._createTransaction("readwrite",n._storeNames,i);s.create(t),s._completion.catch(r);const o=s._reject.bind(s),c=J.transless||J;nn(()=>{J.trans=s,J.transless=c,e===0?(We(i).forEach(a=>{qr(t,a,i[a].primKey,i[a].indexes)}),hi(n,t),V.follow(()=>n.on.populate.fire(s)).catch(o)):function({_novip:a},h,l,d){const p=[],b=a._versions;let C=a._dbSchema=yi(a,a.idbdb,d),m=!1;const v=b.filter(g=>g._cfg.version>=h);function A(){return p.length?V.resolve(p.shift()(l.idbtrans)).then(A):V.resolve()}return v.forEach(g=>{p.push(()=>{const O=C,I=g._cfg.dbschema;mi(a,O,d),mi(a,I,d),C=a._dbSchema=I;const x=Bs(O,I);x.add.forEach(_=>{qr(d,_[0],_[1].primKey,_[1].indexes)}),x.change.forEach(_=>{if(_.recreate)throw new ie.Upgrade("Not yet support for changing primary key");{const P=d.objectStore(_.name);_.add.forEach(T=>pi(P,T)),_.change.forEach(T=>{P.deleteIndex(T.name),pi(P,T)}),_.del.forEach(T=>P.deleteIndex(T))}});const M=g._cfg.contentUpgrade;if(M&&g._cfg.version>h){hi(a,d),l._memoizedTables={},m=!0;let _=us(I);x.del.forEach(Y=>{_[Y]=O[Y]}),fi(a,[a.Transaction.prototype]),Ir(a,[a.Transaction.prototype],We(_),_),l.schema=_;const P=Si(M);let T;P&&Dn();const $=V.follow(()=>{if(T=M(l),T&&P){var Y=zt.bind(null,null);T.then(Y,Y)}});return T&&typeof T.then=="function"?V.resolve(T):$.then(()=>T)}}),p.push(O=>{(!m||!Lo)&&function(I,x){[].slice.call(x.db.objectStoreNames).forEach(M=>I[M]==null&&x.db.deleteObjectStore(M))}(g._cfg.dbschema,O),fi(a,[a.Transaction.prototype]),Ir(a,[a.Transaction.prototype],a._storeNames,a._dbSchema),l.schema=a._dbSchema})}),A().then(()=>{var g,O;O=d,We(g=C).forEach(I=>{O.db.objectStoreNames.contains(I)||qr(O,I,g[I].primKey,g[I].indexes)})})}(n,e,s,t).catch(o)})}function Bs(n,e){const t={del:[],add:[],change:[]};let r;for(r in n)e[r]||t.del.push(r);for(r in e){const i=n[r],s=e[r];if(i){const o={name:r,def:s,recreate:!1,del:[],add:[],change:[]};if(""+(i.primKey.keyPath||"")!=""+(s.primKey.keyPath||"")||i.primKey.auto!==s.primKey.auto&&!Br)o.recreate=!0,t.change.push(o);else{const c=i.idxByName,a=s.idxByName;let h;for(h in c)a[h]||o.del.push(h);for(h in a){const l=c[h],d=a[h];l?l.src!==d.src&&o.change.push(d):o.add.push(d)}(o.del.length>0||o.add.length>0||o.change.length>0)&&t.change.push(o)}}else t.add.push([r,s])}return t}function qr(n,e,t,r){const i=n.db.createObjectStore(e,t.keyPath?{keyPath:t.keyPath,autoIncrement:t.auto}:{autoIncrement:t.auto});return r.forEach(s=>pi(i,s)),i}function pi(n,e){n.createIndex(e.name,e.keyPath,{unique:e.unique,multiEntry:e.multi})}function yi(n,e,t){const r={};return br(e.objectStoreNames,0).forEach(i=>{const s=t.objectStore(i);let o=s.keyPath;const c=li(Ds(o),o||"",!1,!1,!!s.autoIncrement,o&&typeof o!="string",!0),a=[];for(let l=0;l<s.indexNames.length;++l){const d=s.index(s.indexNames[l]);o=d.keyPath;var h=li(d.name,o,!!d.unique,!!d.multiEntry,!1,o&&typeof o!="string",!1);a.push(h)}r[i]=xs(i,c,a)}),r}function mi({_novip:n},e,t){const r=t.db.objectStoreNames;for(let i=0;i<r.length;++i){const s=r[i],o=t.objectStore(s);n._hasGetAll="getAll"in o;for(let c=0;c<o.indexNames.length;++c){const a=o.indexNames[c],h=o.index(a).keyPath,l=typeof h=="string"?h:"["+br(h).join("+")+"]";if(e[s]){const d=e[s].idxByName[l];d&&(d.name=a,delete e[s].idxByName[l],e[s].idxByName[a]=d)}}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&Fe.WorkerGlobalScope&&Fe instanceof Fe.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(n._hasGetAll=!1)}class Jo{_parseStoresSpec(e,t){We(e).forEach(r=>{if(e[r]!==null){var i=e[r].split(",").map((o,c)=>{const a=(o=o.trim()).replace(/([&*]|\+\+)/g,""),h=/^\[/.test(a)?a.match(/^\[(.*)\]$/)[1].split("+"):a;return li(a,h||null,/\&/.test(o),/\*/.test(o),/\+\+/.test(o),nt(h),c===0)}),s=i.shift();if(s.multi)throw new ie.Schema("Primary key cannot be multi-valued");i.forEach(o=>{if(o.auto)throw new ie.Schema("Only primary key can be marked as autoIncrement (++)");if(!o.keyPath)throw new ie.Schema("Index must have a name and cannot be an empty string")}),t[r]=xs(r,s,i)}})}stores(e){const t=this.db;this._cfg.storesSource=this._cfg.storesSource?lt(this._cfg.storesSource,e):e;const r=t._versions,i={};let s={};return r.forEach(o=>{lt(i,o._cfg.storesSource),s=o._cfg.dbschema={},o._parseStoresSpec(i,s)}),t._dbSchema=s,fi(t,[t._allTables,t,t.Transaction.prototype]),Ir(t,[t._allTables,t,t.Transaction.prototype,this._cfg.tables],We(s),s),t._storeNames=We(s),this}upgrade(e){return this._cfg.contentUpgrade=Oi(this._cfg.contentUpgrade||Oe,e),this}}function xi(n,e){let t=n._dbNamesDB;return t||(t=n._dbNamesDB=new fn(Rr,{addons:[],indexedDB:n,IDBKeyRange:e}),t.version(1).stores({dbnames:"name"})),t.table("dbnames")}function Bi(n){return n&&typeof n.databases=="function"}function gi(n){return nn(function(){return J.letThrough=!0,n()})}function Qo(){var n;return!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(e){var t=function(){return indexedDB.databases().finally(e)};n=setInterval(t,100),t()}).finally(function(){return clearInterval(n)}):Promise.resolve()}function Zo(n){const e=n._state,{indexedDB:t}=n._deps;if(e.isBeingOpened||n.idbdb)return e.dbReadyPromise.then(()=>e.dbOpenError?qe(e.dbOpenError):n);Lt&&(e.openCanceller._stackHolder=gn()),e.isBeingOpened=!0,e.dbOpenError=null,e.openComplete=!1;const r=e.openCanceller;function i(){if(e.openCanceller!==r)throw new ie.DatabaseClosed("db.open() was cancelled")}let s=e.dbReadyResolve,o=null,c=!1;return V.race([r,(typeof navigator>"u"?V.resolve():Qo()).then(()=>new V((a,h)=>{if(i(),!t)throw new ie.MissingAPI;const l=n.name,d=e.autoSchema?t.open(l):t.open(l,Math.round(10*n.verno));if(!d)throw new ie.MissingAPI;d.onerror=kt(h),d.onblocked=ke(n._fireOnBlocked),d.onupgradeneeded=ke(p=>{if(o=d.transaction,e.autoSchema&&!n._options.allowEmptyDB){d.onerror=Vn,o.abort(),d.result.close();const C=t.deleteDatabase(l);C.onsuccess=C.onerror=ke(()=>{h(new ie.NoSuchDatabase(`Database ${l} doesnt exist`))})}else{o.onerror=kt(h);var b=p.oldVersion>Math.pow(2,62)?0:p.oldVersion;c=b<1,n._novip.idbdb=d.result,zo(n,b/10,o,h)}},h),d.onsuccess=ke(()=>{o=null;const p=n._novip.idbdb=d.result,b=br(p.objectStoreNames);if(b.length>0)try{const m=p.transaction((C=b).length===1?C[0]:C,"readonly");e.autoSchema?function({_novip:v},A,g){v.verno=A.version/10;const O=v._dbSchema=yi(0,A,g);v._storeNames=br(A.objectStoreNames,0),Ir(v,[v._allTables],We(O),O)}(n,p,m):(mi(n,n._dbSchema,m),function(v,A){const g=Bs(yi(0,v.idbdb,A),v._dbSchema);return!(g.add.length||g.change.some(O=>O.add.length||O.change.length))}(n,m)||console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Some queries may fail.")),hi(n,m)}catch{}var C;Mn.push(n),p.onversionchange=ke(m=>{e.vcFired=!0,n.on("versionchange").fire(m)}),p.onclose=ke(m=>{n.on("close").fire(m)}),c&&function({indexedDB:m,IDBKeyRange:v},A){!Bi(m)&&A!==Rr&&xi(m,v).put({name:A}).catch(Oe)}(n._deps,l),a()},h)}))]).then(()=>(i(),e.onReadyBeingFired=[],V.resolve(gi(()=>n.on.ready.fire(n.vip))).then(function a(){if(e.onReadyBeingFired.length>0){let h=e.onReadyBeingFired.reduce(Oi,Oe);return e.onReadyBeingFired=[],V.resolve(gi(()=>h(n.vip))).then(a)}}))).finally(()=>{e.onReadyBeingFired=null,e.isBeingOpened=!1}).then(()=>n).catch(a=>{e.dbOpenError=a;try{o&&o.abort()}catch{}return r===e.openCanceller&&n._close(),qe(a)}).finally(()=>{e.openComplete=!0,s()})}function vi(n){var e=s=>n.next(s),t=i(e),r=i(s=>n.throw(s));function i(s){return o=>{var c=s(o),a=c.value;return c.done?a:a&&typeof a.then=="function"?a.then(t,r):nt(a)?Promise.all(a).then(t,r):t(a)}}return i(e)()}function ea(n,e,t){var r=arguments.length;if(r<2)throw new ie.InvalidArgument("Too few arguments");for(var i=new Array(r-1);--r;)i[r-1]=arguments[r];return t=i.pop(),[n,cs(i),t]}function Rs(n,e,t,r,i){return V.resolve().then(()=>{const s=J.transless||J,o=n._createTransaction(e,t,n._dbSchema,r),c={trans:o,transless:s};if(r)o.idbtrans=r.idbtrans;else try{o.create(),n._state.PR1398_maxLoop=3}catch(d){return d.name===Ii.InvalidState&&n.isOpen()&&--n._state.PR1398_maxLoop>0?(console.warn("Dexie: Need to reopen db"),n._close(),n.open().then(()=>Rs(n,e,t,null,i))):qe(d)}const a=Si(i);let h;a&&Dn();const l=V.follow(()=>{if(h=i.call(o,o),h)if(a){var d=zt.bind(null,null);h.then(d,d)}else typeof h.next=="function"&&typeof h.throw=="function"&&(h=vi(h))},c);return(h&&typeof h.then=="function"?V.resolve(h).then(d=>o.active?d:qe(new ie.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))):l.then(()=>h)).then(d=>(r&&o._resolve(),o._completion.then(()=>d))).catch(d=>(o._reject(d),qe(d)))})}function cr(n,e,t){const r=nt(n)?n.slice():[n];for(let i=0;i<t;++i)r.push(e);return r}const ta={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(n){return{...n,table(e){const t=n.table(e),{schema:r}=t,i={},s=[];function o(l,d,p){const b=Ln(l),C=i[b]=i[b]||[],m=l==null?0:typeof l=="string"?1:l.length,v=d>0,A={...p,isVirtual:v,keyTail:d,keyLength:m,extractKey:di(l),unique:!v&&p.unique};return C.push(A),A.isPrimaryKey||s.push(A),m>1&&o(m===2?l[0]:l.slice(0,m-1),d+1,p),C.sort((g,O)=>g.keyTail-O.keyTail),A}const c=o(r.primaryKey.keyPath,0,r.primaryKey);i[":id"]=[c];for(const l of r.indexes)o(l.keyPath,0,l);function a(l){const d=l.query.index;return d.isVirtual?{...l,query:{index:d,range:(p=l.query.range,b=d.keyTail,{type:p.type===1?2:p.type,lower:cr(p.lower,p.lowerOpen?n.MAX_KEY:n.MIN_KEY,b),lowerOpen:!0,upper:cr(p.upper,p.upperOpen?n.MIN_KEY:n.MAX_KEY,b),upperOpen:!0})}}:l;var p,b}return{...t,schema:{...r,primaryKey:c,indexes:s,getIndexByKeyPath:function(l){const d=i[Ln(l)];return d&&d[0]}},count:l=>t.count(a(l)),query:l=>t.query(a(l)),openCursor(l){const{keyTail:d,isVirtual:p,keyLength:b}=l.query.index;return p?t.openCursor(a(l)).then(C=>C&&function(m){return Object.create(m,{continue:{value:function(A){A!=null?m.continue(cr(A,l.reverse?n.MAX_KEY:n.MIN_KEY,d)):l.unique?m.continue(m.key.slice(0,b).concat(l.reverse?n.MIN_KEY:n.MAX_KEY,d)):m.continue()}},continuePrimaryKey:{value(A,g){m.continuePrimaryKey(cr(A,n.MAX_KEY,d),g)}},primaryKey:{get:()=>m.primaryKey},key:{get(){const A=m.key;return b===1?A[0]:A.slice(0,b)}},value:{get:()=>m.value}})}(C)):t.openCursor(l)}}}}}};function Ri(n,e,t,r){return t=t||{},r=r||"",We(n).forEach(i=>{if(At(e,i)){var s=n[i],o=e[i];if(typeof s=="object"&&typeof o=="object"&&s&&o){const c=Jr(s);c!==Jr(o)?t[r+i]=e[i]:c==="Object"?Ri(s,o,t,r+i+"."):s!==o&&(t[r+i]=e[i])}else s!==o&&(t[r+i]=e[i])}else t[r+i]=void 0}),We(e).forEach(i=>{At(n,i)||(t[r+i]=e[i])}),t}const na={stack:"dbcore",name:"HooksMiddleware",level:2,create:n=>({...n,table(e){const t=n.table(e),{primaryKey:r}=t.schema;return{...t,mutate(s){const o=J.trans,{deleting:c,creating:a,updating:h}=o.table(e).hook;switch(s.type){case"add":if(a.fire===Oe)break;return o._promise("readwrite",()=>l(s),!0);case"put":if(a.fire===Oe&&h.fire===Oe)break;return o._promise("readwrite",()=>l(s),!0);case"delete":if(c.fire===Oe)break;return o._promise("readwrite",()=>l(s),!0);case"deleteRange":if(c.fire===Oe)break;return o._promise("readwrite",()=>function(p){return d(p.trans,p.range,1e4)}(s),!0)}return t.mutate(s);function l(p){const b=J.trans,C=p.keys||function(m,v){return v.type==="delete"?v.keys:v.keys||v.values.map(m.extractKey)}(r,p);if(!C)throw new Error("Keys missing");return(p=p.type==="add"||p.type==="put"?{...p,keys:C}:{...p}).type!=="delete"&&(p.values=[...p.values]),p.keys&&(p.keys=[...p.keys]),function(m,v,A){return v.type==="add"?Promise.resolve([]):m.getMany({trans:v.trans,keys:A,cache:"immutable"})}(t,p,C).then(m=>{const v=C.map((A,g)=>{const O=m[g],I={onerror:null,onsuccess:null};if(p.type==="delete")c.fire.call(I,A,O,b);else if(p.type==="add"||O===void 0){const x=a.fire.call(I,A,p.values[g],b);A==null&&x!=null&&(A=x,p.keys[g]=A,r.outbound||Nt(p.values[g],r.keyPath,A))}else{const x=Ri(O,p.values[g]),M=h.fire.call(I,x,A,O,b);if(M){const _=p.values[g];Object.keys(M).forEach(P=>{At(_,P)?_[P]=M[P]:Nt(_,P,M[P])})}}return I});return t.mutate(p).then(({failures:A,results:g,numFailures:O,lastResult:I})=>{for(let x=0;x<C.length;++x){const M=g?g[x]:C[x],_=v[x];M==null?_.onerror&&_.onerror(A[x]):_.onsuccess&&_.onsuccess(p.type==="put"&&m[x]?p.values[x]:M)}return{failures:A,results:g,numFailures:O,lastResult:I}}).catch(A=>(v.forEach(g=>g.onerror&&g.onerror(A)),Promise.reject(A)))})}function d(p,b,C){return t.query({trans:p,values:!1,query:{index:r,range:b},limit:C}).then(({result:m})=>l({type:"delete",keys:m,trans:p}).then(v=>v.numFailures>0?Promise.reject(v.failures[0]):m.length<C?{failures:[],numFailures:0,lastResult:void 0}:d(p,{...b,lower:m[m.length-1],lowerOpen:!0},C)))}}}}})};function Ns(n,e,t){try{if(!e||e.keys.length<n.length)return null;const r=[];for(let i=0,s=0;i<e.keys.length&&s<n.length;++i)ct(e.keys[i],n[s])===0&&(r.push(t?Jn(e.values[i]):e.values[i]),++s);return r.length===n.length?r:null}catch{return null}}const ra={stack:"dbcore",level:-1,create:n=>({table:e=>{const t=n.table(e);return{...t,getMany:r=>{if(!r.cache)return t.getMany(r);const i=Ns(r.keys,r.trans._cache,r.cache==="clone");return i?V.resolve(i):t.getMany(r).then(s=>(r.trans._cache={keys:r.keys,values:r.cache==="clone"?Jn(s):s},s))},mutate:r=>(r.type!=="add"&&(r.trans._cache=null),t.mutate(r))}}})};function Ni(n){return!("from"in n)}const Wt=function(n,e){if(!this){const t=new Wt;return n&&"d"in n&&lt(t,n),t}lt(this,arguments.length?{d:1,from:n,to:arguments.length>1?e:n}:{d:0})};function qn(n,e,t){const r=ct(e,t);if(isNaN(r))return;if(r>0)throw RangeError();if(Ni(n))return lt(n,{from:e,to:t,d:1});const i=n.l,s=n.r;if(ct(t,n.from)<0)return i?qn(i,e,t):n.l={from:e,to:t,d:1,l:null,r:null},qi(n);if(ct(e,n.to)>0)return s?qn(s,e,t):n.r={from:e,to:t,d:1,l:null,r:null},qi(n);ct(e,n.from)<0&&(n.from=e,n.l=null,n.d=s?s.d+1:1),ct(t,n.to)>0&&(n.to=t,n.r=null,n.d=n.l?n.l.d+1:1);const o=!n.r;i&&!n.l&&Or(n,i),s&&o&&Or(n,s)}function Or(n,e){Ni(e)||function t(r,{from:i,to:s,l:o,r:c}){qn(r,i,s),o&&t(r,o),c&&t(r,c)}(n,e)}function ia(n,e){const t=bi(e);let r=t.next();if(r.done)return!1;let i=r.value;const s=bi(n);let o=s.next(i.from),c=o.value;for(;!r.done&&!o.done;){if(ct(c.from,i.to)<=0&&ct(c.to,i.from)>=0)return!0;ct(i.from,c.from)<0?i=(r=t.next(c.from)).value:c=(o=s.next(i.from)).value}return!1}function bi(n){let e=Ni(n)?null:{s:0,n};return{next(t){const r=arguments.length>0;for(;e;)switch(e.s){case 0:if(e.s=1,r)for(;e.n.l&&ct(t,e.n.from)<0;)e={up:e,n:e.n.l,s:1};else for(;e.n.l;)e={up:e,n:e.n.l,s:1};case 1:if(e.s=2,!r||ct(t,e.n.to)<=0)return{value:e.n,done:!1};case 2:if(e.n.r){e.s=3,e={up:e,n:e.n.r,s:0};continue}case 3:e=e.up}return{done:!0}}}}function qi(n){var e,t;const r=(((e=n.r)===null||e===void 0?void 0:e.d)||0)-(((t=n.l)===null||t===void 0?void 0:t.d)||0),i=r>1?"r":r<-1?"l":"";if(i){const s=i==="r"?"l":"r",o={...n},c=n[i];n.from=c.from,n.to=c.to,n[i]=c[i],o[i]=c[s],n[s]=o,o.d=$i(o)}n.d=$i(n)}function $i({r:n,l:e}){return(n?e?Math.max(n.d,e.d):n.d:e?e.d:0)+1}On(Wt.prototype,{add(n){return Or(this,n),this},addKey(n){return qn(this,n,n),this},addKeys(n){return n.forEach(e=>qn(this,e,e)),this},[Qr](){return bi(this)}});const sa={stack:"dbcore",level:0,create:n=>{const e=n.schema.name,t=new Wt(n.MIN_KEY,n.MAX_KEY);return{...n,table:r=>{const i=n.table(r),{schema:s}=i,{primaryKey:o}=s,{extractKey:c,outbound:a}=o,h={...i,mutate:p=>{const b=p.trans,C=b.mutatedParts||(b.mutatedParts={}),m=M=>{const _=`idb://${e}/${r}/${M}`;return C[_]||(C[_]=new Wt)},v=m(""),A=m(":dels"),{type:g}=p;let[O,I]=p.type==="deleteRange"?[p.range]:p.type==="delete"?[p.keys]:p.values.length<50?[[],p.values]:[];const x=p.trans._cache;return i.mutate(p).then(M=>{if(nt(O)){g!=="delete"&&(O=M.results),v.addKeys(O);const _=Ns(O,x);_||g==="add"||A.addKeys(O),(_||I)&&function(P,T,$,Y){function he(X){const ne=P(X.name||"");function Qe(Me){return Me!=null?X.extractKey(Me):null}const Ze=Me=>X.multiEntry&&nt(Me)?Me.forEach(et=>ne.addKey(et)):ne.addKey(Me);($||Y).forEach((Me,et)=>{const dt=$&&Qe($[et]),Ut=Y&&Qe(Y[et]);ct(dt,Ut)!==0&&(dt!=null&&Ze(dt),Ut!=null&&Ze(Ut))})}T.indexes.forEach(he)}(m,s,_,I)}else if(O){const _={from:O.lower,to:O.upper};A.add(_),v.add(_)}else v.add(t),A.add(t),s.indexes.forEach(_=>m(_.name).add(t));return M})}},l=({query:{index:p,range:b}})=>{var C,m;return[p,new Wt((C=b.lower)!==null&&C!==void 0?C:n.MIN_KEY,(m=b.upper)!==null&&m!==void 0?m:n.MAX_KEY)]},d={get:p=>[o,new Wt(p.key)],getMany:p=>[o,new Wt().addKeys(p.keys)],count:l,query:l,openCursor:l};return We(d).forEach(p=>{h[p]=function(b){const{subscr:C}=J;if(C){const m=I=>{const x=`idb://${e}/${r}/${I}`;return C[x]||(C[x]=new Wt)},v=m(""),A=m(":dels"),[g,O]=d[p](b);if(m(g.name||"").add(O),!g.isPrimaryKey){if(p!=="count"){const I=p==="query"&&a&&b.values&&i.query({...b,values:!1});return i[p].apply(this,arguments).then(x=>{if(p==="query"){if(a&&b.values)return I.then(({result:_})=>(v.addKeys(_),x));const M=b.values?x.result.map(c):x.result;b.values?v.addKeys(M):A.addKeys(M)}else if(p==="openCursor"){const M=x,_=b.values;return M&&Object.create(M,{key:{get:()=>(A.addKey(M.primaryKey),M.key)},primaryKey:{get(){const P=M.primaryKey;return A.addKey(P),P}},value:{get:()=>(_&&v.addKey(M.primaryKey),M.value)}})}return x})}A.add(t)}}return i[p].apply(this,arguments)}}),h}}}};class fn{constructor(e,t){this._middlewares={},this.verno=0;const r=fn.dependencies;this._options=t={addons:fn.addons,autoOpen:!0,indexedDB:r.indexedDB,IDBKeyRange:r.IDBKeyRange,...t},this._deps={indexedDB:t.indexedDB,IDBKeyRange:t.IDBKeyRange};const{addons:i}=t;this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;const s={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:Oe,dbReadyPromise:null,cancelOpen:Oe,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3};var o;s.dbReadyPromise=new V(c=>{s.dbReadyResolve=c}),s.openCanceller=new V((c,a)=>{s.cancelOpen=a}),this._state=s,this.name=e,this.on=jn(this,"populate","blocked","versionchange","close",{ready:[Oi,Oe]}),this.on.ready.subscribe=ss(this.on.ready.subscribe,c=>(a,h)=>{fn.vip(()=>{const l=this._state;if(l.openComplete)l.dbOpenError||V.resolve().then(a),h&&c(a);else if(l.onReadyBeingFired)l.onReadyBeingFired.push(a),h&&c(a);else{c(a);const d=this;h||c(function p(){d.on.ready.unsubscribe(a),d.on.ready.unsubscribe(p)})}})}),this.Collection=(o=this,Bn(Ko.prototype,function(c,a){this.db=o;let h=Os,l=null;if(a)try{h=a()}catch(C){l=C}const d=c._ctx,p=d.table,b=p.hook.reading.fire;this._ctx={table:p,index:d.index,isPrimKey:!d.index||p.schema.primKey.keyPath&&d.index===p.schema.primKey.name,range:h,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:l,or:d.or,valueMapper:b!==Un?b:null}})),this.Table=function(c){return Bn(Uo.prototype,function(a,h,l){this.db=c,this._tx=l,this.name=a,this.schema=h,this.hook=c._allTables[a]?c._allTables[a].hook:jn(null,{creating:[Do,Oe],reading:[To,Un],updating:[Bo,Oe],deleting:[xo,Oe]})})}(this),this.Transaction=function(c){return Bn(qo.prototype,function(a,h,l,d,p){this.db=c,this.mode=a,this.storeNames=h,this.schema=l,this.chromeTransactionDurability=d,this.idbtrans=null,this.on=jn(this,"complete","error","abort"),this.parent=p||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new V((b,C)=>{this._resolve=b,this._reject=C}),this._completion.then(()=>{this.active=!1,this.on.complete.fire()},b=>{var C=this.active;return this.active=!1,this.on.error.fire(b),this.parent?this.parent._reject(b):C&&this.idbtrans&&this.idbtrans.abort(),qe(b)})})}(this),this.Version=function(c){return Bn(Jo.prototype,function(a){this.db=c,this._cfg={version:a,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})}(this),this.WhereClause=function(c){return Bn(Ts.prototype,function(a,h,l){this.db=c,this._ctx={table:a,index:h===":id"?null:h,or:l};const d=c._deps.indexedDB;if(!d)throw new ie.MissingAPI;this._cmp=this._ascending=d.cmp.bind(d),this._descending=(p,b)=>d.cmp(b,p),this._max=(p,b)=>d.cmp(p,b)>0?p:b,this._min=(p,b)=>d.cmp(p,b)<0?p:b,this._IDBKeyRange=c._deps.IDBKeyRange})}(this),this.on("versionchange",c=>{c.newVersion>0?console.warn(`Another connection wants to upgrade database '${this.name}'. Closing db now to resume the upgrade.`):console.warn(`Another connection wants to delete database '${this.name}'. Closing db now to resume the delete request.`),this.close()}),this.on("blocked",c=>{!c.newVersion||c.newVersion<c.oldVersion?console.warn(`Dexie.delete('${this.name}') was blocked`):console.warn(`Upgrade '${this.name}' blocked by other connection holding version ${c.oldVersion/10}`)}),this._maxKey=Gn(t.IDBKeyRange),this._createTransaction=(c,a,h,l)=>new this.Transaction(c,a,h,this._options.chromeTransactionDurability,l),this._fireOnBlocked=c=>{this.on("blocked").fire(c),Mn.filter(a=>a.name===this.name&&a!==this&&!a._state.vcFired).map(a=>a.on("versionchange").fire(c))},this.use(ta),this.use(na),this.use(sa),this.use(ra),this.vip=Object.create(this,{_vip:{value:!0}}),i.forEach(c=>c(this))}version(e){if(isNaN(e)||e<.1)throw new ie.Type("Given version is not a positive number");if(e=Math.round(10*e)/10,this.idbdb||this._state.isBeingOpened)throw new ie.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,e);const t=this._versions;var r=t.filter(i=>i._cfg.version===e)[0];return r||(r=new this.Version(e),t.push(r),t.sort(Xo),r.stores({}),this._state.autoSchema=!1,r)}_whenReady(e){return this.idbdb&&(this._state.openComplete||J.letThrough||this._vip)?e():new V((t,r)=>{if(this._state.openComplete)return r(new ie.DatabaseClosed(this._state.dbOpenError));if(!this._state.isBeingOpened){if(!this._options.autoOpen)return void r(new ie.DatabaseClosed);this.open().catch(Oe)}this._state.dbReadyPromise.then(t,r)}).then(e)}use({stack:e,create:t,level:r,name:i}){i&&this.unuse({stack:e,name:i});const s=this._middlewares[e]||(this._middlewares[e]=[]);return s.push({stack:e,create:t,level:r??10,name:i}),s.sort((o,c)=>o.level-c.level),this}unuse({stack:e,name:t,create:r}){return e&&this._middlewares[e]&&(this._middlewares[e]=this._middlewares[e].filter(i=>r?i.create!==r:!!t&&i.name!==t)),this}open(){return Zo(this)}_close(){const e=this._state,t=Mn.indexOf(this);if(t>=0&&Mn.splice(t,1),this.idbdb){try{this.idbdb.close()}catch{}this._novip.idbdb=null}e.dbReadyPromise=new V(r=>{e.dbReadyResolve=r}),e.openCanceller=new V((r,i)=>{e.cancelOpen=i})}close(){this._close();const e=this._state;this._options.autoOpen=!1,e.dbOpenError=new ie.DatabaseClosed,e.isBeingOpened&&e.cancelOpen(e.dbOpenError)}delete(){const e=arguments.length>0,t=this._state;return new V((r,i)=>{const s=()=>{this.close();var o=this._deps.indexedDB.deleteDatabase(this.name);o.onsuccess=ke(()=>{(function({indexedDB:c,IDBKeyRange:a},h){!Bi(c)&&h!==Rr&&xi(c,a).delete(h).catch(Oe)})(this._deps,this.name),r()}),o.onerror=kt(i),o.onblocked=this._fireOnBlocked};if(e)throw new ie.InvalidArgument("Arguments not allowed in db.delete()");t.isBeingOpened?t.dbReadyPromise.then(s):s()})}backendDB(){return this.idbdb}isOpen(){return this.idbdb!==null}hasBeenClosed(){const e=this._state.dbOpenError;return e&&e.name==="DatabaseClosed"}hasFailed(){return this._state.dbOpenError!==null}dynamicallyOpened(){return this._state.autoSchema}get tables(){return We(this._allTables).map(e=>this._allTables[e])}transaction(){const e=ea.apply(this,arguments);return this._transaction.apply(this,e)}_transaction(e,t,r){let i=J.trans;i&&i.db===this&&e.indexOf("!")===-1||(i=null);const s=e.indexOf("?")!==-1;let o,c;e=e.replace("!","").replace("?","");try{if(c=t.map(h=>{var l=h instanceof this.Table?h.name:h;if(typeof l!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return l}),e=="r"||e===Ur)o=Ur;else{if(e!="rw"&&e!=Kr)throw new ie.InvalidArgument("Invalid transaction mode: "+e);o=Kr}if(i){if(i.mode===Ur&&o===Kr){if(!s)throw new ie.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");i=null}i&&c.forEach(h=>{if(i&&i.storeNames.indexOf(h)===-1){if(!s)throw new ie.SubTransaction("Table "+h+" not included in parent transaction.");i=null}}),s&&i&&!i.active&&(i=null)}}catch(h){return i?i._promise(null,(l,d)=>{d(h)}):qe(h)}const a=Rs.bind(null,this,o,c,i,r);return i?i._promise(o,a,"lock"):J.trans?xn(J.transless,()=>this._whenReady(a)):this._whenReady(a)}table(e){if(!At(this._allTables,e))throw new ie.InvalidTable(`Table ${e} does not exist`);return this._allTables[e]}}const oa=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable";class aa{constructor(e){this._subscribe=e}subscribe(e,t,r){return this._subscribe(e&&typeof e!="function"?e:{next:e,error:t,complete:r})}[oa](){return this}}function Fs(n,e){return We(e).forEach(t=>{Or(n[t]||(n[t]=new Wt),e[t])}),n}function ua(n){let e,t=!1;const r=new aa(i=>{const s=Si(n);let o=!1,c={},a={};const h={get closed(){return o},unsubscribe:()=>{o=!0,sn.storagemutated.unsubscribe(b)}};i.start&&i.start(h);let l=!1,d=!1;function p(){return We(a).some(m=>c[m]&&ia(c[m],a[m]))}const b=m=>{Fs(c,m),p()&&C()},C=()=>{if(l||o)return;c={};const m={},v=function(A){s&&Dn();const g=()=>nn(n,{subscr:A,trans:null}),O=J.trans?xn(J.transless,g):g();return s&&O.then(zt,zt),O}(m);d||(sn(Wn,b),d=!0),l=!0,Promise.resolve(v).then(A=>{t=!0,e=A,l=!1,o||(p()?C():(c={},a=m,i.next&&i.next(A)))},A=>{l=!1,t=!1,i.error&&i.error(A),h.unsubscribe()})};return C(),h});return r.hasValue=()=>t,r.getValue=()=>e,r}let wi;try{wi={indexedDB:Fe.indexedDB||Fe.mozIndexedDB||Fe.webkitIndexedDB||Fe.msIndexedDB,IDBKeyRange:Fe.IDBKeyRange||Fe.webkitIDBKeyRange}}catch{wi={indexedDB:null,IDBKeyRange:null}}const un=fn;function vr(n){let e=$t;try{$t=!0,sn.storagemutated.fire(n)}finally{$t=e}}On(un,{...hr,delete:n=>new un(n,{addons:[]}).delete(),exists:n=>new un(n,{addons:[]}).open().then(e=>(e.close(),!0)).catch("NoSuchDatabaseError",()=>!1),getDatabaseNames(n){try{return function({indexedDB:e,IDBKeyRange:t}){return Bi(e)?Promise.resolve(e.databases()).then(r=>r.map(i=>i.name).filter(i=>i!==Rr)):xi(e,t).toCollection().primaryKeys()}(un.dependencies).then(n)}catch{return qe(new ie.MissingAPI)}},defineClass:()=>function(n){lt(this,n)},ignoreTransaction:n=>J.trans?xn(J.transless,n):n(),vip:gi,async:function(n){return function(){try{var e=vi(n.apply(this,arguments));return e&&typeof e.then=="function"?e:V.resolve(e)}catch(t){return qe(t)}}},spawn:function(n,e,t){try{var r=vi(n.apply(t,e||[]));return r&&typeof r.then=="function"?r:V.resolve(r)}catch(i){return qe(i)}},currentTransaction:{get:()=>J.trans||null},waitFor:function(n,e){const t=V.resolve(typeof n=="function"?un.ignoreTransaction(n):n).timeout(e||6e4);return J.trans?J.trans.waitFor(t):t},Promise:V,debug:{get:()=>Lt,set:n=>{ds(n,n==="dexie"?()=>!0:Is)}},derive:An,extend:lt,props:On,override:ss,Events:jn,on:sn,liveQuery:ua,extendObservabilitySet:Fs,getByKeyPath:Xt,setByKeyPath:Nt,delByKeyPath:function(n,e){typeof e=="string"?Nt(n,e,void 0):"length"in e&&[].map.call(e,function(t){Nt(n,t,void 0)})},shallowClone:us,deepClone:Jn,getObjectDiff:Ri,cmp:ct,asap:os,minKey:ci,addons:[],connections:Mn,errnames:Ii,dependencies:wi,semVer:Hi,version:Hi.split(".").map(n=>parseInt(n)).reduce((n,e,t)=>n+e/Math.pow(10,2*t))}),un.maxKey=Gn(un.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(sn(Wn,n=>{if(!$t){let e;Br?(e=document.createEvent("CustomEvent"),e.initCustomEvent(tn,!0,!0,n)):e=new CustomEvent(tn,{detail:n}),$t=!0,dispatchEvent(e),$t=!1}}),addEventListener(tn,({detail:n})=>{$t||vr(n)}));let $t=!1;if(typeof BroadcastChannel<"u"){const n=new BroadcastChannel(tn);typeof n.unref=="function"&&n.unref(),sn(Wn,e=>{$t||n.postMessage(e)}),n.onmessage=e=>{e.data&&vr(e.data)}}else if(typeof self<"u"&&typeof navigator<"u"){sn(Wn,e=>{try{$t||(typeof localStorage<"u"&&localStorage.setItem(tn,JSON.stringify({trig:Math.random(),changedParts:e})),typeof self.clients=="object"&&[...self.clients.matchAll({includeUncontrolled:!0})].forEach(t=>t.postMessage({type:tn,changedParts:e})))}catch{}}),typeof addEventListener<"u"&&addEventListener("storage",e=>{if(e.key===tn){const t=JSON.parse(e.newValue);t&&vr(t.changedParts)}});const n=self.document&&navigator.serviceWorker;n&&n.addEventListener("message",function({data:e}){e&&e.type===tn&&vr(e.changedParts)})}V.rejectionMapper=function(n,e){if(!n||n instanceof Sn||n instanceof TypeError||n instanceof SyntaxError||!n.name||!ki[n.name])return n;var t=new ki[n.name](e||n.message,n);return"stack"in n&&Yt(t,"stack",{get:function(){return this.inner.stack}}),t},ds(Lt,Is);const Ht={AbortError:"A request was aborted, for example through a call to IDBTransaction.abort.",ConstraintError:"A mutation operation in the transaction failed because a constraint was not satisfied. For example, an object such as an object store or index already exists and a request attempted to create a new one.",DataCloneError:"The data being stored could not be cloned by the internal structured cloning algorithm.",DataError:"Data provided to an operation does not meet requirements.",InvalidAccessError:"An invalid operation was performed on an object. For example transaction creation attempt was made, but an empty scope was provided.",InvalidStateError:"An operation was called on an object on which it is not allowed or at a time when it is not allowed. Also occurs if a request is made on a source object that has been deleted or removed. Use TransactionInactiveError or ReadOnlyError when possible, as they are more specific variations of InvalidStateError.",NotFoundError:"The operation failed because the requested database object could not be found. For example, an object store did not exist but was being opened.",ReadOnlyError:'The mutating operation was attempted in a "readonly" transaction.',TransactionInactiveError:"A request was placed against a transaction which is currently not active, or which is finished.",VersionError:"An attempt was made to open a database using a lower version than the existing version."};class Ei extends Error{constructor(e=Ht.AbortError){super(),this.name="AbortError",this.message=e}}class on extends Error{constructor(e=Ht.ConstraintError){super(),this.name="ConstraintError",this.message=e}}class ca extends Error{constructor(e=Ht.DataCloneError){super(),this.name="DataCloneError",this.message=e}}class Xe extends Error{constructor(e=Ht.DataError){super(),this.name="DataError",this.message=e}}class _r extends Error{constructor(e=Ht.InvalidAccessError){super(),this.name="InvalidAccessError",this.message=e}}class fe extends Error{constructor(e=Ht.InvalidStateError){super(),this.name="InvalidStateError",this.message=e}}class $n extends Error{constructor(e=Ht.NotFoundError){super(),this.name="NotFoundError",this.message=e}}class Yn extends Error{constructor(e=Ht.ReadOnlyError){super(),this.name="ReadOnlyError",this.message=e}}class Mt extends Error{constructor(e=Ht.TransactionInactiveError){super(),this.name="TransactionInactiveError",this.message=e}}class la extends Error{constructor(e=Ht.VersionError){super(),this.name="VersionError",this.message=e}}const Ce=(n,e)=>{if(typeof n=="number"){if(isNaN(n))throw new Xe;return n}else if(n instanceof Date){const t=n.valueOf();if(isNaN(t))throw new Xe;return new Date(t)}else{if(typeof n=="string")return n;if(n instanceof ArrayBuffer||typeof ArrayBuffer<"u"&&ArrayBuffer.isView&&ArrayBuffer.isView(n))return n instanceof ArrayBuffer?new Uint8Array(n).buffer:new Uint8Array(n.buffer).buffer;if(Array.isArray(n)){if(e===void 0)e=new Set;else if(e.has(n))throw new Xe;e.add(n);const t=[];for(let r=0;r<n.length;r++){if(!n.hasOwnProperty(r))throw new Xe;const s=n[r],o=Ce(s,e);t.push(o)}return t}else throw new Xe}},Yi=n=>{if(typeof n=="number")return"Number";if(n instanceof Date)return"Date";if(Array.isArray(n))return"Array";if(typeof n=="string")return"String";if(n instanceof ArrayBuffer)return"Binary";throw new Xe},ge=(n,e)=>{if(e===void 0)throw new TypeError;n=Ce(n),e=Ce(e);const t=Yi(n),r=Yi(e);if(t!==r)return t==="Array"||t==="Binary"&&(r==="String"||r==="Date"||r==="Number")||t==="String"&&(r==="Date"||r==="Number")||t==="Date"&&r==="Number"?1:-1;if(t==="Binary"&&(n=new Uint8Array(n),e=new Uint8Array(e)),t==="Array"||t==="Binary"){const i=Math.min(n.length,e.length);for(let s=0;s<i;s++){const o=ge(n[s],e[s]);if(o!==0)return o}return n.length>e.length?1:n.length<e.length?-1:0}if(t==="Date"){if(n.getTime()===e.getTime())return 0}else if(n===e)return 0;return n>e?1:-1};class pe{static only(e){if(arguments.length===0)throw new TypeError;return e=Ce(e),new pe(e,e,!1,!1)}static lowerBound(e,t=!1){if(arguments.length===0)throw new TypeError;return e=Ce(e),new pe(e,void 0,t,!0)}static upperBound(e,t=!1){if(arguments.length===0)throw new TypeError;return e=Ce(e),new pe(void 0,e,!0,t)}static bound(e,t,r=!1,i=!1){if(arguments.length<2)throw new TypeError;const s=ge(e,t);if(s===1||s===0&&(r||i))throw new Xe;return e=Ce(e),t=Ce(t),new pe(e,t,r,i)}constructor(e,t,r,i){this.lower=e,this.upper=t,this.lowerOpen=r,this.upperOpen=i}includes(e){if(arguments.length===0)throw new TypeError;if(e=Ce(e),this.lower!==void 0){const t=ge(this.lower,e);if(t===1||t===0&&this.lowerOpen)return!1}if(this.upper!==void 0){const t=ge(this.upper,e);if(t===-1||t===0&&this.upperOpen)return!1}return!0}toString(){return"[object IDBKeyRange]"}}const er=(n,e)=>{if(Array.isArray(n)){const i=[];for(let s of n)s!=null&&typeof s!="string"&&s.toString&&(s=s.toString()),i.push(Ce(er(s,e)));return i}if(n==="")return e;let t=n,r=e;for(;t!==null;){let i;const s=t.indexOf(".");if(s>=0?(i=t.slice(0,s),t=t.slice(s+1)):(i=t,t=null),r==null||!r.hasOwnProperty(i))return;r=r[i]}return r};function lr(n){throw new Error('Could not dynamically require "'+n+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Ps={exports:{}};(function(n,e){(function(t){n.exports=t()})(function(){return function(){function t(r,i,s){function o(h,l){if(!i[h]){if(!r[h]){var d=typeof lr=="function"&&lr;if(!l&&d)return d(h,!0);if(c)return c(h,!0);var p=new Error("Cannot find module '"+h+"'");throw p.code="MODULE_NOT_FOUND",p}var b=i[h]={exports:{}};r[h][0].call(b.exports,function(C){var m=r[h][1][C];return o(m||C)},b,b.exports,t,r,i,s)}return i[h].exports}for(var c=typeof lr=="function"&&lr,a=0;a<s.length;a++)o(s[a]);return o}return t}()({1:[function(t,r,i){var s=t("domexception"),o=t("typeson"),c=t("typeson-registry/dist/presets/structured-cloning-throwing"),a=typeof window<"u"?window:typeof WorkerGlobalScope<"u"?self:typeof Lr<"u"?Lr:Function("return this;")();a.DOMException||(a.DOMException=s);var h=new o().register(c);function l(d){return h.revive(h.encapsulate(d))}r.exports=l},{domexception:5,typeson:8,"typeson-registry/dist/presets/structured-cloning-throwing":7}],2:[function(t,r,i){var s=function(){function l(d,p){var b=[],C=!0,m=!1,v=void 0;try{for(var A=d[Symbol.iterator](),g;!(C=(g=A.next()).done)&&(b.push(g.value),!(p&&b.length===p));C=!0);}catch(O){m=!0,v=O}finally{try{!C&&A.return&&A.return()}finally{if(m)throw v}}return b}return function(d,p){if(Array.isArray(d))return d;if(Symbol.iterator in Object(d))return l(d,p);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=function(){function l(d,p){for(var b=0;b<p.length;b++){var C=p[b];C.enumerable=C.enumerable||!1,C.configurable=!0,"value"in C&&(C.writable=!0),Object.defineProperty(d,C.key,C)}}return function(d,p,b){return p&&l(d.prototype,p),b&&l(d,b),d}}();function c(l,d){if(!(l instanceof d))throw new TypeError("Cannot call a class as a function")}var a=t("./legacy-error-codes.json"),h=t("./utils.js");i.implementation=function(){function l(d){var p=s(d,2),b=p[0],C=p[1];c(this,l),this.name=C,this.message=b}return o(l,[{key:"code",get:function(){return a[this.name]||0}}]),l}(),i.init=function(l){if(Error.captureStackTrace){var d=h.wrapperForImpl(l);Error.captureStackTrace(d,d.constructor)}}},{"./legacy-error-codes.json":4,"./utils.js":6}],3:[function(t,r,i){var s=t("webidl-conversions"),o=t("./utils.js"),c=o.implSymbol;function a(){for(var d=[],p=0;p<arguments.length&&p<2;++p)d[p]=arguments[p];d[0]!==void 0?d[0]=s.DOMString(d[0],{context:"Failed to construct 'DOMException': parameter 1"}):d[0]="",d[1]!==void 0?d[1]=s.DOMString(d[1],{context:"Failed to construct 'DOMException': parameter 2"}):d[1]="Error",h.setup(this,d)}Object.defineProperty(a,"prototype",{value:a.prototype,writable:!1,enumerable:!1,configurable:!1}),Object.defineProperty(a.prototype,"name",{get:function(){return this[c].name},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"message",{get:function(){return this[c].message},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"code",{get:function(){return this[c].code},enumerable:!0,configurable:!0}),Object.defineProperty(a,"INDEX_SIZE_ERR",{value:1,enumerable:!0}),Object.defineProperty(a.prototype,"INDEX_SIZE_ERR",{value:1,enumerable:!0}),Object.defineProperty(a,"DOMSTRING_SIZE_ERR",{value:2,enumerable:!0}),Object.defineProperty(a.prototype,"DOMSTRING_SIZE_ERR",{value:2,enumerable:!0}),Object.defineProperty(a,"HIERARCHY_REQUEST_ERR",{value:3,enumerable:!0}),Object.defineProperty(a.prototype,"HIERARCHY_REQUEST_ERR",{value:3,enumerable:!0}),Object.defineProperty(a,"WRONG_DOCUMENT_ERR",{value:4,enumerable:!0}),Object.defineProperty(a.prototype,"WRONG_DOCUMENT_ERR",{value:4,enumerable:!0}),Object.defineProperty(a,"INVALID_CHARACTER_ERR",{value:5,enumerable:!0}),Object.defineProperty(a.prototype,"INVALID_CHARACTER_ERR",{value:5,enumerable:!0}),Object.defineProperty(a,"NO_DATA_ALLOWED_ERR",{value:6,enumerable:!0}),Object.defineProperty(a.prototype,"NO_DATA_ALLOWED_ERR",{value:6,enumerable:!0}),Object.defineProperty(a,"NO_MODIFICATION_ALLOWED_ERR",{value:7,enumerable:!0}),Object.defineProperty(a.prototype,"NO_MODIFICATION_ALLOWED_ERR",{value:7,enumerable:!0}),Object.defineProperty(a,"NOT_FOUND_ERR",{value:8,enumerable:!0}),Object.defineProperty(a.prototype,"NOT_FOUND_ERR",{value:8,enumerable:!0}),Object.defineProperty(a,"NOT_SUPPORTED_ERR",{value:9,enumerable:!0}),Object.defineProperty(a.prototype,"NOT_SUPPORTED_ERR",{value:9,enumerable:!0}),Object.defineProperty(a,"INUSE_ATTRIBUTE_ERR",{value:10,enumerable:!0}),Object.defineProperty(a.prototype,"INUSE_ATTRIBUTE_ERR",{value:10,enumerable:!0}),Object.defineProperty(a,"INVALID_STATE_ERR",{value:11,enumerable:!0}),Object.defineProperty(a.prototype,"INVALID_STATE_ERR",{value:11,enumerable:!0}),Object.defineProperty(a,"SYNTAX_ERR",{value:12,enumerable:!0}),Object.defineProperty(a.prototype,"SYNTAX_ERR",{value:12,enumerable:!0}),Object.defineProperty(a,"INVALID_MODIFICATION_ERR",{value:13,enumerable:!0}),Object.defineProperty(a.prototype,"INVALID_MODIFICATION_ERR",{value:13,enumerable:!0}),Object.defineProperty(a,"NAMESPACE_ERR",{value:14,enumerable:!0}),Object.defineProperty(a.prototype,"NAMESPACE_ERR",{value:14,enumerable:!0}),Object.defineProperty(a,"INVALID_ACCESS_ERR",{value:15,enumerable:!0}),Object.defineProperty(a.prototype,"INVALID_ACCESS_ERR",{value:15,enumerable:!0}),Object.defineProperty(a,"VALIDATION_ERR",{value:16,enumerable:!0}),Object.defineProperty(a.prototype,"VALIDATION_ERR",{value:16,enumerable:!0}),Object.defineProperty(a,"TYPE_MISMATCH_ERR",{value:17,enumerable:!0}),Object.defineProperty(a.prototype,"TYPE_MISMATCH_ERR",{value:17,enumerable:!0}),Object.defineProperty(a,"SECURITY_ERR",{value:18,enumerable:!0}),Object.defineProperty(a.prototype,"SECURITY_ERR",{value:18,enumerable:!0}),Object.defineProperty(a,"NETWORK_ERR",{value:19,enumerable:!0}),Object.defineProperty(a.prototype,"NETWORK_ERR",{value:19,enumerable:!0}),Object.defineProperty(a,"ABORT_ERR",{value:20,enumerable:!0}),Object.defineProperty(a.prototype,"ABORT_ERR",{value:20,enumerable:!0}),Object.defineProperty(a,"URL_MISMATCH_ERR",{value:21,enumerable:!0}),Object.defineProperty(a.prototype,"URL_MISMATCH_ERR",{value:21,enumerable:!0}),Object.defineProperty(a,"QUOTA_EXCEEDED_ERR",{value:22,enumerable:!0}),Object.defineProperty(a.prototype,"QUOTA_EXCEEDED_ERR",{value:22,enumerable:!0}),Object.defineProperty(a,"TIMEOUT_ERR",{value:23,enumerable:!0}),Object.defineProperty(a.prototype,"TIMEOUT_ERR",{value:23,enumerable:!0}),Object.defineProperty(a,"INVALID_NODE_TYPE_ERR",{value:24,enumerable:!0}),Object.defineProperty(a.prototype,"INVALID_NODE_TYPE_ERR",{value:24,enumerable:!0}),Object.defineProperty(a,"DATA_CLONE_ERR",{value:25,enumerable:!0}),Object.defineProperty(a.prototype,"DATA_CLONE_ERR",{value:25,enumerable:!0}),Object.defineProperty(a.prototype,Symbol.toStringTag,{value:"DOMException",writable:!1,enumerable:!1,configurable:!0});var h={mixedInto:[],is:function(p){if(p){if(p[c]instanceof l.implementation)return!0;for(var b=0;b<r.exports.mixedInto.length;++b)if(p instanceof r.exports.mixedInto[b])return!0}return!1},isImpl:function(p){if(p){if(p instanceof l.implementation)return!0;for(var b=o.wrapperForImpl(p),C=0;C<r.exports.mixedInto.length;++C)if(b instanceof r.exports.mixedInto[C])return!0}return!1},convert:function(p){var b=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},C=b.context,m=C===void 0?"The provided value":C;if(r.exports.is(p))return o.implForWrapper(p);throw new TypeError(m+" is not of type 'DOMException'.")},create:function(p,b){var C=Object.create(a.prototype);return this.setup(C,p,b),C},createImpl:function(p,b){var C=Object.create(a.prototype);return this.setup(C,p,b),o.implForWrapper(C)},_internalSetup:function(p){},setup:function(p,b,C){C||(C={}),C.wrapper=p,this._internalSetup(p),Object.defineProperty(p,c,{value:new l.implementation(b,C),writable:!1,enumerable:!1,configurable:!0}),p[c][o.wrapperSymbol]=p,l.init&&l.init(p[c],C)},interface:a,expose:{Window:{DOMException:a},Worker:{DOMException:a}}};r.exports=h;var l=t(".//DOMException-impl.js")},{".//DOMException-impl.js":2,"./utils.js":6,"webidl-conversions":9}],4:[function(t,r,i){r.exports={IndexSizeError:1,DOMStringSizeError:2,HierarchyRequestError:3,WrongDocumentError:4,InvalidCharacterError:5,NoDataAllowedError:6,NoModificationAllowedError:7,NotFoundError:8,NotSupportedError:9,InUseAttributeError:10,InvalidStateError:11,SyntaxError:12,InvalidModificationError:13,NamespaceError:14,InvalidAccessError:15,ValidationError:16,TypeMismatchError:17,SecurityError:18,NetworkError:19,AbortError:20,URLMismatchError:21,QuotaExceededError:22,TimeoutError:23,InvalidNodeTypeError:24,DataCloneError:25}},{}],5:[function(t,r,i){r.exports=t("./DOMException").interface,Object.setPrototypeOf(r.exports.prototype,Error.prototype)},{"./DOMException":3}],6:[function(t,r,i){var s=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(I){return typeof I}:function(I){return I&&typeof Symbol=="function"&&I.constructor===Symbol&&I!==Symbol.prototype?"symbol":typeof I};function o(I){return(typeof I>"u"?"undefined":s(I))==="object"&&I!==null||typeof I=="function"}function c(I){return Object.getPrototypeOf(I)===Buffer.prototype?I:I instanceof ArrayBuffer?Buffer.from(I):Buffer.from(I.buffer,I.byteOffset,I.byteLength)}function a(I){return Buffer.from(c(I))}function h(I,x){for(var M=Object.getOwnPropertyNames(x),_=0;_<M.length;++_)M[_]in I||Object.defineProperty(I,M[_],Object.getOwnPropertyDescriptor(x,M[_]))}var l=Symbol("wrapper"),d=Symbol("impl"),p=Symbol("SameObject caches");function b(I,x,M){return I[p]||(I[p]=Object.create(null)),x in I[p]||(I[p][x]=M()),I[p][x]}function C(I){return I?I[l]:null}function m(I){return I?I[d]:null}function v(I){var x=C(I);return x||I}function A(I){var x=m(I);return x||I}var g=Symbol("internal"),O=Object.getPrototypeOf(Object.getPrototypeOf([][Symbol.iterator]()));r.exports={isObject:o,getReferenceToBytes:c,getCopyToBytes:a,mixin:h,wrapperSymbol:l,implSymbol:d,getSameObject:b,wrapperForImpl:C,implForWrapper:m,tryWrapperForImpl:v,tryImplForWrapper:A,iterInternalSymbol:g,IteratorPrototype:O}},{}],7:[function(t,r,i){var s=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(o){return typeof o}:function(o){return o&&typeof Symbol=="function"&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o};(function(o,c){(typeof i>"u"?"undefined":s(i))=="object"&&typeof r<"u"?r.exports=c():((o=typeof globalThis<"u"?globalThis:o||self).Typeson=o.Typeson||{},o.Typeson.presets=o.Typeson.presets||{},o.Typeson.presets.structuredCloningThrowing=c())})(void 0,function(){function o(y){return(o=typeof Symbol=="function"&&s(Symbol.iterator)=="symbol"?function(u){return typeof u>"u"?"undefined":s(u)}:function(u){return u&&typeof Symbol=="function"&&u.constructor===Symbol&&u!==Symbol.prototype?"symbol":typeof u>"u"?"undefined":s(u)})(y)}function c(y,u){if(!(y instanceof u))throw new TypeError("Cannot call a class as a function")}function a(y,u){for(var f=0;f<u.length;f++){var w=u[f];w.enumerable=w.enumerable||!1,w.configurable=!0,"value"in w&&(w.writable=!0),Object.defineProperty(y,w.key,w)}}function h(y,u,f){return u in y?Object.defineProperty(y,u,{value:f,enumerable:!0,configurable:!0,writable:!0}):y[u]=f,y}function l(y,u){var f=Object.keys(y);if(Object.getOwnPropertySymbols){var w=Object.getOwnPropertySymbols(y);u&&(w=w.filter(function(S){return Object.getOwnPropertyDescriptor(y,S).enumerable})),f.push.apply(f,w)}return f}function d(y){return function(f){if(Array.isArray(f))return p(f)}(y)||function(f){if(typeof Symbol<"u"&&Symbol.iterator in Object(f))return Array.from(f)}(y)||function(f,w){if(f){if(typeof f=="string")return p(f,w);var S=Object.prototype.toString.call(f).slice(8,-1);if(S==="Object"&&f.constructor&&(S=f.constructor.name),S==="Map"||S==="Set")return Array.from(f);if(S==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(S))return p(f,w)}}(y)||function(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}()}function p(y,u){(u==null||u>y.length)&&(u=y.length);for(var f=0,w=new Array(u);f<u;f++)w[f]=y[f];return w}function b(y){return(b=typeof Symbol=="function"&&s(Symbol.iterator)=="symbol"?function(f){return typeof f>"u"?"undefined":s(f)}:function(f){return f&&typeof Symbol=="function"&&f.constructor===Symbol&&f!==Symbol.prototype?"symbol":typeof f>"u"?"undefined":s(f)})(y)}function C(y,u){if(!(y instanceof u))throw new TypeError("Cannot call a class as a function")}function m(y,u){for(var f=0;f<u.length;f++){var w=u[f];w.enumerable=w.enumerable||!1,w.configurable=!0,"value"in w&&(w.writable=!0),Object.defineProperty(y,w.key,w)}}function v(y,u,f){return u in y?Object.defineProperty(y,u,{value:f,enumerable:!0,configurable:!0,writable:!0}):y[u]=f,y}function A(y,u){var f=Object.keys(y);if(Object.getOwnPropertySymbols){var w=Object.getOwnPropertySymbols(y);u&&(w=w.filter(function(S){return Object.getOwnPropertyDescriptor(y,S).enumerable})),f.push.apply(f,w)}return f}function g(y){for(var u=1;u<arguments.length;u++){var f=arguments[u]!=null?arguments[u]:{};u%2?A(Object(f),!0).forEach(function(w){v(y,w,f[w])}):Object.getOwnPropertyDescriptors?Object.defineProperties(y,Object.getOwnPropertyDescriptors(f)):A(Object(f)).forEach(function(w){Object.defineProperty(y,w,Object.getOwnPropertyDescriptor(f,w))})}return y}function O(y,u){return function(w){if(Array.isArray(w))return w}(y)||function(w,S){if(!(typeof Symbol>"u"||!(Symbol.iterator in Object(w)))){var L=[],W=!0,Z=!1,q=void 0;try{for(var be,ce=w[Symbol.iterator]();!(W=(be=ce.next()).done)&&(L.push(be.value),!S||L.length!==S);W=!0);}catch(we){Z=!0,q=we}finally{try{W||ce.return==null||ce.return()}finally{if(Z)throw q}}return L}}(y,u)||x(y,u)||function(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}()}function I(y){return function(f){if(Array.isArray(f))return M(f)}(y)||function(f){if(typeof Symbol<"u"&&Symbol.iterator in Object(f))return Array.from(f)}(y)||x(y)||function(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}()}function x(y,u){if(y){if(typeof y=="string")return M(y,u);var f=Object.prototype.toString.call(y).slice(8,-1);return f==="Object"&&y.constructor&&(f=y.constructor.name),f==="Map"||f==="Set"?Array.from(y):f==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(f)?M(y,u):void 0}}function M(y,u){(u==null||u>y.length)&&(u=y.length);for(var f=0,w=new Array(u);f<u;f++)w[f]=y[f];return w}var _=function y(u){C(this,y),this.p=new Promise(u)};_.__typeson__type__="TypesonPromise",typeof Symbol<"u"&&(_.prototype[Symbol.toStringTag]="TypesonPromise"),_.prototype.then=function(y,u){var f=this;return new _(function(w,S){f.p.then(function(L){w(y?y(L):L)}).catch(function(L){return u?u(L):Promise.reject(L)}).then(w,S)})},_.prototype.catch=function(y){return this.then(null,y)},_.resolve=function(y){return new _(function(u){u(y)})},_.reject=function(y){return new _(function(u,f){f(y)})},["all","race"].forEach(function(y){_[y]=function(u){return new _(function(f,w){Promise[y](u.map(function(S){return S&&S.constructor&&S.constructor.__typeson__type__==="TypesonPromise"?S.p:S})).then(f,w)})}});var P={}.toString,T={}.hasOwnProperty,$=Object.getPrototypeOf,Y=T.toString;function he(y,u){return Ze(y)&&typeof y.then=="function"&&(!u||typeof y.catch=="function")}function X(y){return P.call(y).slice(8,-1)}function ne(y,u){if(!y||b(y)!=="object")return!1;var f=$(y);if(!f)return u===null;var w=T.call(f,"constructor")&&f.constructor;return typeof w!="function"?u===null:u===w||u!==null&&Y.call(w)===Y.call(u)||typeof u=="function"&&typeof w.__typeson__type__=="string"&&w.__typeson__type__===u.__typeson__type__}function Qe(y){return!(!y||X(y)!=="Object")&&(!$(y)||ne(y,Object))}function Ze(y){return y&&b(y)==="object"}function Me(y){return y.replace(/~/g,"~0").replace(/\./g,"~1")}function et(y){return y.replace(/~1/g,".").replace(/~0/g,"~")}function dt(y,u){if(u==="")return y;var f=u.indexOf(".");if(f>-1){var w=y[et(u.slice(0,f))];return w===void 0?void 0:dt(w,u.slice(f+1))}return y[et(u)]}function Ut(y,u,f){if(u==="")return f;var w=u.indexOf(".");return w>-1?Ut(y[et(u.slice(0,w))],u.slice(w+1),f):(y[et(u)]=f,y)}function $e(y,u,f){return f?u?u(y):y:(y&&y.then||(y=Promise.resolve(y)),u?y.then(u):y)}var Jt=Object.keys,D=Array.isArray,R={}.hasOwnProperty,B=["type","replaced","iterateIn","iterateUnsetNumeric"];function k(y){return function(){for(var u=[],f=0;f<arguments.length;f++)u[f]=arguments[f];try{return Promise.resolve(y.apply(this,u))}catch(w){return Promise.reject(w)}}}function U(y,u){if(y.keypath==="")return-1;var f=y.keypath.match(/\./g)||0,w=u.keypath.match(/\./g)||0;return f&&(f=f.length),w&&(w=w.length),f>w?-1:f<w?1:y.keypath<u.keypath?-1:y.keypath>u.keypath}var j=function(){function y(u){C(this,y),this.options=u,this.plainObjectReplacers=[],this.nonplainObjectReplacers=[],this.revivers={},this.types={}}return function(f,w,S){return w&&m(f.prototype,w),S&&m(f,S),f}(y,[{key:"stringify",value:function(f,w,S,L){L=g(g(g({},this.options),L),{},{stringification:!0});var W=this.encapsulate(f,null,L);return D(W)?JSON.stringify(W[0],w,S):W.then(function(Z){return JSON.stringify(Z,w,S)})}},{key:"stringifySync",value:function(f,w,S,L){return this.stringify(f,w,S,g(g({throwOnBadSyncType:!0},L),{},{sync:!0}))}},{key:"stringifyAsync",value:function(f,w,S,L){return this.stringify(f,w,S,g(g({throwOnBadSyncType:!0},L),{},{sync:!1}))}},{key:"parse",value:function(f,w,S){return S=g(g(g({},this.options),S),{},{parse:!0}),this.revive(JSON.parse(f,w),S)}},{key:"parseSync",value:function(f,w,S){return this.parse(f,w,g(g({throwOnBadSyncType:!0},S),{},{sync:!0}))}},{key:"parseAsync",value:function(f,w,S){return this.parse(f,w,g(g({throwOnBadSyncType:!0},S),{},{sync:!1}))}},{key:"specialTypeNames",value:function(f,w){var S=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return S.returnTypeNames=!0,this.encapsulate(f,w,S)}},{key:"rootTypeName",value:function(f,w){var S=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return S.iterateNone=!0,this.encapsulate(f,w,S)}},{key:"encapsulate",value:function(f,w,S){var L=k(function(re,K){return $e(Promise.all(K.map(function(me){return me[1].p})),function(me){return $e(Promise.all(me.map(k(function(oe){var Ee=!1,De=[],vt=O(K.splice(0,1),1),Ue=O(vt[0],7),mt=Ue[0],It=Ue[2],Se=Ue[3],Ot=Ue[4],Re=Ue[5],bt=Ue[6],ot=le(mt,oe,It,Se,De,!0,bt),Dt=ne(ot,_);return function(kr,tr){var vn=kr();return vn&&vn.then?vn.then(tr):tr(vn)}(function(){if(mt&&Dt)return $e(ot.p,function(xt){return Ot[Re]=xt,Ee=!0,L(re,De)})},function(xt){return Ee?xt:(mt?Ot[Re]=ot:re=Dt?ot.p:ot,L(re,De))})}))),function(){return re})})}),W=(S=g(g({sync:!0},this.options),S)).sync,Z=this,q={},be=[],ce=[],we=[],Ge=!("cyclic"in S)||S.cyclic,Le=S.encapsulateObserver,Pt=le("",f,Ge,w||{},we);function He(re){var K=Object.values(q);if(S.iterateNone)return K.length?K[0]:y.getJSONType(re);if(K.length){if(S.returnTypeNames)return I(new Set(K));re&&Qe(re)&&!R.call(re,"$types")?re.$types=q:re={$:re,$types:{$:q}}}else Ze(re)&&R.call(re,"$types")&&(re={$:re,$types:!0});return!S.returnTypeNames&&re}function Ve(re,K,me){Object.assign(re,K);var oe=B.map(function(Ee){var De=re[Ee];return delete re[Ee],De});me(),B.forEach(function(Ee,De){re[Ee]=oe[De]})}function le(re,K,me,oe,Ee,De,vt){var Ue,mt={},It=b(K),Se=Le?function(Qt){var at=vt||oe.type||y.getJSONType(K);Le(Object.assign(Qt||mt,{keypath:re,value:K,cyclic:me,stateObj:oe,promisesData:Ee,resolvingTypesonPromise:De,awaitingTypesonPromise:ne(K,_)},{type:at}))}:null;if(["string","boolean","number","undefined"].includes(It))return K===void 0||Number.isNaN(K)||K===Number.NEGATIVE_INFINITY||K===Number.POSITIVE_INFINITY?(Ue=oe.replaced?K:Ct(re,K,oe,Ee,!1,De,Se))!==K&&(mt={replaced:Ue}):Ue=K,Se&&Se(),Ue;if(K===null)return Se&&Se(),K;if(me&&!oe.iterateIn&&!oe.iterateUnsetNumeric&&K&&b(K)==="object"){var Ot=be.indexOf(K);if(!(Ot<0))return q[re]="#",Se&&Se({cyclicKeypath:ce[Ot]}),"#"+ce[Ot];me===!0&&(be.push(K),ce.push(re))}var Re,bt=Qe(K),ot=D(K),Dt=(bt||ot)&&(!Z.plainObjectReplacers.length||oe.replaced)||oe.iterateIn?K:Ct(re,K,oe,Ee,bt||ot,null,Se);if(Dt!==K?(Ue=Dt,mt={replaced:Dt}):re===""&&ne(K,_)?(Ee.push([re,K,me,oe,void 0,void 0,oe.type]),Ue=K):ot&&oe.iterateIn!=="object"||oe.iterateIn==="array"?(Re=new Array(K.length),mt={clone:Re}):(["function","symbol"].includes(b(K))||"toJSON"in K||ne(K,_)||ne(K,Promise)||ne(K,ArrayBuffer))&&!bt&&oe.iterateIn!=="object"?Ue=K:(Re={},oe.addLength&&(Re.length=K.length),mt={clone:Re}),Se&&Se(),S.iterateNone)return Re||Ue;if(!Re)return Ue;if(oe.iterateIn){var xt=function(at){var Kt={ownKeys:R.call(K,at)};Ve(oe,Kt,function(){var an=re+(re?".":"")+Me(at),nr=le(an,K[at],!!me,oe,Ee,De);ne(nr,_)?Ee.push([an,nr,!!me,oe,Re,at,oe.type]):nr!==void 0&&(Re[at]=nr)})};for(var kr in K)xt(kr);Se&&Se({endIterateIn:!0,end:!0})}else Jt(K).forEach(function(Qt){var at=re+(re?".":"")+Me(Qt);Ve(oe,{ownKeys:!0},function(){var Kt=le(at,K[Qt],!!me,oe,Ee,De);ne(Kt,_)?Ee.push([at,Kt,!!me,oe,Re,Qt,oe.type]):Kt!==void 0&&(Re[Qt]=Kt)})}),Se&&Se({endIterateOwn:!0,end:!0});if(oe.iterateUnsetNumeric){for(var tr=K.length,vn=function(at){if(!(at in K)){var Kt=re+(re?".":"")+at;Ve(oe,{ownKeys:!1},function(){var an=le(Kt,void 0,!!me,oe,Ee,De);ne(an,_)?Ee.push([Kt,an,!!me,oe,Re,at,oe.type]):an!==void 0&&(Re[at]=an)})}},Mr=0;Mr<tr;Mr++)vn(Mr);Se&&Se({endIterateUnsetNumeric:!0,end:!0})}return Re}function Ct(re,K,me,oe,Ee,De,vt){for(var Ue=Ee?Z.plainObjectReplacers:Z.nonplainObjectReplacers,mt=Ue.length;mt--;){var It=Ue[mt];if(It.test(K,me)){var Se=It.type;if(Z.revivers[Se]){var Ot=q[re];q[re]=Ot?[Se].concat(Ot):Se}return Object.assign(me,{type:Se,replaced:!0}),!W&&It.replaceAsync||It.replace?(vt&&vt({replacing:!0}),le(re,It[W||!It.replaceAsync?"replace":"replaceAsync"](K,me),Ge&&"readonly",me,oe,De,Se)):(vt&&vt({typeDetected:!0}),le(re,K,Ge&&"readonly",me,oe,De,Se))}}return K}return we.length?W&&S.throwOnBadSyncType?function(){throw new TypeError("Sync method requested but async result obtained")}():Promise.resolve(L(Pt,we)).then(He):!W&&S.throwOnBadSyncType?function(){throw new TypeError("Async method requested but sync result obtained")}():S.stringification&&W?[He(Pt)]:W?He(Pt):Promise.resolve(He(Pt))}},{key:"encapsulateSync",value:function(f,w,S){return this.encapsulate(f,w,g(g({throwOnBadSyncType:!0},S),{},{sync:!0}))}},{key:"encapsulateAsync",value:function(f,w,S){return this.encapsulate(f,w,g(g({throwOnBadSyncType:!0},S),{},{sync:!1}))}},{key:"revive",value:function(f,w){var S=f&&f.$types;if(!S)return f;if(S===!0)return f.$;var L=(w=g(g({sync:!0},this.options),w)).sync,W=[],Z={},q=!0;S.$&&Qe(S.$)&&(f=f.$,S=S.$,q=!1);var be=this;function ce(He,Ve){var le=O(be.revivers[He]||[],1)[0];if(!le)throw new Error("Unregistered type: "+He);return L&&!("revive"in le)?Ve:le[L&&le.revive?"revive":!L&&le.reviveAsync?"reviveAsync":"revive"](Ve,Z)}var we=[];function Ge(He){return ne(He,Te)?void 0:He}var Le,Pt=function(){var Ve=[];if(Object.entries(S).forEach(function(le){var Ct=O(le,2),re=Ct[0],K=Ct[1];K!=="#"&&[].concat(K).forEach(function(me){O(be.revivers[me]||[null,{}],2)[1].plain&&(Ve.push({keypath:re,type:me}),delete S[re])})}),Ve.length)return Ve.sort(U).reduce(function le(Ct,re){var K=re.keypath,me=re.type;if(he(Ct))return Ct.then(function(De){return le(De,{keypath:K,type:me})});var oe=dt(f,K);if(ne(oe=ce(me,oe),_))return oe.then(function(De){var vt=Ut(f,K,De);vt===De&&(f=vt)});var Ee=Ut(f,K,oe);Ee===oe&&(f=Ee)},void 0)}();return ne(Pt,_)?Le=Pt.then(function(){return f}):(Le=function He(Ve,le,Ct,re,K){if(!q||Ve!=="$types"){var me=S[Ve],oe=D(le);if(oe||Qe(le)){var Ee=oe?new Array(le.length):{};for(Jt(le).forEach(function(Re){var bt=He(Ve+(Ve?".":"")+Me(Re),le[Re],Ct||Ee,Ee,Re),ot=function(xt){return ne(xt,Te)?Ee[Re]=void 0:xt!==void 0&&(Ee[Re]=xt),xt};ne(bt,_)?we.push(bt.then(function(Dt){return ot(Dt)})):ot(bt)}),le=Ee;W.length;){var De=O(W[0],4),vt=De[0],Ue=De[1],mt=De[2],It=De[3],Se=dt(vt,Ue);if(Se===void 0)break;mt[It]=Se,W.splice(0,1)}}if(!me)return le;if(me==="#"){var Ot=dt(Ct,le.slice(1));return Ot===void 0&&W.push([Ct,le.slice(1),re,K]),Ot}return[].concat(me).reduce(function Re(bt,ot){return ne(bt,_)?bt.then(function(Dt){return Re(Dt,ot)}):ce(ot,bt)},le)}}("",f,null),we.length&&(Le=_.resolve(Le).then(function(He){return _.all([He].concat(we))}).then(function(He){return O(He,1)[0]}))),he(Le)?L&&w.throwOnBadSyncType?function(){throw new TypeError("Sync method requested but async result obtained")}():ne(Le,_)?Le.p.then(Ge):Le:!L&&w.throwOnBadSyncType?function(){throw new TypeError("Async method requested but sync result obtained")}():L?Ge(Le):Promise.resolve(Ge(Le))}},{key:"reviveSync",value:function(f,w){return this.revive(f,g(g({throwOnBadSyncType:!0},w),{},{sync:!0}))}},{key:"reviveAsync",value:function(f,w){return this.revive(f,g(g({throwOnBadSyncType:!0},w),{},{sync:!1}))}},{key:"register",value:function(f,w){return w=w||{},[].concat(f).forEach(function S(L){var W=this;if(D(L))return L.map(function(Z){return S.call(W,Z)});L&&Jt(L).forEach(function(Z){if(Z==="#")throw new TypeError("# cannot be used as a type name as it is reserved for cyclic objects");if(y.JSON_TYPES.includes(Z))throw new TypeError("Plain JSON object types are reserved as type names");var q=L[Z],be=q&&q.testPlainObjects?this.plainObjectReplacers:this.nonplainObjectReplacers,ce=be.filter(function(Ve){return Ve.type===Z});if(ce.length&&(be.splice(be.indexOf(ce[0]),1),delete this.revivers[Z],delete this.types[Z]),typeof q=="function"){var we=q;q={test:function(le){return le&&le.constructor===we},replace:function(le){return g({},le)},revive:function(le){return Object.assign(Object.create(we.prototype),le)}}}else if(D(q)){var Ge=O(q,3);q={test:Ge[0],replace:Ge[1],revive:Ge[2]}}if(q&&q.test){var Le={type:Z,test:q.test.bind(q)};q.replace&&(Le.replace=q.replace.bind(q)),q.replaceAsync&&(Le.replaceAsync=q.replaceAsync.bind(q));var Pt=typeof w.fallback=="number"?w.fallback:w.fallback?0:Number.POSITIVE_INFINITY;if(q.testPlainObjects?this.plainObjectReplacers.splice(Pt,0,Le):this.nonplainObjectReplacers.splice(Pt,0,Le),q.revive||q.reviveAsync){var He={};q.revive&&(He.revive=q.revive.bind(q)),q.reviveAsync&&(He.reviveAsync=q.reviveAsync.bind(q)),this.revivers[Z]=[He,{plain:q.testPlainObjects}]}this.types[Z]=q}},this)},this),this}}]),y}(),Te=function y(){C(this,y)};Te.__typeson__type__="TypesonUndefined",j.Undefined=Te,j.Promise=_,j.isThenable=he,j.toStringTag=X,j.hasConstructorOf=ne,j.isObject=Ze,j.isPlainObject=Qe,j.isUserObject=function y(u){if(!u||X(u)!=="Object")return!1;var f=$(u);return!f||ne(u,Object)||y(f)},j.escapeKeyPathComponent=Me,j.unescapeKeyPathComponent=et,j.getByKeyPath=dt,j.getJSONType=function(u){return u===null?"null":Array.isArray(u)?"array":b(u)},j.JSON_TYPES=["null","boolean","number","string","array","object"];for(var Be={userObject:{test:function(u,f){return j.isUserObject(u)},replace:function(u){return function(w){for(var S=1;S<arguments.length;S++){var L=arguments[S]!=null?arguments[S]:{};S%2?l(Object(L),!0).forEach(function(W){h(w,W,L[W])}):Object.getOwnPropertyDescriptors?Object.defineProperties(w,Object.getOwnPropertyDescriptors(L)):l(Object(L)).forEach(function(W){Object.defineProperty(w,W,Object.getOwnPropertyDescriptor(L,W))})}return w}({},u)},revive:function(u){return u}}},ae=[{arrayNonindexKeys:{testPlainObjects:!0,test:function(u,f){return!!Array.isArray(u)&&(Object.keys(u).some(function(w){return String(Number.parseInt(w))!==w})&&(f.iterateIn="object",f.addLength=!0),!0)},replace:function(u,f){return f.iterateUnsetNumeric=!0,u},revive:function(u){if(Array.isArray(u))return u;var f=[];return Object.keys(u).forEach(function(w){var S=u[w];f[w]=S}),f}}},{sparseUndefined:{test:function(u,f){return u===void 0&&f.ownKeys===!1},replace:function(u){return 0},revive:function(u){}}}],ht={undef:{test:function(u,f){return u===void 0&&(f.ownKeys||!("ownKeys"in f))},replace:function(u){return 0},revive:function(u){return new j.Undefined}}},it={StringObject:{test:function(u){return j.toStringTag(u)==="String"&&o(u)==="object"},replace:function(u){return String(u)},revive:function(u){return new String(u)}},BooleanObject:{test:function(u){return j.toStringTag(u)==="Boolean"&&o(u)==="object"},replace:function(u){return!!u},revive:function(u){return new Boolean(u)}},NumberObject:{test:function(u){return j.toStringTag(u)==="Number"&&o(u)==="object"},replace:function(u){return Number(u)},revive:function(u){return new Number(u)}}},ft=[{nan:{test:function(u){return Number.isNaN(u)},replace:function(u){return"NaN"},revive:function(u){return Number.NaN}}},{infinity:{test:function(u){return u===Number.POSITIVE_INFINITY},replace:function(u){return"Infinity"},revive:function(u){return Number.POSITIVE_INFINITY}}},{negativeInfinity:{test:function(u){return u===Number.NEGATIVE_INFINITY},replace:function(u){return"-Infinity"},revive:function(u){return Number.NEGATIVE_INFINITY}}}],gt={date:{test:function(u){return j.toStringTag(u)==="Date"},replace:function(u){var f=u.getTime();return Number.isNaN(f)?"NaN":f},revive:function(u){return u==="NaN"?new Date(Number.NaN):new Date(u)}}},Ke={regexp:{test:function(u){return j.toStringTag(u)==="RegExp"},replace:function(u){return{source:u.source,flags:(u.global?"g":"")+(u.ignoreCase?"i":"")+(u.multiline?"m":"")+(u.sticky?"y":"")+(u.unicode?"u":"")}},revive:function(u){var f=u.source,w=u.flags;return new RegExp(f,w)}}},St={map:{test:function(u){return j.toStringTag(u)==="Map"},replace:function(u){return d(u.entries())},revive:function(u){return new Map(u)}}},je={set:{test:function(u){return j.toStringTag(u)==="Set"},replace:function(u){return d(u.values())},revive:function(u){return new Set(u)}}},Ie="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",ue=new Uint8Array(256),ze=0;ze<Ie.length;ze++)ue[Ie.charCodeAt(ze)]=ze;var z=function(u,f,w){w==null&&(w=u.byteLength);for(var S=new Uint8Array(u,f||0,w),L=S.length,W="",Z=0;Z<L;Z+=3)W+=Ie[S[Z]>>2],W+=Ie[(3&S[Z])<<4|S[Z+1]>>4],W+=Ie[(15&S[Z+1])<<2|S[Z+2]>>6],W+=Ie[63&S[Z+2]];return L%3==2?W=W.slice(0,-1)+"=":L%3==1&&(W=W.slice(0,-2)+"=="),W},H=function(u){var f,w,S,L,W=u.length,Z=.75*u.length,q=0;u[u.length-1]==="="&&(Z--,u[u.length-2]==="="&&Z--);for(var be=new ArrayBuffer(Z),ce=new Uint8Array(be),we=0;we<W;we+=4)f=ue[u.charCodeAt(we)],w=ue[u.charCodeAt(we+1)],S=ue[u.charCodeAt(we+2)],L=ue[u.charCodeAt(we+3)],ce[q++]=f<<2|w>>4,ce[q++]=(15&w)<<4|S>>2,ce[q++]=(3&S)<<6|63&L;return be},de={arraybuffer:{test:function(u){return j.toStringTag(u)==="ArrayBuffer"},replace:function(u,f){f.buffers||(f.buffers=[]);var w=f.buffers.indexOf(u);return w>-1?{index:w}:(f.buffers.push(u),z(u))},revive:function(u,f){if(f.buffers||(f.buffers=[]),o(u)==="object")return f.buffers[u.index];var w=H(u);return f.buffers.push(w),w}}},se=typeof self>"u"?Lr:self,ye={};["Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array"].forEach(function(y){var u=y,f=se[u];f&&(ye[y.toLowerCase()]={test:function(S){return j.toStringTag(S)===u},replace:function(S,L){var W=S.buffer,Z=S.byteOffset,q=S.length;L.buffers||(L.buffers=[]);var be=L.buffers.indexOf(W);return be>-1?{index:be,byteOffset:Z,length:q}:(L.buffers.push(W),{encoded:z(W),byteOffset:Z,length:q})},revive:function(S,L){L.buffers||(L.buffers=[]);var W,Z=S.byteOffset,q=S.length,be=S.encoded,ce=S.index;return"index"in S?W=L.buffers[ce]:(W=H(be),L.buffers.push(W)),new f(W,Z,q)}})});var Ae={dataview:{test:function(u){return j.toStringTag(u)==="DataView"},replace:function(u,f){var w=u.buffer,S=u.byteOffset,L=u.byteLength;f.buffers||(f.buffers=[]);var W=f.buffers.indexOf(w);return W>-1?{index:W,byteOffset:S,byteLength:L}:(f.buffers.push(w),{encoded:z(w),byteOffset:S,byteLength:L})},revive:function(u,f){f.buffers||(f.buffers=[]);var w,S=u.byteOffset,L=u.byteLength,W=u.encoded,Z=u.index;return"index"in u?w=f.buffers[Z]:(w=H(W),f.buffers.push(w)),new DataView(w,S,L)}}},st={IntlCollator:{test:function(u){return j.hasConstructorOf(u,Intl.Collator)},replace:function(u){return u.resolvedOptions()},revive:function(u){return new Intl.Collator(u.locale,u)}},IntlDateTimeFormat:{test:function(u){return j.hasConstructorOf(u,Intl.DateTimeFormat)},replace:function(u){return u.resolvedOptions()},revive:function(u){return new Intl.DateTimeFormat(u.locale,u)}},IntlNumberFormat:{test:function(u){return j.hasConstructorOf(u,Intl.NumberFormat)},replace:function(u){return u.resolvedOptions()},revive:function(u){return new Intl.NumberFormat(u.locale,u)}}};function Pe(y){for(var u=new Uint8Array(y.length),f=0;f<y.length;f++)u[f]=y.charCodeAt(f);return u.buffer}var Je={file:{test:function(u){return j.toStringTag(u)==="File"},replace:function(u){var f=new XMLHttpRequest;if(f.overrideMimeType("text/plain; charset=x-user-defined"),f.open("GET",URL.createObjectURL(u),!1),f.send(),f.status!==200&&f.status!==0)throw new Error("Bad File access: "+f.status);return{type:u.type,stringContents:f.responseText,name:u.name,lastModified:u.lastModified}},revive:function(u){var f=u.name,w=u.type,S=u.stringContents,L=u.lastModified;return new File([Pe(S)],f,{type:w,lastModified:L})},replaceAsync:function(u){return new j.Promise(function(f,w){var S=new FileReader;S.addEventListener("load",function(){f({type:u.type,stringContents:S.result,name:u.name,lastModified:u.lastModified})}),S.addEventListener("error",function(){w(S.error)}),S.readAsBinaryString(u)})}}},pt={bigint:{test:function(u){return typeof u=="bigint"},replace:function(u){return String(u)},revive:function(u){return BigInt(u)}}},ve={bigintObject:{test:function(u){return o(u)==="object"&&j.hasConstructorOf(u,BigInt)},replace:function(u){return String(u)},revive:function(u){return new Object(BigInt(u))}}},yt={cryptokey:{test:function(u){return j.toStringTag(u)==="CryptoKey"&&u.extractable},replaceAsync:function(u){return new j.Promise(function(f,w){crypto.subtle.exportKey("jwk",u).catch(function(S){w(S)}).then(function(S){f({jwk:S,algorithm:u.algorithm,usages:u.usages})})})},revive:function(u){var f=u.jwk,w=u.algorithm,S=u.usages;return crypto.subtle.importKey("jwk",f,w,!0,S)}}};return[Be,ht,ae,it,ft,gt,Ke,{imagedata:{test:function(u){return j.toStringTag(u)==="ImageData"},replace:function(u){return{array:d(u.data),width:u.width,height:u.height}},revive:function(u){return new ImageData(new Uint8ClampedArray(u.array),u.width,u.height)}}},{imagebitmap:{test:function(u){return j.toStringTag(u)==="ImageBitmap"||u&&u.dataset&&u.dataset.toStringTag==="ImageBitmap"},replace:function(u){var f=document.createElement("canvas");return f.getContext("2d").drawImage(u,0,0),f.toDataURL()},revive:function(u){var f=document.createElement("canvas"),w=f.getContext("2d"),S=document.createElement("img");return S.addEventListener("load",function(){w.drawImage(S,0,0)}),S.src=u,f},reviveAsync:function(u){var f=document.createElement("canvas"),w=f.getContext("2d"),S=document.createElement("img");return S.addEventListener("load",function(){w.drawImage(S,0,0)}),S.src=u,createImageBitmap(f)}}},Je,{file:Je.file,filelist:{test:function(u){return j.toStringTag(u)==="FileList"},replace:function(u){for(var f=[],w=0;w<u.length;w++)f[w]=u.item(w);return f},revive:function(u){return new(function(){function f(){c(this,f),this._files=arguments[0],this.length=this._files.length}return function(S,L,W){return L&&a(S.prototype,L),W&&a(S,W),S}(f,[{key:"item",value:function(S){return this._files[S]}},{key:Symbol.toStringTag,get:function(){return"FileList"}}]),f}())(u)}}},{blob:{test:function(u){return j.toStringTag(u)==="Blob"},replace:function(u){var f=new XMLHttpRequest;if(f.overrideMimeType("text/plain; charset=x-user-defined"),f.open("GET",URL.createObjectURL(u),!1),f.send(),f.status!==200&&f.status!==0)throw new Error("Bad Blob access: "+f.status);return{type:u.type,stringContents:f.responseText}},revive:function(u){var f=u.type,w=u.stringContents;return new Blob([Pe(w)],{type:f})},replaceAsync:function(u){return new j.Promise(function(f,w){var S=new FileReader;S.addEventListener("load",function(){f({type:u.type,stringContents:S.result})}),S.addEventListener("error",function(){w(S.error)}),S.readAsBinaryString(u)})}}}].concat(typeof Map=="function"?St:[],typeof Set=="function"?je:[],typeof ArrayBuffer=="function"?de:[],typeof Uint8Array=="function"?ye:[],typeof DataView=="function"?Ae:[],typeof Intl<"u"?st:[],typeof crypto<"u"?yt:[],typeof BigInt<"u"?[pt,ve]:[]).concat({checkDataCloneException:{test:function(u){var f={}.toString.call(u).slice(8,-1);if(["symbol","function"].includes(o(u))||["Arguments","Module","Error","Promise","WeakMap","WeakSet","Event","MessageChannel"].includes(f)||u&&o(u)==="object"&&typeof u.nodeType=="number"&&typeof u.insertBefore=="function")throw new DOMException("The object cannot be cloned.","DataCloneError");return!1}}})})},{}],8:[function(t,r,i){var s=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(D){return typeof D}:function(D){return D&&typeof Symbol=="function"&&D.constructor===Symbol&&D!==Symbol.prototype?"symbol":typeof D};function o(D){return(o=typeof Symbol=="function"&&s(Symbol.iterator)=="symbol"?function(R){return typeof R>"u"?"undefined":s(R)}:function(R){return R&&typeof Symbol=="function"&&R.constructor===Symbol&&R!==Symbol.prototype?"symbol":typeof R>"u"?"undefined":s(R)})(D)}function c(D,R){if(!(D instanceof R))throw new TypeError("Cannot call a class as a function")}function a(D,R){for(var B=0;B<R.length;B++){var k=R[B];k.enumerable=k.enumerable||!1,k.configurable=!0,"value"in k&&(k.writable=!0),Object.defineProperty(D,k.key,k)}}function h(D,R,B){return R in D?Object.defineProperty(D,R,{value:B,enumerable:!0,configurable:!0,writable:!0}):D[R]=B,D}function l(D,R){var B=Object.keys(D);if(Object.getOwnPropertySymbols){var k=Object.getOwnPropertySymbols(D);R&&(k=k.filter(function(U){return Object.getOwnPropertyDescriptor(D,U).enumerable})),B.push.apply(B,k)}return B}function d(D){for(var R=1;R<arguments.length;R++){var B=arguments[R]!=null?arguments[R]:{};R%2?l(Object(B),!0).forEach(function(k){h(D,k,B[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(D,Object.getOwnPropertyDescriptors(B)):l(Object(B)).forEach(function(k){Object.defineProperty(D,k,Object.getOwnPropertyDescriptor(B,k))})}return D}function p(D,R){return function(k){if(Array.isArray(k))return k}(D)||function(k,U){if(!(typeof Symbol>"u"||!(Symbol.iterator in Object(k)))){var j=[],Te=!0,Be=!1,ae=void 0;try{for(var ht,it=k[Symbol.iterator]();!(Te=(ht=it.next()).done)&&(j.push(ht.value),!U||j.length!==U);Te=!0);}catch(ft){Be=!0,ae=ft}finally{try{Te||it.return==null||it.return()}finally{if(Be)throw ae}}return j}}(D,R)||C(D,R)||function(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}()}function b(D){return function(B){if(Array.isArray(B))return m(B)}(D)||function(B){if(typeof Symbol<"u"&&Symbol.iterator in Object(B))return Array.from(B)}(D)||C(D)||function(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}()}function C(D,R){if(D){if(typeof D=="string")return m(D,R);var B=Object.prototype.toString.call(D).slice(8,-1);return B==="Object"&&D.constructor&&(B=D.constructor.name),B==="Map"||B==="Set"?Array.from(D):B==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(B)?m(D,R):void 0}}function m(D,R){(R==null||R>D.length)&&(R=D.length);for(var B=0,k=new Array(R);B<R;B++)k[B]=D[B];return k}var v=function D(R){c(this,D),this.p=new Promise(R)};v.__typeson__type__="TypesonPromise",typeof Symbol<"u"&&(v.prototype[Symbol.toStringTag]="TypesonPromise"),v.prototype.then=function(D,R){var B=this;return new v(function(k,U){B.p.then(function(j){k(D?D(j):j)}).catch(function(j){return R?R(j):Promise.reject(j)}).then(k,U)})},v.prototype.catch=function(D){return this.then(null,D)},v.resolve=function(D){return new v(function(R){R(D)})},v.reject=function(D){return new v(function(R,B){B(D)})},["all","race","allSettled"].forEach(function(D){v[D]=function(R){return new v(function(B,k){Promise[D](R.map(function(U){return U&&U.constructor&&U.constructor.__typeson__type__==="TypesonPromise"?U.p:U})).then(B,k)})}});var A={}.toString,g={}.hasOwnProperty,O=Object.getPrototypeOf,I=g.toString;function x(D,R){return T(D)&&typeof D.then=="function"&&(!R||typeof D.catch=="function")}function M(D){return A.call(D).slice(8,-1)}function _(D,R){if(!D||o(D)!=="object")return!1;var B=O(D);if(!B)return R===null;var k=g.call(B,"constructor")&&B.constructor;return typeof k!="function"?R===null:R===k||R!==null&&I.call(k)===I.call(R)||typeof R=="function"&&typeof k.__typeson__type__=="string"&&k.__typeson__type__===R.__typeson__type__}function P(D){return!(!D||M(D)!=="Object")&&(!O(D)||_(D,Object))}function T(D){return D&&o(D)==="object"}function $(D){return D.replace(/~/g,"~0").replace(/\./g,"~1")}function Y(D){return D.replace(/~1/g,".").replace(/~0/g,"~")}function he(D,R){if(R==="")return D;var B=R.indexOf(".");if(B>-1){var k=D[Y(R.slice(0,B))];return k===void 0?void 0:he(k,R.slice(B+1))}return D[Y(R)]}function X(D,R,B){if(R==="")return B;var k=R.indexOf(".");return k>-1?X(D[Y(R.slice(0,k))],R.slice(k+1),B):(D[Y(R)]=B,D)}function ne(D,R,B){return B?R?R(D):D:(D&&D.then||(D=Promise.resolve(D)),R?D.then(R):D)}var Qe=Object.keys,Ze=Array.isArray,Me={}.hasOwnProperty,et=["type","replaced","iterateIn","iterateUnsetNumeric"];function dt(D){return function(){for(var R=[],B=0;B<arguments.length;B++)R[B]=arguments[B];try{return Promise.resolve(D.apply(this,R))}catch(k){return Promise.reject(k)}}}function Ut(D,R){if(D.keypath==="")return-1;var B=D.keypath.match(/\./g)||0,k=R.keypath.match(/\./g)||0;return B&&(B=B.length),k&&(k=k.length),B>k?-1:B<k?1:D.keypath<R.keypath?-1:D.keypath>R.keypath}var $e=function(){function D(R){c(this,D),this.options=R,this.plainObjectReplacers=[],this.nonplainObjectReplacers=[],this.revivers={},this.types={}}return function(B,k,U){return k&&a(B.prototype,k),U&&a(B,U),B}(D,[{key:"stringify",value:function(B,k,U,j){j=d(d(d({},this.options),j),{},{stringification:!0});var Te=this.encapsulate(B,null,j);return Ze(Te)?JSON.stringify(Te[0],k,U):Te.then(function(Be){return JSON.stringify(Be,k,U)})}},{key:"stringifySync",value:function(B,k,U,j){return this.stringify(B,k,U,d(d({throwOnBadSyncType:!0},j),{},{sync:!0}))}},{key:"stringifyAsync",value:function(B,k,U,j){return this.stringify(B,k,U,d(d({throwOnBadSyncType:!0},j),{},{sync:!1}))}},{key:"parse",value:function(B,k,U){return U=d(d(d({},this.options),U),{},{parse:!0}),this.revive(JSON.parse(B,k),U)}},{key:"parseSync",value:function(B,k,U){return this.parse(B,k,d(d({throwOnBadSyncType:!0},U),{},{sync:!0}))}},{key:"parseAsync",value:function(B,k,U){return this.parse(B,k,d(d({throwOnBadSyncType:!0},U),{},{sync:!1}))}},{key:"specialTypeNames",value:function(B,k){var U=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return U.returnTypeNames=!0,this.encapsulate(B,k,U)}},{key:"rootTypeName",value:function(B,k){var U=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return U.iterateNone=!0,this.encapsulate(B,k,U)}},{key:"encapsulate",value:function(B,k,U){var j=dt(function(z,H){return ne(Promise.all(H.map(function(de){return de[1].p})),function(de){return ne(Promise.all(de.map(dt(function(se){var ye=!1,Ae=[],st=p(H.splice(0,1),1),Pe=p(st[0],7),Je=Pe[0],pt=Pe[2],ve=Pe[3],yt=Pe[4],y=Pe[5],u=Pe[6],f=ue(Je,se,pt,ve,Ae,!0,u),w=_(f,v);return function(L,W){var Z=L();return Z&&Z.then?Z.then(W):W(Z)}(function(){if(Je&&w)return ne(f.p,function(S){return yt[y]=S,ye=!0,j(z,Ae)})},function(S){return ye?S:(Je?yt[y]=f:z=w?f.p:f,j(z,Ae))})}))),function(){return z})})}),Te=(U=d(d({sync:!0},this.options),U)).sync,Be=this,ae={},ht=[],it=[],ft=[],gt=!("cyclic"in U)||U.cyclic,Ke=U.encapsulateObserver,St=ue("",B,gt,k||{},ft);function je(z){var H=Object.values(ae);if(U.iterateNone)return H.length?H[0]:D.getJSONType(z);if(H.length){if(U.returnTypeNames)return b(new Set(H));z&&P(z)&&!Me.call(z,"$types")?z.$types=ae:z={$:z,$types:{$:ae}}}else T(z)&&Me.call(z,"$types")&&(z={$:z,$types:!0});return!U.returnTypeNames&&z}function Ie(z,H,de){Object.assign(z,H);var se=et.map(function(ye){var Ae=z[ye];return delete z[ye],Ae});de(),et.forEach(function(ye,Ae){z[ye]=se[Ae]})}function ue(z,H,de,se,ye,Ae,st){var Pe,Je={},pt=o(H),ve=Ke?function(be){var ce=st||se.type||D.getJSONType(H);Ke(Object.assign(be||Je,{keypath:z,value:H,cyclic:de,stateObj:se,promisesData:ye,resolvingTypesonPromise:Ae,awaitingTypesonPromise:_(H,v)},{type:ce}))}:null;if(["string","boolean","number","undefined"].includes(pt))return H===void 0||Number.isNaN(H)||H===Number.NEGATIVE_INFINITY||H===Number.POSITIVE_INFINITY?(Pe=se.replaced?H:ze(z,H,se,ye,!1,Ae,ve))!==H&&(Je={replaced:Pe}):Pe=H,ve&&ve(),Pe;if(H===null)return ve&&ve(),H;if(de&&!se.iterateIn&&!se.iterateUnsetNumeric&&H&&o(H)==="object"){var yt=ht.indexOf(H);if(!(yt<0))return ae[z]="#",ve&&ve({cyclicKeypath:it[yt]}),"#"+it[yt];de===!0&&(ht.push(H),it.push(z))}var y,u=P(H),f=Ze(H),w=(u||f)&&(!Be.plainObjectReplacers.length||se.replaced)||se.iterateIn?H:ze(z,H,se,ye,u||f,null,ve);if(w!==H?(Pe=w,Je={replaced:w}):z===""&&_(H,v)?(ye.push([z,H,de,se,void 0,void 0,se.type]),Pe=H):f&&se.iterateIn!=="object"||se.iterateIn==="array"?(y=new Array(H.length),Je={clone:y}):(["function","symbol"].includes(o(H))||"toJSON"in H||_(H,v)||_(H,Promise)||_(H,ArrayBuffer))&&!u&&se.iterateIn!=="object"?Pe=H:(y={},se.addLength&&(y.length=H.length),Je={clone:y}),ve&&ve(),U.iterateNone)return y||Pe;if(!y)return Pe;if(se.iterateIn){var S=function(ce){var we={ownKeys:Me.call(H,ce)};Ie(se,we,function(){var Ge=z+(z?".":"")+$(ce),Le=ue(Ge,H[ce],!!de,se,ye,Ae);_(Le,v)?ye.push([Ge,Le,!!de,se,y,ce,se.type]):Le!==void 0&&(y[ce]=Le)})};for(var L in H)S(L);ve&&ve({endIterateIn:!0,end:!0})}else Qe(H).forEach(function(be){var ce=z+(z?".":"")+$(be);Ie(se,{ownKeys:!0},function(){var we=ue(ce,H[be],!!de,se,ye,Ae);_(we,v)?ye.push([ce,we,!!de,se,y,be,se.type]):we!==void 0&&(y[be]=we)})}),ve&&ve({endIterateOwn:!0,end:!0});if(se.iterateUnsetNumeric){for(var W=H.length,Z=function(ce){if(!(ce in H)){var we=z+(z?".":"")+ce;Ie(se,{ownKeys:!1},function(){var Ge=ue(we,void 0,!!de,se,ye,Ae);_(Ge,v)?ye.push([we,Ge,!!de,se,y,ce,se.type]):Ge!==void 0&&(y[ce]=Ge)})}},q=0;q<W;q++)Z(q);ve&&ve({endIterateUnsetNumeric:!0,end:!0})}return y}function ze(z,H,de,se,ye,Ae,st){for(var Pe=ye?Be.plainObjectReplacers:Be.nonplainObjectReplacers,Je=Pe.length;Je--;){var pt=Pe[Je];if(pt.test(H,de)){var ve=pt.type;if(Be.revivers[ve]){var yt=ae[z];ae[z]=yt?[ve].concat(yt):ve}return Object.assign(de,{type:ve,replaced:!0}),!Te&&pt.replaceAsync||pt.replace?(st&&st({replacing:!0}),ue(z,pt[Te||!pt.replaceAsync?"replace":"replaceAsync"](H,de),gt&&"readonly",de,se,Ae,ve)):(st&&st({typeDetected:!0}),ue(z,H,gt&&"readonly",de,se,Ae,ve))}}return H}return ft.length?Te&&U.throwOnBadSyncType?function(){throw new TypeError("Sync method requested but async result obtained")}():Promise.resolve(j(St,ft)).then(je):!Te&&U.throwOnBadSyncType?function(){throw new TypeError("Async method requested but sync result obtained")}():U.stringification&&Te?[je(St)]:Te?je(St):Promise.resolve(je(St))}},{key:"encapsulateSync",value:function(B,k,U){return this.encapsulate(B,k,d(d({throwOnBadSyncType:!0},U),{},{sync:!0}))}},{key:"encapsulateAsync",value:function(B,k,U){return this.encapsulate(B,k,d(d({throwOnBadSyncType:!0},U),{},{sync:!1}))}},{key:"revive",value:function(B,k){var U=B&&B.$types;if(!U)return B;if(U===!0)return B.$;var j=(k=d(d({sync:!0},this.options),k)).sync,Te=[],Be={},ae=!0;U.$&&P(U.$)&&(B=B.$,U=U.$,ae=!1);var ht=this;function it(je,Ie){var ue=p(ht.revivers[je]||[],1)[0];if(!ue)throw new Error("Unregistered type: "+je);return j&&!("revive"in ue)?Ie:ue[j&&ue.revive?"revive":!j&&ue.reviveAsync?"reviveAsync":"revive"](Ie,Be)}var ft=[];function gt(je){return _(je,Jt)?void 0:je}var Ke,St=function(){var Ie=[];if(Object.entries(U).forEach(function(ue){var ze=p(ue,2),z=ze[0],H=ze[1];H!=="#"&&[].concat(H).forEach(function(de){p(ht.revivers[de]||[null,{}],2)[1].plain&&(Ie.push({keypath:z,type:de}),delete U[z])})}),Ie.length)return Ie.sort(Ut).reduce(function ue(ze,z){var H=z.keypath,de=z.type;if(x(ze))return ze.then(function(Ae){return ue(Ae,{keypath:H,type:de})});var se=he(B,H);if(_(se=it(de,se),v))return se.then(function(Ae){var st=X(B,H,Ae);st===Ae&&(B=st)});var ye=X(B,H,se);ye===se&&(B=ye)},void 0)}();return _(St,v)?Ke=St.then(function(){return B}):(Ke=function je(Ie,ue,ze,z,H){if(!ae||Ie!=="$types"){var de=U[Ie],se=Ze(ue);if(se||P(ue)){var ye=se?new Array(ue.length):{};for(Qe(ue).forEach(function(y){var u=je(Ie+(Ie?".":"")+$(y),ue[y],ze||ye,ye,y),f=function(S){return _(S,Jt)?ye[y]=void 0:S!==void 0&&(ye[y]=S),S};_(u,v)?ft.push(u.then(function(w){return f(w)})):f(u)}),ue=ye;Te.length;){var Ae=p(Te[0],4),st=Ae[0],Pe=Ae[1],Je=Ae[2],pt=Ae[3],ve=he(st,Pe);if(ve===void 0)break;Je[pt]=ve,Te.splice(0,1)}}if(!de)return ue;if(de==="#"){var yt=he(ze,ue.slice(1));return yt===void 0&&Te.push([ze,ue.slice(1),z,H]),yt}return[].concat(de).reduce(function y(u,f){return _(u,v)?u.then(function(w){return y(w,f)}):it(f,u)},ue)}}("",B,null),ft.length&&(Ke=v.resolve(Ke).then(function(je){return v.all([je].concat(ft))}).then(function(je){return p(je,1)[0]}))),x(Ke)?j&&k.throwOnBadSyncType?function(){throw new TypeError("Sync method requested but async result obtained")}():_(Ke,v)?Ke.p.then(gt):Ke:!j&&k.throwOnBadSyncType?function(){throw new TypeError("Async method requested but sync result obtained")}():j?gt(Ke):Promise.resolve(gt(Ke))}},{key:"reviveSync",value:function(B,k){return this.revive(B,d(d({throwOnBadSyncType:!0},k),{},{sync:!0}))}},{key:"reviveAsync",value:function(B,k){return this.revive(B,d(d({throwOnBadSyncType:!0},k),{},{sync:!1}))}},{key:"register",value:function(B,k){return k=k||{},[].concat(B).forEach(function U(j){var Te=this;if(Ze(j))return j.map(function(Be){return U.call(Te,Be)});j&&Qe(j).forEach(function(Be){if(Be==="#")throw new TypeError("# cannot be used as a type name as it is reserved for cyclic objects");if(D.JSON_TYPES.includes(Be))throw new TypeError("Plain JSON object types are reserved as type names");var ae=j[Be],ht=ae&&ae.testPlainObjects?this.plainObjectReplacers:this.nonplainObjectReplacers,it=ht.filter(function(Ie){return Ie.type===Be});if(it.length&&(ht.splice(ht.indexOf(it[0]),1),delete this.revivers[Be],delete this.types[Be]),typeof ae=="function"){var ft=ae;ae={test:function(ue){return ue&&ue.constructor===ft},replace:function(ue){return d({},ue)},revive:function(ue){return Object.assign(Object.create(ft.prototype),ue)}}}else if(Ze(ae)){var gt=p(ae,3);ae={test:gt[0],replace:gt[1],revive:gt[2]}}if(ae&&ae.test){var Ke={type:Be,test:ae.test.bind(ae)};ae.replace&&(Ke.replace=ae.replace.bind(ae)),ae.replaceAsync&&(Ke.replaceAsync=ae.replaceAsync.bind(ae));var St=typeof k.fallback=="number"?k.fallback:k.fallback?0:Number.POSITIVE_INFINITY;if(ae.testPlainObjects?this.plainObjectReplacers.splice(St,0,Ke):this.nonplainObjectReplacers.splice(St,0,Ke),ae.revive||ae.reviveAsync){var je={};ae.revive&&(je.revive=ae.revive.bind(ae)),ae.reviveAsync&&(je.reviveAsync=ae.reviveAsync.bind(ae)),this.revivers[Be]=[je,{plain:ae.testPlainObjects}]}this.types[Be]=ae}},this)},this),this}}]),D}(),Jt=function D(){c(this,D)};Jt.__typeson__type__="TypesonUndefined",$e.Undefined=Jt,$e.Promise=v,$e.isThenable=x,$e.toStringTag=M,$e.hasConstructorOf=_,$e.isObject=T,$e.isPlainObject=P,$e.isUserObject=function D(R){if(!R||M(R)!=="Object")return!1;var B=O(R);return!B||_(R,Object)||D(B)},$e.escapeKeyPathComponent=$,$e.unescapeKeyPathComponent=Y,$e.getByKeyPath=he,$e.getJSONType=function(R){return R===null?"null":Array.isArray(R)?"array":o(R)},$e.JSON_TYPES=["null","boolean","number","string","array","object"],r.exports=$e},{}],9:[function(t,r,i){var s=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(m){return typeof m}:function(m){return m&&typeof Symbol=="function"&&m.constructor===Symbol&&m!==Symbol.prototype?"symbol":typeof m};function o(m,v){return(v&&v.context?v.context:"Value")+" "+m+"."}function c(m){if(m===null)return"Null";switch(typeof m>"u"?"undefined":s(m)){case"undefined":return"Undefined";case"boolean":return"Boolean";case"number":return"Number";case"string":return"String";case"symbol":return"Symbol";case"object":case"function":default:return"Object"}}function a(m){return m>0&&m%1===.5&&!(m&1)||m<0&&m%1===-.5&&(m&1)===1?p(Math.floor(m)):p(Math.round(m))}function h(m){return p(Math.trunc(m))}function l(m){return m<0?-1:1}function d(m,v){var A=m%v;return l(v)!==l(A)?A+v:A}function p(m){return m===0?0:m}function b(m,v){var A=!v.unsigned,g=void 0,O=void 0;m===64?(O=Math.pow(2,53)-1,g=A?-Math.pow(2,53)+1:0):A?(g=-Math.pow(2,m-1),O=Math.pow(2,m-1)-1):(g=0,O=Math.pow(2,m)-1);var I=Math.pow(2,m),x=Math.pow(2,m-1);return function(M,_){_===void 0&&(_={});var P=+M;if(P=p(P),_.enforceRange){if(!Number.isFinite(P))throw new TypeError(o("is not a finite number",_));if(P=h(P),P<g||P>O)throw new TypeError(o("is outside the accepted range of "+g+" to "+O+", inclusive",_));return P}return!Number.isNaN(P)&&_.clamp?(P=Math.min(Math.max(P,g),O),P=a(P),P):!Number.isFinite(P)||P===0?0:(P=h(P),P>=g&&P<=O?P:(P=d(P,I),A&&P>=x?P-I:P))}}i.any=function(m){return m},i.void=function(){},i.boolean=function(m){return!!m},i.byte=b(8,{unsigned:!1}),i.octet=b(8,{unsigned:!0}),i.short=b(16,{unsigned:!1}),i["unsigned short"]=b(16,{unsigned:!0}),i.long=b(32,{unsigned:!1}),i["unsigned long"]=b(32,{unsigned:!0}),i["long long"]=b(64,{unsigned:!1}),i["unsigned long long"]=b(64,{unsigned:!0}),i.double=function(m,v){var A=+m;if(!Number.isFinite(A))throw new TypeError(o("is not a finite floating-point value",v));return A},i["unrestricted double"]=function(m){var v=+m;return v},i.float=function(m,v){var A=+m;if(!Number.isFinite(A))throw new TypeError(o("is not a finite floating-point value",v));if(Object.is(A,-0))return A;var g=Math.fround(A);if(!Number.isFinite(g))throw new TypeError(o("is outside the range of a single-precision floating-point value",v));return g},i["unrestricted float"]=function(m){var v=+m;return isNaN(v)||Object.is(v,-0)?v:Math.fround(v)},i.DOMString=function(m,v){if(v===void 0&&(v={}),v.treatNullAsEmptyString&&m===null)return"";if((typeof m>"u"?"undefined":s(m))==="symbol")throw new TypeError(o("is a symbol, which cannot be converted to a string",v));return String(m)},i.ByteString=function(m,v){for(var A=i.DOMString(m,v),g=void 0,O=0;(g=A.codePointAt(O))!==void 0;++O)if(g>255)throw new TypeError(o("is not a valid ByteString",v));return A},i.USVString=function(m,v){for(var A=i.DOMString(m,v),g=A.length,O=[],I=0;I<g;++I){var x=A.charCodeAt(I);if(x<55296||x>57343)O.push(String.fromCodePoint(x));else if(56320<=x&&x<=57343)O.push(String.fromCodePoint(65533));else if(I===g-1)O.push(String.fromCodePoint(65533));else{var M=A.charCodeAt(I+1);if(56320<=M&&M<=57343){var _=x&1023,P=M&1023;O.push(String.fromCodePoint(65536+1024*_+P)),++I}else O.push(String.fromCodePoint(65533))}}return O.join("")},i.object=function(m,v){if(c(m)!=="Object")throw new TypeError(o("is not an object",v));return m};function C(m,v){if(typeof m!="function")throw new TypeError(o("is not a function",v));return m}[Error,ArrayBuffer,DataView,Int8Array,Int16Array,Int32Array,Uint8Array,Uint16Array,Uint32Array,Uint8ClampedArray,Float32Array,Float64Array].forEach(function(m){var v=m.name,A=/^[AEIOU]/.test(v)?"an":"a";i[v]=function(g,O){if(!(g instanceof m))throw new TypeError(o("is not "+A+" "+v+" object",O));return g}}),i.ArrayBufferView=function(m,v){if(!ArrayBuffer.isView(m))throw new TypeError(o("is not a view on an ArrayBuffer object",v));return m},i.BufferSource=function(m,v){if(!(ArrayBuffer.isView(m)||m instanceof ArrayBuffer))throw new TypeError(o("is not an ArrayBuffer object or a view on one",v));return m},i.DOMTimeStamp=i["unsigned long long"],i.Function=C,i.VoidFunction=C},{}]},{},[1])(1)})})(Ps);var da=Ps.exports;const ha=yo(da),Rt=n=>{if(typeof structuredClone<"u")return structuredClone(n);try{return ha(n)}catch{throw new ca}},Rn=n=>n.source instanceof Bt?n.source:n.source.objectStore,dr=(n,e,t)=>{let r=n!==void 0?n.lower:void 0,i=n!==void 0?n.upper:void 0;for(const s of e)s!==void 0&&(r===void 0||ge(r,s)===1)&&(r=s);for(const s of t)s!==void 0&&(i===void 0||ge(i,s)===-1)&&(i=s);if(r!==void 0&&i!==void 0)return pe.bound(r,i);if(r!==void 0)return pe.lowerBound(r);if(i!==void 0)return pe.upperBound(i)};class Xn{_gotValue=!1;_position=void 0;_objectStorePosition=void 0;_keyOnly=!1;_key=void 0;_primaryKey=void 0;constructor(e,t,r="next",i,s=!1){this._range=t,this._source=e,this._direction=r,this._request=i,this._keyOnly=s}get source(){return this._source}set source(e){}get request(){return this._request}set request(e){}get direction(){return this._direction}set direction(e){}get key(){return this._key}set key(e){}get primaryKey(){return this._primaryKey}set primaryKey(e){}_iterate(e,t){const r=this.source instanceof Bt,i=this.source instanceof Bt?this.source._rawObjectStore.records:this.source._rawIndex.records;let s;if(this.direction==="next"){const c=dr(this._range,[e,this._position],[]);for(const a of i.values(c)){const h=e!==void 0?ge(a.key,e):void 0,l=this._position!==void 0?ge(a.key,this._position):void 0;if(!(e!==void 0&&h===-1)){if(t!==void 0){if(h===-1)continue;const d=ge(a.value,t);if(h===0&&d===-1)continue}if(!(this._position!==void 0&&r&&l!==1)&&!(this._position!==void 0&&!r&&(l===-1||l===0&&ge(a.value,this._objectStorePosition)!==1))&&!(this._range!==void 0&&!this._range.includes(a.key))){s=a;break}}}}else if(this.direction==="nextunique"){const c=dr(this._range,[e,this._position],[]);for(const a of i.values(c))if(!(e!==void 0&&ge(a.key,e)===-1)&&!(this._position!==void 0&&ge(a.key,this._position)!==1)&&!(this._range!==void 0&&!this._range.includes(a.key))){s=a;break}}else if(this.direction==="prev"){const c=dr(this._range,[],[e,this._position]);for(const a of i.values(c,"prev")){const h=e!==void 0?ge(a.key,e):void 0,l=this._position!==void 0?ge(a.key,this._position):void 0;if(!(e!==void 0&&h===1)){if(t!==void 0){if(h===1)continue;const d=ge(a.value,t);if(h===0&&d===1)continue}if(!(this._position!==void 0&&r&&l!==-1)&&!(this._position!==void 0&&!r&&(l===1||l===0&&ge(a.value,this._objectStorePosition)!==-1))&&!(this._range!==void 0&&!this._range.includes(a.key))){s=a;break}}}}else if(this.direction==="prevunique"){let c;const a=dr(this._range,[],[e,this._position]);for(const h of i.values(a,"prev"))if(!(e!==void 0&&ge(h.key,e)===1)&&!(this._position!==void 0&&ge(h.key,this._position)!==-1)&&!(this._range!==void 0&&!this._range.includes(h.key))){c=h;break}c&&(s=i.get(c.key))}let o;if(!s)this._key=void 0,r||(this._objectStorePosition=void 0),!this._keyOnly&&this.toString()==="[object IDBCursorWithValue]"&&(this.value=void 0),o=null;else{if(this._position=s.key,r||(this._objectStorePosition=s.value),this._key=s.key,r)this._primaryKey=Rt(s.key),!this._keyOnly&&this.toString()==="[object IDBCursorWithValue]"&&(this.value=Rt(s.value));else if(this._primaryKey=Rt(s.value),!this._keyOnly&&this.toString()==="[object IDBCursorWithValue]"){if(this.source instanceof Bt)throw new Error("This should never happen");const c=this.source.objectStore._rawObjectStore.getValue(s.value);this.value=Rt(c)}this._gotValue=!0,o=this}return o}update(e){if(e===void 0)throw new TypeError;const t=Rn(this),r=this.source.hasOwnProperty("_rawIndex")?this.primaryKey:this._position,i=t.transaction;if(i._state!=="active")throw new Mt;if(i.mode==="readonly")throw new Yn;if(t._rawObjectStore.deleted)throw new fe;if(!(this.source instanceof Bt)&&this.source._rawIndex.deleted)throw new fe;if(!this._gotValue||!this.hasOwnProperty("value"))throw new fe;const s=Rt(e);if(t.keyPath!==null){let c;try{c=er(t.keyPath,s)}catch{}if(ge(c,r)!==0)throw new Xe}const o={key:r,value:s};return i._execRequestAsync({operation:t._rawObjectStore.storeRecord.bind(t._rawObjectStore,o,!1,i._rollbackLog),source:this})}advance(e){if(!Number.isInteger(e)||e<=0)throw new TypeError;const t=Rn(this),r=t.transaction;if(r._state!=="active")throw new Mt;if(t._rawObjectStore.deleted)throw new fe;if(!(this.source instanceof Bt)&&this.source._rawIndex.deleted)throw new fe;if(!this._gotValue)throw new fe;this._request&&(this._request.readyState="pending"),r._execRequestAsync({operation:()=>{let i;for(let s=0;s<e&&(i=this._iterate(),!!i);s++);return i},request:this._request,source:this.source}),this._gotValue=!1}continue(e){const t=Rn(this),r=t.transaction;if(r._state!=="active")throw new Mt;if(t._rawObjectStore.deleted)throw new fe;if(!(this.source instanceof Bt)&&this.source._rawIndex.deleted)throw new fe;if(!this._gotValue)throw new fe;if(e!==void 0){e=Ce(e);const i=ge(e,this._position);if(i<=0&&(this.direction==="next"||this.direction==="nextunique")||i>=0&&(this.direction==="prev"||this.direction==="prevunique"))throw new Xe}this._request&&(this._request.readyState="pending"),r._execRequestAsync({operation:this._iterate.bind(this,e),request:this._request,source:this.source}),this._gotValue=!1}continuePrimaryKey(e,t){const r=Rn(this),i=r.transaction;if(i._state!=="active")throw new Mt;if(r._rawObjectStore.deleted)throw new fe;if(!(this.source instanceof Bt)&&this.source._rawIndex.deleted)throw new fe;if(this.source instanceof Bt||this.direction!=="next"&&this.direction!=="prev")throw new _r;if(!this._gotValue)throw new fe;if(e===void 0||t===void 0)throw new Xe;e=Ce(e);const s=ge(e,this._position);if(s===-1&&this.direction==="next"||s===1&&this.direction==="prev")throw new Xe;const o=ge(t,this._objectStorePosition);if(s===0&&(o<=0&&this.direction==="next"||o>=0&&this.direction==="prev"))throw new Xe;this._request&&(this._request.readyState="pending"),i._execRequestAsync({operation:this._iterate.bind(this,e,t),request:this._request,source:this.source}),this._gotValue=!1}delete(){const e=Rn(this),t=this.source.hasOwnProperty("_rawIndex")?this.primaryKey:this._position,r=e.transaction;if(r._state!=="active")throw new Mt;if(r.mode==="readonly")throw new Yn;if(e._rawObjectStore.deleted)throw new fe;if(!(this.source instanceof Bt)&&this.source._rawIndex.deleted)throw new fe;if(!this._gotValue||!this.hasOwnProperty("value"))throw new fe;return r._execRequestAsync({operation:e._rawObjectStore.deleteRecord.bind(e._rawObjectStore,t,r._rollbackLog),source:this})}toString(){return"[object IDBCursor]"}}class ks extends Xn{value=void 0;constructor(e,t,r,i){super(e,t,r,i)}toString(){return"[object IDBCursorWithValue]"}}const Xi=(n,e)=>n.immediatePropagationStopped||n.eventPhase===n.CAPTURING_PHASE&&e.capture===!1||n.eventPhase===n.BUBBLING_PHASE&&e.capture===!0,$r=(n,e)=>{n.currentTarget=e;for(const s of e.listeners.slice())n.type!==s.type||Xi(n,s)||s.callback.call(n.currentTarget,n);const r={abort:"onabort",blocked:"onblocked",complete:"oncomplete",error:"onerror",success:"onsuccess",upgradeneeded:"onupgradeneeded",versionchange:"onversionchange"}[n.type];if(r===void 0)throw new Error(`Unknown event type: "${n.type}"`);const i=n.currentTarget[r];if(i){const s={callback:i,capture:!1,type:n.type};Xi(n,s)||s.callback.call(n.currentTarget,n)}};class Fi{listeners=[];addEventListener(e,t,r=!1){this.listeners.push({callback:t,capture:r,type:e})}removeEventListener(e,t,r=!1){const i=this.listeners.findIndex(s=>s.type===e&&s.callback===t&&s.capture===r);this.listeners.splice(i,1)}dispatchEvent(e){if(e.dispatched||!e.initialized)throw new fe("The object is in an invalid state.");e.isTrusted=!1,e.dispatched=!0,e.target=this,e.eventPhase=e.CAPTURING_PHASE;for(const t of e.eventPath)e.propagationStopped||$r(e,t);if(e.eventPhase=e.AT_TARGET,e.propagationStopped||$r(e,e.target),e.bubbles){e.eventPath.reverse(),e.eventPhase=e.BUBBLING_PHASE;for(const t of e.eventPath)e.propagationStopped||$r(e,t)}return e.dispatched=!1,e.eventPhase=e.NONE,e.currentTarget=null,!e.canceled}}class mn extends Fi{_result=null;_error=null;source=null;transaction=null;readyState="pending";onsuccess=null;onerror=null;get error(){if(this.readyState==="pending")throw new fe;return this._error}set error(e){this._error=e}get result(){if(this.readyState==="pending")throw new fe;return this._result}set result(e){this._result=e}toString(){return"[object IDBRequest]"}}const zn=(n,e)=>{const r=e==="unsigned long"?4294967295:9007199254740991;if(isNaN(n)||n<0||n>r)throw new TypeError;if(n>=0)return Math.floor(n)};class ut extends Array{contains(e){for(const t of this)if(e===t)return!0;return!1}item(e){return e<0||e>=this.length?null:this[e]}_push(...e){return Array.prototype.push.call(this,...e)}_sort(...e){return Array.prototype.sort.call(this,...e)}}const Tr=(n,e=!1)=>{if(n instanceof pe)return n;if(n==null){if(e)throw new Xe;return new pe(void 0,void 0,!1,!1)}const t=Ce(n);return pe.only(t)},cn=n=>{if(n._rawIndex.deleted||n.objectStore._rawObjectStore.deleted)throw new fe;if(n.objectStore.transaction._state!=="active")throw new Mt};class zi{constructor(e,t){this._rawIndex=t,this._name=t.name,this.objectStore=e,this.keyPath=t.keyPath,this.multiEntry=t.multiEntry,this.unique=t.unique}get name(){return this._name}set name(e){const t=this.objectStore.transaction;if(!t.db._runningVersionchangeTransaction)throw new fe;if(t._state!=="active")throw new Mt;if(this._rawIndex.deleted||this.objectStore._rawObjectStore.deleted)throw new fe;if(e=String(e),e===this._name)return;if(this.objectStore.indexNames.contains(e))throw new on;const r=this._name,i=[...this.objectStore.indexNames];this._name=e,this._rawIndex.name=e,this.objectStore._indexesCache.delete(r),this.objectStore._indexesCache.set(e,this),this.objectStore._rawObjectStore.rawIndexes.delete(r),this.objectStore._rawObjectStore.rawIndexes.set(e,this._rawIndex),this.objectStore.indexNames=new ut(...Array.from(this.objectStore._rawObjectStore.rawIndexes.keys()).filter(s=>{const o=this.objectStore._rawObjectStore.rawIndexes.get(s);return o&&!o.deleted}).sort()),t._rollbackLog.push(()=>{this._name=r,this._rawIndex.name=r,this.objectStore._indexesCache.delete(e),this.objectStore._indexesCache.set(r,this),this.objectStore._rawObjectStore.rawIndexes.delete(e),this.objectStore._rawObjectStore.rawIndexes.set(r,this._rawIndex),this.objectStore.indexNames=new ut(...i)})}openCursor(e,t){cn(this),e===null&&(e=void 0),e!==void 0&&!(e instanceof pe)&&(e=pe.only(Ce(e)));const r=new mn;r.source=this,r.transaction=this.objectStore.transaction;const i=new ks(this,e,t,r);return this.objectStore.transaction._execRequestAsync({operation:i._iterate.bind(i),request:r,source:this})}openKeyCursor(e,t){cn(this),e===null&&(e=void 0),e!==void 0&&!(e instanceof pe)&&(e=pe.only(Ce(e)));const r=new mn;r.source=this,r.transaction=this.objectStore.transaction;const i=new Xn(this,e,t,r,!0);return this.objectStore.transaction._execRequestAsync({operation:i._iterate.bind(i),request:r,source:this})}get(e){return cn(this),e instanceof pe||(e=Ce(e)),this.objectStore.transaction._execRequestAsync({operation:this._rawIndex.getValue.bind(this._rawIndex,e),source:this})}getAll(e,t){arguments.length>1&&t!==void 0&&(t=zn(t,"unsigned long")),cn(this);const r=Tr(e);return this.objectStore.transaction._execRequestAsync({operation:this._rawIndex.getAllValues.bind(this._rawIndex,r,t),source:this})}getKey(e){return cn(this),e instanceof pe||(e=Ce(e)),this.objectStore.transaction._execRequestAsync({operation:this._rawIndex.getKey.bind(this._rawIndex,e),source:this})}getAllKeys(e,t){arguments.length>1&&t!==void 0&&(t=zn(t,"unsigned long")),cn(this);const r=Tr(e);return this.objectStore.transaction._execRequestAsync({operation:this._rawIndex.getAllKeys.bind(this._rawIndex,r,t),source:this})}count(e){return cn(this),e===null&&(e=void 0),e!==void 0&&!(e instanceof pe)&&(e=pe.only(Ce(e))),this.objectStore.transaction._execRequestAsync({operation:()=>{let t=0;const r=new Xn(this,e);for(;r._iterate()!==null;)t+=1;return t},source:this})}toString(){return"[object IDBIndex]"}}const fa=(n,e)=>{if(Array.isArray(n))throw new Error("The key paths used in this section are always strings and never sequences, since it is not possible to create a object store which has a key generator and also has a key path that is a sequence.");const t=n.split(".");if(t.length===0)throw new Error("Assert: identifiers is not empty");t.pop();for(const r of t){if(typeof e!="object"&&!Array.isArray(e))return!1;if(!e.hasOwnProperty(r))return!0;e=e[r]}return typeof e=="object"||Array.isArray(e)};function Dr(n,e){let t=0,r=n.length,i;for(;t<r;)i=t+r>>>1,ge(n[i].key,e)<0?t=i+1:r=i;return t}function Ms(n,e){const t=Dr(n,e),r=n[t];return r&&ge(r.key,e)===0?t:-1}function pa(n,e){const t=Ms(n,e);return n[t]}function js(n,e){const t=typeof e.lower>"u"?0:Dr(n,e.lower),r=typeof e.upper>"u"?n.length-1:Dr(n,e.upper);for(let i=t;i<=r;i++){const s=n[i];if(s&&e.includes(s.key))return i}return-1}function ya(n,e){const t=js(n,e);return n[t]}function ma(n,e){const t=Dr(n,e),r=n[t];return r&&ge(r.key,e)>=0?t:-1}class Ls{records=[];get(e){return e instanceof pe?ya(this.records,e):pa(this.records,e)}add(e){let t;if(this.records.length===0)t=0;else if(t=ma(this.records,e.key),t===-1)t=this.records.length;else for(;t<this.records.length&&ge(this.records[t].key,e.key)===0&&ge(this.records[t].value,e.value)===-1;)t+=1;this.records.splice(t,0,e)}delete(e){const t=[],r=e instanceof pe;for(;;){const i=r?js(this.records,e):Ms(this.records,e);if(i===-1)break;t.push(this.records[i]),this.records.splice(i,1)}return t}deleteByValue(e){const t=e instanceof pe?e:pe.only(e),r=[];return this.records=this.records.filter(i=>{const s=t.includes(i.value);return s&&r.push(i),!s}),r}clear(){const e=this.records.slice();return this.records=[],e}values(e,t="next"){return{[Symbol.iterator]:()=>{let r;if(t==="next"){if(r=0,e!==void 0&&e.lower!==void 0)for(;this.records[r]!==void 0;){const i=ge(this.records[r].key,e.lower);if(i===1||i===0&&!e.lowerOpen)break;r+=1}}else if(r=this.records.length-1,e!==void 0&&e.upper!==void 0)for(;this.records[r]!==void 0;){const i=ge(this.records[r].key,e.upper);if(i===-1||i===0&&!e.upperOpen)break;r-=1}return{next:()=>{let i,s;if(t==="next"){if(s=this.records[r],i=r>=this.records.length,r+=1,!i&&e!==void 0&&e.upper!==void 0){const o=ge(s.key,e.upper);i=o===1||o===0&&e.upperOpen,i&&(s=void 0)}}else if(s=this.records[r],i=r<0,r-=1,!i&&e!==void 0&&e.lower!==void 0){const o=ge(s.key,e.lower);i=o===-1||o===0&&e.lowerOpen,i&&(s=void 0)}return{done:i,value:s}}}}}}}class ga{deleted=!1;initialized=!1;records=new Ls;constructor(e,t,r,i,s){this.rawObjectStore=e,this.name=t,this.keyPath=r,this.multiEntry=i,this.unique=s}getKey(e){const t=this.records.get(e);return t!==void 0?t.value:void 0}getAllKeys(e,t){(t===void 0||t===0)&&(t=1/0);const r=[];for(const i of this.records.values(e))if(r.push(Rt(i.value)),r.length>=t)break;return r}getValue(e){const t=this.records.get(e);return t!==void 0?this.rawObjectStore.getValue(t.value):void 0}getAllValues(e,t){(t===void 0||t===0)&&(t=1/0);const r=[];for(const i of this.records.values(e))if(r.push(this.rawObjectStore.getValue(i.value)),r.length>=t)break;return r}storeRecord(e){let t;try{t=er(this.keyPath,e.value)}catch(r){if(r.name==="DataError")return;throw r}if(!this.multiEntry||!Array.isArray(t))try{Ce(t)}catch{return}else{const r=[];for(const i of t)if(r.indexOf(i)<0)try{r.push(Ce(i))}catch{}t=r}if(!this.multiEntry||!Array.isArray(t)){if(this.unique&&this.records.get(t))throw new on}else if(this.unique){for(const r of t)if(this.records.get(r))throw new on}if(!this.multiEntry||!Array.isArray(t))this.records.add({key:t,value:e.key});else for(const r of t)this.records.add({key:r,value:e.key})}initialize(e){if(this.initialized)throw new Error("Index already initialized");e._execRequestAsync({operation:()=>{try{for(const t of this.rawObjectStore.records.values())this.storeRecord(t);this.initialized=!0}catch(t){e._abort(t.name)}},source:null})}}const xr=(n,e)=>{if(n!=null&&typeof n!="string"&&n.toString&&(e==="array"||!Array.isArray(n))&&(n=n.toString()),typeof n=="string"){if(n===""&&e!=="string")return;try{const t=/^(?:[\$A-Z_a-z\xAA\xB5\xBA\xC0-\xD6\xD8-\xF6\xF8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0370-\u0374\u0376\u0377\u037A-\u037D\u037F\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u048A-\u052F\u0531-\u0556\u0559\u0561-\u0587\u05D0-\u05EA\u05F0-\u05F2\u0620-\u064A\u066E\u066F\u0671-\u06D3\u06D5\u06E5\u06E6\u06EE\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u07F4\u07F5\u07FA\u0800-\u0815\u081A\u0824\u0828\u0840-\u0858\u08A0-\u08B2\u0904-\u0939\u093D\u0950\u0958-\u0961\u0971-\u0980\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC\u09DD\u09DF-\u09E1\u09F0\u09F1\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0\u0AE1\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3D\u0B5C\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C39\u0C3D\u0C58\u0C59\u0C60\u0C61\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDE\u0CE0\u0CE1\u0CF1\u0CF2\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D\u0D4E\u0D60\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32\u0E33\u0E40-\u0E46\u0E81\u0E82\u0E84\u0E87\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA\u0EAB\u0EAD-\u0EB0\u0EB2\u0EB3\u0EBD\u0EC0-\u0EC4\u0EC6\u0EDC-\u0EDF\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8C\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065\u1066\u106E-\u1070\u1075-\u1081\u108E\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u13A0-\u13F4\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u16EE-\u16F8\u1700-\u170C\u170E-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17D7\u17DC\u1820-\u1877\u1880-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191E\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19C1-\u19C7\u1A00-\u1A16\u1A20-\u1A54\u1AA7\u1B05-\u1B33\u1B45-\u1B4B\u1B83-\u1BA0\u1BAE\u1BAF\u1BBA-\u1BE5\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C7D\u1CE9-\u1CEC\u1CEE-\u1CF1\u1CF5\u1CF6\u1D00-\u1DBF\u1E00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u2071\u207F\u2090-\u209C\u2102\u2107\u210A-\u2113\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u212F-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2160-\u2188\u2C00-\u2C2E\u2C30-\u2C5E\u2C60-\u2CE4\u2CEB-\u2CEE\u2CF2\u2CF3\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u2E2F\u3005-\u3007\u3021-\u3029\u3031-\u3035\u3038-\u303C\u3041-\u3096\u309D-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312D\u3131-\u318E\u31A0-\u31BA\u31F0-\u31FF\u3400-\u4DB5\u4E00-\u9FCC\uA000-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA61F\uA62A\uA62B\uA640-\uA66E\uA67F-\uA69D\uA6A0-\uA6EF\uA717-\uA71F\uA722-\uA788\uA78B-\uA78E\uA790-\uA7AD\uA7B0\uA7B1\uA7F7-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uA9CF\uA9E0-\uA9E4\uA9E6-\uA9EF\uA9FA-\uA9FE\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA76\uAA7A\uAA7E-\uAAAF\uAAB1\uAAB5\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADD\uAAE0-\uAAEA\uAAF2-\uAAF4\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uAB30-\uAB5A\uAB5C-\uAB5F\uAB64\uAB65\uABC0-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF21-\uFF3A\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC])(?:[\$0-9A-Z_a-z\xAA\xB5\xBA\xC0-\xD6\xD8-\xF6\xF8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0300-\u0374\u0376\u0377\u037A-\u037D\u037F\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u0483-\u0487\u048A-\u052F\u0531-\u0556\u0559\u0561-\u0587\u0591-\u05BD\u05BF\u05C1\u05C2\u05C4\u05C5\u05C7\u05D0-\u05EA\u05F0-\u05F2\u0610-\u061A\u0620-\u0669\u066E-\u06D3\u06D5-\u06DC\u06DF-\u06E8\u06EA-\u06FC\u06FF\u0710-\u074A\u074D-\u07B1\u07C0-\u07F5\u07FA\u0800-\u082D\u0840-\u085B\u08A0-\u08B2\u08E4-\u0963\u0966-\u096F\u0971-\u0983\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BC-\u09C4\u09C7\u09C8\u09CB-\u09CE\u09D7\u09DC\u09DD\u09DF-\u09E3\u09E6-\u09F1\u0A01-\u0A03\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A3C\u0A3E-\u0A42\u0A47\u0A48\u0A4B-\u0A4D\u0A51\u0A59-\u0A5C\u0A5E\u0A66-\u0A75\u0A81-\u0A83\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABC-\u0AC5\u0AC7-\u0AC9\u0ACB-\u0ACD\u0AD0\u0AE0-\u0AE3\u0AE6-\u0AEF\u0B01-\u0B03\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3C-\u0B44\u0B47\u0B48\u0B4B-\u0B4D\u0B56\u0B57\u0B5C\u0B5D\u0B5F-\u0B63\u0B66-\u0B6F\u0B71\u0B82\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BBE-\u0BC2\u0BC6-\u0BC8\u0BCA-\u0BCD\u0BD0\u0BD7\u0BE6-\u0BEF\u0C00-\u0C03\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C39\u0C3D-\u0C44\u0C46-\u0C48\u0C4A-\u0C4D\u0C55\u0C56\u0C58\u0C59\u0C60-\u0C63\u0C66-\u0C6F\u0C81-\u0C83\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBC-\u0CC4\u0CC6-\u0CC8\u0CCA-\u0CCD\u0CD5\u0CD6\u0CDE\u0CE0-\u0CE3\u0CE6-\u0CEF\u0CF1\u0CF2\u0D01-\u0D03\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D-\u0D44\u0D46-\u0D48\u0D4A-\u0D4E\u0D57\u0D60-\u0D63\u0D66-\u0D6F\u0D7A-\u0D7F\u0D82\u0D83\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0DCA\u0DCF-\u0DD4\u0DD6\u0DD8-\u0DDF\u0DE6-\u0DEF\u0DF2\u0DF3\u0E01-\u0E3A\u0E40-\u0E4E\u0E50-\u0E59\u0E81\u0E82\u0E84\u0E87\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA\u0EAB\u0EAD-\u0EB9\u0EBB-\u0EBD\u0EC0-\u0EC4\u0EC6\u0EC8-\u0ECD\u0ED0-\u0ED9\u0EDC-\u0EDF\u0F00\u0F18\u0F19\u0F20-\u0F29\u0F35\u0F37\u0F39\u0F3E-\u0F47\u0F49-\u0F6C\u0F71-\u0F84\u0F86-\u0F97\u0F99-\u0FBC\u0FC6\u1000-\u1049\u1050-\u109D\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u135D-\u135F\u1380-\u138F\u13A0-\u13F4\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u16EE-\u16F8\u1700-\u170C\u170E-\u1714\u1720-\u1734\u1740-\u1753\u1760-\u176C\u176E-\u1770\u1772\u1773\u1780-\u17D3\u17D7\u17DC\u17DD\u17E0-\u17E9\u180B-\u180D\u1810-\u1819\u1820-\u1877\u1880-\u18AA\u18B0-\u18F5\u1900-\u191E\u1920-\u192B\u1930-\u193B\u1946-\u196D\u1970-\u1974\u1980-\u19AB\u19B0-\u19C9\u19D0-\u19D9\u1A00-\u1A1B\u1A20-\u1A5E\u1A60-\u1A7C\u1A7F-\u1A89\u1A90-\u1A99\u1AA7\u1AB0-\u1ABD\u1B00-\u1B4B\u1B50-\u1B59\u1B6B-\u1B73\u1B80-\u1BF3\u1C00-\u1C37\u1C40-\u1C49\u1C4D-\u1C7D\u1CD0-\u1CD2\u1CD4-\u1CF6\u1CF8\u1CF9\u1D00-\u1DF5\u1DFC-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u200C\u200D\u203F\u2040\u2054\u2071\u207F\u2090-\u209C\u20D0-\u20DC\u20E1\u20E5-\u20F0\u2102\u2107\u210A-\u2113\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u212F-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2160-\u2188\u2C00-\u2C2E\u2C30-\u2C5E\u2C60-\u2CE4\u2CEB-\u2CF3\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D7F-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u2DE0-\u2DFF\u2E2F\u3005-\u3007\u3021-\u302F\u3031-\u3035\u3038-\u303C\u3041-\u3096\u3099\u309A\u309D-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312D\u3131-\u318E\u31A0-\u31BA\u31F0-\u31FF\u3400-\u4DB5\u4E00-\u9FCC\uA000-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA62B\uA640-\uA66F\uA674-\uA67D\uA67F-\uA69D\uA69F-\uA6F1\uA717-\uA71F\uA722-\uA788\uA78B-\uA78E\uA790-\uA7AD\uA7B0\uA7B1\uA7F7-\uA827\uA840-\uA873\uA880-\uA8C4\uA8D0-\uA8D9\uA8E0-\uA8F7\uA8FB\uA900-\uA92D\uA930-\uA953\uA960-\uA97C\uA980-\uA9C0\uA9CF-\uA9D9\uA9E0-\uA9FE\uAA00-\uAA36\uAA40-\uAA4D\uAA50-\uAA59\uAA60-\uAA76\uAA7A-\uAAC2\uAADB-\uAADD\uAAE0-\uAAEF\uAAF2-\uAAF6\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uAB30-\uAB5A\uAB5C-\uAB5F\uAB64\uAB65\uABC0-\uABEA\uABEC\uABED\uABF0-\uABF9\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE00-\uFE0F\uFE20-\uFE2D\uFE33\uFE34\uFE4D-\uFE4F\uFE70-\uFE74\uFE76-\uFEFC\uFF10-\uFF19\uFF21-\uFF3A\uFF3F\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC])*$/;if(n.length>=1&&t.test(n))return}catch(t){throw new SyntaxError(t.message)}if(n.indexOf(" ")>=0)throw new SyntaxError("The keypath argument contains an invalid key path (no spaces allowed).")}if(Array.isArray(n)&&n.length>0){if(e)throw new SyntaxError("The keypath argument contains an invalid key path (nested arrays).");for(const t of n)xr(t,"array");return}else if(typeof n=="string"&&n.indexOf(".")>=0){n=n.split(".");for(const t of n)xr(t,"string");return}throw new SyntaxError},Et=n=>{if(n._rawObjectStore.deleted)throw new fe;if(n.transaction._state!=="active")throw new Mt},Ji=(n,e,t)=>{if(Et(n),n.transaction.mode==="readonly")throw new Yn;if(n.keyPath!==null&&t!==void 0)throw new Xe;const r=Rt(e);if(n.keyPath!==null){const i=er(n.keyPath,r);if(i!==void 0)Ce(i);else if(n._rawObjectStore.keyGenerator){if(!fa(n.keyPath,r))throw new Xe}else throw new Xe}if(n.keyPath===null&&n._rawObjectStore.keyGenerator===null&&t===void 0)throw new Xe;return t!==void 0&&(t=Ce(t)),{key:t,value:r}};class va{_indexesCache=new Map;constructor(e,t){this._rawObjectStore=t,this._name=t.name,this.keyPath=t.keyPath,this.autoIncrement=t.autoIncrement,this.transaction=e,this.indexNames=new ut(...Array.from(t.rawIndexes.keys()).sort())}get name(){return this._name}set name(e){const t=this.transaction;if(!t.db._runningVersionchangeTransaction)throw new fe;if(Et(this),e=String(e),e===this._name)return;if(this._rawObjectStore.rawDatabase.rawObjectStores.has(e))throw new on;const r=this._name,i=[...t.db.objectStoreNames];this._name=e,this._rawObjectStore.name=e,this.transaction._objectStoresCache.delete(r),this.transaction._objectStoresCache.set(e,this),this._rawObjectStore.rawDatabase.rawObjectStores.delete(r),this._rawObjectStore.rawDatabase.rawObjectStores.set(e,this._rawObjectStore),t.db.objectStoreNames=new ut(...Array.from(this._rawObjectStore.rawDatabase.rawObjectStores.keys()).filter(c=>{const a=this._rawObjectStore.rawDatabase.rawObjectStores.get(c);return a&&!a.deleted}).sort());const s=new Set(t._scope),o=[...t.objectStoreNames];this.transaction._scope.delete(r),t._scope.add(e),t.objectStoreNames=new ut(...Array.from(t._scope).sort()),t._rollbackLog.push(()=>{this._name=r,this._rawObjectStore.name=r,this.transaction._objectStoresCache.delete(e),this.transaction._objectStoresCache.set(r,this),this._rawObjectStore.rawDatabase.rawObjectStores.delete(e),this._rawObjectStore.rawDatabase.rawObjectStores.set(r,this._rawObjectStore),t.db.objectStoreNames=new ut(...i),t._scope=s,t.objectStoreNames=new ut(...o)})}put(e,t){if(arguments.length===0)throw new TypeError;const r=Ji(this,e,t);return this.transaction._execRequestAsync({operation:this._rawObjectStore.storeRecord.bind(this._rawObjectStore,r,!1,this.transaction._rollbackLog),source:this})}add(e,t){if(arguments.length===0)throw new TypeError;const r=Ji(this,e,t);return this.transaction._execRequestAsync({operation:this._rawObjectStore.storeRecord.bind(this._rawObjectStore,r,!0,this.transaction._rollbackLog),source:this})}delete(e){if(arguments.length===0)throw new TypeError;if(Et(this),this.transaction.mode==="readonly")throw new Yn;return e instanceof pe||(e=Ce(e)),this.transaction._execRequestAsync({operation:this._rawObjectStore.deleteRecord.bind(this._rawObjectStore,e,this.transaction._rollbackLog),source:this})}get(e){if(arguments.length===0)throw new TypeError;return Et(this),e instanceof pe||(e=Ce(e)),this.transaction._execRequestAsync({operation:this._rawObjectStore.getValue.bind(this._rawObjectStore,e),source:this})}getAll(e,t){arguments.length>1&&t!==void 0&&(t=zn(t,"unsigned long")),Et(this);const r=Tr(e);return this.transaction._execRequestAsync({operation:this._rawObjectStore.getAllValues.bind(this._rawObjectStore,r,t),source:this})}getKey(e){if(arguments.length===0)throw new TypeError;return Et(this),e instanceof pe||(e=Ce(e)),this.transaction._execRequestAsync({operation:this._rawObjectStore.getKey.bind(this._rawObjectStore,e),source:this})}getAllKeys(e,t){arguments.length>1&&t!==void 0&&(t=zn(t,"unsigned long")),Et(this);const r=Tr(e);return this.transaction._execRequestAsync({operation:this._rawObjectStore.getAllKeys.bind(this._rawObjectStore,r,t),source:this})}clear(){if(Et(this),this.transaction.mode==="readonly")throw new Yn;return this.transaction._execRequestAsync({operation:this._rawObjectStore.clear.bind(this._rawObjectStore,this.transaction._rollbackLog),source:this})}openCursor(e,t){Et(this),e===null&&(e=void 0),e!==void 0&&!(e instanceof pe)&&(e=pe.only(Ce(e)));const r=new mn;r.source=this,r.transaction=this.transaction;const i=new ks(this,e,t,r);return this.transaction._execRequestAsync({operation:i._iterate.bind(i),request:r,source:this})}openKeyCursor(e,t){Et(this),e===null&&(e=void 0),e!==void 0&&!(e instanceof pe)&&(e=pe.only(Ce(e)));const r=new mn;r.source=this,r.transaction=this.transaction;const i=new Xn(this,e,t,r,!0);return this.transaction._execRequestAsync({operation:i._iterate.bind(i),request:r,source:this})}createIndex(e,t,r={}){if(arguments.length<2)throw new TypeError;const i=r.multiEntry!==void 0?r.multiEntry:!1,s=r.unique!==void 0?r.unique:!1;if(this.transaction.mode!=="versionchange")throw new fe;if(Et(this),this.indexNames.contains(e))throw new on;if(xr(t),Array.isArray(t)&&i)throw new _r;const o=[...this.indexNames];this.transaction._rollbackLog.push(()=>{const a=this._rawObjectStore.rawIndexes.get(e);a&&(a.deleted=!0),this.indexNames=new ut(...o),this._rawObjectStore.rawIndexes.delete(e)});const c=new ga(this._rawObjectStore,e,t,i,s);return this.indexNames._push(e),this.indexNames._sort(),this._rawObjectStore.rawIndexes.set(e,c),c.initialize(this.transaction),new zi(this,c)}index(e){if(arguments.length===0)throw new TypeError;if(this._rawObjectStore.deleted||this.transaction._state==="finished")throw new fe;const t=this._indexesCache.get(e);if(t!==void 0)return t;const r=this._rawObjectStore.rawIndexes.get(e);if(!this.indexNames.contains(e)||r===void 0)throw new $n;const i=new zi(this,r);return this._indexesCache.set(e,i),i}deleteIndex(e){if(arguments.length===0)throw new TypeError;if(this.transaction.mode!=="versionchange")throw new fe;Et(this);const t=this._rawObjectStore.rawIndexes.get(e);if(t===void 0)throw new $n;this.transaction._rollbackLog.push(()=>{t.deleted=!1,this._rawObjectStore.rawIndexes.set(e,t),this.indexNames._push(e),this.indexNames._sort()}),this.indexNames=new ut(...Array.from(this.indexNames).filter(r=>r!==e)),t.deleted=!0,this.transaction._execRequestAsync({operation:()=>{const r=this._rawObjectStore.rawIndexes.get(e);t===r&&this._rawObjectStore.rawIndexes.delete(e)},source:this})}count(e){return Et(this),e===null&&(e=void 0),e!==void 0&&!(e instanceof pe)&&(e=pe.only(Ce(e))),this.transaction._execRequestAsync({operation:()=>{let t=0;const r=new Xn(this,e);for(;r._iterate()!==null;)t+=1;return t},source:this})}toString(){return"[object IDBObjectStore]"}}const Bt=va;class qt{eventPath=[];NONE=0;CAPTURING_PHASE=1;AT_TARGET=2;BUBBLING_PHASE=3;propagationStopped=!1;immediatePropagationStopped=!1;canceled=!1;initialized=!0;dispatched=!1;target=null;currentTarget=null;eventPhase=0;defaultPrevented=!1;isTrusted=!1;timeStamp=Date.now();constructor(e,t={}){this.type=e,this.bubbles=t.bubbles!==void 0?t.bubbles:!1,this.cancelable=t.cancelable!==void 0?t.cancelable:!1}preventDefault(){this.cancelable&&(this.canceled=!0)}stopPropagation(){this.propagationStopped=!0}stopImmediatePropagation(){this.propagationStopped=!0,this.immediatePropagationStopped=!0}}function ba(){if(typeof navigator<"u"&&/jsdom/.test(navigator.userAgent)){const n=Node.constructor;return new n("return setImmediate")()}else return}const jt=globalThis.setImmediate||ba()||(n=>setTimeout(n,0));class wa extends Fi{_state="active";_started=!1;_rollbackLog=[];_objectStoresCache=new Map;error=null;onabort=null;oncomplete=null;onerror=null;_requests=[];constructor(e,t,r){super(),this._scope=new Set(e),this.mode=t,this.db=r,this.objectStoreNames=new ut(...Array.from(this._scope).sort())}_abort(e){for(const t of this._rollbackLog.reverse())t();if(e!==null){const t=new Error;t.name=e,this.error=t}for(const{request:t}of this._requests)if(t.readyState!=="done"&&(t.readyState="done",t.source)){t.result=void 0,t.error=new Ei;const r=new qt("error",{bubbles:!0,cancelable:!0});r.eventPath=[this.db,this],t.dispatchEvent(r)}jt(()=>{const t=new qt("abort",{bubbles:!0,cancelable:!1});t.eventPath=[this.db],this.dispatchEvent(t)}),this._state="finished"}abort(){if(this._state==="committing"||this._state==="finished")throw new fe;this._state="active",this._abort(null)}objectStore(e){if(this._state!=="active")throw new fe;const t=this._objectStoresCache.get(e);if(t!==void 0)return t;const r=this.db._rawDatabase.rawObjectStores.get(e);if(!this._scope.has(e)||r===void 0)throw new $n;const i=new Bt(this,r);return this._objectStoresCache.set(e,i),i}_execRequestAsync(e){const t=e.source,r=e.operation;let i=e.hasOwnProperty("request")?e.request:null;if(this._state!=="active")throw new Mt;return i||(t?(i=new mn,i.source=t,i.transaction=t.transaction):i=new mn),this._requests.push({operation:r,request:i}),i}_start(){this._started=!0;let e,t;for(;this._requests.length>0;){const r=this._requests.shift();if(r&&r.request.readyState!=="done"){t=r.request,e=r.operation;break}}if(t&&e){if(!t.source)e();else{let r,i;try{const s=e();t.readyState="done",t.result=s,t.error=void 0,this._state==="inactive"&&(this._state="active"),i=new qt("success",{bubbles:!1,cancelable:!1})}catch(s){t.readyState="done",t.result=void 0,t.error=s,this._state==="inactive"&&(this._state="active"),i=new qt("error",{bubbles:!0,cancelable:!0}),r=this._abort.bind(this,s.name)}try{i.eventPath=[this.db,this],t.dispatchEvent(i)}catch(s){throw this._state!=="committing"&&this._abort("AbortError"),s}i.canceled||r&&r()}jt(this._start.bind(this));return}if(this._state!=="finished"&&(this._state="finished",!this.error)){const r=new qt("complete");this.dispatchEvent(r)}}commit(){if(this._state!=="active")throw new fe;this._state="committing"}toString(){return"[object IDBRequest]"}}const Qi=9007199254740992;class Ea{num=0;next(){if(this.num>=Qi)throw new on;return this.num+=1,this.num}setIfLarger(e){const t=Math.floor(Math.min(e,Qi))-1;t>=this.num&&(this.num=t+1)}}class Aa{deleted=!1;records=new Ls;rawIndexes=new Map;constructor(e,t,r,i){this.rawDatabase=e,this.keyGenerator=i===!0?new Ea:null,this.deleted=!1,this.name=t,this.keyPath=r,this.autoIncrement=i}getKey(e){const t=this.records.get(e);return t!==void 0?Rt(t.key):void 0}getAllKeys(e,t){(t===void 0||t===0)&&(t=1/0);const r=[];for(const i of this.records.values(e))if(r.push(Rt(i.key)),r.length>=t)break;return r}getValue(e){const t=this.records.get(e);return t!==void 0?Rt(t.value):void 0}getAllValues(e,t){(t===void 0||t===0)&&(t=1/0);const r=[];for(const i of this.records.values(e))if(r.push(Rt(i.value)),r.length>=t)break;return r}storeRecord(e,t,r){if(this.keyPath!==null){const s=er(this.keyPath,e.value);s!==void 0&&(e.key=s)}if(this.keyGenerator!==null&&e.key===void 0){if(r){const s=this.keyGenerator.num;r.push(()=>{this.keyGenerator&&(this.keyGenerator.num=s)})}if(e.key=this.keyGenerator.next(),this.keyPath!==null){if(Array.isArray(this.keyPath))throw new Error("Cannot have an array key path in an object store with a key generator");let s=this.keyPath,o=e.value,c,a=0;for(;a>=0;){if(typeof o!="object")throw new Xe;a=s.indexOf("."),a>=0&&(c=s.slice(0,a),s=s.slice(a+1),o.hasOwnProperty(c)||(o[c]={}),o=o[c])}c=s,o[c]=e.key}}else this.keyGenerator!==null&&typeof e.key=="number"&&this.keyGenerator.setIfLarger(e.key);if(this.records.get(e.key)){if(t)throw new on;this.deleteRecord(e.key,r)}this.records.add(e),r&&r.push(()=>{this.deleteRecord(e.key)});for(const s of this.rawIndexes.values())s.initialized&&s.storeRecord(e);return e.key}deleteRecord(e,t){const r=this.records.delete(e);if(t)for(const i of r)t.push(()=>{this.storeRecord(i,!0)});for(const i of this.rawIndexes.values())i.records.deleteByValue(e)}clear(e){const t=this.records.clear();if(e)for(const r of t)e.push(()=>{this.storeRecord(r,!0)});for(const r of this.rawIndexes.values())r.records.clear()}}const Zi=n=>{if(!n._runningVersionchangeTransaction)throw new fe;const e=n._rawDatabase.transactions.filter(r=>r.mode==="versionchange"),t=e[e.length-1];if(!t||t._state==="finished")throw new fe;if(t._state!=="active")throw new Mt;return t},Hs=n=>{n._closePending=!0,n._rawDatabase.transactions.every(t=>t._state==="finished")?(n._closed=!0,n._rawDatabase.connections=n._rawDatabase.connections.filter(t=>n!==t)):jt(()=>{Hs(n)})};class Sa extends Fi{_closePending=!1;_closed=!1;_runningVersionchangeTransaction=!1;constructor(e){super(),this._rawDatabase=e,this._rawDatabase.connections.push(this),this.name=e.name,this.version=e.version,this.objectStoreNames=new ut(...Array.from(e.rawObjectStores.keys()).sort())}createObjectStore(e,t={}){if(e===void 0)throw new TypeError;const r=Zi(this),i=t!==null&&t.keyPath!==void 0?t.keyPath:null,s=t!==null&&t.autoIncrement!==void 0?t.autoIncrement:!1;if(i!==null&&xr(i),this._rawDatabase.rawObjectStores.has(e))throw new on;if(s&&(i===""||Array.isArray(i)))throw new _r;const o=[...this.objectStoreNames];r._rollbackLog.push(()=>{const a=this._rawDatabase.rawObjectStores.get(e);a&&(a.deleted=!0),this.objectStoreNames=new ut(...o),r._scope.delete(e),this._rawDatabase.rawObjectStores.delete(e)});const c=new Aa(this._rawDatabase,e,i,s);return this.objectStoreNames._push(e),this.objectStoreNames._sort(),r._scope.add(e),this._rawDatabase.rawObjectStores.set(e,c),r.objectStoreNames=new ut(...this.objectStoreNames),r.objectStore(e)}deleteObjectStore(e){if(e===void 0)throw new TypeError;const t=Zi(this),r=this._rawDatabase.rawObjectStores.get(e);if(r===void 0)throw new $n;this.objectStoreNames=new ut(...Array.from(this.objectStoreNames).filter(i=>i!==e)),t.objectStoreNames=new ut(...this.objectStoreNames),t._rollbackLog.push(()=>{r.deleted=!1,this._rawDatabase.rawObjectStores.set(e,r),this.objectStoreNames._push(e),this.objectStoreNames._sort()}),r.deleted=!0,this._rawDatabase.rawObjectStores.delete(e),t._objectStoresCache.delete(e)}transaction(e,t){if(t=t!==void 0?t:"readonly",t!=="readonly"&&t!=="readwrite"&&t!=="versionchange")throw new TypeError("Invalid mode: "+t);if(this._rawDatabase.transactions.some(s=>s._state==="active"&&s.mode==="versionchange"&&s.db===this))throw new fe;if(this._closePending)throw new fe;if(Array.isArray(e)||(e=[e]),e.length===0&&t!=="versionchange")throw new _r;for(const s of e)if(!this.objectStoreNames.contains(s))throw new $n("No objectStore named "+s+" in this database");const i=new wa(e,t,this);return this._rawDatabase.transactions.push(i),this._rawDatabase.processTransactions(),i}close(){Hs(this)}toString(){return"[object IDBDatabase]"}}class es extends mn{onupgradeneeded=null;onblocked=null;toString(){return"[object IDBOpenDBRequest]"}}class In extends qt{constructor(e,t={}){super(e),this.newVersion=t.newVersion!==void 0?t.newVersion:null,this.oldVersion=t.oldVersion!==void 0?t.oldVersion:0}toString(){return"[object IDBVersionChangeEvent]"}}class Ca{deletePending=!1;transactions=[];rawObjectStores=new Map;connections=[];constructor(e,t){this.name=e,this.version=t,this.processTransactions=this.processTransactions.bind(this)}processTransactions(){jt(()=>{if(!this.transactions.some(t=>t._started&&t._state!=="finished")){const t=this.transactions.find(r=>!r._started&&r._state!=="finished");t&&(t.addEventListener("complete",this.processTransactions),t.addEventListener("abort",this.processTransactions),t._start())}})}}const Us=(n,e,t,r)=>{if(t.some(s=>!s._closed&&!s._closePending)){jt(()=>Us(n,e,t,r));return}n.delete(e),r(null)},Ia=(n,e,t,r)=>{try{const i=n.get(e);if(i===void 0){r(null);return}i.deletePending=!0;const s=i.connections.filter(c=>!c._closed&&!c._closePending);for(const c of s)if(!c._closePending){const a=new In("versionchange",{newVersion:null,oldVersion:i.version});c.dispatchEvent(a)}const o=s.some(c=>!c._closed&&!c._closePending);if(t&&o){const c=new In("blocked",{newVersion:null,oldVersion:i.version});t.dispatchEvent(c)}Us(n,e,s,r)}catch(i){r(i)}},Oa=(n,e,t,r)=>{n._runningVersionchangeTransaction=!0;const i=n.version,s=n._rawDatabase.connections.filter(a=>n!==a);for(const a of s)if(!a._closed&&!a._closePending){const h=new In("versionchange",{newVersion:e,oldVersion:i});a.dispatchEvent(h)}if(s.some(a=>!a._closed&&!a._closePending)){const a=new In("blocked",{newVersion:e,oldVersion:i});t.dispatchEvent(a)}const c=()=>{if(s.some(d=>!d._closed&&!d._closePending)){jt(c);return}n._rawDatabase.version=e,n.version=e;const h=n.transaction(n.objectStoreNames,"versionchange");t.result=n,t.readyState="done",t.transaction=h,h._rollbackLog.push(()=>{n._rawDatabase.version=i,n.version=i});const l=new In("upgradeneeded",{newVersion:e,oldVersion:i});t.dispatchEvent(l),h.addEventListener("error",()=>{n._runningVersionchangeTransaction=!1}),h.addEventListener("abort",()=>{n._runningVersionchangeTransaction=!1,t.transaction=null,jt(()=>{r(new Ei)})}),h.addEventListener("complete",()=>{n._runningVersionchangeTransaction=!1,t.transaction=null,jt(()=>{n._closePending?r(new Ei):r(null)})})};c()},_a=(n,e,t,r,i)=>{let s=n.get(e);if(s===void 0&&(s=new Ca(e,0),n.set(e,s)),t===void 0&&(t=s.version!==0?s.version:1),s.version>t)return i(new la);const o=new Sa(s);s.version<t?Oa(o,t,r,c=>{if(c)return i(c);i(null,o)}):i(null,o)};class Ta{cmp=ge;_databases=new Map;deleteDatabase(e){const t=new es;return t.source=null,jt(()=>{const r=this._databases.get(e),i=r!==void 0?r.version:0;Ia(this._databases,e,t,s=>{if(s){t.error=new Error,t.error.name=s.name,t.readyState="done";const c=new qt("error",{bubbles:!0,cancelable:!0});c.eventPath=[],t.dispatchEvent(c);return}t.result=void 0,t.readyState="done";const o=new In("success",{newVersion:null,oldVersion:i});t.dispatchEvent(o)})}),t}open(e,t){if(arguments.length>1&&t!==void 0&&(t=zn(t,"MAX_SAFE_INTEGER")),t===0)throw new TypeError;const r=new es;return r.source=null,jt(()=>{_a(this._databases,e,t,r,(i,s)=>{if(i){r.result=void 0,r.readyState="done",r.error=new Error,r.error.name=i.name;const c=new qt("error",{bubbles:!0,cancelable:!0});c.eventPath=[],r.dispatchEvent(c);return}r.result=s,r.readyState="done";const o=new qt("success");o.eventPath=[],r.dispatchEvent(o)})}),r}databases(){return new Promise(e=>{const t=[];for(const[r,i]of this._databases)t.push({name:r,version:i.version});e(t)})}toString(){return"[object IDBFactory]"}}const Da=new Ta;class ts extends fn{inMemory;ActiveEncounter;Creatures;Tracker;Settings;constructor(e,t){super("ClashDatabase",t),this.inMemory=e;const r=`
        id,
        tokenId,
        initiative,
        currentHp,
        isMonster,
        isActive,
        unitName,
        maxHP,
        armorClass,
        unitType,
        unitSize,
        strScore,
        strSave,
        dexScore,
        dexSave,
        conScore,
        conSave,
        intScore,
        intSave,
        wisScore,
        wisSave,
        chaScore,
        chaSave,
        damageVulnerabilities,
        damageImmunities,
        damageResistances,
        conditionImmunities,
        challengeRating,
        experiencePoints,
        alignment,
        standardActions,
        legendaryActions,
        specialAbilities,
        spellActions,
        reactions,
        spellList,
        senses,
        skills,
        languages,
        speedWalk,
        speedFly,
        speedClimb,
        speedBurrow,
        speedSwim,
        dataSlug
        `,i=r+", favorite",s=i+", ownerId",o=s+", sceneId";this.version(1).stores({ActiveEncounter:r,Creatures:r,Tracker:"id, currentTurn, currentRound",Settings:"id, gmHideHp, gmHideAll, gmDisableLabel, disableFocus"}),this.version(2).stores({ActiveEncounter:r,Creatures:r,Tracker:"id, currentTurn, currentRound",Settings:"id, gmHideHp, gmHideAll, gmDisableLabel, gmTurnText, disableFocus, gmReverseList"}),this.version(3).stores({ActiveEncounter:i,Creatures:i,Tracker:"id, currentTurn, currentRound",Settings:"id, gmHideHp, gmHideAll, gmDisableLabel, gmTurnText, disableFocus, gmReverseList"}),this.version(4).stores({ActiveEncounter:i,Creatures:i,Tracker:"id, currentTurn, currentRound",Settings:"id, gmHideHp, gmHideAll, gmDisableLabel, gmTurnText, disableFocus, gmReverseList, gmRumbleLog"}),this.version(5).stores({ActiveEncounter:s,Creatures:i,Tracker:"id, currentTurn, currentRound",Settings:"id, gmHideHp, gmHideAll, gmDisableLabel, gmTurnText, disableFocus, gmReverseList, gmRumbleLog"}),this.version(6).stores({ActiveEncounter:o,Creatures:i,Tracker:"id, currentTurn, currentRound",Settings:"id, gmHideHp, gmHideAll, gmDisableLabel, gmTurnText, disableFocus, gmReverseList, gmRumbleLog"})}async SaveToCreatureStorage(e){return await rt.Creatures.add(e)}async DeleteFromCreatureStorage(e){return await rt.Creatures.delete(e)}async SaveToActiveList(e){return await rt.ActiveEncounter.add(e)}async DeleteFromActiveList(e){return await rt.ActiveEncounter.delete(e)}Ready(){console.log("Setup is complete.")}}async function Za(){return rt||(rt=await xa(),rt)}async function xa(){return new Promise(n=>{let e=window.indexedDB.open("__test");e.onsuccess=async function(){e.result.close(),window.indexedDB.deleteDatabase("__test"),n(new ts(!1))},e.onerror=async function(){console.warn("IndexDB is disabled, no Collection Items will be saved"),window.indexedDB.deleteDatabase("__test"),n(new ts(!0,{indexedDB:Da,IDBKeyRange:pe}))}})}let rt;function Ba(){let n=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const r=(n+Math.random()*16)%16|0;return n=Math.floor(n/16),(t==="x"?r:r&3|8).toString(16)})}function Ks(n,e){const t=parseInt(n.substring(1,3),16),r=parseInt(n.substring(3,5),16),i=parseInt(n.substring(5,7),16);return`rgba(${t}, ${r}, ${i}, ${e})`}function Ra(n){for(const e of G.ADJECTIVES)if(n.includes(e)){const t=G.ADJECTIVES[Math.floor(Math.random()*G.ADJECTIVES.length)];return n.replace(e,t)}return Na(n)}function Na(n){const e=Math.floor(Math.random()*G.ADJECTIVES.length);return`${G.ADJECTIVES[e]} ${n}`}function Yr(n,e){let t;return function(i){clearTimeout(t),t=setTimeout(()=>{n(i)},e)}}function eu(n){return n.length>30?n.substring(0,30)+"...":n}function tu(n){if(n.indexOf("#")===0&&(n=n.slice(1)),n.length===3&&(n=n[0]+n[0]+n[1]+n[1]+n[2]+n[2]),n.length!==6)throw new Error("Invalid HEX color.");var e=parseInt(n.slice(0,2),16),t=parseInt(n.slice(2,4),16),r=parseInt(n.slice(4,6),16);return e*.299+t*.587+r*.114>186?"#000000":"#FFFFFF"}function nu(n){if(!n||n==="")return"white";switch(n.substring(0,1).toLowerCase()){case"a":case"e":case"i":case"o":case"u":return"red";case"b":case"c":case"d":return"pink";case"f":case"g":case"h":return"cyan";case"j":case"k":case"l":case"m":return"#747bff";case"n":case"p":case"q":return"green";case"r":case"s":case"t":case"v":return"orange";case"w":case"x":case"y":case"z":return"yellow";default:return"white"}}function ns(n,e){const t=window.matchMedia("(prefers-color-scheme: dark)"),r=t.matches?"dark":"light",i=t.matches?"light":"dark";for(var s=0;s<e.styleSheets.length;s++)for(var o=0;o<e.styleSheets[s].cssRules.length;o++){let c=e.styleSheets[s].cssRules[o];c&&c.media&&c.media.mediaText.includes("prefers-color-scheme")&&(n.mode=="LIGHT"?(c.media.appendMedium(`(prefers-color-scheme: ${r})`),c.media.mediaText.includes(i)&&c.media.deleteMedium(`(prefers-color-scheme: ${i})`)):n.mode=="DARK"&&(c.media.appendMedium(`(prefers-color-scheme: ${i})`),c.media.mediaText.includes(r)&&c.media.deleteMedium(`(prefers-color-scheme: ${r})`)))}}function rs(n,e){const t=e/n.grid.dpi,r=n.image.width*t*n.scale.x,i=n.image.height*t*n.scale.y,s=n.grid.offset.x/n.image.width*r,o=n.grid.offset.y/n.image.height*i,c={x:n.position.x-s,y:n.position.y-o},a={x:c.x+r,y:c.y+i};return{min:c,max:a}}function Ne(n,e){return n.metadata[e]}function Q(n){return ee.roomMetadata[n]}function _n(n){return ee.sceneMetadata[n]}const Ft="10%",Nr="25px",Fr="15%",Pr="40px",Pi="40%",Fa="60px",Pa="80%",ka="100px";function Vs(){const n=document.createElement("th");n.style.width=Ft,n.style.minWidth=Nr;const e=document.createElement("img");return e.setAttribute("class","icon"),e.setAttribute("title","Initiative"),e.setAttribute("src","/queue.svg"),n.appendChild(e),n}function Ws(){const n=document.createElement("th");n.style.width=Ft,n.style.minWidth=Nr;const e=document.createElement("input");return e.type="image",e.className="icon roller-button clickable",e.title="Roll For All (Purple) Units",e.src="/dice.svg",e.onclick=async function(){F.notification.show("Rolled Initiative for all selected.");const t=document.querySelectorAll(".isMonster"),r=[];t.forEach(i=>{const o=i.id.substring(2),c=document.querySelector(`#iI${o}`),h=Q(N.INITBONUS)??!0?parseFloat(c.getAttribute("unit-dexbonus")):0,l=Q(N.INITIATIVEDICE)??20,d=(h+Math.floor(Math.random()*(l-1)+1)).toString();c.value=d,r.push({key:o,value:d})}),await F.scene.items.updateItems(r.map(i=>i.key),i=>{for(let s of i)s.metadata[E.INITIATIVE]=r.find(o=>o.key===s.id)?.value})},n.appendChild(e),n}function Gs(){const n=document.createElement("th");return n.style.width=Pa,n.style.minWidth=ka,n.innerText="NAME",n}function qs(){const n=document.createElement("th");n.style.width=Pi,n.style.minWidth=Fa;const e=document.createElement("img");return e.setAttribute("class","icon"),e.setAttribute("title","Hit Points"),e.setAttribute("src","/health.svg"),n.appendChild(e),n}function $s(){const n=document.createElement("th");n.style.width=Ft,n.style.minWidth=Nr;const e=document.createElement("img");return e.setAttribute("class","icon"),e.setAttribute("title","Temporary Health"),e.setAttribute("src","/temphp.svg"),n.appendChild(e),n}function Ys(){const n=document.createElement("th");n.style.width=Ft,n.style.minWidth=Nr;const e=document.createElement("img");return e.setAttribute("class","icon"),e.setAttribute("title","Armor Class"),e.setAttribute("src","/shield.svg"),n.appendChild(e),n}function Xs(){const n=document.createElement("th");n.style.width=Fr,n.style.minWidth=Pr;const e=document.createElement("img");return e.setAttribute("class","icon"),e.setAttribute("title","Highest Move Speed"),e.setAttribute("src","/speedwalk.svg"),n.appendChild(e),n}function zs(){const n=document.createElement("th");n.style.width=Fr,n.style.minWidth=Pr;const e=document.createElement("img");return e.setAttribute("class","icon"),e.setAttribute("title","Unit Elevation"),e.setAttribute("src","/elevation.svg"),n.appendChild(e),n}function Js(){const n=document.createElement("th");n.style.width=Fr,n.style.minWidth=Pr;const e=document.createElement("img");return e.setAttribute("class","icon"),e.setAttribute("title","Effects"),e.setAttribute("src","/effectheader.svg"),n.appendChild(e),n}function Qs(){const n=document.createElement("th");n.style.width=Ft;const e=document.createElement("img");e.id="whatsNewButton",e.setAttribute("class","icon"),e.classList.add("clickable"),e.setAttribute("title","Whats New?"),e.setAttribute("src","/info.svg"),e.onclick=async function(){try{localStorage.setItem(G.VERSION,"true"),e.classList.remove("whats-new-shine")}catch{}await F.modal.open({id:G.EXTENSIONWHATSNEW,url:"/submenu/whatsnew.html?timer=300",height:500,width:350})};try{localStorage.getItem(G.VERSION)!=="true"&&e.classList.add("whats-new-shine")}catch{}return n.appendChild(e),n}function Zs(n){const e=document.createElement("input");return e.classList.add("text-input"),e.classList.add("unit-initiative"),e.inputMode="numeric",e.setAttribute("unit-dexbonus",Math.floor((_e(n,E.DEXSCORE)-10)/2).toString()),e.value=_e(n,E.INITIATIVE).toString(),e.id=`iI${n.id}`,e.size=2,e.min="0",e.max="99",e.maxLength=2,e.style.width=Ft,e.style.minWidth="25px",e.onblur=async t=>{const r=t.currentTarget;await Ye(r.id,[{key:E.INITIATIVE,value:r.value}])},e}function eo(n){const e=document.createElement("input");return e.type="image",e.title="Roll this Unit's Initiative",e.id=`rB${n.id}`,e.className="clickable",e.onclick=async t=>{const r=t.currentTarget,i=r.id.substring(2),o=ee.sceneItems.find(d=>d.id===i).metadata[E.DEXSCORE],a=Q(N.INITBONUS)??!0?Math.floor((+o-10)/2):0,h=Q(N.INITIATIVEDICE)??20,l=(a+Math.floor(Math.random()*(h-1)+1)).toString();await Ye(r.id,[{key:E.INITIATIVE,value:l}])},e.src="/dice.svg",e.height=20,e.width=20,e.style.width=Ft,e.style.minWidth="25px",e}function to(n){let e;if(_e(n,E.OWNERID)){const r=ee.party.find(i=>i.id===_e(n,E.OWNERID))?.color;r&&(e=Ks(r,.9))}const t=document.createElement("input");return t.type="button",t.value=_e(n,E.ISMONSTER)?`ʳ ${_e(n,E.UNITNAME)} ʴ`:_e(n,E.UNITNAME),t.title="Change between Player and Monster groups",t.id=`nT${n.id}`,t.style.width="100%",t.classList.add("text-input"),t.classList.add("unit-name-input"),t.style.textOverflow="ellipsis",t.style.overflow="hidden",e&&(t.style.borderColor=e,t.style.borderWidth="2px"),t.onclick=async function(){t.classList.contains("isMonster")?(t.value=_e(n,E.UNITNAME),t.classList.remove("isMonster")):(t.value=`ʳ ${_e(n,E.UNITNAME)} ʴ`,t.classList.add("isMonster"))},t.oncontextmenu=async function(r){r.preventDefault();const i=document.getElementById("contextMenu"),s=a=>{a.preventDefault()},o=async a=>{const h=a.target;h.id==="REMOVE"?await F.scene.items.updateItems([t.id.substring(2)],l=>{for(let d of l)delete d.metadata[E.ONLIST],delete d.metadata[E.HPBAR]}):await Ye(t.id,[{key:E.OWNERID,value:h.id}]),i.style.display="none",a.stopPropagation(),window.removeEventListener("click",c),i.removeEventListener("click",o),i.removeEventListener("contextmenu",s)};i.setAttribute("currentUnit",n.id);const c=()=>{i.style.display="none",window.removeEventListener("click",c),i.removeEventListener("click",o),i.removeEventListener("contextmenu",s)};if(i.addEventListener("click",o),i.addEventListener("contextmenu",s),window.addEventListener("click",c),i.style.display=="block")Ga();else{const a=Math.min(r.pageX,window.innerWidth-150),h=Math.min(r.pageY,(window.innerHeight>300?window.innerHeight-50:window.innerHeight)-120);i.style.display="block",i.style.left=a+"px",i.style.top=h+"px"}},t}function no(n){const e=document.createElement("input");return e.classList.add("text-input"),e.inputMode="numeric",e.id=`cH${n.id}`,e.title=_e(n,E.CURRENTHP).toString(),e.value=_e(n,E.CURRENTHP).toString(),e.size=4,e.style.width="30px",e.maxLength=4,e.style.width=(+Pi/2).toString(),e.style.minWidth="25px",e.onblur=async function(t){const r=t.currentTarget,i=r.value;if(i.substring(0,1)=="+"){const o=(+i.substring(i.indexOf("+")+1)+ +_e(n,E.CURRENTHP)).toString();await Ye(r.id,[{key:E.CURRENTHP,value:o}]),t.preventDefault()}else if(i.substring(0,1)=="-"){const s=i.substring(i.indexOf("-")+1),o=(+_e(n,E.CURRENTHP)-+s).toString();await Ye(r.id,[{key:E.CURRENTHP,value:o}]),t.preventDefault()}else await Ye(r.id,[{key:E.CURRENTHP,value:e.value}])},e.onkeydown=async function(t){if(t.key!=="Enter")return;const r=t.currentTarget,i=r.value;if(i.substring(0,1)=="+"){const o=(+i.substring(i.indexOf("+")+1)+ +_e(n,E.CURRENTHP)).toString();await Ye(r.id,[{key:E.CURRENTHP,value:o}]),t.preventDefault()}else if(i.substring(0,1)=="-"){const s=i.substring(i.indexOf("-")+1),o=(+_e(n,E.CURRENTHP)-+s).toString();await Ye(r.id,[{key:E.CURRENTHP,value:o}]),t.preventDefault()}else await Ye(r.id,[{key:E.CURRENTHP,value:r.value}])},e}function ro(n){const e=document.createElement("input");return e.classList.add("text-input"),e.inputMode="numeric",e.id=`mH${n.id}`,e.value=_e(n,E.MAXHP).toString(),e.style.width="30px",e.size=4,e.maxLength=4,e.style.width=(+Pi/2).toString(),e.style.minWidth="25px",e.onblur=async t=>{const r=t.currentTarget;await Ye(r.id,[{key:E.MAXHP,value:r.value}])},e}function io(n){const e=document.createElement("input");return e.classList.add("text-input"),e.inputMode="numeric",e.id=`tH${n.id}`,e.title=_e(n,E.TEMPHP)??0,e.value=_e(n,E.TEMPHP)??0,e.size=3,e.maxLength=3,e.style.width=Ft,e.style.minWidth="25px",e.onblur=async function(t){const r=t.currentTarget,i=document.getElementById(`cH${r.id.substring(2)}`);let s=i.value;const o=r.value;if(o.substring(0,1)=="+"){let a=(+o.substring(o.indexOf("+")+1)+ +e.title).toString();await Ye(r.id,[{key:E.TEMPHP,value:a}]),t.preventDefault()}else if(o.substring(0,1)=="-"){const c=o.substring(o.indexOf("-")+1);let a=+e.title-+c;a<0&&(s=(+i.value+a).toString(),a=0),await Ye(r.id,[{key:E.TEMPHP,value:a.toString()},{key:E.CURRENTHP,value:s}]),t.preventDefault()}else await Ye(r.id,[{key:E.TEMPHP,value:o}])},e.onkeydown=async function(t){if(t.key!=="Enter")return;const r=t.currentTarget,i=document.getElementById(`cH${r.id.substring(2)}`);let s=i.value;const o=r.value;if(o.substring(0,1)=="+"){let a=(+o.substring(o.indexOf("+")+1)+ +e.title).toString();await Ye(r.id,[{key:E.TEMPHP,value:a}]),t.preventDefault()}else if(o.substring(0,1)=="-"){const c=o.substring(o.indexOf("-")+1);let a=+e.title-+c;a<0&&(s=(+i.value+a).toString(),a=0),await Ye(r.id,[{key:E.TEMPHP,value:a.toString()},{key:E.CURRENTHP,value:s}]),t.preventDefault()}else await Ye(r.id,[{key:E.TEMPHP,value:o}])},e}function so(n){const e=document.createElement("input");return e.classList.add("text-input"),e.inputMode="numeric",e.id=`aC${n.id}`,e.value=_e(n,E.ARMORCLASS),e.size=2,e.maxLength=2,e.style.width=Ft,e.style.minWidth="25px",e.onblur=async t=>{const r=t.currentTarget;await Ye(r.id,[{key:E.ARMORCLASS,value:r.value}])},e}function oo(n){const e=document.createElement("input");return e.classList.add("text-input"),e.inputMode="numeric",e.id=`eL${n.id}`,e.value=_e(n,E.ELEVATION)??"-",e.size=3,e.maxLength=3,e.style.width=Ft,e.style.minWidth="25px",e.onblur=async t=>{const r=t.currentTarget;await Ye(r.id,[{key:E.ELEVATION,value:r.value}])},e}function ao(n){const e=document.createElement("input");e.type="image",e.src=_e(n,E.EFFECTS)?"/effect-on.svg":"/effect-off.svg",e.classList.add("text-input"),e.classList.add("icon"),e.classList.add("clickable"),e.id=`eX${n.id}`,e.style.width=Ft,e.style.minWidth="25px",e.onclick=async r=>{await F.popover.open({id:G.EXTENSIONEFFECTSID,url:`/submenu/effects.html?unitid=${n.id}`,height:220,width:300,hidePaper:!0})};const t=_e(n,E.EFFECTS);if(t?.length>0){const r=[];for(const i of t){const s=`'${i.Name}' til ${i.StartOfTurn.toLowerCase()} of Round ${i.EndingRound}`;r.push(s)}e.title=r.join(`\r
`)}else e.title="No active effects";return e}function uo(n){const e=_e(n,E.SPEEDWALK);let t=e,r="/speedwalk.svg";const i=_e(n,E.SPEEDCLIMB);i>t&&(t=i,r="/speedclimb.svg");const s=_e(n,E.SPEEDSWIM);s>t&&(t=s,r="/speedswim.svg");const o=_e(n,E.SPEEDFLY);o>t&&(t=o,r="/speedfly.svg");const c=_e(n,E.SPEEDBURROW);c>t&&(t=c,r="/speedburrow.svg");const a=`Walk:${e}
Climb:${i}
Swim:${s}
Fly:${o}
Burrow:${c}`,h=document.createElement("div");h.classList.add("text-input"),h.classList.add("disabled"),h.classList.add("information"),h.inputMode="numeric",h.id=`mV${n.id}`,h.style.width=Fr,h.style.minWidth=Pr,h.innerText=t.toString(),h.setAttribute("data-information",a);const l=document.createElement("img");return l.setAttribute("class","icon"),l.setAttribute("title","Highest Move Speed"),l.setAttribute("src",r),l.style.paddingLeft="2px",h.appendChild(l),h}function Ma(n){const e=document.createElement("input");return e.type="image",e.title="View/Edit this Unit's Stats",e.id=`tB${n.id}`,e.className="clickable",e.onclick=async function(t){const r=t.currentTarget;await qa(r.id.substring(2))},e.src="/triangle.svg",e.height=20,e.width=20,e.style.marginLeft="5px",e}function ja(){document.getElementById("previousContainer")?.appendChild(Ha()),document.getElementById("nextContainer")?.appendChild(Ua()),document.getElementById("settingsContainer")?.appendChild(Va()),document.getElementById("showLogContainer")?.appendChild(co())}function La(){document.getElementById("showLogContainer")?.appendChild(co())}function Ha(){const n=document.createElement("input");return n.type="button",n.id="previousButton",n.value="Previous",n.classList.add("footer-button"),n.title="Previous Turn",n.onclick=async function(){if(!(te.roundCounter===1&&te.turnCounter===0)&&te.viewBody.rows?.length>1){te.turnCounter--;for(var e=0,t;t=te.viewBody.rows[e];e++)t.className.includes("turn-outline")&&t.parentElement?.firstElementChild===t&&(te.roundCounter--,te.roundCounter<1&&(te.roundCounter=1),te.turnCounter=t.parentElement.childElementCount);await F.scene.setMetadata({[N.TURNCOUNT]:te.turnCounter,[N.ROUNDCOUNT]:te.roundCounter})}},n}function Ua(){const n=document.createElement("input");return n.type="button",n.id="nextButton",n.value="Next",n.classList.add("footer-button"),n.title="Next Turn",n.onclick=async function(){if(te.currentTurnUnit&&te.HandleEffects(te.currentTurnUnit,"End"),te.viewBody.rows?.length>1){te.turnCounter++;for(var e=0,t;t=te.viewBody.rows[e];e++)t.className.includes("turn-outline")&&t.parentElement?.lastElementChild===t&&(te.roundCounter++,te.turnCounter=0);te.startEffectsDone=!1,await F.scene.setMetadata({[N.TURNCOUNT]:te.turnCounter,[N.ROUNDCOUNT]:te.roundCounter})}},n}function co(){const n=document.createElement("input");return n.type="button",n.id="showLogButton",n.value="Show Log",n.title="Show Log",n.classList.add("footer-button"),n.onclick=async function(){fo(!0)},n}function lo(){G.MAINLOG.innerHTML=G.ROLLLOG,Ka()}function Ka(){const n=document.getElementById("rollLogReturnContainer"),e=document.createElement("input");e.type="button",e.classList.add("footer-button"),e.id="returnButton",e.title="Return to Initiative List",e.value="Return",e.onclick=async function(){fo(!1)},n?.append(e)}function Va(){const n=document.createElement("input");return n.type="button",n.id="settingsButton",n.value="Settings",n.title="View Settings",n.classList.add("footer-button"),n.onclick=async function(){ho(!0)},n}function ho(n){G.MAINSETTINGS.style.display=n?"contents":"none",G.MAINAPP.style.display=n?"none":"block"}function fo(n){G.MAINLOG.style.display=n?"contents":"none",G.MAINAPP.style.display=n?"none":"block"}function Wa(n){G.MAINSETTINGS.style.display=n?"none":"contents",G.MAINLOG.style.display=n?"none":"contents",G.MAINAPP.style.display=n?"block":"none"}function Ga(){document.getElementById("contextMenu").style.display="none"}function _e(n,e){return n.metadata[e]}async function Ye(n,e){const t=n.substring(2);await F.scene.items.updateItems(r=>r.id===t,r=>{for(let i of r)for(let s of e)i.metadata[s.key]=s.value,s.key===E.OWNERID&&(i.createdUserId=s.value)})}async function qa(n,e){const t=await F.viewport.getHeight(),r=100,i=t>800?700:t-r;e?(await F.popover.close(`POP_${n}`),await F.popover.open({id:G.EXTENSIONSUBMENUID,url:`/submenu/subindex.html?unitid=${n}`,height:i,width:350,anchorElementId:e,hidePaper:!0,disableClickAway:!0})):(await F.popover.close(`POP_${n}`),await F.popover.open({id:G.EXTENSIONSUBMENUID,url:`/submenu/subindex.html?unitid=${n}`,height:i,width:350,hidePaper:!0,disableClickAway:!0}))}class $a{id;tokenId;initiative;currentHP;isMonster;isActive;unitName;maxHP;armorClass;unitType;unitSize;strScore;strSave;dexScore;dexSave;conScore;conSave;intScore;intSave;wisScore;wisSave;chaScore;chaSave;damageVulnerabilities;damageImmunities;damageResistances;conditionImmunities;challengeRating;experiencePoints;alignment;standardActions;legendaryActions;specialAbilities;spellActions;reactions;spellList;senses;languages;speedWalk;speedFly;speedClimb;speedBurrow;speedSwim;dataSlug;favorite;ownerId;sceneId;constructor(e,t,r){this.id=e,this.tokenId=e,this.isActive=0,this.unitName=t??="Default",this.initiative=1,this.currentHP=4,this.maxHP=4,this.armorClass=10,this.speedWalk=30,this.speedBurrow=0,this.speedSwim=0,this.speedClimb=0,this.speedFly=0,this.strScore=10,this.dexScore=10,this.conScore=10,this.intScore=10,this.wisScore=10,this.chaScore=10,this.strSave=2,this.dexSave=2,this.conSave=2,this.intSave=2,this.wisSave=2,this.chaSave=2,this.senses="No unique senses.",this.unitSize="Medium",this.unitType="Humanoid",this.alignment="True Neutral",this.languages="No known languages.",this.damageVulnerabilities="None.",this.damageResistances="None.",this.damageImmunities="None.",this.conditionImmunities="None.",this.challengeRating="0CR.",this.experiencePoints=0,this.standardActions=[],this.specialAbilities=[],this.spellList=[],this.dataSlug="",this.favorite=!1,this.ownerId=r,this.sceneId=""}ImportFromJSON(e){let t=JSON.parse(e);this.SetToModel(t)}async ImportFromDatabase(e){const t=await rt.ActiveEncounter.get(e);if(!t){console.log("Found no UnitInformation for "+e);return}this.SetToModel(t),this.isActive=t.isActive}SetMetadata(e){const t=e.metadata;this.id=t[E.ID],this.initiative=t[E.INITIATIVE],this.maxHP=t[E.CURRENTHP],this.maxHP=t[E.MAXHP],this.isMonster=t[E.ISMONSTER],this.unitName=t[E.UNITNAME],this.armorClass=t[E.ARMORCLASS],this.unitType=t[E.UNITTYPE],this.unitSize=t[E.UNITSIZE],this.strScore=t[E.STRSCORE],this.strSave=t[E.STRSAVE],this.dexScore=t[E.DEXSCORE],this.dexSave=t[E.DEXSAVE],this.conScore=t[E.CONSCORE],this.conSave=t[E.CONSAVE],this.intScore=t[E.INTSCORE],this.intSave=t[E.INTSAVE],this.wisScore=t[E.WISSCORE],this.wisSave=t[E.WISSAVE],this.chaScore=t[E.CHASCORE],this.chaSave=t[E.CHASAVE],this.damageVulnerabilities=t[E.DAMAGEVULNERABILITIES],this.damageImmunities=t[E.DAMAGEIMMUNITIES],this.damageResistances=t[E.DAMAGERESISTANCES],this.conditionImmunities=t[E.CONDITIONIMMUNITIES],this.challengeRating=t[E.CHALLENGERATING],this.experiencePoints=t[E.EXPERIENCEPOINTS],this.alignment=t[E.ALIGNMENT],this.standardActions=t[E.STANDARDACTIONS],this.legendaryActions=t[E.LEGENDARYACTIONS],this.specialAbilities=t[E.SPECIALABILITIES],this.spellActions=t[E.SPELLACTIONS],this.reactions=t[E.REACTIONS],this.spellList=t[E.SPELLLIST],this.senses=t[E.SENSES],this.languages=t[E.LANGUAGES],this.speedWalk=t[E.SPEEDWALK],this.speedFly=t[E.SPEEDFLY],this.speedClimb=t[E.SPEEDCLIMB],this.speedBurrow=t[E.SPEEDBURROW],this.speedSwim=t[E.SPEEDSWIM],this.ownerId=t[E.OWNERID]}GetMetadata(){const e={};return e[E.ID]=this.id,e[E.INITIATIVE]=this.initiative,e[E.CURRENTHP]=this.maxHP,e[E.MAXHP]=this.maxHP,e[E.ISMONSTER]=this.isMonster,e[E.UNITNAME]=this.unitName,e[E.ARMORCLASS]=this.armorClass,e[E.UNITTYPE]=this.unitType,e[E.UNITSIZE]=this.unitSize,e[E.STRSCORE]=this.strScore,e[E.STRSAVE]=this.strSave,e[E.DEXSCORE]=this.dexScore,e[E.DEXSAVE]=this.dexSave,e[E.CONSCORE]=this.conScore,e[E.CONSAVE]=this.conSave,e[E.INTSCORE]=this.intScore,e[E.INTSAVE]=this.intSave,e[E.WISSCORE]=this.wisScore,e[E.WISSAVE]=this.wisSave,e[E.CHASCORE]=this.chaScore,e[E.CHASAVE]=this.chaSave,e[E.DAMAGEVULNERABILITIES]=this.damageVulnerabilities,e[E.DAMAGEIMMUNITIES]=this.damageImmunities,e[E.DAMAGERESISTANCES]=this.damageResistances,e[E.CONDITIONIMMUNITIES]=this.conditionImmunities,e[E.CHALLENGERATING]=this.challengeRating,e[E.EXPERIENCEPOINTS]=this.experiencePoints,e[E.ALIGNMENT]=this.alignment,e[E.STANDARDACTIONS]=this.standardActions,e[E.LEGENDARYACTIONS]=this.legendaryActions,e[E.SPECIALABILITIES]=this.specialAbilities,e[E.SPELLACTIONS]=this.spellActions,e[E.REACTIONS]=this.reactions,e[E.SPELLLIST]=this.spellList,e[E.SENSES]=this.senses,e[E.LANGUAGES]=this.languages,e[E.SPEEDWALK]=this.speedWalk,e[E.SPEEDFLY]=this.speedFly,e[E.SPEEDCLIMB]=this.speedClimb,e[E.SPEEDBURROW]=this.speedBurrow,e[E.SPEEDSWIM]=this.speedSwim,e[E.OWNERID]=this.ownerId,e}SetToModel(e,t){this.initiative=e.initiative,this.currentHP=e.maxHP,this.maxHP=e.maxHP,this.isMonster=e.isMonster,this.unitName=e.unitName,this.armorClass=e.armorClass,this.unitType=e.unitType,this.unitSize=e.unitSize,this.strScore=e.strScore,this.strSave=e.strSave,this.dexScore=e.dexScore,this.dexSave=e.dexSave,this.conScore=e.conScore,this.conSave=e.conSave,this.intScore=e.intScore,this.intSave=e.intSave,this.wisScore=e.wisScore,this.wisSave=e.wisSave,this.chaScore=e.chaScore,this.chaSave=e.chaSave,this.damageVulnerabilities=e.damageVulnerabilities,this.damageImmunities=e.damageImmunities,this.damageResistances=e.damageResistances,this.conditionImmunities=e.conditionImmunities,this.challengeRating=e.challengeRating,this.experiencePoints=e.experiencePoints,this.alignment=e.alignment,this.standardActions=e.standardActions,this.legendaryActions=e.legendaryActions,this.specialAbilities=e.specialAbilities,this.spellActions=e.spellActions,this.reactions=e.reactions,this.spellList=e.spellList,this.senses=e.senses,this.languages=e.languages,this.speedWalk=e.speedWalk,this.speedFly=e.speedFly,this.speedClimb=e.speedClimb,this.speedBurrow=e.speedBurrow,this.speedSwim=e.speedSwim,this.dataSlug=e.dataSlug,this.favorite=t?e.favorite:!1,this.CheckDefaults()}ImportCustomFormInputs(e){this.unitName=this.GetContent(e,"formUnitName"),this.maxHP=parseFloat(this.GetContent(e,"formMaxHP"))||4,this.currentHP=this.maxHP,this.armorClass=parseFloat(this.GetContent(e,"formArmorClass"))||10,this.unitType=this.GetContent(e,"formUnitType"),this.unitSize=this.GetContent(e,"formUnitSize"),this.alignment=this.GetContent(e,"formAlignment"),this.speedWalk=parseFloat(this.GetContent(e,"formSpeedWalk"))||0,this.speedSwim=parseFloat(this.GetContent(e,"formSpeedSwim"))||0,this.speedClimb=parseFloat(this.GetContent(e,"formSpeedClimb"))||0,this.speedFly=parseFloat(this.GetContent(e,"formSpeedFly"))||0,this.speedBurrow=parseFloat(this.GetContent(e,"formSpeedBurrow"))||0,this.strScore=parseFloat(this.GetContent(e,"formStrScore"))||1,this.dexScore=parseFloat(this.GetContent(e,"formDexScore"))||1,this.conScore=parseFloat(this.GetContent(e,"formConScore"))||1,this.intScore=parseFloat(this.GetContent(e,"formIntScore"))||1,this.wisScore=parseFloat(this.GetContent(e,"formWisScore"))||1,this.chaScore=parseFloat(this.GetContent(e,"formChaScore"))||1,this.strSave=parseFloat(this.GetContent(e,"formStrSave"))||0,this.dexSave=parseFloat(this.GetContent(e,"formDexSave"))||0,this.conSave=parseFloat(this.GetContent(e,"formConSave"))||0,this.intSave=parseFloat(this.GetContent(e,"formIntSave"))||0,this.wisSave=parseFloat(this.GetContent(e,"formWisSave"))||0,this.chaSave=parseFloat(this.GetContent(e,"formChaSave"))||0,this.senses=this.GetContent(e,"formSenses"),this.languages=this.GetContent(e,"formLanguages"),this.challengeRating=this.GetContent(e,"formChallengeRating"),this.experiencePoints=parseFloat(this.GetContent(e,"formEXP"))||0,this.damageImmunities=this.GetContent(e,"formImmune"),this.damageResistances=this.GetContent(e,"formResist"),this.damageVulnerabilities=this.GetContent(e,"formVulnerable"),this.conditionImmunities=this.GetContent(e,"formConditions");const t=e.querySelectorAll("#formAttackCollection > #formAttackContainer");this.standardActions=[],t.forEach(c=>{const a=c.querySelector("#formAttackName")?.textContent,h=c.querySelector("#formAttackDesc")?.textContent;if(a&&h){let l={name:a,desc:h};this.standardActions?.push(l)}});const r=e.querySelectorAll("#formReactionCollection > #formReactionContainer");this.reactions=[],r.forEach(c=>{const a=c.querySelector("#formReactionName")?.textContent,h=c.querySelector("#formReactionDesc")?.textContent;if(a&&h){let l={name:a,desc:h};this.reactions?.push(l)}});const i=e.querySelectorAll("#formLegendaryCollection > #formLegendaryContainer");this.legendaryActions=[],i.forEach(c=>{const a=c.querySelector("#formLegendaryName")?.textContent,h=c.querySelector("#formLegendaryDesc")?.textContent;if(a&&h){let l={name:a,desc:h};this.legendaryActions?.push(l)}});const s=e.querySelectorAll("#formAbilityCollection > #formAbilityContainer");this.specialAbilities=[],s.forEach(c=>{const a=c.querySelector("#formAbilityName")?.textContent,h=c.querySelector("#formAbilityDesc")?.textContent;if(a&&h){let l={name:a,desc:h};this.specialAbilities?.push(l)}});const o=e.querySelectorAll("#formSpellCollection > #formSpellContainer");this.spellActions=[],o.forEach(c=>{const a=c.querySelector("#formSpellName")?.textContent,h=c.querySelector("#formSpellDesc")?.textContent;if(a&&h){let l={name:a,desc:h};this.spellActions?.push(l)}}),this.CheckDefaults()}CheckDefaults(){this.unitName??="Nameless",this.maxHP??=4,this.currentHP??=this.maxHP,this.armorClass??=10,this.dataSlug??="Unknown",this.unitType??="Humanoid",this.unitSize??="Medium",this.alignment??="True Neutral",this.speedWalk??=30,this.speedSwim??=0,this.speedClimb??=0,this.speedFly??=0,this.speedBurrow??=0,this.strScore??=10,this.dexScore??=10,this.conScore??=10,this.intScore??=10,this.wisScore??=10,this.chaScore??=10,this.strSave??=Math.floor((Number(this.strScore)-10)/2),this.dexSave??=Math.floor((Number(this.dexScore)-10)/2),this.conSave??=Math.floor((Number(this.conScore)-10)/2),this.intSave??=Math.floor((Number(this.intScore)-10)/2),this.wisSave??=Math.floor((Number(this.wisScore)-10)/2),this.chaSave??=Math.floor((Number(this.chaScore)-10)/2),this.senses??="No unique senses.",this.languages??="No known languages.",this.challengeRating??="0CR.",this.experiencePoints??=0,this.damageImmunities??="None.",this.damageResistances??="None.",this.damageVulnerabilities??="None.",this.conditionImmunities??="None."}GetContent(e,t){return e.getElementById(t).textContent}async ImportOpen5eResponse(e){this.unitName=e.name,this.maxHP=e.hit_points,this.armorClass=e.armor_class,this.unitType=e.type,this.unitSize=e.size,this.strScore=e.strength,this.strSave=e.strength_save,this.dexScore=e.dexterity,this.dexSave=e.dexterity_save,this.conScore=e.constitution,this.conSave=e.constitution_save,this.intScore=e.intelligence,this.intSave=e.intelligence_save,this.wisScore=e.wisdom,this.wisSave=e.wisdom_save,this.chaScore=e.charisma,this.chaSave=e.charisma_save,this.damageVulnerabilities=e.damage_vulnerabilities,this.damageImmunities=e.damage_immunities,this.damageResistances=e.damage_resistances,this.conditionImmunities=e.condition_immunities,this.challengeRating=e.challenge_rating,this.experiencePoints=0,this.alignment=e.alignment,this.standardActions=e.actions,this.legendaryActions=e.legendary_actions,this.specialAbilities=e.special_abilities,this.reactions=e.reactions,this.spellList=e.spell_list,this.spellList!=null&&this.spellList?.length>0&&(this.spellActions=await this.ConvertSpellListtoSpellAction(this.spellList)),this.senses=e.senses,this.languages=e.languages,this.speedWalk=e.speed?.walk,this.speedFly=e.speed?.fly,this.speedClimb=e.speed?.walk,this.speedBurrow=e.speed?.burrow,this.speedSwim=e.speed?.swim,this.CheckDefaults()}async ConvertSpellListtoSpellAction(e){const t=[];for(var r=0,i;i=e[r];r++)await fetch(i).then(function(s){return s.json()}).then(function(s){let o={name:s.name,desc:s.desc};t.push(o)});return t}async SaveToDB(e){return this.sceneId=e,await rt.ActiveEncounter.put(this)}async SaveToCreatureStorage(){return await rt.Creatures.add(this)}}async function Ya(){G.MAINSETTINGS.innerHTML=`
        <div id="settingsWindowContainer">
            <div class="settings-header">Settings - Data Management</div>
            <div class="settings-item">
                <div>
                    <span id="exportAllContainer"></span>
                    - Collection to Clash! JSON
                </div>
                <i><small>This will save Collection data to a Text/JSON file</small></i>
            </div>
            <div class="settings-item">
                <div>
                    <span id="importSubmitContainer">
                    <label id="importSubmitLabel" for="importSubmitButton">IMPORT</label></span>
                    - Clash! JSON to Collection
                </div>
                <div>
                    <span id="importAllContainer"></span>
                </div>
                <i><small>This will overwrite keys with the same Name/Author</small></i>
            </div>
            <div class="settings-item">
                <div>
                    <span id="clearAllContainer"></span>
                    - Clear All Clash! Collection Data 
                </div>
                <i><small>This will delete the database and start from scratch.</small></i>
            </div>
            <div class="settings-header">Initiative List</div>
                <div style="display:flex;">
                    <span id="resetClearContainer"></span>
                </div>
                <table>
                    <tr>
                        <td>
                            ${I("HPROW")}
                            Health </div>
                        </td>
                        <td>
                            ${I("TEMPHPROW")}
                            Temp Health </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            ${I("ACROW")}
                            Armor </div>
                        </td>
                        <td>
                            ${I("MOVEROW")}
                            Fastest Move </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            ${I("EFXROW")}
                            Effects </div>
                        </td>
                        <td>
                            ${I("ELEVATEROW")}
                            Elevation </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            ${I("ROLLERROW")}
                            Roller </div>
                        </td>
                        <td>
                            ${I("BLOCKROW")}
                            Stat Block </div>
                        </td>
                    </tr>
                </table>
            <div class="settings-header">Gameplay</div>
            <div title="This disables the view from a player's perspective, so they cannot see any information on the Initiative List.">
                ${I("HIDEALL")}
                Disable Player Initiative List
            </div>
            <div title="Ths will hide all information other than enemy Initiative for units they do not own.">
                ${I("HIDEENEMYINFO")}
                Hide Enemy Information on Player Initiative List
            </div>
            <div title="This changes the color of a unit from White to Yellow to Red depending on how much HP they have left. 100% => 50% => 25%.">
                ${I("HIDEHP")}
                Disable HP Colors on Player Initiative List 
            </div>
            <div title="This disables showing HP bars on each token in Initiative for you and your players.">
                ${I("HIDEHPBAR")}
                Disable HP Bars on Tokens 
            </div>
            <div title="This swaps the HP on the bar to showing exact numbers instead of a percentage.">
                ${I("HPBARNUMBERS")}
                Show HP Numbers instead of Bar 
            </div>
            <div title="This reverses the Initiative List turn order, so that lowest number goes first.">
                ${I("REVERSELIST")}
                Reverse Initiative Order
            </div>
            <div title="This disables the auto-focus when current turn changes.">
                ${I("DISABLEFOCUS")}
                Disable Camera Focus (For Self)
            </div>
            <div title="This will make it so Clash! will also add the name to the token's label. Turning it off will REMOVE visible names from any token on the Initiative List.">
                ${I("SHOWNAMES")}
                Show Names on Token
            </div>
            <div title="This will give all duplicate tokens a random descripitor to tell them apart. Turn off if you hate fun.">
                ${I("RANDOMNAME")}
                Descriptor Names for Duplicates
            </div>
            <div title="This removes the label applied to the token indicating it's their turn.">
                ${I("DISABLELABEL")}
                Disable Turn Label
            </div>
            <span style="display:flex;">Turn Label <div id="turnLabelTextContainer" style="padding-left: 6px;"></div></span>
            <div title="This makes it so any initiative rolled via Clash adds the unit's Dexterity modifier.">
                ${I("INITBONUS")}
                Add DEX to Initiative Rolls
            </div>
            <span style="display:flex;">Initiative Dice <div id="initDiceContainer" style="padding-left: 6px;"></div></span>

            <div class="settings-header">Dice</div>
            <div title="This enables the integration with Rumble! so that roll results are shown for all to see.">
                ${I("RUMBLELOG")}
                Enable Rumble! Integratrion 
            </div>
            <div title="This enables the 3D dice window when rolling (To self only).">
                ${I("VISUALDICE")}
                Enable 3D Dice Rolls (For Self)
            </div>
            <div title="This enables the dice notification showing the results at the top of the screen.">
                ${I("DICENOTIFICATION")}
                Enable Dice Text Notification of Results 
            </div>
            <div title="This enables showing dice notifications to everyone.">
                ${I("DICEEVERYONE")}
                Enable Showing Text Results to All
            </div>
            <div title="This sends the results of all rolls to the specified Discord channel/hook.">
                ${I("DISCORDHOOK")}
                Enable Discord Logging
            </div>
                <span style="display:flex;">Discord Hook <div id="discordHookContainer" style="padding-left: 6px;"></div><embed id="discordIcon" class="discord" src="/discord2.svg" /></span>
            <footer>
                <span id="settingsReturnContainer"></span>
            </footer>
        </div>
       `,x("HIDEHP",!!Q(N.HIDEHP)),x("HIDEALL",!!Q(N.HIDEALL)),x("HIDEENEMYINFO",!!Q(N.HIDEENEMYINFO)),x("HIDEHPBAR",!!Q(N.HIDEHPBAR)),x("HPBARNUMBERS",!!Q(N.HPBARNUMBERS)),x("REVERSELIST",!!Q(N.REVERSELIST)),x("DISABLEFOCUS",!!Q(N.DISABLEFOCUS)),x("SHOWNAMES",!!Q(N.NAMELABELS)),x("RANDOMNAME",Q(N.RANDOMNAME)??!0),x("DISABLELABEL",!!Q(N.DISABLELABEL)),x("INITBONUS",Q(N.INITBONUS)??!0),x("RUMBLELOG",!!Q(N.RUMBLELOG)),x("VISUALDICE",!!Q(N.VISUALDICE)),x("DICENOTIFICATION",!!Q(N.DICENOTIFICATION)),x("DICEEVERYONE",!!Q(N.DICEEVERYONE)),x("DISCORDHOOK",Q(N.DISCORDHOOK)??!1),x("HPROW",Q(N.HPROW)??!0),x("TEMPHPROW",!!Q(N.TEMPHPROW)),x("ACROW",Q(N.ACROW)??!0),x("MOVEROW",!!Q(N.MOVEROW)),x("ROLLERROW",Q(N.ROLLERROW)??!0),x("BLOCKROW",Q(N.BLOCKROW)??!0),x("EFXROW",!!Q(N.EFXROW)),x("ELEVATEROW",!!Q(N.ELEVATEROW));const n=document.getElementById("turnLabelTextContainer"),e=document.createElement("input");e.type="text",e.id="textLabelButton",e.title="Change your Turn Label's text",e.placeholder="Custom Turn Label",e.maxLength=20,e.value=ee.roomMetadata[N.TURNTEXT]??"",e.size=20,e.onblur=async P=>{const T=P.currentTarget;await F.room.setMetadata({[N.TURNTEXT]:T.value})},n?.appendChild(e);const t=document.getElementById("discordIcon");Q(N.DISCORDURL)&&(t.style.display="block");const r=document.getElementById("discordHookContainer"),i=document.createElement("input");i.type="text",i.id="discordHookInput",i.title="Add your Discord Webhook",i.placeholder="Add your channel hook..",i.maxLength=200,i.value=ee.roomMetadata[N.DISCORDURL]??"",i.size=18,i.onblur=async P=>{const T=P.currentTarget;T.value&&(T.value.startsWith("https://discord.com/api/webhook")||T.value.startsWith("https://discordapp.com/api/webhook"))?(T.classList.add("flash-input"),await F.room.setMetadata({[N.DISCORDURL]:T.value}),setTimeout(()=>{T.classList.remove("flash-input"),t.style.display="block"},1e3)):(T.classList.add("shake-input"),T.value="Invalid/Clearing URL",Q(N.DISCORDURL)&&await F.room.setMetadata({[N.DISCORDURL]:void 0}),setTimeout(()=>{T.classList.remove("shake-input"),T.value="",t.style.display="none"},1e3))},r?.appendChild(i);const s=document.getElementById("initDiceContainer"),o=document.createElement("input");o.type="number",o.id="textLabelButton",o.classList.add("remove-number-arrow"),o.title="Change your Turn Label's text",o.placeholder="Custom Turn Label",o.maxLength=2,o.min="2",o.max="99",o.value=ee.roomMetadata[N.INITIATIVEDICE]??"20",o.size=6,o.oninput=P=>{const T=P.currentTarget;parseInt(T.value)<1?T.value="1":parseInt(T.value)>99?T.value="99":isNaN(parseInt(T.value))&&(T.value="20")},o.onblur=async P=>{const T=P.currentTarget;await F.room.setMetadata({[N.INITIATIVEDICE]:parseInt(T.value)})},s?.appendChild(o);const c=document.getElementById("importAllContainer"),a=document.createElement("input");a.type="checkbox",a.id="favBox",a.title="Unfavorite during Upload";const h=document.getElementById("importSubmitContainer"),l=document.createElement("input");l.type="file",l.style.display="none",l.id="importSubmitButton",l.onchange=async function(){if(l.files&&l.files.length>0){let P=l.files[0],T=new FileReader;T.readAsText(P),T.onload=async function(){try{const $=JSON.parse(T.result);await _($),F.notification.show("Import Complete!","SUCCESS"),l.files=null}catch($){await F.notification.show(`The import failed - ${$}`,"ERROR"),l.files=null}},T.onerror=function(){console.log(T.error),l.files=null}}},c?.appendChild(a),c?.appendChild(document.createTextNode("Unfavorite all items that are Imported")),h?.appendChild(l);const d=document.getElementById("exportAllContainer"),p=document.createElement("input");p.type="button",p.classList.add("settings-input-button"),p.id="exportButton",p.value="EXPORT",p.title="Export Clash Collection Data",p.onclick=async function(){await M()},d?.appendChild(p);const b=document.getElementById("clearAllContainer"),C=document.createElement("input");C.type="button",C.classList.add("settings-input-button"),C.id="deleteButton",C.value="DELETE",C.title="Clear all Clash! Data",C.onclick=async function(){confirm("Delete EVERYTHING? (Deletes Database and Refreshes Window)")&&(te.turnCounter=1,te.roundCounter=1,te.viewCounter.innerText=`Round: ${te.roundCounter}`,await F.scene.items.deleteItems([G.LABEL]),await F.scene.items.updateItems(P=>P.metadata[`${G.EXTENSIONID}/metadata_initiative`]!=null||P.id===G.LABEL,P=>{for(let T of P)delete T.metadata[`${G.EXTENSIONID}/metadata_initiative`]}),await rt.delete(),window.location.reload())},b?.appendChild(C);const m=document.getElementById("settingsReturnContainer"),v=document.createElement("input");v.type="button",v.id="returnButton",v.title="Save and return to Initiative List",v.value="Return",v.onclick=async function(){ho(!1),te.RefreshList(),Wa(!0)},m?.append(v);const A=document.getElementById("resetClearContainer"),g=document.createElement("input");g.type="button",g.classList.add("settings-input-button"),g.id="resetTurnButton",g.value="Reset Initiative List",g.title="Reset",g.onclick=async function(){te.turnCounter=0,te.roundCounter=1;const P=document.getElementById("roundCounter");P.innerText=`Round: ${te.roundCounter}`,await F.scene.items.updateItems(ee.sceneItems.filter(T=>Ne(T,E.ONLIST)===!0).map(T=>T.id),T=>{for(let $ of T)$.metadata[E.INITIATIVE]=1,$.metadata[E.CURRENTHP]=$.metadata[E.MAXHP],$.metadata[E.ELEVATION]=null,$.metadata[E.EFFECTS]=null}),await F.scene.setMetadata({[N.TURNCOUNT]:te.turnCounter,[N.ROUNDCOUNT]:te.roundCounter}),te.ShowTurnSelection()},A?.appendChild(g);const O=document.createElement("input");O.type="button",O.id="clearButton",O.classList.add("settings-input-button"),O.value="Clear Initiative List",O.title="Clear",O.onclick=async function(){if(confirm("Clear the Initiative List (This will leave unit info)?")){te.turnCounter=0,te.roundCounter=1;const P=document.getElementById("roundCounter");P.innerText=`Round: ${te.roundCounter}`;const T=ee.sceneItems.map($=>$.id+"_hpbar");T.push(G.LABEL),await F.scene.items.deleteItems(T),await F.scene.items.updateItems(ee.sceneItems,$=>{for(let Y of $)Y.metadata[E.INITIATIVE]=1,delete Y.metadata[E.ONLIST],delete Y.metadata[E.HPBAR]})}},A?.appendChild(O);function I(P){return`<label class="switch" id="setting${P}Container">
            <span class="slider round"></span>
            </label>`}function x(P,T){const $=document.getElementById(`setting${P}Container`),Y=document.createElement("input");Y.type="checkbox",Y.value=String(T),Y.checked=T,Y.onclick=async function(he){const X=he.target;switch(Y.value=String(X.checked),P){case"HIDEHP":await F.room.setMetadata({[N.HIDEHP]:X.checked});break;case"HIDEALL":await F.room.setMetadata({[N.HIDEALL]:X.checked});break;case"HIDEENEMYINFO":await F.room.setMetadata({[N.HIDEENEMYINFO]:X.checked});break;case"HIDEHPBAR":await F.room.setMetadata({[N.HIDEHPBAR]:X.checked});break;case"HPBARNUMBERS":await F.room.setMetadata({[N.HPBARNUMBERS]:X.checked});break;case"DISABLEFOCUS":await F.room.setMetadata({[N.DISABLEFOCUS]:X.checked});break;case"SHOWNAMES":await F.room.setMetadata({[N.NAMELABELS]:X.checked});break;case"RANDOMNAME":await F.room.setMetadata({[N.RANDOMNAME]:X.checked});break;case"DISABLELABEL":await F.room.setMetadata({[N.DISABLELABEL]:X.checked});break;case"REVERSELIST":await F.room.setMetadata({[N.REVERSELIST]:X.checked});break;case"RUMBLELOG":await F.room.setMetadata({[N.RUMBLELOG]:X.checked});break;case"VISUALDICE":await F.room.setMetadata({[N.VISUALDICE]:X.checked});break;case"DICENOTIFICATION":await F.room.setMetadata({[N.DICENOTIFICATION]:X.checked});break;case"DICEEVERYONE":await F.room.setMetadata({[N.DICEEVERYONE]:X.checked});break;case"DISCORDHOOK":await F.room.setMetadata({[N.DISCORDHOOK]:X.checked});break;case"HPROW":await F.room.setMetadata({[N.HPROW]:X.checked});break;case"ROLLERROW":await F.room.setMetadata({[N.ROLLERROW]:X.checked});break;case"TEMPHPROW":await F.room.setMetadata({[N.TEMPHPROW]:X.checked});break;case"ACROW":await F.room.setMetadata({[N.ACROW]:X.checked});break;case"MOVEROW":await F.room.setMetadata({[N.MOVEROW]:X.checked});break;case"BLOCKROW":await F.room.setMetadata({[N.BLOCKROW]:X.checked});break;case"EFXROW":await F.room.setMetadata({[N.EFXROW]:X.checked});break;case"ELEVATEROW":await F.room.setMetadata({[N.ELEVATEROW]:X.checked});break;case"INITBONUS":await F.room.setMetadata({[N.INITBONUS]:X.checked});break}},$?.insertBefore(Y,$.firstChild)}async function M(){const P=await rt.Creatures.toArray();var T=document.createElement("a"),$=new Blob([JSON.stringify(P)],{type:"text/plain"});T.href=URL.createObjectURL($),T.download=`ClashCollectionExport-${Date.now()}`,document.body.appendChild(T),T.click(),document.body.removeChild(T)}async function _(P){const T=await rt.Creatures.toArray();let $=[];P.forEach(Y=>{let he=new $a("","Default");he.SetToModel(Y,!a.checked),he.tokenId="";const X=T.find(ne=>ne.unitName==Y.unitName&&ne.dataSlug==Y.dataSlug);X?he.id=X.id:he.id=Ba(),$.push(he)}),await rt.Creatures.bulkPut($)}}class Tn{static async FocusUnit(e){e.preventDefault();const r=e.target.closest("tr").getAttribute("unit-id"),i=ee.sceneItems.find(s=>s.id===r);await Tn.CenterViewportOnImage(i)}static async CenterViewportOnImage(e){const t=await F.scene.grid.getDpi(),r=await F.viewport.getScale(),i=await F.viewport.getWidth(),s=await F.viewport.getHeight(),o={x:i/2,y:s/2},c={x:o.x/r,y:o.y/r},a=await this.GetImageCenter(e,t),h={x:a.x-c.x,y:a.y-c.y},l={x:h.x*r*-1,y:h.y*r*-1};await F.viewport.animateTo({position:l,scale:r})}static async GetImageCenter(e,t){if(go(e)){const r=t/e.grid.dpi,i=e.image.width*r,s=e.image.height*r,o=e.grid.offset.x/e.image.width*i,c=e.grid.offset.y/e.image.height*s;return{x:e.position.x-o+i/2,y:e.position.y-c+s/2}}else return mo(e)&&e.points.length>0?{x:e.points[0].x,y:e.points[0].y}:{x:e.position.x,y:e.position.y}}}class Xa{DISABLEMYFOCUS="";viewHeader;viewBody;viewFooter;viewCounter;windowWidth=350;currentTurnUnit;roundCounter=1;turnCounter=0;RenderWaiting(e){e?(ee.KillHandlers(),G.MAINAPP.hidden=!0,G.MAINLOAD.hidden=!1):(G.MAINAPP.hidden=!1,G.MAINLOAD.hidden=!0)}async Render(){G.MAINAPP.innerHTML=G.PLAYERLIST,this.viewHeader=document.querySelector("#clashPLViewHeader"),this.viewBody=document.querySelector("#clashPLViewBody"),this.viewFooter=document.querySelector("#clashPLViewButtons"),this.viewCounter=document.querySelector("#roundCounterContainer"),this.roundCounter=_n(N.ROUNDCOUNT)??1,this.turnCounter=_n(N.TURNCOUNT)??0,this.DISABLEMYFOCUS=`${G.EXTENSIONID}/setting_disablefocus_${ee.playerId}`,this.SetupFocusSlider(),La(),lo();const e=document.getElementById("clashPLViewBody");e&&e.addEventListener("dblclick",t=>Tn.FocusUnit(t)),await this.RefreshList()}async RefreshList(){const e=ee.sceneItems.filter(l=>l.metadata[E.ONLIST]===!0);let t=0;const r=Ks(ee.playerColor,.9),i=["INIT"];(ee.roomMetadata[N.ROLLERROW]??!0)&&i.push("ROLL"),i.push("NAME"),(ee.roomMetadata[N.HPROW]??!0)&&i.push("HP"),ee.roomMetadata[N.TEMPHPROW]&&i.push("TEMPHP"),(ee.roomMetadata[N.ACROW]??!0)&&i.push("AC"),ee.roomMetadata[N.MOVEROW]&&i.push("MOVE"),ee.roomMetadata[N.ELEVATEROW]&&i.push("ELEVATE"),ee.roomMetadata[N.EFXROW]&&i.push("EFX");let s;ee.roomMetadata[N.REVERSELIST]?s=e.sort((l,d)=>Ne(l,E.INITIATIVE)-Ne(d,E.INITIATIVE)||Ne(l,E.UNITNAME).localeCompare(Ne(d,E.UNITNAME))):s=e.sort((l,d)=>Ne(d,E.INITIATIVE)-Ne(l,E.INITIATIVE)||Ne(l,E.UNITNAME).localeCompare(Ne(d,E.UNITNAME))),this.viewHeader.innerHTML="",this.viewBody.innerHTML="";const o=this.viewHeader.insertRow(-1),c=Vs();if(o.appendChild(c),t+=1,i.includes("ROLL")){const l=Ws();o.appendChild(l),t+=1}const a=Gs();if(o.appendChild(a),t+=3,i.includes("HP")){const l=qs();o.appendChild(l),t+=2}if(i.includes("TEMPHP")){const l=$s();o.appendChild(l),t+=1}if(i.includes("AC")){const l=Ys();o.appendChild(l),t+=1}if(i.includes("MOVE")){const l=Xs();o.appendChild(l),t+=1}if(i.includes("ELEVATE")){const l=zs();o.appendChild(l),t+=1}if(i.includes("EFX")){const l=Js();o.appendChild(l),t+=1}const h=Qs();if(o.appendChild(h),t>7){const l=350+(t-7)*25;l!==this.windowWidth&&(await F.action.setWidth(l),this.windowWidth=l)}else this.windowWidth!==400&&(await F.action.setWidth(350),this.windowWidth=350);for(const l of s){const d=ee.playerId===l.createdUserId,p=this.viewBody.insertRow(-1);l.visible||(p.style.display="none"),p.setAttribute("unit-id",l.id);let b=0;const C=p.insertCell(b),m=Zs(l);if(this.Disable(m,d),C.appendChild(m),b++,i.includes("ROLL")){const g=p.insertCell(b);g.style.textAlign="center";const O=eo(l);this.Disable(O,d),g.appendChild(O),b++}const v=p.insertCell(b),A=to(l);if(d&&(A.style.borderColor=r,A.style.borderWidth="2px"),!Q(N.HIDEHP)){const g=Ne(l,E.CURRENTHP),O=Ne(l,E.MAXHP);g<=O/4?A.classList.add("unit-harmed"):g<=O/2?A.classList.add("unit-hurt"):A.classList.add("unit-happy")}if(this.Disable(A,d),v.appendChild(A),v.classList.add("name-cell"),b++,i.includes("HP")){const g=p.insertCell(b);g.style.display="flex",g.style.marginTop="4px";const O=no(l);this.Disable(O,d);const I=ro(l);this.Disable(I,d),g.appendChild(O),(!Q(N.HIDEENEMYINFO)||d)&&g.appendChild(document.createTextNode("/")),g.appendChild(I),b++}if(i.includes("TEMPHP")){const g=p.insertCell(b),O=io(l);this.Disable(O,d),g.appendChild(O),b++}if(i.includes("AC")){const g=p.insertCell(b),O=so(l);this.Disable(O,d),g.appendChild(O),b++}if(i.includes("MOVE")){const g=p.insertCell(b),O=uo(l);g.colSpan=2,d||(O.innerText="",O.classList.remove("information"),O.setAttribute("data-information","")),g.appendChild(O),b++}if(i.includes("ELEVATE")){const g=p.insertCell(b),O=oo(l);this.Disable(O,d),g.appendChild(O),b++}if(i.includes("EFX")){const g=p.insertCell(b);g.style.textAlign="center";const O=ao(l);this.Disable(O,d),g.appendChild(O),b++}p.insertCell(b)}this.ShowTurnSelection()}ShowTurnSelection(){const e=this.viewBody;if(e&&e.rows?.length>0){for(var t=0,r;r=e.rows[t];t++)r.classList.remove("turn-outline");if(this.turnCounter>=e.rows.length&&(this.turnCounter=e.rows.length-1),e.rows[this.turnCounter]){const i=e.rows[this.turnCounter];i.classList.add("turn-outline");const s=i.getAttribute("unit-id");this.currentTurnUnit=ee.sceneItems.find(c=>c.id===s);const o=document.getElementById("roundCounter");o.innerText=`Round: ${this.roundCounter}`}}else this.currentTurnUnit=void 0}async FocusOnCurrentTurnUnit(){ee.roomMetadata[this.DISABLEMYFOCUS]===!0&&this.currentTurnUnit&&await Tn.CenterViewportOnImage(this.currentTurnUnit),await Tt.UpdateLabel()}Disable(e,t){t||(e.disabled=!0,e.classList.add("disabled"),e.classList.remove("clickable"),e.onclick=null,Q(N.HIDEENEMYINFO)&&!e.classList.contains("unit-initiative")&&!e.classList.contains("unit-name-input")&&(e.hidden=!0))}SetupFocusSlider(){const e=document.getElementById("settingnoFocusContainer"),t=document.createElement("input");t.type="checkbox",t.value=Q(this.DISABLEMYFOCUS)?"true":"false",t.checked=!!Q(this.DISABLEMYFOCUS),t.onclick=async function(r){const i=r.target;await F.room.setMetadata({[`${G.EXTENSIONID}/setting_disablefocus_${ee.playerId}`]:i.checked})},e?.insertBefore(t,e.firstChild)}}const _t=new Xa;class Tt{static async UpdateLabel(){const e=Q(N.TURNTEXT),t=e?.trim().length===0||e===void 0?"💡":e,r=!!Q(N.DISABLELABEL),i=ee.playerRole==="GM"?te.currentTurnUnit:_t.currentTurnUnit,s=await F.scene.local.getItems([G.LABEL]);if(await Tt.CleanupHPBars(),r||i===void 0)s&&await F.scene.local.deleteItems([G.LABEL]);else if(s.length===0){const o=po().fillColor("#ffffff").plainText(t).build();o.visible=!1,o.type="LABEL",o.id=G.LABEL,o.style={backgroundColor:"#bb99ff",backgroundOpacity:.5,pointerDirection:"DOWN",pointerWidth:15,pointerHeight:15,cornerRadius:10},o.position={x:i.position.x,y:i.position.y-100},o.visible=!!i.visible,o.text.plainText=o.visible?t:t+`\r
(Hidden)`,o.attachedTo=i.id,o.locked=!0,await F.scene.local.addItems([o])}else await F.scene.local.updateItems(o=>o.id==G.LABEL,o=>{const c=ee.playerRole==="GM"?te.currentTurnUnit:_t.currentTurnUnit;for(let a of o)a.position={x:c.position.x,y:c.position.y-100},a.visible=!!c.visible,a.text.plainText=a.visible?t:t+`\r
(Hidden)`,a.attachedTo=c.id,a.locked=!0})}static async CleanupHPBars(){const e=await F.scene.local.getItems(t=>t.metadata[E.HPBAR]===!0);if(e.length>0){const t=[];for(const r of e)ee.sceneItems.some(s=>s.id===r.attachedTo)||t.push(r.id);t.length>0&&await F.scene.local.deleteItems(t)}}static async UpdateElevation(){const e=ee.sceneItems.filter(i=>i.metadata[E.ONLIST]===!0),t=await F.scene.local.getItems(i=>i.id.startsWith("ELE")),r=t.map(i=>i.id);if(t.length>0||Q(N.ELEVATEROW))if(Q(N.ELEVATEROW)===!1)r.length>0&&await F.scene.local.deleteItems(r);else{await F.scene.local.deleteItems(r);let i=[];for(const s of e){const o=Tt.GetElevation(s);o&&i.push(o)}await F.scene.local.addItems(i)}}static async UpdateHealthBars(){const e=ee.sceneItems.filter(r=>r.metadata[E.ONLIST]===!0),t=await F.scene.local.getItems(r=>r.id.startsWith("LBL"));if(t.length>0||!Q(N.HIDEHPBAR)){const r=t.map(i=>i.id);if(Q(N.HIDEHPBAR)===!0)r.length>0&&await F.scene.local.deleteItems(r);else{await F.scene.local.deleteItems(r);let i=[];for(const s of e)i.push(Tt.GetHPBar(s));await F.scene.local.addItems(i)}}}static GetElevation(e){const r=rs(e,ee.gridDpi),i=Ne(e,E.ELEVATION)??null;if(i===null||i===0||i==="0"||isNaN(i))return;let s="";Ne(e,E.ELEVATION)>0?s="🡹":Ne(e,E.ELEVATION)<0&&(s="🡻");let o=i<0?-i:i;const c=`${s}${o}`,a=jr().plainText(c).fontWeight(900).fillOpacity(.95).fillColor("white").strokeWidth(2).strokeColor("black").strokeOpacity(1).build();return a.position={x:r.min.x-40,y:r.min.y},a.text.style.fontSize=36,a.id="ELE"+e.id.slice(3),a.metadata[E.ELEVATION]=!0,a.metadata[E.ID]=e.id,a.type="TEXT",a.attachedTo=e.id,a.visible=!!e.visible,a.locked=!0,a.disableAttachmentBehavior=["ROTATION","SCALE"],a.text.style.fontFamily="Segoe UI",a.text.type="PLAIN",a.text.style.textAlign="CENTER",a}static GetHPBar(e){const r=rs(e,ee.gridDpi),i=this.GetHealthInformation(e);let s;return Q(N.HPBARNUMBERS)===!0?(s=jr().plainText(i.health).fontWeight(900).fillOpacity(.95).fillColor(i.color).strokeWidth(2).strokeColor("black").strokeOpacity(1).build(),s.position={x:r.max.x-(r.max.x-r.min.x)/2-30,y:r.max.y-55},s.text.style.fontSize=36):(s=jr().plainText(i.health).fontWeight(800).fillOpacity(.85).fillColor(i.color).strokeWidth(1).strokeColor("black").strokeOpacity(1).build(),s.position={x:r.max.x-(r.max.x-r.min.x)/2-85,y:r.max.y-44},s.text.style.fontSize=24),s.id="LBL"+e.id.slice(3),s.metadata[E.HPBAR]=!0,s.metadata[E.ID]=e.id,s.type="TEXT",s.attachedTo=e.id,s.visible=!!e.visible,s.locked=!0,s.disableAttachmentBehavior=["ROTATION","SCALE"],s.text.style.fontFamily="Segoe UI",s.text.type="PLAIN",s.text.style.textAlign="CENTER",s}static GetHealthInformation(e){const t=Ne(e,E.CURRENTHP),r=Ne(e,E.MAXHP),i=Ne(e,E.TEMPHP);let s=this.getHealthPercentageString(t,r),o=this.getTempHealthPercentageString(i,r,s);return{color:this.getHealthColorString(t,r,i),health:o}}static getHealthPercentageString(e,t){const r=e/t*100;if(Q(N.HPBARNUMBERS)===!0)return`${e}⫽${t}`;switch(!0){case r==0:return"▱▱▱▱▱ 0%";case r<=20:return"▰▱▱▱▱ 20%";case r<=40:return"▰▰▱▱▱ 40%";case r<=60:return"▰▰▰▱▱ 60%";case r<=80:return"▰▰▰▰▱ 80%";default:return"▰▰▰▰▰ 100%"}}static getTempHealthPercentageString(e,t,r){if(e>0){if(Q(N.HPBARNUMBERS)===!0)return r+`(${e})`;const i=e/t*100;switch(!0){case i==0:return"▱▱▱▱▱ 0%";case i<=20:return"▮"+r.substring(1);case i<=40:return"▮▮"+r.substring(2);case i<=60:return"▮▮▮"+r.substring(3);case i<=80:return"▮▮▮▮"+r.substring(4);default:return"▮▮▮▮▮ 100%"}}return r}static getHealthColorString(e,t,r){const i=e/t*100;switch(!0){case r>0:return"lightgrey";case i<=25:return"red";case i<=50:return"yellow";default:return"white"}}static async GetCTUFromRow(e){let t={id:"",visible:!1,xpos:0,ypos:0,dpi:0,width:0,height:0,offsetx:0,offsety:0};const r=e.getAttribute("unit-id"),i=await F.scene.items.getItems([r]);for(let s of i){const o=s;t={id:o.id,visible:o.visible,xpos:o.position.x,ypos:o.position.y,dpi:o.grid.dpi,width:o.image.width,height:o.image.height,offsetx:o.grid.offset.x,offsety:o.grid.offset.y}}return t}}class za{currentTurnUnit;startEffectsDone=!1;lastTurnUnit;roundCounter=1;turnCounter=0;windowWidth=350;viewHeader;viewBody;viewFooter;viewCounter;viewPlayerList;addedColumns=[];RenderWaiting(e){e?(ee.KillHandlers(),G.MAINAPP.hidden=!0,G.MAINLOAD.hidden=!1):(G.MAINAPP.hidden=!1,G.MAINLOAD.hidden=!0)}async Render(){if(G.MAINAPP.innerHTML=G.BASELIST,this.viewHeader=document.querySelector("#clashGMViewHeader"),this.viewBody=document.querySelector("#clashGMViewBody"),this.viewFooter=document.querySelector("#clashGMViewButtons"),this.viewCounter=document.querySelector("#roundCounter"),this.viewPlayerList=document.querySelector("#playerListing"),ja(),rt.inMemory){const r=document.createElement("div");r.innerText="Local Storage Disabled - Features Limited",r.className="noDatabase",G.MAINAPP.prepend(r)}this.roundCounter=_n(N.ROUNDCOUNT)??1,this.turnCounter=_n(N.TURNCOUNT)??0,Ya(),lo();const e=document.getElementById("clashGMViewBody");e&&e.addEventListener("dblclick",r=>Tn.FocusUnit(r));const t=document.getElementById("playerListing");t.appendChild(this.GetEmptyContextItem()),t.appendChild(this.GetRemoveContextItem());for(const r of ee.party){const i=document.createElement("li");i.id=r.id,i.textContent=r.name,i.style.color=r.color,t.appendChild(i)}await this.RefreshList()}async RefreshList(){const e=ee.sceneItems.filter(h=>h.metadata[E.ONLIST]===!0);let t=0;const r=["INIT"];(ee.roomMetadata[N.ROLLERROW]??!0)&&r.push("ROLL"),r.push("NAME"),(ee.roomMetadata[N.HPROW]??!0)&&r.push("HP"),ee.roomMetadata[N.TEMPHPROW]&&r.push("TEMPHP"),(ee.roomMetadata[N.ACROW]??!0)&&r.push("AC"),ee.roomMetadata[N.MOVEROW]&&r.push("MOVE"),ee.roomMetadata[N.ELEVATEROW]&&r.push("ELEVATE"),ee.roomMetadata[N.EFXROW]&&r.push("EFX"),(ee.roomMetadata[N.BLOCKROW]??!0)&&r.push("BLOCK");let i;ee.roomMetadata[N.REVERSELIST]?i=e.sort((h,l)=>Ne(h,E.INITIATIVE)-Ne(l,E.INITIATIVE)||Ne(h,E.UNITNAME).localeCompare(Ne(l,E.UNITNAME))):i=e.sort((h,l)=>Ne(l,E.INITIATIVE)-Ne(h,E.INITIATIVE)||Ne(h,E.UNITNAME).localeCompare(Ne(l,E.UNITNAME))),this.viewHeader.innerHTML="",this.viewBody.innerHTML="";const s=this.viewHeader.insertRow(-1),o=Vs();if(s.appendChild(o),t+=1,r.includes("ROLL")){const h=Ws();s.appendChild(h),t+=1}const c=Gs();if(s.appendChild(c),t+=3,r.includes("HP")){const h=qs();s.appendChild(h),t+=2}if(r.includes("TEMPHP")){const h=$s();s.appendChild(h),t+=1}if(r.includes("AC")){const h=Ys();s.appendChild(h),t+=1}if(r.includes("MOVE")){const h=Xs();s.appendChild(h),t+=1}if(r.includes("ELEVATE")){const h=zs();s.appendChild(h),t+=1}if(r.includes("EFX")){const h=Js();s.appendChild(h),t+=1}r.includes("BLOCK")&&(t+=1);const a=Qs();if(s.appendChild(a),t>7){const h=350+(t-7)*25;h!==this.windowWidth&&(await F.action.setWidth(h),this.windowWidth=h)}else this.windowWidth!==400&&(await F.action.setWidth(350),this.windowWidth=350);for(const h of i){const l=this.viewBody.insertRow(-1);l.setAttribute("unit-id",h.id);let d=0;const p=l.insertCell(d),b=Zs(h);if(p.appendChild(b),d++,r.includes("ROLL")){const v=l.insertCell(d);v.style.textAlign="center";const A=eo(h);v.appendChild(A),d++}const C=l.insertCell(d),m=to(h);if(h.visible===!1&&(m.value="(Hidden) "+m.value),C.appendChild(m),C.classList.add("name-cell"),d++,r.includes("HP")){const v=l.insertCell(d);v.style.display="flex",v.style.marginTop="4px";const A=no(h),g=ro(h);v.appendChild(A),v.appendChild(document.createTextNode("/")),v.appendChild(g),d++}if(r.includes("TEMPHP")){const v=l.insertCell(d),A=io(h);v.appendChild(A),d++}if(r.includes("AC")){const v=l.insertCell(d),A=so(h);v.appendChild(A),d++}if(r.includes("MOVE")){const v=l.insertCell(d),A=uo(h);v.appendChild(A),r.includes("BLOCK")||(v.colSpan=2),d++}if(r.includes("ELEVATE")){const v=l.insertCell(d),A=oo(h);v.appendChild(A),d++}if(r.includes("EFX")){const v=l.insertCell(d);v.style.textAlign="center";const A=ao(h);v.appendChild(A),d++}if(r.includes("BLOCK")){const v=l.insertCell(d),A=Ma(h);v.appendChild(A)}else l.insertCell(d)}this.ShowTurnSelection()}ShowTurnSelection(){const e=document.getElementById("clashGMViewBody");if(e&&e.rows?.length>0){for(var t=0,r;r=e.rows[t];t++)r.classList.remove("turn-outline");if(this.turnCounter>=e.rows.length&&(this.turnCounter=e.rows.length-1),e.rows[this.turnCounter]){const i=e.rows[this.turnCounter];i.classList.add("turn-outline");const s=i.getAttribute("unit-id");this.currentTurnUnit=ee.sceneItems.find(c=>c.id===s);const o=document.getElementById("roundCounter");o.innerText=`Round: ${this.roundCounter}`,this.currentTurnUnit&&!this.startEffectsDone&&this.HandleEffects(this.currentTurnUnit,"Start")}}else this.currentTurnUnit=void 0}async HandleEffects(e,t){if(this.startEffectsDone=!0,Q(N.EFXROW)===!0){const r=[],i=[],s=e.metadata[E.EFFECTS];if(s&&s.length>0){for(let o=0;o<s.length;o++){const c=s[o];c.EndingRound===this.roundCounter&&c.StartOfTurn===t?i.push(c.Name):r.push(c)}await F.scene.items.updateItems([e.id],o=>{for(const c of o)r.length>0?c.metadata[E.EFFECTS]=r:c.metadata[E.EFFECTS]=void 0})}if(i.length>0){const o=new Date().toISOString(),c=`The following effects have expired for ${e.metadata[E.UNITNAME]}: ${i.join(", ")}`;await F.player.setMetadata({[`${G.EXTENSIONID}/metadata_effect_notify`]:{message:c,created:o}})}}}async FocusOnCurrentTurnUnit(){ee.playerRole==="GM"&&(this.currentTurnUnit&&ee.roomMetadata[N.DISABLEFOCUS]!==!0&&await Tn.CenterViewportOnImage(this.currentTurnUnit),await Tt.UpdateLabel())}GetEmptyContextItem(){const e=document.createElement("li");return e.id=ee.playerId,e.textContent="No Owner",e}GetRemoveContextItem(){const e=document.createElement("li");return e.id="REMOVE",e.textContent="Remove Unit",e}}const te=new za;class Ja{messageCounter;constructor(){this.messageCounter={}}IsThisOld(e,t,r="DEFAULT"){const i=`${t}_${r}}`,s=this.messageCounter[i];return s?s!==e?(this.messageCounter[i]=e,!1):!0:(this.messageCounter[i]=e,!1)}async HandleMessage(e){const t=document.querySelector("#rollLog"),r=new Date().toLocaleTimeString();if(e[`${G.EXTENSIONID}/metadata_effect_notify`]!=null){const i=e[`${G.EXTENSIONID}/metadata_effect_notify`];this.IsThisOld(i.created,"CLASH","EFFECT")||await F.notification.show(i.message,"INFO")}if(e[`${G.EXTENSIONID}/metadata_rolllog`]!=null){const i=e[`${G.EXTENSIONID}/metadata_rolllog`];if(!this.IsThisOld(i.created,"CLASH","DICE")){const s=i.chatlog,o=document.createElement("li"),c=document.createElement("li");o.className="clashAuthor",o.style.color=i.color,o.innerText=`[${r}] - ${i.sender}`,c.className=i.critical?"clashLog glow":"clashLog",c.innerText="..."+s.replace(i.sender,"").trim(),t.append(o),t.append(c),Q(N.DICENOTIFICATION)&&await F.notification.show(s,"INFO")}}}}const Xr=new Ja;class xe{static PLAYER="PLAYER";static PARTY="PARTY";static SCENEITEMS="SCENEITEMS";static SCENEMETA="SCENEMETADATA";static SCENEGRID="SCENEGRID";static ROOMMETA="ROOMMETADATA";debouncedOnSceneItemsChange;debouncedOnSceneMetadataChange;debouncedOnRoomMetadataChange;playerId;playerColor;playerName;playerMetadata;playerRole;party;gridDpi;gridScale;sceneItems;sceneSelected;sceneMetadata;sceneReady;roomMetadata;oldRoomMetadata;theme;caches;sceneMetadataHandler;sceneItemsHandler;sceneGridHandler;sceneReadyHandler;playerHandler;partyHandler;themeHandler;roomHandler;constructor(e){this.playerId="",this.playerName="",this.playerColor="",this.playerMetadata={},this.playerRole="PLAYER",this.party=[],this.sceneItems=[],this.sceneSelected=[],this.sceneMetadata={},this.gridDpi=0,this.gridScale=5,this.sceneReady=!1,this.theme="DARK",this.roomMetadata={},this.oldRoomMetadata={},this.caches=e,this.debouncedOnSceneItemsChange=Yr(this.OnSceneItemsChange.bind(this),100),this.debouncedOnSceneMetadataChange=Yr(this.OnSceneMetadataChanges.bind(this),100),this.debouncedOnRoomMetadataChange=Yr(this.OnRoomMetadataChange.bind(this),100)}async InitializeCache(){this.sceneReady=await F.scene.isReady(),this.theme=await F.theme.getTheme(),ns(this.theme,document),this.caches.includes(xe.PLAYER)&&(this.playerId=await F.player.getId(),this.playerName=await F.player.getName(),this.playerColor=await F.player.getColor(),this.playerMetadata=await F.player.getMetadata(),this.playerRole=await F.player.getRole()),this.caches.includes(xe.PARTY)&&(this.party=await F.party.getPlayers()),this.caches.includes(xe.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await F.scene.items.getItems()),this.caches.includes(xe.SCENEMETA)&&this.sceneReady&&(this.sceneMetadata=await F.scene.getMetadata()),this.caches.includes(xe.SCENEGRID)&&this.sceneReady&&(this.gridDpi=await F.scene.grid.getDpi(),this.gridScale=(await F.scene.grid.getScale()).parsed?.multiplier??5),this.caches.includes(xe.ROOMMETA)&&(this.roomMetadata=await F.room.getMetadata())}KillHandlers(){this.caches.includes(xe.SCENEMETA)&&this.sceneMetadataHandler!==void 0&&this.sceneMetadataHandler(),this.caches.includes(xe.SCENEITEMS)&&this.sceneItemsHandler!==void 0&&this.sceneItemsHandler(),this.caches.includes(xe.SCENEGRID)&&this.sceneGridHandler!==void 0&&this.sceneGridHandler(),this.caches.includes(xe.PLAYER)&&this.playerHandler!==void 0&&this.playerHandler(),this.caches.includes(xe.PARTY)&&this.partyHandler!==void 0&&this.partyHandler(),this.caches.includes(xe.ROOMMETA)&&this.roomHandler!==void 0&&this.roomHandler(),this.themeHandler!==void 0&&this.themeHandler()}SetupHandlers(){(this.sceneMetadataHandler===void 0||this.sceneMetadataHandler.length===0)&&this.caches.includes(xe.SCENEMETA)&&(this.sceneMetadataHandler=F.scene.onMetadataChange(async e=>{this.debouncedOnSceneMetadataChange(e),this.sceneMetadata=e})),(this.sceneItemsHandler===void 0||this.sceneItemsHandler.length===0)&&this.caches.includes(xe.SCENEITEMS)&&(this.sceneItemsHandler=F.scene.items.onChange(async e=>{this.debouncedOnSceneItemsChange(e),this.sceneItems=e})),(this.sceneGridHandler===void 0||this.sceneGridHandler.length===0)&&this.caches.includes(xe.SCENEGRID)&&(this.sceneGridHandler=F.scene.grid.onChange(async e=>{this.gridDpi=e.dpi,this.gridScale=parseInt(e.scale),await this.OnSceneGridChange(e)})),(this.playerHandler===void 0||this.playerHandler.length===0)&&this.caches.includes(xe.PLAYER)&&(this.playerHandler=F.player.onChange(async e=>{this.playerName=e.name,this.playerColor=e.color,this.playerId=e.id,this.playerRole=e.role,this.playerMetadata=e.metadata,await this.OnPlayerChange(e)})),(this.partyHandler===void 0||this.partyHandler.length===0)&&this.caches.includes(xe.PARTY)&&(this.partyHandler=F.party.onChange(async e=>{this.party=e,await this.OnPartyChange(e)})),(this.roomHandler===void 0||this.roomHandler.length===0)&&this.caches.includes(xe.ROOMMETA)&&(this.roomHandler=F.room.onMetadataChange(async e=>{this.roomMetadata=e,this.debouncedOnRoomMetadataChange(e)})),this.themeHandler===void 0&&(this.themeHandler=F.theme.onChange(async e=>{this.theme=e.mode,await this.OnThemeChange(e)})),this.sceneReadyHandler===void 0&&(this.sceneReadyHandler=F.scene.onReadyChange(async e=>{this.sceneReady=e,this.playerRole==="GM"?te.currentTurnUnit=void 0:_t.currentTurnUnit=void 0,e&&(this.sceneItems=await F.scene.items.getItems(),this.sceneMetadata=await F.scene.getMetadata(),this.gridDpi=await F.scene.grid.getDpi(),this.gridScale=(await F.scene.grid.getScale()).parsed?.multiplier??5),await this.OnSceneReadyChange(e)}))}async OnSceneMetadataChanges(e){this.playerRole==="GM"?(te.ShowTurnSelection(),te.FocusOnCurrentTurnUnit()):(_t.turnCounter=_n(N.TURNCOUNT),_t.roundCounter=_n(N.ROUNDCOUNT),_t.ShowTurnSelection(),_t.FocusOnCurrentTurnUnit())}async OnSceneItemsChange(e){if(this.sceneReady){if(this.playerRole==="GM"){if(Q(N.RANDOMNAME)??!0){const r=[],i=[];for(const s of e){if(s.metadata[E.ONLIST]!==!0)continue;const o=s.name;r.includes(o)?i.push(s):r.push(o)}for(let s of i)s.name=Ra(s.name);i.length>0&&await F.scene.items.updateItems(i.map(s=>s.id),s=>{for(let o of s){const c=i.find(a=>a.id===o.id);c&&(Q(N.NAMELABELS)&&(o.text.plainText=c.name),o.name=c.name,o.metadata[E.UNITNAME]=c.name)}})}await te.RefreshList()}else await _t.RefreshList();await Tt.UpdateHealthBars(),await Tt.UpdateElevation(),await Tt.UpdateLabel()}}async OnSceneGridChange(e){}async OnSceneReadyChange(e){this.playerRole==="GM"?te.RenderWaiting(!e):_t.RenderWaiting(!e),e&&(this.SetupHandlers(),this.playerRole==="GM"?await te.Render():await _t.Render(),this.playerRole==="GM"?await te.RefreshList():await _t.RefreshList())}async OnPlayerChange(e){this.sceneSelected=e.selection?e.selection:[],await Xr.HandleMessage(e.metadata);const t=document.querySelectorAll(".unit-name-input");for(let r=0;r<t.length;r++){const i=t[r],o=i.id.substring(2);this.sceneSelected.includes(o)?i.classList.add("selected"):i.classList.remove("selected")}}async OnPartyChange(e){if(te.viewPlayerList){te.viewPlayerList.innerHTML="",te.viewPlayerList.appendChild(te.GetEmptyContextItem());for(const t of e){const r=document.createElement("li");r.id=t.id,r.textContent=t.name,r.style.color=t.color,te.viewPlayerList.appendChild(r)}}if(Q(N.DICEEVERYONE))for(const t of e)t.role==="GM"&&await Xr.HandleMessage(t.metadata);if(Q(N.EFXROW))for(const t of e)t.role==="GM"&&await Xr.HandleMessage(t.metadata)}async OnRoomMetadataChange(e){if(await Tt.UpdateHealthBars(),await Tt.UpdateElevation(),await Tt.UpdateLabel(),this.playerRole==="PLAYER"&&(await _t.RefreshList(),Q(N.HIDEALL)===!0?(G.MAINDISABLED.style.display="block",G.MAINAPP.style.display="none",G.MAINLOG.style.display="none"):(G.MAINDISABLED.style.display="none",G.MAINAPP.style.display="block",G.MAINLOG.style.display="none")),this.oldRoomMetadata[N.NAMELABELS]!==!0&&e[N.NAMELABELS]===!0){const t=this.sceneItems.filter(r=>r.metadata[E.ONLIST]===!0);t.length>0&&await F.scene.items.updateItems(t,r=>{for(const i of r)i.text.plainText=i.name})}else if(this.oldRoomMetadata[N.NAMELABELS]!==!1&&e[N.NAMELABELS]===!1){const t=this.sceneItems.filter(r=>r.metadata[E.ONLIST]===!0);t.length>0&&await F.scene.items.updateItems(t,r=>{for(const i of r)i.text.plainText=""})}this.oldRoomMetadata=e}async OnThemeChange(e){ns(e,document)}}const ee=new xe([xe.ROOMMETA,xe.SCENEGRID,xe.SCENEMETA,xe.SCENEITEMS,xe.PLAYER,xe.PARTY]);export{Ra as A,ee as B,nu as C,te as G,tu as I,qa as O,_t as P,Q as R,ns as S,eu as T,$a as U,Ba as a,rt as d,Za as g,go as i};
