import{O as u,C as m,b as F,a as P,d as h,U as k,G as X,S as U,W as _}from"./utilities-495f4ab4.js";class D{static async CenterViewportOnImage(e){const a=await u.scene.grid.getDpi(),i=await u.viewport.getScale(),s=await u.viewport.getWidth(),r=await u.viewport.getHeight(),t={x:s/2,y:r/2},n={x:t.x/i,y:t.y/i},o=await this.GetImageCenter(e,a),l={x:o.x-n.x,y:o.y-n.y},c={x:l.x*i*-1,y:l.y*i*-1};await u.viewport.animateTo({position:c,scale:i})}static async GetImageCenter(e,a){const i=a/e.dpi,s=e.width*i,r=e.height*i,t=e.offsetx/e.width*s,n=e.offsety/e.height*r;return{x:e.xpos-t+s/2,y:e.ypos-n+r/2}}}class x{static async UpdateLabel(e,a){const i=await u.scene.items.getItems([m.LABEL]),s=a||"« Go! »";let r=!1;if(i.length==0||i[0].id!=m.LABEL){const o=F().fillColor("#ffffff").plainText(s).build();o.visible=!1,o.type="LABEL",o.id=m.LABEL,o.style={backgroundColor:"#bb99ff",backgroundOpacity:.5,pointerDirection:"DOWN",pointerWidth:15,pointerHeight:15,cornerRadius:10};const l=document.getElementById("initiative-list");if(l.rows?.length>1){for(var t=0,n;n=l.rows[t];t++)n.className=="turnOutline"&&(o.position={x:e.xpos,y:e.ypos-100},o.visible=!!e.visible,o.text.plainText=o.visible?s:s+`\r
(Hidden)`,o.attachedTo=e.id,o.locked=!0,r=!0);r||(o.visible=!1)}await u.scene.items.addItems([o])}else await u.scene.items.updateItems(o=>o.id==m.LABEL,o=>{for(let p of o){const g=document.getElementById("initiative-list");if(g.rows?.length>1){for(var l=0,c;c=g.rows[l];l++)c.className=="turnOutline"&&(p.position={x:e.xpos,y:e.ypos-100},p.visible=!!e.visible,p.text.plainText=p.visible?s:s+`\r
(Hidden)`,p.attachedTo=e.id,p.locked=!0,r=!0);r||(p.visible=!1)}}})}static UpdateHPBar(e,a,i){const s=e.id+"_hpbar",r=x.getHealthPercentageString(a,i),t=x.getHealthColorString(a,i),n=P().plainText(r).fontWeight(800).fillOpacity(.75).fillColor(t).strokeWidth(1).strokeColor("black").strokeOpacity(1).build();return n.id=s,n.type="TEXT",n.attachedTo=e.id,n.visible=!!e.visible,n.locked=!0,n.position={x:e.position.x-85,y:e.position.y+25},n.disableAttachmentBehavior=["ROTATION","SCALE"],n.text.style.fontFamily="Segoe UI",n.text.style.fontSize=24,n.text.type="PLAIN",n.text.style.textAlign="CENTER",n}static getHealthPercentageString(e,a){const i=e/a*100;switch(!0){case i<=20:return"▰▱▱▱▱ 20%";case i<=40:return"▰▰▱▱▱ 40%";case i<=60:return"▰▰▰▱▱ 60%";case i<=80:return"▰▰▰▰▱ 80%";default:return"▰▰▰▰▰ 100%"}}static getHealthColorString(e,a){const i=e/a*100;switch(!0){case i<=25:return"red";case i<=50:return"yellow";default:return"white"}}static async GetCTUFromRow(e){let a={id:"",visible:!1,xpos:0,ypos:0,dpi:0,width:0,height:0,offsetx:0,offsety:0};const i=e.getAttribute("unit-id"),s=await u.scene.items.getItems([i]);for(let r of s){const t=r;a={id:t.id,visible:t.visible,xpos:t.position.x,ypos:t.position.y,dpi:t.grid.dpi,width:t.image.width,height:t.image.height,offsetx:t.grid.offset.x,offsety:t.grid.offset.y}}return a}}async function G(d,e){var a=e;const i='<hr style="height:5px; margin-top: 4px; margin-bottom: 4px; visibility:hidden;" />';d.querySelector("#clash-main-body-settings").innerHTML=`
        <div id="settingsContainer">
        <h2 style="margin-top: 10px;">Settings</h2>
        <div><span id="exportAllContainer"></span>Export Collection Data </div>
        <i><small>This will save Collection data to a Text/JSON file</small></i>
        </br>
        ${i}
        <div><span id="importSubmitContainer"></span>Import Collection Data </div>
        <div><span id="importAllContainer"></span></div>
        <i><small>This will overwrite keys with the same Name/Author</small></i>
        </br>
        ${i}
        <div><span id="clearAllContainer"></span>Clear All Data </div>
        <i><small>This will delete the database.</small></i>
        </br>
        ${i}
        <div>${v("hideHp")}</span>&emsp;Hide HP Indication from Players </div>
        ${i}
        <div>${v("hideAll")}</span>&emsp;Hide All from Players </div>
        ${i}
        <div>${v("reverseList")}</span>&emsp;Reverse Initiative </div>
        ${i}
        <div>${v("noFocus")}</span>&emsp;Disable Camera Focus </div>
        ${i}
        <div>${v("noLabel")}</span>&emsp;Disable Turn Label </div>
        <div id="turnLabelTextContainer">&emsp;&emsp;&emsp;&emsp;</div>
        ${i}
        <div>${v("logToGM")}</span>&emsp;[Rumble!] Send Log to GM Only </div>
        <footer><span class="returnFloatLeft" id="settingsReturnContainer"></span></footer>
        </div>
       `,E(d,"hideHp",e.gmHideHp,e),E(d,"hideAll",e.gmHideAll,e),E(d,"reverseList",e.gmReverseList,e),E(d,"noFocus",e.gmDisableFocus,e),E(d,"noLabel",e.gmDisableLabel,e),E(d,"logToGM",e.gmRumbleLog,e);const s=d.getElementById("turnLabelTextContainer"),r=d.createElement("input");r.type="text",r.id="textLabelButton",r.title="Change your Turn Label's text",r.placeholder="« Go! »",r.maxLength=40,r.value=e.gmTurnText?e.gmTurnText:"",r.size=30,r.className="textInput",s?.appendChild(r);const t=d.getElementById("importAllContainer"),n=d.createElement("input");n.type="file",n.id="importButton",n.title="Choose a file to import",n.className="tinyType";const o=d.createElement("input");o.type="checkbox",o.id="favBox",o.title="Unfavorite during Upload";const l=d.getElementById("importSubmitContainer"),c=d.createElement("input");c.type="button",c.id="importSubmitButton",c.value="IMPORT DATA",c.title="Import Clash Collection Data",c.className="tinyType",c.onclick=async function(){if(n.files&&n.files.length>0){let w=n.files[0],b=new FileReader;b.readAsText(w),b.onload=async function(){try{const C=JSON.parse(b.result);await N(C),u.notification.show("Import Complete!","SUCCESS")}catch(C){alert(`The import failed - ${C}`)}},b.onerror=function(){console.log(b.error)}}},t?.appendChild(o),t?.appendChild(d.createTextNode("Un-Favorite  ˣ  ")),t?.appendChild(n),l?.appendChild(c);const p=d.getElementById("exportAllContainer"),g=d.createElement("input");g.type="button",g.id="exportButton",g.value="EXPORT DATA",g.title="Export Clash Collection Data",g.className="tinyType",g.onclick=async function(){await R()},p?.appendChild(g);const S=d.getElementById("clearAllContainer"),f=d.createElement("input");f.type="button",f.id="resetButton",f.value="DELETE DATA",f.title="Clear all Clash! Data",f.className="tinyType",f.onclick=async function(){if(confirm("Delete EVERYTHING? (Deletes Database and Refreshes Window)")){a.turnCounter=1,a.roundCounter=1;const w=d.getElementById("roundCount");w.innerText=`Round: ${a.roundCounter}`,await u.scene.items.deleteItems([m.LABEL]),await u.scene.items.updateItems(b=>b.metadata[`${m.EXTENSIONID}/metadata_initiative`]!=null||b.id===m.LABEL,b=>{for(let C of b)delete C.metadata[`${m.EXTENSIONID}/metadata_initiative`]}),await h.delete(),window.location.reload()}},S?.appendChild(f);const T=d.getElementById("settingsReturnContainer"),y=d.createElement("input");y.type="button",y.id="returnButton",y.className="turnColor chalkBorder turnIndicator",y.title="Save and return to Initiative List",y.value="Return",y.onclick=async function(){e.gmTurnText=r.value,await h.Settings.update(m.SETTINGSID,{gmHideHp:e.gmHideHp,gmHideAll:e.gmHideAll,gmDisableLabel:e.gmDisableLabel,gmReverseList:e.gmReverseList,gmTurnText:e.gmTurnText,gmRumbleLog:e.gmRumbleLog,disableFocus:e.gmDisableFocus}),e.gmDisableLabel&&u.scene.items.deleteItems([m.LABEL]),a.ShowSettingsMenu(!1),a.ShowMainMenu(!0)},T?.append(y);function v(w){return`<label class="switch" id="setting${w}Container">
            <span class="slider round"></span>
            </label>`}function E(w,b,C,I){const H=w.getElementById(`setting${b}Container`),A=w.createElement("input");A.type="checkbox",A.value=String(C),A.checked=C,A.onclick=async function(B){const L=B.target;switch(A.value=String(L.checked),b){case"hideHp":I.gmHideHp=L.checked;break;case"hideAll":I.gmHideAll=L.checked;break;case"noFocus":I.gmDisableFocus=L.checked;break;case"noLabel":I.gmDisableLabel=L.checked;break;case"reverseList":I.gmReverseList=L.checked;break;case"logToGM":I.gmRumbleLog=L.checked;break}},H?.insertBefore(A,H.firstChild)}async function R(){const w=await h.Creatures.toArray();var b=d.createElement("a"),C=new Blob([JSON.stringify(w)],{type:"text/plain"});b.href=URL.createObjectURL(C),b.download=`ClashCollectionExport-${Date.now()}`,d.body.appendChild(b),b.click(),d.body.removeChild(b)}async function N(w){const b=await h.Creatures.toArray();let C=[];w.forEach(I=>{let H=new k("","Default");H.SetToModel(I,!o.checked),H.tokenId="";const A=b.find(B=>B.unitName==I.unitName&&B.dataSlug==I.dataSlug);A?H.id=A.id:H.id=X(),C.push(H)}),await h.Creatures.bulkPut(C),console.log("Import complete.")}}function q(d,e){var a=e;const i=d.getElementById("saveButtonContainer"),s=d.createElement("input");s.type="image",s.className="Icon clickable",s.id="saveButton",s.onclick=async function(){await a.Save()},s.src="/save.svg",s.title="Save Changes",s.height=20,s.width=20,i.appendChild(s)}function V(d){const e=d.getElementById("rollAllContainer"),a=d.createElement("input");a.type="image",a.className="Icon RollerButton clickable",a.id="rollAllButton",a.onclick=async function(){u.notification.show("Rolled Initiative for all Monsters."),d.querySelectorAll(".isMonster").forEach(s=>{const t=s.id.substring(2),n=d.querySelector(`#iI${t}`),o=parseFloat(n.getAttribute("unit-dexbonus"));n.value=(o+Math.floor(Math.random()*(20-1)+1)).toString()})},a.src="/dice.svg",a.title="Roll Initiative for all Monsters",a.height=20,a.width=20,e.appendChild(a)}function W(d,e){var a=e;const i=d.getElementById("prevContainer"),s=d.getElementById("nextContainer"),r=d.createElement("input");r.type="button",r.id="previousButton",r.value="Previous",r.className="turnColor chalkBorder turnIndicator",r.title="Previous Turn",r.onclick=async function(){const n=d.getElementById("initiative-list");if(n.rows?.length>1){a.turnCounter--;for(var o=0,l;l=n.rows[o];o++)l.className=="turnOutline"&&l.parentElement?.firstElementChild===l&&(a.roundCounter--,a.roundCounter<1&&(a.roundCounter=1),a.turnCounter=l.parentElement.childElementCount);await a.FocusOnCurrentTurnUnit(n),await a.Save()}};const t=d.createElement("input");t.type="button",t.id="nextButton",t.value="Next",t.className="turnColor chalkBorder turnIndicator",t.title="Next Turn",t.onclick=async function(){const n=d.getElementById("initiative-list");if(n.rows?.length>1){a.turnCounter++;for(var o=0,l;l=n.rows[o];o++)l.className=="turnOutline"&&l.parentElement?.lastElementChild===l&&(a.roundCounter++,a.turnCounter=1);await a.FocusOnCurrentTurnUnit(n),await a.Save()}},i?.appendChild(r),s?.appendChild(t)}function z(d,e){var a=e;const i=d.getElementById("resetContainer"),s=d.createElement("input");s.type="button",s.id="resetTurnButton",s.value="Reset Round",s.title="Reset Round",s.className="tinyType",s.onclick=async function(){a.turnCounter=1,a.roundCounter=1;const n=d.getElementById("roundCount");n.innerText=`Round: ${a.roundCounter}`,await h.Tracker.clear(),await h.Tracker.add({id:m.TURNTRACKER,currentRound:1,currentTurn:1}),await u.scene.items.deleteItems([m.LABEL]),await e.UpdateTrackerForPlayers(),await e.ShowTurnSelection(),await e.Save()},i.appendChild(s);const r=d.createElement("input");r.type="button",r.id="clearButton",r.value="CLEAR LIST",r.title="Clear List",r.className="tinyType",r.onclick=async function(){if(confirm("Clear the Initiative List (This will leave unit info)?")){a.turnCounter=1,a.roundCounter=1;const n=d.getElementById("roundCount");n.innerText=`Round: ${a.roundCounter}`,await h.Tracker.clear(),await h.Tracker.add({id:m.TURNTRACKER,currentRound:1,currentTurn:1}),await h.ActiveEncounter.where("isActive").equals(1).modify({isActive:0}),await u.scene.items.deleteItems([m.LABEL]),await u.scene.items.updateItems(o=>o.metadata[`${m.EXTENSIONID}/metadata_initiative`]!=null||o.id===m.LABEL,o=>{for(let l of o)delete l.metadata[`${m.EXTENSIONID}/metadata_initiative`]})}},i.appendChild(r);const t=d.createElement("input");t.type="button",t.id="settingsButton",t.value="Settings",t.title="View Settings",t.className="tinyType",t.onclick=async function(){a.ShowMainMenu(!1),a.ShowSettingsMenu(!0),G(d,e)},i.appendChild(t)}class K{inSceneUnits=[];roundCounter=1;turnCounter=1;activeUnits=[];gmHideHp=!1;gmHideAll=!1;gmDisableLabel=!1;gmDisableFocus=!1;gmReverseList=!1;gmRumbleLog=!1;gmTurnText="";async RenderInitiativeList(e){this.setupContextMenu(this),this.ShowSettingsMenu(!1),this.ShowMainMenu(!0);const a=e.querySelector("#clash-main-body-app");if(a.innerHTML=`
        <table id="initiative-list">
        <thead>
            <tr>
            <th style="width: 8%"><img class="Icon" title="Initiative" src="/queue.svg"></th>
            <th style="width: 8%"><div id="rollAllContainer"></div></th>
            <th style="width: 42%">Name</th>
            <th style="width: 24%"><img class="Icon" title="Hit Points" src="/heart.svg"></th>
            <th style="width: 8%"><img class="Icon" title="Armor Class" src="/shield.svg"></th>
            <th style="width: 10%"><span id="saveButtonContainer"></span></th>
            </tr>
        </thead>
        <tbody id="unit-list"></tbody>
        </table>
        <footer>
        <div id="roundCounter" class="bottom"><span id="prevContainer"></span><span id="roundCount" class="centerish">Round: ${this.roundCounter}</span><span id="nextContainer"></span></div>
        <div id="bombContainer" class="bombBottom"><span id="resetContainer" class=""></span></div>
        </footer>
        `,h.inMemory){const n=e.createElement("div");n.innerText="Local Storage Disabled - Features Limited",n.className="noDatabase",a.prepend(n)}q(e,this),W(e,this),z(e,this),V(e);const i=await h.Settings.get(m.SETTINGSID);i?(this.gmHideHp=i.gmHideHp,this.gmHideAll=i.gmHideAll,this.gmDisableLabel=i.gmDisableLabel,this.gmDisableFocus=i.disableFocus,this.gmReverseList=i.gmReverseList,this.gmRumbleLog=i.gmRumbleLog,this.gmTurnText=i.gmTurnText):await h.Settings.add({id:m.SETTINGSID,gmHideHp:!1,gmHideAll:!1,gmDisableLabel:!1,gmTurnText:"",gmReverseList:!1,gmRumbleLog:!1,disableFocus:!1});const s=await h.Tracker.get(m.TURNTRACKER);s?(this.turnCounter=s.currentTurn,this.roundCounter=s.currentRound):await h.Tracker.add({id:m.TURNTRACKER,currentRound:1,currentTurn:1}),u.scene.onReadyChange(async n=>{n&&await this.CheckIniativeList()});const r=await u.theme.getTheme();U(r,e),u.theme.onChange(n=>{U(n,e)}),u.scene.items.onChange(async n=>{n.forEach(async l=>{const c=l,p=c.text?.plainText||c.name,g=this.activeUnits.find(S=>S.id===c.id);g&&g.unitName!==p&&await h.ActiveEncounter.update(g.id,{unitName:p}),l.metadata[`${m.EXTENSIONID}/metadata_initiative`]!==void 0&&g?.isActive==0&&await h.ActiveEncounter.update(g.id,{isActive:1})}),this.activeUnits.filter(({id:l})=>!n.some(({id:c})=>c===l)).forEach(async l=>{await h.ActiveEncounter.update(l.id,{isActive:0})})}),_(async()=>await h.ActiveEncounter.toArray()).subscribe({next:n=>this.RefreshList(n),error:n=>console.log("Error refreshing list: "+n)}),this.CheckIniativeList()}async CheckIniativeList(){const e=await u.scene.items.getItems(i=>i.layer==="CHARACTER"&&i.metadata[`${m.EXTENSIONID}/metadata_initiative`]!==void 0);let a=[];e.length>0&&(this.inSceneUnits=e.map(s=>s.id),a=await(await h.ActiveEncounter.toCollection()).toArray(),this.activeUnits=a.filter(s=>this.inSceneUnits.includes(s.id)),this.activeUnits.forEach(async s=>{await h.ActiveEncounter.update(s.id,{isActive:1})})),this.RefreshList(a)}async RefreshList(e){const a=document.querySelector("#unit-list"),i=this,s=e.filter(t=>t.isActive==1);this.activeUnits=s.filter(t=>this.inSceneUnits.includes(t.id));const r=this.gmReverseList?this.activeUnits.sort((t,n)=>t.initiative-n.initiative||t.unitName.localeCompare(n.unitName)):this.activeUnits.sort((t,n)=>n.initiative-t.initiative||t.unitName.localeCompare(n.unitName));for(;a?.rows.length>0;)a.deleteRow(0);for(const t of r){let n=a.insertRow(-1),o=n.insertCell(0),l=n.insertCell(1),c=n.insertCell(2),p=n.insertCell(3),g=n.insertCell(4),S=n.insertCell(5);n.setAttribute("unit-id",t.id);const f=document.createElement("input");f.className="InitiativeInput",f.inputMode="numeric",f.setAttribute("unit-dexbonus",Math.floor((t.dexScore-10)/2).toString()),f.value=t.initiative.toString(),f.id=`iI${t.id}`,f.size=2,f.min="0",f.max="99",f.maxLength=2;const T=document.createElement("input");T.type="image",T.title="Roll this Unit's Iniative",T.id=`rB${t.id}`,T.className="clickable",T.onclick=async function(){const w=parseFloat(f.getAttribute("unit-dexbonus"));f.value=(w+Math.floor(Math.random()*(20-1)+1)).toString()},T.src="/dice.svg",T.height=20,T.width=20;const y=document.createElement("input");y.type="button",y.value=t.isMonster?`ʳ ${t.unitName} ʴ`:t.unitName,y.title="Change between Player and Monster groups",y.id=`nT${t.id}`,y.style.width="140px",y.style.textOverflow="ellipsis",y.style.overflow="hidden",y.className=t.isMonster?"isMonster nameToggleInput":"nameToggleInput",y.onclick=async function(){y.className=="isMonster nameToggleInput"?(y.value=t.unitName,y.className="nameToggleInput"):(y.value=`ʳ ${t.unitName} ʴ`,y.className="isMonster nameToggleInput")};const v=document.createElement("input");v.className="HealthInput",v.inputMode="numeric",v.id=`cHP${t.id}`,v.title=t.currentHP.toString(),v.value=t.currentHP.toString(),v.size=4,v.maxLength=4,v.onblur=function(w){const C=w.currentTarget.value;if(C.substring(0,1)=="+"){const I=C.substring(C.indexOf("+")+1);v.value=(+I+ +v.title).toString(),v.title=v.value,w.preventDefault()}else if(C.substring(0,1)=="-"){const I=C.substring(C.indexOf("-")+1);v.value=(+v.title-+I).toString(),v.title=v.value,w.preventDefault()}i.Save()},v.onkeydown=function(w){if(w.key!=="Enter")return;const C=w.currentTarget.value;if(C.substring(0,1)=="+"){const I=C.substring(C.indexOf("+")+1);v.value=(+I+ +v.title).toString(),v.title=v.value,w.preventDefault()}else if(C.substring(0,1)=="-"){const I=C.substring(C.indexOf("-")+1);v.value=(+v.title-+I).toString(),v.title=v.value,w.preventDefault()}i.Save()};const E=document.createElement("input");E.className="HealthInput",E.inputMode="numeric",E.id=`mHP${t.id}`,E.value=t.maxHP.toString(),E.size=4,E.maxLength=4;const R=document.createElement("input");R.className="ArmorInput",R.inputMode="numeric",R.id=`aC${t.id}`,R.value=t.armorClass.toString(),R.size=2,R.maxLength=2;const N=document.createElement("input");N.type="image",N.title="View/Edit this Unit's Stats",N.id=`tB${t.id}`,N.className="clickable",N.onclick=async function(w){const b=w.currentTarget;await i.OpenSubMenu(b.id.substring(2))},N.src="/triangle.svg",N.height=20,N.width=20,o.appendChild(f),o.style.width="8%",l.appendChild(T),l.style.width="8%",c.appendChild(y),c.style.width="42%",p.appendChild(v),p.appendChild(document.createTextNode("/")),p.appendChild(E),p.style.width="24%",g.appendChild(R),g.style.width="8%",h.inMemory||(S.appendChild(N),S.style.width="10%")}this.AttachFocusListeners(),await this.ShowTurnSelection()}AttachFocusListeners(){const e=document.getElementById("initiative-list");e&&e.addEventListener("dblclick",a);async function a(i){i.preventDefault();const s=i.target.closest("tr"),r=await x.GetCTUFromRow(s);await D.CenterViewportOnImage(r)}}async ShowTurnSelection(){const e=document.getElementById("initiative-list");if(e.rows?.length>1){for(var a=0,i;i=e.rows[a];a++)i.classList.remove("turnOutline");if(this.turnCounter>=e.rows.length&&(this.turnCounter=e.rows.length-1),e.rows[this.turnCounter]){const s=e.rows[this.turnCounter];s.className="turnOutline";const r=document.getElementById("roundCount");r.innerText=`Round: ${this.roundCounter}`}}}async Save(){document.querySelectorAll(".InitiativeInput").forEach(async a=>{const i=a,s=i.id.substring(2),r=i.value,t=document.querySelector(`#cHP${s}`),n=t.value?t.value:"0",o=document.querySelector(`#mHP${s}`),l=o.value?o.value:"1",c=document.querySelector(`#aC${s}`),p=c.value?c.value:"10",S=document.querySelector(`#nT${s}`).className=="isMonster nameToggleInput";if(!s||!r)return;let f=this.activeUnits?.find(T=>T.id==s);f&&await h.ActiveEncounter.update(f.id,{initiative:parseFloat(r),currentHP:parseFloat(n),maxHP:parseFloat(l),armorClass:parseFloat(p),isMonster:S})}),await h.Tracker.update(m.TURNTRACKER,{id:m.TURNTRACKER,currentTurn:this.turnCounter,currentRound:this.roundCounter}),await this.CheckIniativeList(),await this.UpdateTrackerForPlayers()}async UpdateTrackerForPlayers(){const e=[],a=new Date().toISOString(),i=[];(await u.scene.items.getItems(n=>n.id.endsWith("_hpbar"))).forEach(n=>{const o=n,l=this.activeUnits.find(c=>c.id===o.id.replace("_hpbar",""));l&&(o.text.plainText=x.getHealthPercentageString(l.currentHP,l.maxHP),o.text.style.fillColor=x.getHealthColorString(l.currentHP,l.maxHP),i.push(o))}),await u.scene.items.addItems(i);for(const n of this.activeUnits)e.push({id:n.id,name:n.unitName,initiative:n.initiative,cHp:n.currentHP,mHp:n.maxHP});const r={turn:this.turnCounter,round:this.roundCounter,units:e,gmHideHp:this.gmHideHp,gmHideAll:this.gmHideAll,gmReverseList:this.gmReverseList,lastUpdate:a},t={};t[`${m.EXTENSIONID}/metadata_trackeritem`]={Tracker:r},await u.scene.setMetadata(t)}async FocusOnCurrentTurnUnit(e){const a=e.rows[this.turnCounter],i=await x.GetCTUFromRow(a);this.gmDisableFocus||await D.CenterViewportOnImage(i),this.gmDisableLabel||await x.UpdateLabel(i,this.gmTurnText)}ShowSettingsMenu(e){const a=document.querySelector("#clash-main-body-settings");a.hidden=!e}ShowMainMenu(e){const a=document.querySelector("#clash-main-body-app");a.hidden=!e}async OpenSubMenu(e){const i=window.outerHeight-150,s=i>800?700:i-100;await u.modal.open({id:m.EXTENSIONSUBMENUID,url:`/submenu/subindex.html?unitid=${e}`,height:s,width:350})}setupContextMenu(e){const a=/\s[\da-zA-Z]$/;h.inMemory||u.contextMenu.create({id:`${m.EXTENSIONID}/context-menu-sheet`,icons:[{icon:"/sheet.svg",label:"[Clash!] View Info",filter:{max:1,every:[{key:"layer",value:"CHARACTER"}]}},{icon:"/multi-sheet.svg",label:"[Clash!] View Info",filter:{min:2,every:[{key:"layer",value:"CHARACTER"}]}}],async onClick(i,s){if(i.items.length==1){const r=i.items[0],t=r.text?.plainText||r.name;if(!await h.ActiveEncounter.get(r.id)){let p=new k(r.id,t);if(a.test(t)){const g=t.slice(0,-2),S=await h.Creatures.get({unitName:g});S&&p.SetToModel(S)}else{const g=await h.Creatures.get({unitName:t});g&&p.SetToModel(g)}await p.SaveToDB()}const o=100,l=window.outerHeight-150,c=l>800?700:l-o;await u.popover.open({id:m.EXTENSIONSUBMENUID,url:`/submenu/subindex.html?unitid=${r.id}`,height:c,width:325,anchorElementId:s,hidePaper:!0})}else{i.items.forEach(async c=>{const p=c,g=p.text?.plainText||p.name;if(!await h.ActiveEncounter.get(c.id)){let f=new k(c.id,g);if(a.test(g)){const T=g.slice(0,-2),y=await h.Creatures.get({unitName:T});y&&f.SetToModel(y)}else{const T=await h.Creatures.get({unitName:g});T&&f.SetToModel(T)}await f.SaveToDB()}});const r=i.items.map(c=>c.id).toString(),t=i.items.map(c=>c.metadata[`${m.EXTENSIONID}/metadata_initiative`]!==void 0).toString(),n=100,o=window.outerHeight-150,l=o>800?700:o-n;await u.popover.open({id:m.EXTENSIONSUBMENUID,url:`/submenu/subindex.html?unitid=${r}&unitactive=${t}&multi=true`,height:l,width:325,anchorElementId:s,hidePaper:!0})}}}),u.contextMenu.create({id:`${m.EXTENSIONID}/context-hp-menu`,icons:[{icon:"/health.svg",label:"[Clash!] Show HP Bar",filter:{every:[{key:"layer",value:"CHARACTER"},{key:["metadata",`${m.EXTENSIONID}/metadata_hpbar`],value:void 0},{key:["metadata",`${m.EXTENSIONID}/metadata_initiative`],value:void 0,operator:"!="}]}},{icon:"/health-black.svg",label:"[Clash!] Hide HP Bar",filter:{every:[{key:"layer",value:"CHARACTER"},{key:["metadata",`${m.EXTENSIONID}/metadata_hpbar`],value:void 0,operator:"!="}]}}],async onClick(i){if(i.items.every(r=>r.metadata[`${m.EXTENSIONID}/metadata_hpbar`]===void 0)){const t=[];await u.scene.items.updateItems(i.items,n=>{for(let o of n){const l=o,c=e.activeUnits.find(p=>p.id===o.id);c&&(o.metadata[`${m.EXTENSIONID}/metadata_hpbar`]={showHpBars:!0},t.push(x.UpdateHPBar(l,c.currentHP,c.maxHP)))}}),await u.scene.items.addItems(t)}else{const r=i.items.map(t=>t.id+"_hpbar");await u.scene.items.deleteItems(r),u.scene.items.updateItems(i.items,t=>{for(let n of t)delete n.metadata[`${m.EXTENSIONID}/metadata_hpbar`]})}}}),u.contextMenu.create({id:`${m.EXTENSIONID}/context-menu`,icons:[{icon:"/addunit.svg",label:"[Clash!] Add to Initiative",filter:{every:[{key:"layer",value:"CHARACTER"},{key:["metadata",`${m.EXTENSIONID}/metadata_initiative`],value:void 0}]}},{icon:"/removeunit.svg",label:"[Clash!] Remove from Initiative",filter:{every:[{key:"layer",value:"CHARACTER"}]}}],async onClick(i){const r=i.items.every(o=>o.metadata[`${m.EXTENSIONID}/metadata_initiative`]===void 0),t=i.items;let n=[];if(r)u.scene.items.updateItems(t,o=>{for(let l of o)n.push({id:l.id,name:l.text?.plainText||l.name}),l.metadata[`${m.EXTENSIONID}/metadata_initiative`]={initiative:!0}}),n.forEach(async o=>{if(await h.ActiveEncounter.get(o.id))await h.ActiveEncounter.update(o.id,{isActive:1});else{let c=new k(o.id,o.name);if(a.test(o.name)){const p=o.name.slice(0,-2),g=await h.Creatures.get({unitName:p});g&&c.SetToModel(g)}else{const p=await h.Creatures.get({unitName:o.name});p&&c.SetToModel(p)}c.isActive=1,c.SaveToDB()}e.inSceneUnits.push(o.id)});else{const o=i.items.map(l=>l.id+"_hpbar");await u.scene.items.deleteItems(o),u.scene.items.updateItems(i.items,l=>{for(let c of l)n.push({id:c.id,name:c.name}),delete c.metadata[`${m.EXTENSIONID}/metadata_initiative`],delete c.metadata[`${m.EXTENSIONID}/metadata_hpbar`]}),n.forEach(async l=>{await h.ActiveEncounter.update(l.id,{isActive:0}),e.inSceneUnits=e.inSceneUnits.filter(c=>c!=l.id)})}}})}}class J{roundCounter=1;turnCounter=1;disableFocus=!1;lastUpdate="";async Render(e){e.querySelector("#clash-main-body-app").innerHTML=`
            <table id="initiative-list">
            <thead>
                <tr>
                <th style="width: 20%"><img class="Icon" title="Initiative" src="/queue.svg"></th>
                <th style="width: 80%">Name</th>
                </tr>
            </thead>
            <tbody id="unit-list"></tbody>
            </table>
            <footer>
            <div id="roundCounter" class="playerBottom">
            <label class="switch" id="settingnoFocusContainer">
            <span class="slider round"></span>
            </label> No AutoFocus
            <span id="roundCount" class="playerCenterish">Round: ${this.roundCounter}</span>
            </div>
            </footer>
            `;var a=this;const i=e.getElementById("settingnoFocusContainer"),s=e.createElement("input");s.type="checkbox",s.value=String(this.disableFocus),s.checked=this.disableFocus,s.onclick=async function(n){const o=n.target;s.value=String(o.checked),a.disableFocus=o.checked},i?.insertBefore(s,i.firstChild),u.scene.onMetadataChange(n=>this.RefreshList(n));const r=await u.theme.getTheme();U(r,e),u.theme.onChange(n=>{U(n,e)});const t=await u.scene.getMetadata();await this.RefreshList(t)}async RefreshList(e){const i=e[`${m.EXTENSIONID}/metadata_trackeritem`]?.Tracker;if(!i||!i.units||i.lastUpdate==this.lastUpdate)return;this.lastUpdate=i.lastUpdate;const s=document.querySelector("#unit-list");if(i.gmHideAll){s.innerHTML="";return}const r=i.gmReverseList?i.units.sort((t,n)=>t.initiative-n.initiative||t.name.localeCompare(n.name)):i.units.sort((t,n)=>n.initiative-t.initiative||t.name.localeCompare(n.name));for(this.roundCounter=i.round,this.turnCounter=i.turn;s.rows.length>0;)s.deleteRow(0);for(const t of r){let n=s.insertRow(-1),o=n.insertCell(0),l=n.insertCell(1);l.style.textOverflow="ellipsis",l.style.overflow="hidden",l.style.whiteSpace="nowrap",n.setAttribute("unit-id",t.id);const c=document.createElement("input");c.className="HealthInput",c.inputMode="numeric",c.id="cHP"+t.id,c.value=t.cHp.toString(),c.size=4,c.maxLength=4,i.gmHideHp||(t.cHp<=t.mHp/4?l.className="unitHarmed":t.cHp<=t.mHp/2?l.className="unitHurt":l.className="unitHappy"),o.appendChild(document.createTextNode(t.initiative.toString())),o.style.width="20%",l.appendChild(document.createTextNode(t.name)),l.style.width="75%"}console.log("Show turn selection"),this.AttachFocusListeners(),await this.ShowTurnSelection()}AttachFocusListeners(){const e=document.getElementById("initiative-list");e&&e.addEventListener("dblclick",a);async function a(i){i.preventDefault();const s=i.target.closest("tr"),r=await x.GetCTUFromRow(s);await D.CenterViewportOnImage(r)}}async ShowTurnSelection(){const e=document.getElementById("initiative-list");if(e.rows?.length>1){for(var a=0,i;i=e.rows[a];a++)i.classList.remove("turnOutline");if(this.turnCounter>=e.rows.length&&(this.turnCounter=e.rows.length-1),e.rows[this.turnCounter]){const s=e.rows[this.turnCounter];s.className="turnOutline";const r=document.getElementById("roundCount");r.innerText=`Round: ${this.roundCounter}`;let t=await x.GetCTUFromRow(s);t.visible&&(this.disableFocus||await D.CenterViewportOnImage(t))}}}}const Y=new K,j=new J;let M=!1;const $=document.querySelector("#clash-main-body-app"),Z=h;Z.Ready();$.innerHTML=`
  <div>
    <h1>Loading...</h1>
  </div>
`;u.onReady(async()=>{M=await u.scene.isReady(),O(M),u.scene.onReadyChange(async d=>{O(d)})});async function O(d){const e=await u.player.getRole();d?e==="GM"?await Y.RenderInitiativeList(document):await j.Render(document):$.innerHTML=`
            <div>
            <h1>Waiting for Scene...</h1>
            <div class="imageContainer">
            <img class="resize_fit_center" src="logo.png" alt="Clash!" class="center">
            </div>
            </div>`}
