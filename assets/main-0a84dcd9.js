import{O as p,C as h,b as X,a as _,d as y,U as B,G,I as q,S as U,H as P,W as z}from"./utilities-83dee349.js";class D{static async CenterViewportOnImage(e){const n=await p.scene.grid.getDpi(),s=await p.viewport.getScale(),r=await p.viewport.getWidth(),o=await p.viewport.getHeight(),a={x:r/2,y:o/2},i={x:a.x/s,y:a.y/s},t=await this.GetImageCenter(e,n),l={x:t.x-i.x,y:t.y-i.y},c={x:l.x*s*-1,y:l.y*s*-1};await p.viewport.animateTo({position:c,scale:s})}static async GetImageCenter(e,n){const s=n/e.dpi,r=e.width*s,o=e.height*s,a=e.offsetx/e.width*r,i=e.offsety/e.height*o;return{x:e.xpos-a+r/2,y:e.ypos-i+o/2}}}class L{static async UpdateLabel(e,n){const s=await p.scene.items.getItems([h.LABEL]),r=n||"« Go! »";let o=!1;if(s.length==0||s[0].id!=h.LABEL){const t=X().fillColor("#ffffff").plainText(r).build();t.visible=!1,t.type="LABEL",t.id=h.LABEL,t.style={backgroundColor:"#bb99ff",backgroundOpacity:.5,pointerDirection:"DOWN",pointerWidth:15,pointerHeight:15,cornerRadius:10};const l=document.getElementById("initiative-list");if(l.rows?.length>1){for(var a=0,i;i=l.rows[a];a++)i.className=="turnOutline"&&(t.position={x:e.xpos,y:e.ypos-100},t.visible=!!e.visible,t.text.plainText=t.visible?r:r+`\r
(Hidden)`,t.attachedTo=e.id,t.locked=!0,o=!0);o||(t.visible=!1)}await p.scene.items.addItems([t])}else await p.scene.items.updateItems(t=>t.id==h.LABEL,t=>{for(let m of t){const g=document.getElementById("initiative-list");if(g.rows?.length>1){for(var l=0,c;c=g.rows[l];l++)c.className=="turnOutline"&&(m.position={x:e.xpos,y:e.ypos-100},m.visible=!!e.visible,m.text.plainText=m.visible?r:r+`\r
(Hidden)`,m.attachedTo=e.id,m.locked=!0,o=!0);o||(m.visible=!1)}}})}static UpdateHPBar(e,n,s){const r=e.id+"_hpbar",o=L.getHealthPercentageString(n,s),a=L.getHealthColorString(n,s),i=_().plainText(o).fontWeight(800).fillOpacity(.75).fillColor(a).strokeWidth(1).strokeColor("black").strokeOpacity(1).build();return i.id=r,i.type="TEXT",i.attachedTo=e.id,i.visible=!!e.visible,i.locked=!0,i.position={x:e.position.x-85,y:e.position.y+25},i.disableAttachmentBehavior=["ROTATION","SCALE"],i.text.style.fontFamily="Segoe UI",i.text.style.fontSize=24,i.text.type="PLAIN",i.text.style.textAlign="CENTER",i}static getHealthPercentageString(e,n){const s=e/n*100;switch(!0){case s==0:return"▱▱▱▱▱ 0%";case s<=20:return"▰▱▱▱▱ 20%";case s<=40:return"▰▰▱▱▱ 40%";case s<=60:return"▰▰▰▱▱ 60%";case s<=80:return"▰▰▰▰▱ 80%";default:return"▰▰▰▰▰ 100%"}}static getHealthColorString(e,n){const s=e/n*100;switch(!0){case s<=25:return"red";case s<=50:return"yellow";default:return"white"}}static async GetCTUFromRow(e){let n={id:"",visible:!1,xpos:0,ypos:0,dpi:0,width:0,height:0,offsetx:0,offsety:0};const s=e.getAttribute("unit-id"),r=await p.scene.items.getItems([s]);for(let o of r){const a=o;n={id:a.id,visible:a.visible,xpos:a.position.x,ypos:a.position.y,dpi:a.grid.dpi,width:a.image.width,height:a.image.height,offsetx:a.grid.offset.x,offsety:a.grid.offset.y}}return n}}async function W(d,e){var n=e;const s='<hr style="height:5px; margin-top: 4px; margin-bottom: 4px; visibility:hidden;" />';d.querySelector("#clash-main-body-settings").innerHTML=`
        <div id="settingsContainer">
        <h2 style="margin-top: 10px;">Settings</h2>
        <div><span id="exportAllContainer"></span>Export Collection Data </div>
        <i><small>This will save Collection data to a Text/JSON file</small></i>
        </br>
        ${s}
        <div><span id="importSubmitContainer"></span>Import Collection Data </div>
        <div><span id="importAllContainer"></span></div>
        <i><small>This will overwrite keys with the same Name/Author</small></i>
        </br>
        ${s}
        <div><span id="clearAllContainer"></span>Clear All Data </div>
        <i><small>This will delete the database.</small></i>
        </br>
        ${s}
        <div>${b("hideHp")}</span>&emsp;Hide HP Indication from Players </div>
        ${s}
        <div>${b("hideAll")}</span>&emsp;Hide All from Players </div>
        ${s}
        <div>${b("reverseList")}</span>&emsp;Reverse Initiative </div>
        ${s}
        <div>${b("noFocus")}</span>&emsp;Disable Camera Focus </div>
        ${s}
        <div>${b("noLabel")}</span>&emsp;Disable Turn Label </div>
        <div id="turnLabelTextContainer">&emsp;&emsp;&emsp;&emsp;</div>
        ${s}
        <div>${b("logToGM")}</span>&emsp;[Rumble!] Send Log to GM Only </div>
        <footer><span class="returnFloatLeft" id="settingsReturnContainer"></span></footer>
        </div>
       `,u(d,"hideHp",e.gmHideHp,e),u(d,"hideAll",e.gmHideAll,e),u(d,"reverseList",e.gmReverseList,e),u(d,"noFocus",e.gmDisableFocus,e),u(d,"noLabel",e.gmDisableLabel,e),u(d,"logToGM",e.gmRumbleLog,e);const r=d.getElementById("turnLabelTextContainer"),o=d.createElement("input");o.type="text",o.id="textLabelButton",o.title="Change your Turn Label's text",o.placeholder="« Go! »",o.maxLength=40,o.value=e.gmTurnText?e.gmTurnText:"",o.size=30,o.className="textInput",r?.appendChild(o);const a=d.getElementById("importAllContainer"),i=d.createElement("input");i.type="file",i.id="importButton",i.title="Choose a file to import",i.className="tinyType";const t=d.createElement("input");t.type="checkbox",t.id="favBox",t.title="Unfavorite during Upload";const l=d.getElementById("importSubmitContainer"),c=d.createElement("input");c.type="button",c.id="importSubmitButton",c.value="IMPORT DATA",c.title="Import Clash Collection Data",c.className="tinyType",c.onclick=async function(){if(i.files&&i.files.length>0){let E=i.files[0],C=new FileReader;C.readAsText(E),C.onload=async function(){try{const T=JSON.parse(C.result);await N(T),p.notification.show("Import Complete!","SUCCESS")}catch(T){alert(`The import failed - ${T}`)}},C.onerror=function(){console.log(C.error)}}},a?.appendChild(t),a?.appendChild(d.createTextNode("Un-Favorite  ˣ  ")),a?.appendChild(i),l?.appendChild(c);const m=d.getElementById("exportAllContainer"),g=d.createElement("input");g.type="button",g.id="exportButton",g.value="EXPORT DATA",g.title="Export Clash Collection Data",g.className="tinyType",g.onclick=async function(){await f()},m?.appendChild(g);const w=d.getElementById("clearAllContainer"),v=d.createElement("input");v.type="button",v.id="resetButton",v.value="DELETE DATA",v.title="Clear all Clash! Data",v.className="tinyType",v.onclick=async function(){if(confirm("Delete EVERYTHING? (Deletes Database and Refreshes Window)")){n.turnCounter=1,n.roundCounter=1;const E=d.getElementById("roundCount");E.innerText=`Round: ${n.roundCounter}`,await p.scene.items.deleteItems([h.LABEL]),await p.scene.items.updateItems(C=>C.metadata[`${h.EXTENSIONID}/metadata_initiative`]!=null||C.id===h.LABEL,C=>{for(let T of C)delete T.metadata[`${h.EXTENSIONID}/metadata_initiative`]}),await y.delete(),window.location.reload()}},w?.appendChild(v);const I=d.getElementById("settingsReturnContainer"),x=d.createElement("input");x.type="button",x.id="returnButton",x.className="turnColor chalkBorder turnIndicator",x.title="Save and return to Initiative List",x.value="Return",x.onclick=async function(){e.gmTurnText=o.value,await y.Settings.update(h.SETTINGSID,{gmHideHp:e.gmHideHp,gmHideAll:e.gmHideAll,gmDisableLabel:e.gmDisableLabel,gmReverseList:e.gmReverseList,gmTurnText:e.gmTurnText,gmRumbleLog:e.gmRumbleLog,disableFocus:e.gmDisableFocus}),e.gmDisableLabel&&p.scene.items.deleteItems([h.LABEL]),n.ShowSettingsMenu(!1),n.ShowMainMenu(!0)},I?.append(x);function b(E){return`<label class="switch" id="setting${E}Container">
            <span class="slider round"></span>
            </label>`}function u(E,C,T,S){const H=E.getElementById(`setting${C}Container`),A=E.createElement("input");A.type="checkbox",A.value=String(T),A.checked=T,A.onclick=async function(k){const R=k.target;switch(A.value=String(R.checked),C){case"hideHp":S.gmHideHp=R.checked;break;case"hideAll":S.gmHideAll=R.checked;break;case"noFocus":S.gmDisableFocus=R.checked;break;case"noLabel":S.gmDisableLabel=R.checked;break;case"reverseList":S.gmReverseList=R.checked;break;case"logToGM":S.gmRumbleLog=R.checked;break}},H?.insertBefore(A,H.firstChild)}async function f(){const E=await y.Creatures.toArray();var C=d.createElement("a"),T=new Blob([JSON.stringify(E)],{type:"text/plain"});C.href=URL.createObjectURL(T),C.download=`ClashCollectionExport-${Date.now()}`,d.body.appendChild(C),C.click(),d.body.removeChild(C)}async function N(E){const C=await y.Creatures.toArray();let T=[];E.forEach(S=>{let H=new B("","Default");H.SetToModel(S,!t.checked),H.tokenId="";const A=C.find(k=>k.unitName==S.unitName&&k.dataSlug==S.dataSlug);A?H.id=A.id:H.id=G(),T.push(H)}),await y.Creatures.bulkPut(T)}}function V(d,e){var n=e;const s=d.getElementById("saveButtonContainer"),r=d.createElement("input");r.type="image",r.className="Icon clickable",r.id="saveButton",r.onclick=async function(){await n.Save()},r.src="/save.svg",r.title="Save Changes",r.height=20,r.width=20,s.appendChild(r)}function K(d){const e=d.getElementById("rollAllContainer"),n=d.createElement("input");n.type="image",n.className="Icon RollerButton clickable",n.id="rollAllButton",n.onclick=async function(){p.notification.show("Rolled Initiative for all Monsters."),d.querySelectorAll(".isMonster").forEach(r=>{const a=r.id.substring(2),i=d.querySelector(`#iI${a}`),t=parseFloat(i.getAttribute("unit-dexbonus"));i.value=(t+Math.floor(Math.random()*(20-1)+1)).toString()})},n.src="/dice.svg",n.title="Roll Initiative for all Monsters",n.height=20,n.width=20,e.appendChild(n)}function J(d,e){var n=e;const s=d.getElementById("prevContainer"),r=d.getElementById("nextContainer"),o=d.createElement("input");o.type="button",o.id="previousButton",o.value="Previous",o.className="turnColor chalkBorder turnIndicator",o.title="Previous Turn",o.onclick=async function(){const i=d.getElementById("initiative-list");if(i.rows?.length>1){n.turnCounter--;for(var t=0,l;l=i.rows[t];t++)l.className=="turnOutline"&&l.parentElement?.firstElementChild===l&&(n.roundCounter--,n.roundCounter<1&&(n.roundCounter=1),n.turnCounter=l.parentElement.childElementCount);await n.FocusOnCurrentTurnUnit(i),await n.Save()}};const a=d.createElement("input");a.type="button",a.id="nextButton",a.value="Next",a.className="turnColor chalkBorder turnIndicator",a.title="Next Turn",a.onclick=async function(){const i=d.getElementById("initiative-list");if(i.rows?.length>1){n.turnCounter++;for(var t=0,l;l=i.rows[t];t++)l.className=="turnOutline"&&l.parentElement?.lastElementChild===l&&(n.roundCounter++,n.turnCounter=1);await n.FocusOnCurrentTurnUnit(i),await n.Save()}},s?.appendChild(o),r?.appendChild(a)}function Y(d,e){var n=e;const s=d.getElementById("resetContainer"),r=d.createElement("input");r.type="button",r.id="resetTurnButton",r.value="Reset Round",r.title="Reset Round",r.className="tinyType",r.onclick=async function(){n.turnCounter=1,n.roundCounter=1;const i=d.getElementById("roundCount");i.innerText=`Round: ${n.roundCounter}`,await y.Tracker.clear(),await y.Tracker.add({id:h.TURNTRACKER,currentRound:1,currentTurn:1}),await p.scene.items.deleteItems([h.LABEL]),await e.ShowTurnSelection(),await e.Save()},s.appendChild(r);const o=d.createElement("input");o.type="button",o.id="clearButton",o.value="CLEAR LIST",o.title="Clear List",o.className="tinyType",o.onclick=async function(){if(confirm("Clear the Initiative List (This will leave unit info)?")){n.turnCounter=1,n.roundCounter=1;const i=d.getElementById("roundCount");i.innerText=`Round: ${n.roundCounter}`,await y.Tracker.clear(),await y.Tracker.add({id:h.TURNTRACKER,currentRound:1,currentTurn:1}),await y.ActiveEncounter.where("isActive").equals(1).modify({isActive:0}),await p.scene.items.deleteItems([h.LABEL]),await p.scene.items.updateItems(t=>t.metadata[`${h.EXTENSIONID}/metadata_initiative`]!=null||t.id===h.LABEL,t=>{for(let l of t)delete l.metadata[`${h.EXTENSIONID}/metadata_initiative`]}),await e.Save()}},s.appendChild(o);const a=d.createElement("input");a.type="button",a.id="settingsButton",a.value="Settings",a.title="View Settings",a.className="tinyType",a.onclick=async function(){n.ShowMainMenu(!1),n.ShowSettingsMenu(!0),W(d,e)},s.appendChild(a)}class j{inSceneUnits=[];roundCounter=1;turnCounter=1;activeUnits=[];party=[];gmHideHp=!1;gmHideAll=!1;gmDisableLabel=!1;gmDisableFocus=!1;gmReverseList=!1;gmRumbleLog=!1;gmTurnText="";async RenderInitiativeList(e){this.setupContextMenu(this),this.ShowSettingsMenu(!1),this.ShowMainMenu(!0);const n=e.querySelector("#clash-main-body-app");if(n.innerHTML=`
        <div id="contextMenu" class="context-menu" style="display: none">
            <ul id="playerListing"></ul>
        </div>
        <table id="initiative-list">
        <thead>
            <tr>
            <th style="width: 8%"><img class="Icon" title="Initiative" src="/queue.svg"></th>
            <th style="width: 8%"><div id="rollAllContainer"></div></th>
            <th style="width: 42%">Name</th>
            <th style="width: 24%"><img class="Icon" title="Hit Points" src="/heart.svg"></th>
            <th style="width: 8%"><img class="Icon" title="Armor Class" src="/shield.svg"></th>
            <th style="width: 10%"><span id="saveButtonContainer"></span></th>
            </tr>
        </thead>
        <tbody id="unit-list"></tbody>
        </table>
        <footer>
        <div id="roundCounter" class="bottom"><span id="prevContainer"></span><span id="roundCount" class="centerish">Round: ${this.roundCounter}</span><span id="nextContainer"></span></div>
        <div id="bombContainer" class="bombBottom"><span id="resetContainer" class=""></span></div>
        </footer>
        `,y.inMemory){const t=e.createElement("div");t.innerText="Local Storage Disabled - Features Limited",t.className="noDatabase",n.prepend(t)}V(e,this),J(e,this),Y(e,this),K(e);const s=await y.Settings.get(h.SETTINGSID);s?(this.gmHideHp=s.gmHideHp,this.gmHideAll=s.gmHideAll,this.gmDisableLabel=s.gmDisableLabel,this.gmDisableFocus=s.disableFocus,this.gmReverseList=s.gmReverseList,this.gmRumbleLog=s.gmRumbleLog,this.gmTurnText=s.gmTurnText):await y.Settings.add({id:h.SETTINGSID,gmHideHp:!1,gmHideAll:!1,gmDisableLabel:!1,gmTurnText:"",gmReverseList:!1,gmRumbleLog:!1,disableFocus:!1});const r=await y.Tracker.get(h.TURNTRACKER);r?(this.turnCounter=r.currentTurn,this.roundCounter=r.currentRound):await y.Tracker.add({id:h.TURNTRACKER,currentRound:1,currentTurn:1});const o=e.getElementById("playerListing");this.party=await p.party.getPlayers(),o.appendChild(M()),this.party.forEach(t=>{const l=e.createElement("li");l.id=t.id,l.textContent=t.name,l.style.color=t.color,o.appendChild(l)}),p.party.onChange(t=>{o.innerHTML="",o.appendChild(M()),this.party=t,t.forEach(async l=>{const c=e.createElement("li");c.id=l.id,c.textContent=l.name,c.style.color=l.color,o.appendChild(c);const m=l.metadata;if(m[`${h.EXTENSIONID}/metadata_playerItem`]!=null){const w=m[`${h.EXTENSIONID}/metadata_playerItem`].PlayerUpdate;q(w.stamp)||(w.initiative?await y.ActiveEncounter.update(w.id,{initiative:w.initiative}):w.cHp?await y.ActiveEncounter.update(w.id,{currentHP:w.cHp}):w.mHp?await y.ActiveEncounter.update(w.id,{maxHP:w.mHp}):w.aC&&await y.ActiveEncounter.update(w.id,{armorClass:w.aC}),await this.UpdateTrackerForPlayers())}})}),p.scene.onReadyChange(async t=>{t&&await this.CheckIniativeList()});const a=await p.theme.getTheme();U(a,e),p.theme.onChange(t=>{U(t,e)}),p.scene.items.onChange(async t=>{t.forEach(async c=>{const m=c,g=m.text?.plainText||m.name,w=this.activeUnits.find(v=>v.id===m.id);w&&w.unitName!==g&&await y.ActiveEncounter.update(w.id,{unitName:g}),c.metadata[`${h.EXTENSIONID}/metadata_initiative`]!==void 0&&w?.isActive==0&&await y.ActiveEncounter.update(w.id,{isActive:1})}),this.activeUnits.filter(({id:c})=>!t.some(({id:m})=>m===c)).forEach(async c=>{await y.ActiveEncounter.update(c.id,{isActive:0})})}),await z(async()=>await y.ActiveEncounter.toArray()).subscribe({next:async t=>{this.RefreshList(t)},error:t=>console.log("Error refreshing list: "+t)}),await this.CheckIniativeList()}async CheckIniativeList(){const e=await p.scene.items.getItems(s=>s.layer==="CHARACTER"&&s.metadata[`${h.EXTENSIONID}/metadata_initiative`]!==void 0);let n=[];e.length>0&&(this.inSceneUnits=e.map(r=>r.id),n=await(await y.ActiveEncounter.toCollection()).toArray(),this.activeUnits=n.filter(r=>this.inSceneUnits.includes(r.id)),this.activeUnits.forEach(async r=>{await y.ActiveEncounter.update(r.id,{isActive:1})})),await this.RefreshList(n)}RefreshList(e){const n=document.querySelector("#unit-list"),s=this,r=e.filter(a=>a.isActive==1);this.activeUnits=r.filter(a=>this.inSceneUnits.includes(a.id));const o=this.gmReverseList?this.activeUnits.sort((a,i)=>a.initiative-i.initiative||a.unitName.localeCompare(i.unitName)):this.activeUnits.sort((a,i)=>i.initiative-a.initiative||a.unitName.localeCompare(i.unitName));for(;n?.rows.length>0;)n.deleteRow(0);for(const a of o){let i;if(a.ownerId){const C=this.party.find(T=>T.id===a.ownerId)?.color;C&&(i=P(C,.4))}let t=n.insertRow(-1),l=t.insertCell(0),c=t.insertCell(1),m=t.insertCell(2),g=t.insertCell(3),w=t.insertCell(4),v=t.insertCell(5);t.setAttribute("unit-id",a.id);const I=document.createElement("input");I.className="InitiativeInput",I.inputMode="numeric",I.setAttribute("unit-dexbonus",Math.floor((a.dexScore-10)/2).toString()),I.value=a.initiative.toString(),I.id=`iI${a.id}`,I.size=2,I.min="0",I.max="99",I.maxLength=2;const x=document.createElement("input");x.type="image",x.title="Roll this Unit's Iniative",x.id=`rB${a.id}`,x.className="clickable",x.onclick=async function(){const C=parseFloat(I.getAttribute("unit-dexbonus"));I.value=(C+Math.floor(Math.random()*(20-1)+1)).toString()},x.src="/dice.svg",x.height=20,x.width=20;const b=document.createElement("input");b.type="button",b.value=a.isMonster?`ʳ ${a.unitName} ʴ`:a.unitName,b.title="Change between Player and Monster groups",b.id=`nT${a.id}`,b.style.width="100%",b.style.textOverflow="ellipsis",b.style.overflow="hidden",i&&(b.style.background=`linear-gradient(200deg, transparent, ${i})`),b.className=a.isMonster?"isMonster nameToggleInput":"nameToggleInput",b.onclick=async function(){b.className=="isMonster nameToggleInput"?(b.value=a.unitName,b.className="nameToggleInput"):(b.value=`ʳ ${a.unitName} ʴ`,b.className="isMonster nameToggleInput")},b.oncontextmenu=async function(C){C.preventDefault();const T=document.getElementById("contextMenu");T.addEventListener("click",async H=>{H.stopPropagation();const A=H.target,k=T.getAttribute("currentUnit");await y.ActiveEncounter.update(k,{ownerId:A.id})}),T.setAttribute("currentUnit",a.id);const S=()=>{T.style.display="none",document.removeEventListener("click",S)};document.addEventListener("click",S),T.style.display=="block"?Z():(T.style.display="block",T.style.left=C.pageX+"px",T.style.top=C.pageY+"px")};const u=document.createElement("input");u.className="HealthInput",u.inputMode="numeric",u.id=`cHP${a.id}`,u.title=a.currentHP.toString(),u.value=a.currentHP.toString(),u.size=4,u.maxLength=4,u.onblur=function(C){const S=C.currentTarget.value;if(S.substring(0,1)=="+"){const H=S.substring(S.indexOf("+")+1);u.value=(+H+ +u.title).toString(),u.title=u.value,C.preventDefault()}else if(S.substring(0,1)=="-"){const H=S.substring(S.indexOf("-")+1);u.value=(+u.title-+H).toString(),u.title=u.value,C.preventDefault()}s.Save()},u.onkeydown=function(C){if(C.key!=="Enter")return;const S=C.currentTarget.value;if(S.substring(0,1)=="+"){const H=S.substring(S.indexOf("+")+1);u.value=(+H+ +u.title).toString(),u.title=u.value,C.preventDefault()}else if(S.substring(0,1)=="-"){const H=S.substring(S.indexOf("-")+1);u.value=(+u.title-+H).toString(),u.title=u.value,C.preventDefault()}s.Save()};const f=document.createElement("input");f.className="HealthInput",f.inputMode="numeric",f.id=`mHP${a.id}`,f.value=a.maxHP.toString(),f.size=4,f.maxLength=4;const N=document.createElement("input");N.className="ArmorInput",N.inputMode="numeric",N.id=`aC${a.id}`,N.value=a.armorClass.toString(),N.size=2,N.maxLength=2;const E=document.createElement("input");E.type="image",E.title="View/Edit this Unit's Stats",E.id=`tB${a.id}`,E.className="clickable",E.onclick=async function(C){const T=C.currentTarget;await s.OpenSubMenu(T.id.substring(2))},E.src="/triangle.svg",E.height=20,E.width=20,E.style.marginLeft="5px",l.appendChild(I),l.style.width="8%",c.appendChild(x),c.style.width="8%",m.appendChild(b),m.style.width="42%",g.appendChild(u),g.appendChild(document.createTextNode("/")),g.appendChild(f),g.style.width="24%",w.appendChild(N),w.style.width="8%",y.inMemory||(v.appendChild(E),v.style.width="10%")}this.AttachFocusListeners(),this.ShowTurnSelection()}AttachFocusListeners(){const e=document.getElementById("initiative-list");e&&e.addEventListener("dblclick",n);async function n(s){s.preventDefault();const r=s.target.closest("tr"),o=await L.GetCTUFromRow(r);await D.CenterViewportOnImage(o)}}ShowTurnSelection(){const e=document.getElementById("initiative-list");if(e.rows?.length>1){for(var n=0,s;s=e.rows[n];n++)s.classList.remove("turnOutline");if(this.turnCounter>=e.rows.length&&(this.turnCounter=e.rows.length-1),e.rows[this.turnCounter]){const r=e.rows[this.turnCounter];r.className="turnOutline";const o=document.getElementById("roundCount");o.innerText=`Round: ${this.roundCounter}`}}}async Save(){document.querySelectorAll(".InitiativeInput").forEach(async n=>{const s=n,r=s.id.substring(2),o=s.value,a=document.querySelector(`#cHP${r}`),i=a.value?a.value:"0",t=document.querySelector(`#mHP${r}`),l=t.value?t.value:"1",c=document.querySelector(`#aC${r}`),m=c.value?c.value:"10",w=document.querySelector(`#nT${r}`).className=="isMonster nameToggleInput";if(!r||!o)return;let v=this.activeUnits?.find(I=>I.id==r);v&&await y.ActiveEncounter.update(v.id,{initiative:parseFloat(o),currentHP:parseFloat(i),maxHP:parseFloat(l),armorClass:parseFloat(m),isMonster:w})}),await y.Tracker.update(h.TURNTRACKER,{id:h.TURNTRACKER,currentTurn:this.turnCounter,currentRound:this.roundCounter}),await this.CheckIniativeList(),await this.UpdateTrackerForPlayers()}async UpdateTrackerForPlayers(){const e=[],n=new Date().toISOString(),s=[];(await p.scene.items.getItems(i=>i.id.endsWith("_hpbar"))).forEach(i=>{const t=i,l=this.activeUnits.find(c=>c.id===t.id.replace("_hpbar",""));l&&(t.text.plainText=L.getHealthPercentageString(l.currentHP,l.maxHP),t.text.style.fillColor=L.getHealthColorString(l.currentHP,l.maxHP),s.push(t))}),await p.scene.items.addItems(s);for(const i of this.activeUnits)e.push({id:i.id,name:i.unitName,initiative:i.initiative,cHp:i.currentHP,mHp:i.maxHP,aC:i.armorClass,owner:i.ownerId});const o={turn:this.turnCounter,round:this.roundCounter,units:e,gmHideHp:this.gmHideHp,gmHideAll:this.gmHideAll,gmReverseList:this.gmReverseList,lastUpdate:n},a={};a[`${h.EXTENSIONID}/metadata_trackeritem`]={Tracker:o},await p.scene.setMetadata(a)}async FocusOnCurrentTurnUnit(e){const n=e.rows[this.turnCounter],s=await L.GetCTUFromRow(n);this.gmDisableFocus||await D.CenterViewportOnImage(s),this.gmDisableLabel||await L.UpdateLabel(s,this.gmTurnText)}ShowSettingsMenu(e){const n=document.querySelector("#clash-main-body-settings");n.hidden=!e}ShowMainMenu(e){const n=document.querySelector("#clash-main-body-app");n.hidden=!e}async OpenSubMenu(e){const s=window.innerWidth<h.MOBILEWIDTH,r=window.outerHeight-150,o=r>800?700:r-100;s?await p.popover.open({id:h.EXTENSIONSUBMENUID,url:`/submenu/subindex.html?unitid=${e}`,height:o,width:325,hidePaper:!0}):await p.modal.open({id:h.EXTENSIONSUBMENUID,url:`/submenu/subindex.html?unitid=${e}`,height:o,width:350})}setupContextMenu(e){const n=/\s[\da-zA-Z]$/;y.inMemory||p.contextMenu.create({id:`${h.EXTENSIONID}/context-menu-sheet`,icons:[{icon:"/sheet.svg",label:"[Clash!] View Info",filter:{max:1,every:[{key:"layer",value:"CHARACTER"}]}},{icon:"/multi-sheet.svg",label:"[Clash!] View Info",filter:{min:2,every:[{key:"layer",value:"CHARACTER"}]}}],async onClick(s,r){if(s.items.length==1){const o=s.items[0],a=o.text?.plainText||o.name;if(!await y.ActiveEncounter.get(o.id)){let m=new B(o.id,a);if(n.test(a)){const g=a.slice(0,-2),w=await y.Creatures.get({unitName:g});w&&m.SetToModel(w)}else{const g=await y.Creatures.get({unitName:a});g&&m.SetToModel(g)}await m.SaveToDB()}const t=100,l=window.outerHeight-150,c=l>800?700:l-t;await p.popover.open({id:h.EXTENSIONSUBMENUID,url:`/submenu/subindex.html?unitid=${o.id}`,height:c,width:325,anchorElementId:r,hidePaper:!0})}else{s.items.forEach(async c=>{const m=c,g=m.text?.plainText||m.name;if(!await y.ActiveEncounter.get(c.id)){let v=new B(c.id,g);if(n.test(g)){const I=g.slice(0,-2),x=await y.Creatures.get({unitName:I});x&&v.SetToModel(x)}else{const I=await y.Creatures.get({unitName:g});I&&v.SetToModel(I)}await v.SaveToDB()}});const o=s.items.map(c=>c.id).toString(),a=s.items.map(c=>c.metadata[`${h.EXTENSIONID}/metadata_initiative`]!==void 0).toString(),i=100,t=window.outerHeight-150,l=t>800?700:t-i;await p.popover.open({id:h.EXTENSIONSUBMENUID,url:`/submenu/subindex.html?unitid=${o}&unitactive=${a}&multi=true`,height:l,width:325,anchorElementId:r,hidePaper:!0})}}}),p.contextMenu.create({id:`${h.EXTENSIONID}/context-hp-menu`,icons:[{icon:"/health.svg",label:"[Clash!] Show HP Bar",filter:{every:[{key:"layer",value:"CHARACTER"},{key:["metadata",`${h.EXTENSIONID}/metadata_hpbar`],value:void 0},{key:["metadata",`${h.EXTENSIONID}/metadata_initiative`],value:void 0,operator:"!="}]}},{icon:"/health-black.svg",label:"[Clash!] Hide HP Bar",filter:{every:[{key:"layer",value:"CHARACTER"},{key:["metadata",`${h.EXTENSIONID}/metadata_hpbar`],value:void 0,operator:"!="}]}}],async onClick(s){if(s.items.every(o=>o.metadata[`${h.EXTENSIONID}/metadata_hpbar`]===void 0)){const a=[];await p.scene.items.updateItems(s.items,i=>{for(let t of i){const l=t,c=e.activeUnits.find(m=>m.id===t.id);c&&(t.metadata[`${h.EXTENSIONID}/metadata_hpbar`]={showHpBars:!0},a.push(L.UpdateHPBar(l,c.currentHP,c.maxHP)))}}),await p.scene.items.addItems(a)}else{const o=s.items.map(a=>a.id+"_hpbar");await p.scene.items.deleteItems(o),p.scene.items.updateItems(s.items,a=>{for(let i of a)delete i.metadata[`${h.EXTENSIONID}/metadata_hpbar`]})}}}),p.contextMenu.create({id:`${h.EXTENSIONID}/context-menu`,icons:[{icon:"/addunit.svg",label:"[Clash!] Add to Initiative",filter:{every:[{key:"layer",value:"CHARACTER"},{key:["metadata",`${h.EXTENSIONID}/metadata_initiative`],value:void 0}]}},{icon:"/removeunit.svg",label:"[Clash!] Remove from Initiative",filter:{every:[{key:"layer",value:"CHARACTER"}]}}],async onClick(s){const o=s.items.every(t=>t.metadata[`${h.EXTENSIONID}/metadata_initiative`]===void 0),a=s.items;let i=[];if(o)p.scene.items.updateItems(a,t=>{for(let l of t)i.push({id:l.id,name:l.text?.plainText||l.name,ownerId:l.createdUserId}),l.metadata[`${h.EXTENSIONID}/metadata_initiative`]={initiative:!0}}),i.forEach(async t=>{if(await y.ActiveEncounter.get(t.id))await y.ActiveEncounter.update(t.id,{isActive:1});else{let c=new B(t.id,t.name,t.ownerId);if(n.test(t.name)){const m=t.name.slice(0,-2),g=await y.Creatures.get({unitName:m});g&&c.SetToModel(g)}else{const m=await y.Creatures.get({unitName:t.name});m&&c.SetToModel(m)}c.isActive=1,c.SaveToDB()}e.inSceneUnits.push(t.id)});else{const t=s.items.map(l=>l.id+"_hpbar");await p.scene.items.deleteItems(t),p.scene.items.updateItems(s.items,l=>{for(let c of l)i.push({id:c.id,name:c.name}),delete c.metadata[`${h.EXTENSIONID}/metadata_initiative`],delete c.metadata[`${h.EXTENSIONID}/metadata_hpbar`]}),i.forEach(async l=>{await y.ActiveEncounter.update(l.id,{isActive:0}),e.inSceneUnits=e.inSceneUnits.filter(c=>c!=l.id)})}}})}}function M(){const d=document.createElement("li");return d.id="",d.textContent="No Owner",d}function Z(){document.getElementById("contextMenu").style.display="none"}class Q{roundCounter=1;turnCounter=1;enableAutoFocus=!1;lastUpdate="";playerId="";playerColor="";party=[];async Render(e){e.querySelector("#clash-main-body-app").innerHTML=`
            <table id="initiative-list">
            <thead>
                <tr>
                <th style="width: 10%"><img class="Icon" title="Initiative" src="/queue.svg"></th>
                <th style="width: 58%">Name</th>
                <th style="width: 24%"><img class="Icon" title="Hit Points" src="/heart.svg"></th>
                <th style="width: 8%"><img class="Icon" title="Armor Class" src="/shield.svg"></th>
                </tr>
            </thead>
            <tbody id="unit-list"></tbody>
            </table>
            <footer>
            <div id="roundCounter" class="playerBottom">
            <label class="switch" id="settingnoFocusContainer">
            <span class="slider round"></span>
            </label> AutoFocus
            <span id="roundCount" class="playerCenterish">Round: ${this.roundCounter}</span>
            </div>
            </footer>
            `;var n=this;const s=e.getElementById("settingnoFocusContainer"),r=e.createElement("input");r.type="checkbox",r.value=String(this.enableAutoFocus),r.checked=this.enableAutoFocus,r.onclick=async function(i){const t=i.target;r.value=String(t.checked),n.enableAutoFocus=t.checked},s?.insertBefore(r,s.firstChild),this.playerId=await p.player.getId(),this.playerColor=await p.player.getColor(),this.party=await p.party.getPlayers();const o=await p.theme.getTheme();U(o,e),this.SetupListeners();const a=await p.scene.getMetadata();await this.RefreshList(a)}async RefreshList(e){const n=this,r=e[`${h.EXTENSIONID}/metadata_trackeritem`]?.Tracker;if(!r||!r.units||r.lastUpdate==this.lastUpdate)return;this.lastUpdate=r.lastUpdate;const o=document.querySelector("#unit-list");if(r.gmHideAll){o.innerHTML="";return}const a=r.gmReverseList?r.units.sort((i,t)=>i.initiative-t.initiative||i.name.localeCompare(t.name)):r.units.sort((i,t)=>t.initiative-i.initiative||i.name.localeCompare(t.name));for(this.roundCounter=r.round,this.turnCounter=r.turn;o.rows.length>0;)o.deleteRow(0);for(const i of a){let t=o.insertRow(-1);if(i.owner===this.playerId){const l=P(this.playerColor,.4);t.setAttribute("unit-id",i.id);let c=t.insertCell(0);c.style.placeContent="center";const m=document.createElement("input");m.className="InitiativeInput wide",m.inputMode="numeric",m.value=i.initiative.toString(),m.id=`iI${i.id}`,m.size=2,m.min="0",m.max="99",m.maxLength=2,m.onblur=function(u){const f=u.currentTarget;f.value&&n.SendUpdate({id:f.id.substring(2),initiative:+f.value})},m.onkeydown=function(u){if(u.key!=="Enter")return;const f=u.currentTarget;f.value&&n.SendUpdate({id:f.id.substring(2),initiative:+f.value})};let g=t.insertCell(1);g.style.placeContent="center",g.style.textOverflow="ellipsis",g.style.overflow="hidden",g.style.whiteSpace="nowrap",g.className="nameToggleInput",g.style.background=`linear-gradient(200deg, transparent, ${l})`;let w=t.insertCell(2);const v=document.createElement("input");v.className="HealthInput",v.inputMode="numeric",v.id=`cHP${i.id}`,v.title=i.cHp.toString(),v.value=i.cHp.toString(),v.size=4,v.maxLength=4,v.onblur=function(u){const f=u.currentTarget,N=f.value;if(N.substring(0,1)=="+"){const E=N.substring(N.indexOf("+")+1);v.value=(+E+ +v.title).toString(),v.title=v.value,u.preventDefault()}else if(N.substring(0,1)=="-"){const E=N.substring(N.indexOf("-")+1);v.value=(+v.title-+E).toString(),v.title=v.value,u.preventDefault()}f.value&&n.SendUpdate({id:f.id.substring(3),cHp:+f.value})},v.onkeydown=function(u){if(u.key!=="Enter")return;const f=u.currentTarget,N=f.value;if(N.substring(0,1)=="+"){const E=N.substring(N.indexOf("+")+1);v.value=(+E+ +v.title).toString(),v.title=v.value,u.preventDefault()}else if(N.substring(0,1)=="-"){const E=N.substring(N.indexOf("-")+1);v.value=(+v.title-+E).toString(),v.title=v.value,u.preventDefault()}f.value&&n.SendUpdate({id:f.id.substring(3),cHp:+f.value})};const I=document.createElement("input");I.className="HealthInput",I.inputMode="numeric",I.id=`mHP${i.id}`,I.value=i.mHp.toString(),I.size=4,I.maxLength=4,I.onblur=function(u){const f=u.currentTarget;f.value&&n.SendUpdate({id:f.id.substring(3),mHp:+f.value})},I.onkeydown=function(u){if(u.key!=="Enter")return;const f=u.currentTarget;f.value&&n.SendUpdate({id:f.id.substring(3),mHp:+f.value})};let x=t.insertCell(3);const b=document.createElement("input");b.className="ArmorInput",b.inputMode="numeric",b.id=`aC${i.id}`,b.value=i.aC.toString(),b.size=2,b.maxLength=2,b.onblur=function(u){const f=u.currentTarget;f.value&&n.SendUpdate({id:f.id.substring(2),aC:+f.value})},b.onkeydown=function(u){if(u.key!=="Enter")return;const f=u.currentTarget;f.value&&n.SendUpdate({id:f.id.substring(2),aC:+f.value})},r.gmHideHp||(i.cHp<=i.mHp/4?g.className=g.className+" unitHarmed":i.cHp<=i.mHp/2?g.className=g.className+" unitHurt":g.className=g.className+" unitHappy"),c.appendChild(m),c.style.width="10%",g.appendChild(document.createTextNode(i.name)),g.style.width="58%",w.appendChild(v),w.appendChild(document.createTextNode("/")),w.appendChild(I),x.appendChild(b),x.style.width="8%"}else{let l=t.insertCell(0);l.style.placeContent="center";let c=t.insertCell(1);c.style.placeContent="center",c.style.textOverflow="ellipsis",c.style.overflow="hidden",c.style.whiteSpace="nowrap",t.setAttribute("unit-id",i.id);const m=document.createElement("input");m.className="HealthInput",m.inputMode="numeric",m.id="cHP"+i.id,m.value=i.cHp.toString(),m.size=4,m.maxLength=4,r.gmHideHp||(i.cHp<=i.mHp/4?c.className="unitHarmed":i.cHp<=i.mHp/2?c.className="unitHurt":c.className="unitHappy"),l.appendChild(document.createTextNode(i.initiative.toString())),l.style.width="10%",c.appendChild(document.createTextNode(i.name)),c.style.width="58%"}}this.AttachFocusListeners(),await this.ShowTurnSelection()}AttachFocusListeners(){const e=document.getElementById("initiative-list");e&&e.addEventListener("dblclick",n);async function n(s){s.preventDefault();const r=s.target.closest("tr"),o=await L.GetCTUFromRow(r);await D.CenterViewportOnImage(o)}}async ShowTurnSelection(){const e=document.getElementById("initiative-list");if(e.rows?.length>1){for(var n=0,s;s=e.rows[n];n++)s.classList.remove("turnOutline");if(this.turnCounter>=e.rows.length&&(this.turnCounter=e.rows.length-1),e.rows[this.turnCounter]){const r=e.rows[this.turnCounter];r.className="turnOutline";const o=document.getElementById("roundCount");o.innerText=`Round: ${this.roundCounter}`;let a=await L.GetCTUFromRow(r);a.visible&&this.enableAutoFocus&&await D.CenterViewportOnImage(a)}}}async SetupListeners(){p.scene.onMetadataChange(e=>this.RefreshList(e)),p.theme.onChange(e=>{U(e,document)}),p.player.onChange(e=>{this.playerColor=e.color}),p.party.onChange(e=>{this.party=e})}async SendUpdate(e){e.stamp=new Date().toISOString();const n={};n[`${h.EXTENSIONID}/metadata_playerItem`]={PlayerUpdate:e},await p.player.setMetadata(n)}}const ee=new j,te=new Q;let O=!1;const F=document.querySelector("#clash-main-body-app"),ie=y;ie.Ready();F.innerHTML=`
  <div>
    <h1>Loading...</h1>
  </div>
`;p.onReady(async()=>{O=await p.scene.isReady(),$(O),p.scene.onReadyChange(async d=>{$(d)})});async function $(d){const e=await p.player.getRole();d?e==="GM"?await ee.RenderInitiativeList(document):await te.Render(document):F.innerHTML=`
            <div>
            <h1>Waiting for Scene...</h1>
            <div class="imageContainer">
            <img class="resize_fit_center" src="logo.png" alt="Clash!" class="center">
            </div>
            </div>`}
