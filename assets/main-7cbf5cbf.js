import{O as d,C as c,U as o,S as A}from"./clashConstants-0f9588e3.js";import{i as g,U as M,d as f,R as h,O as y,B as C,g as p,G as w,P as S}from"./bsSceneCache-75aaca06.js";function E(){d.contextMenu.create({id:`${c.EXTENSIONID}/context-menu`,icons:[{icon:"/addunit.svg",label:"[Clash!] Add to Initiative",filter:{every:[{key:["metadata",o.ONLIST],operator:"!=",value:!0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"MOUNT"}]}},{icon:"/removeunit.svg",label:"[Clash!] Remove from Initiative",filter:{every:[{key:["metadata",o.ONLIST],operator:"==",value:!0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"MOUNT"}]}}],async onClick(T){const m=T.items.filter(e=>e.layer==="CHARACTER"||e.layer==="MOUNT"),u=m.every(e=>e.metadata[o.ONLIST]===!0),l=m.filter(e=>g(e));if(u){const e=m.map(i=>i.id+"_hpbar");await d.scene.items.deleteItems(e),await d.scene.items.updateItems(m,i=>{for(let n of i)delete n.metadata[o.ONLIST],delete n.metadata[o.HPBAR]})}else{const e=[];for(const i of l){const n=i.text?.plainText||i.name;if(i.metadata[o.ID]!==void 0){const a={};a[o.ID]=i.id,a[o.ONLIST]=!0,e.push(a);continue}let s=new M(i.id,n,i.createdUserId);if(c.ALPHANUMERICTEXTMATCH.test(i.name)){const a=n.slice(0,-2),r=await f.Creatures.get({unitName:a});r&&s.SetToModel(r)}else{const a=await f.Creatures.get({unitName:n});a&&s.SetToModel(a)}const t=s.GetMetadata();t[o.ONLIST]=!0,e.push(t)}await d.scene.items.updateItems(l,i=>{for(let n of i){const s=e.find(t=>t[o.ID]===n.id);if(s){if(h(A.NAMELABELS)){const t=s[o.UNITNAME];t&&(n.text.plainText=t)}Object.assign(n.metadata,s)}}})}}}),d.contextMenu.create({id:`${c.EXTENSIONID}/context-menu-sheet`,icons:[{icon:"/sheet.svg",label:"[Clash!] View Info",filter:{max:1,some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"MOUNT"}]}},{icon:"/multi-sheet.svg",label:"[Clash!] View Info",filter:{min:2,some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"MOUNT"}]}}],async onClick(T,m){const u=T.items.filter(l=>l.layer==="CHARACTER"||l.layer==="MOUNT");if(u.length==1){const l=[],e=u[0],i=e.text?.plainText||e.name;if(e.metadata[o.ID]===void 0){let n=new M(e.id,i,e.createdUserId);if(c.ALPHANUMERICTEXTMATCH.test(e.name)){const t=i.slice(0,-2),a=await f.Creatures.get({unitName:t});a&&n.SetToModel(a)}else{const t=await f.Creatures.get({unitName:i});t&&n.SetToModel(t)}const s=n.GetMetadata();l.push(s),await d.scene.items.updateItems([e.id],t=>{for(let a of t){const r=l.find(N=>N[o.ID]===a.id);r&&Object.assign(a.metadata,r)}})}await y(e.id,m)}else{const l=[];for(const s of u){const t=s,a=t.text?.plainText||t.name;if(t.metadata[o.ID]===void 0){let r=new M(t.id,a,t.createdUserId);if(c.ALPHANUMERICTEXTMATCH.test(t.name)){const I=a.slice(0,-2),v=await f.Creatures.get({unitName:I});v&&r.SetToModel(v)}else{const I=await f.Creatures.get({unitName:a});I&&r.SetToModel(I)}const N=r.GetMetadata();l.push(N)}}await d.scene.items.updateItems(u,s=>{for(let t of s){const a=l.find(r=>r[o.ID]===t.id);a&&Object.assign(t.metadata,a)}});const e=await d.viewport.getHeight(),i=100,n=e>800?700:e-i;await d.popover.open({id:c.EXTENSIONSUBMENUID,url:`/submenu/subindex.html?unitid=${u.map(s=>s.id)}&multi=true`,height:n,width:350,anchorElementId:m,hidePaper:!0,disableClickAway:!0})}}})}c.MAINAPP.innerHTML=`
  <div>
    <h1>Loading...</h1>
  </div>
`;c.MAINLOAD.innerHTML=`
<div>
    <h1 id="loadingScreenHeader">Waiting for Scene...</h1>
    <div class="imageContainer">
        <img class="resize-fit-center" src="logo.png" alt="Clash!" class="center">
    </div>
</div>`;c.MAINDISABLED.innerHTML=`
<div>
    <h1 id="loadingScreenHeader">Access has been disabled</h1>
    <div class="imageContainer">
        <img class="resize-fit-center" src="logo.png" alt="Clash!" class="center">
    </div>
</div>`;d.onReady(async()=>{await C.InitializeCache(),C.SetupHandlers(),C.playerRole==="GM"&&(await p(),f.Ready()),C.playerRole==="GM"?(w.Render(),E()):S.Render(),c.MAINAPP.hidden=!1,c.MAINLOAD.hidden=!0});
