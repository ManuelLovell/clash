import{O as c,C as r,U as o}from"./clashConstants-4a61437d.js";import{i as M,U as T,d as u,O as g,B as C,g as h,G as A,P as p}from"./bsSceneCache-1541913a.js";function w(){c.contextMenu.create({id:`${r.EXTENSIONID}/context-menu`,icons:[{icon:"/addunit.svg",label:"[Clash!] Add to Initiative",filter:{every:[{key:["metadata",o.ONLIST],operator:"!=",value:!0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"MOUNT"}]}},{icon:"/removeunit.svg",label:"[Clash!] Remove from Initiative",filter:{every:[{key:["metadata",o.ONLIST],operator:"==",value:!0}],some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"MOUNT"}]}}],async onClick(d){const f=d.items.every(e=>e.metadata[o.ONLIST]===!0),m=d.items.filter(e=>M(e));if(f){const e=d.items.map(i=>i.id+"_hpbar");await c.scene.items.deleteItems(e),await c.scene.items.updateItems(d.items,i=>{for(let n of i)delete n.metadata[o.ONLIST],delete n.metadata[o.HPBAR]})}else{const e=[];for(const i of m){const n=i.text?.plainText||i.name;if(i.metadata[o.ID]!==void 0){const a={};a[o.ID]=i.id,a[o.ONLIST]=!0,e.push(a);continue}let s=new T(i.id,n,i.createdUserId);if(r.ALPHANUMERICTEXTMATCH.test(i.name)){const a=n.slice(0,-2),l=await u.Creatures.get({unitName:a});l&&s.SetToModel(l)}else{const a=await u.Creatures.get({unitName:n});a&&s.SetToModel(a)}const t=s.GetMetadata();t[o.ONLIST]=!0,e.push(t)}await c.scene.items.updateItems(m,i=>{for(let n of i){const s=e.find(t=>t[o.ID]===n.id);s&&Object.assign(n.metadata,s)}})}}}),c.contextMenu.create({id:`${r.EXTENSIONID}/context-menu-sheet`,icons:[{icon:"/sheet.svg",label:"[Clash!] View Info",filter:{max:1,some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"MOUNT"}]}},{icon:"/multi-sheet.svg",label:"[Clash!] View Info",filter:{min:2,some:[{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"MOUNT"}]}}],async onClick(d,f){if(d.items.length==1){const m=[],e=d.items[0],i=e.text?.plainText||e.name;if(e.metadata[o.ID]===void 0){let n=new T(e.id,i,e.createdUserId);if(r.ALPHANUMERICTEXTMATCH.test(e.name)){const t=i.slice(0,-2),a=await u.Creatures.get({unitName:t});a&&n.SetToModel(a)}else{const t=await u.Creatures.get({unitName:i});t&&n.SetToModel(t)}const s=n.GetMetadata();m.push(s),await c.scene.items.updateItems([e.id],t=>{for(let a of t){const l=m.find(v=>v[o.ID]===a.id);l&&Object.assign(a.metadata,l)}})}await g(e.id,f)}else{const m=[];for(const s of d.items){const t=s,a=t.text?.plainText||t.name;if(t.metadata[o.ID]===void 0){let l=new T(t.id,a,t.createdUserId);if(r.ALPHANUMERICTEXTMATCH.test(t.name)){const I=a.slice(0,-2),N=await u.Creatures.get({unitName:I});N&&l.SetToModel(N)}else{const I=await u.Creatures.get({unitName:a});I&&l.SetToModel(I)}const v=l.GetMetadata();m.push(v)}}await c.scene.items.updateItems(d.items,s=>{for(let t of s){const a=m.find(l=>l[o.ID]===t.id);a&&Object.assign(t.metadata,a)}});const e=await c.viewport.getHeight(),i=100,n=e>800?700:e-i;await c.popover.open({id:r.EXTENSIONSUBMENUID,url:`/submenu/subindex.html?unitid=${d.items.map(s=>s.id)}&multi=true`,height:n,width:350,anchorElementId:f,hidePaper:!0})}}})}r.MAINAPP.innerHTML=`
  <div>
    <h1>Loading...</h1>
  </div>
`;r.MAINLOAD.innerHTML=`
<div>
    <h1 id="loadingScreenHeader">Waiting for Scene...</h1>
    <div class="imageContainer">
        <img class="resize-fit-center" src="logo.png" alt="Clash!" class="center">
    </div>
</div>`;r.MAINDISABLED.innerHTML=`
<div>
    <h1 id="loadingScreenHeader">Access has been disabled</h1>
    <div class="imageContainer">
        <img class="resize-fit-center" src="logo.png" alt="Clash!" class="center">
    </div>
</div>`;c.onReady(async()=>{await C.InitializeCache(),C.SetupHandlers(),C.playerRole==="GM"&&(await h(),u.Ready()),C.playerRole==="GM"?(A.Render(),w()):p.Render(),r.MAINAPP.hidden=!1,r.MAINLOAD.hidden=!0});
